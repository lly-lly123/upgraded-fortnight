<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‰ø°È∏ΩÊ°£Ê°à‰∏éË°ÄÁªüÁÆ°ÁêÜÁ≥ªÁªü Pro</title>
  <!-- Google Fonts - ‰∏ì‰∏öÂ≠ó‰Ωì -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ==========================================
       üé® CSS ÂèòÈáè - ËÆæËÆ°Á≥ªÁªü
       ========================================== */
    :root {
      /* ‰∏ªËâ≤Ë∞É */
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --primary-50: #eff6ff;
      --primary-100: #dbeafe;
      --primary-200: #bfdbfe;
      
      /* Âº∫Ë∞ÉËâ≤ */
      --accent: #8b5cf6;
      --accent-light: #a78bfa;
      
      /* ÊàêÂäü/Ë≠¶Âëä/ÈîôËØØ */
      --success: #10b981;
      --success-light: #d1fae5;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --danger: #ef4444;
      --danger-light: #fee2e2;
      
      /* ‰∏≠ÊÄßËâ≤ */
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      
      /* ËÉåÊôØËâ≤ */
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f1f5f9;
      
      /* ÊñáÂ≠óÈ¢úËâ≤ */
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      
      /* ËæπÊ°Ü */
      --border-light: #e2e8f0;
      --border-medium: #cbd5e1;
      
      /* Èò¥ÂΩ± */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --shadow-glow: 0 0 20px rgba(37, 99, 235, 0.3);
      
      /* ÂúÜËßí */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      
      /* ËøáÊ∏° */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
      
      /* È°∂Ê†èÈ´òÂ∫¶ */
      --header-height: 68px;
      --sidebar-width: 260px;
    }
    
    /* Ê∑±Ëâ≤Ê®°ÂºèÂèòÈáè */
    [data-theme="dark"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-light: #334155;
      --border-medium: #475569;
      --gray-50: #1e293b;
      --gray-100: #334155;
      --gray-200: #475569;
    }
    
    /* ==========================================
       üîß Âü∫Á°ÄÈáçÁΩÆ‰∏éÈÄöÁî®Ê†∑Âºè
       ========================================== */
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    body { 
      font-family: 'Inter', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* ÊªöÂä®Êù°ÁæéÂåñ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--gray-100);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-400);
    }
    
    /* ÈÄâ‰∏≠ÊñáÂ≠óÊ†∑Âºè */
    ::selection {
      background: var(--primary-200);
      color: var(--primary-dark);
    }
    
    /* ==========================================
       üîù È°∂ÈÉ®ÂØºËà™Ê†è
       ========================================== */
    .top-header { 
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      color: #fff; 
      padding: 0 28px; 
      height: var(--header-height); 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      z-index: 1000;
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .top-header h1 { 
      margin: 0; 
      font-size: 20px; 
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(90deg, #fff 0%, #a5b4fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .top-header h1::before {
      content: 'üïäÔ∏è';
      font-size: 24px;
      -webkit-text-fill-color: initial;
    }
    .top-header-actions { 
      display: flex; 
      align-items: center; 
      gap: 14px; 
    }
    
    /* ==========================================
       üì± Â∑¶‰æßËèúÂçï
       ========================================== */
    .sidebar { 
      width: var(--sidebar-width); 
      background: var(--bg-secondary);
      position: fixed; 
      top: var(--header-height); 
      left: 0; 
      bottom: 0; 
      box-shadow: var(--shadow-lg);
      overflow-y: auto; 
      z-index: 999;
      border-right: 1px solid var(--border-light);
      transition: transform var(--transition-normal);
    }
    .sidebar-menu { 
      padding: 20px 12px;
    }
    .sidebar-item { 
      display: flex; 
      align-items: center; 
      padding: 14px 18px; 
      color: var(--text-secondary); 
      cursor: pointer; 
      transition: all var(--transition-fast);
      border-radius: var(--radius-md);
      margin-bottom: 4px;
      font-weight: 500;
      font-size: 14px;
    }
    .sidebar-item:hover { 
      background: var(--primary-50);
      color: var(--primary);
      transform: translateX(4px);
    }
    .sidebar-item.active { 
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: #fff;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    .sidebar-item-icon { 
      margin-right: 14px; 
      font-size: 18px;
      width: 24px;
      text-align: center;
    }
    
    /* ==========================================
       üìÑ ‰∏ªÂÜÖÂÆπÂå∫
       ========================================== */
    .main-content { 
      margin-left: var(--sidebar-width); 
      margin-top: var(--header-height); 
      padding: 28px; 
      min-height: calc(100vh - var(--header-height));
      background: var(--bg-primary);
    }
    .content-wrapper { 
      max-width: 1600px; 
      margin: 0 auto;
    }
    
    /* ==========================================
       üÉè Âç°ÁâáÊ†∑Âºè
       ========================================== */
    .card { 
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: 28px;
      margin-bottom: 24px;
      border: 1px solid var(--border-light);
      transition: all var(--transition-normal);
    }
    .card:hover {
      box-shadow: var(--shadow-lg);
    }
    .card-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-light);
    }
    .card-header h2 { 
      margin: 0; 
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* ==========================================
       üîò ÊåâÈíÆÁ≥ªÁªü
       ========================================== */
    .btn { 
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all var(--transition-fast);
      gap: 6px;
      white-space: nowrap;
    }
    .btn:active {
      transform: scale(0.97);
    }
    .btn-primary { 
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.35);
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.45);
      transform: translateY(-2px);
    }
    .btn-outline { 
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }
    .btn-outline:hover {
      background: var(--primary-50);
      border-color: var(--primary-dark);
    }
    .btn-danger { 
      background: linear-gradient(135deg, var(--danger) 0%, #f87171 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(239, 68, 68, 0.35);
    }
    .btn-danger:hover {
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.45);
      transform: translateY(-2px);
    }
    .btn-ghost { 
      background: transparent;
      color: var(--text-secondary);
    }
    .btn-ghost:hover {
      background: var(--gray-100);
      color: var(--text-primary);
    }
    .btn-sm { 
      padding: 6px 12px;
      font-size: 13px;
      border-radius: var(--radius-sm);
    }
    .btn + .btn { 
      margin-left: 10px; 
    }
    
    /* ==========================================
       üîÄ ËßÜÂõæÂàáÊç¢Âô®
       ========================================== */
    .view-switcher {
      display: flex;
      gap: 4px;
      background: var(--gray-100);
      padding: 5px;
      border-radius: var(--radius-md);
    }
    .view-switch-btn {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
    }
    .view-switch-btn:hover {
      background: rgba(255,255,255,0.7);
      color: var(--text-primary);
    }
    .view-switch-btn.active {
      background: var(--bg-secondary);
      color: var(--primary);
      font-weight: 600;
      box-shadow: var(--shadow-md);
    }
    
    /* ==========================================
       üè∑Ô∏è Ê†áÁ≠æÁ≥ªÁªü
       ========================================== */
    .tag { 
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
      margin-left: 8px;
      transition: all var(--transition-fast);
    }
    .tag-alive { 
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #047857;
    }
    .tag-dead { 
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #b91c1c;
    }
    .tag-type { 
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      color: #1d4ed8;
    }
    
    /* ==========================================
       üìä Ë°®Ê†ºÊ†∑Âºè
       ========================================== */
    table { 
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td { 
      padding: 14px 12px;
      border-bottom: 1px solid var(--border-light);
      text-align: left;
    }
    th { 
      background: var(--gray-50);
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    tr {
      transition: all var(--transition-fast);
    }
    tr:hover { 
      background: var(--primary-50);
    }
    tbody tr:last-child td {
      border-bottom: none;
    }
    .muted { 
      color: var(--text-muted);
      font-size: 13px;
    }

    /* ==========================================
       üìù Ë°®ÂçïÊ†∑Âºè
       ========================================== */
    .form-grid { 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px 28px;
      margin-top: 12px;
    }
    .form-group { 
      display: flex;
      flex-direction: column;
      margin-bottom: 12px;
    }
    .form-group label { 
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }
    .form-group label .required { 
      color: var(--danger);
      margin-left: 4px;
    }
    .form-group input[type="text"],
    .form-group input[type="date"],
    .form-group input[type="number"],
    .form-group input[type="time"],
    .form-group input[type="file"],
    .form-group select,
    .form-group textarea {
      padding: 12px 14px;
      border-radius: var(--radius-md);
      border: 2px solid var(--border-light);
      font-size: 14px;
      outline: none;
      transition: all var(--transition-fast);
      background: var(--bg-secondary);
      color: var(--text-primary);
    }
    .form-group input:hover,
    .form-group select:hover,
    .form-group textarea:hover {
      border-color: var(--border-medium);
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }
    .form-group input::placeholder,
    .form-group textarea::placeholder {
      color: var(--text-muted);
    }
    .form-inline { 
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .radio-group { 
      display: flex;
      gap: 16px;
      font-size: 14px;
    }
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    .radio-group input[type="radio"],
    .radio-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }
    
    /* ==========================================
       üìë Âå∫ÂùóÊ†áÈ¢ò
       ========================================== */
    .section-title { 
      font-size: 16px;
      font-weight: 700;
      margin: 36px 0 18px;
      padding: 14px 20px;
      color: var(--text-primary);
      background: linear-gradient(135deg, var(--primary-50) 0%, var(--bg-tertiary) 100%);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section-title:first-of-type { 
      margin-top: 0;
    }
    
    /* ËØ¶ÁªÜ‰ø°ÊÅØÈ°µÈù¢Â≠óÊÆµÂÆπÂô® */
    .detail-section {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-light);
    }
    .section-desc { 
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    .flex-between { 
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* ==========================================
       üèÅ ÊØîËµõËÆ∞ÂΩï
       ========================================== */
    .race-list { 
      margin-top: 12px;
    }
    .race-item { 
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: 16px 18px;
      margin-bottom: 12px;
      background: var(--gray-50);
      transition: all var(--transition-fast);
    }
    .race-item:hover {
      border-color: var(--primary-200);
      box-shadow: var(--shadow-sm);
    }
    .race-header { 
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .race-fields { 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px 20px;
      font-size: 13px;
    }
    .pill { 
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 999px;
      background: var(--gray-100);
      font-size: 12px;
      font-weight: 500;
      margin-right: 6px;
      transition: all var(--transition-fast);
    }
    .pill:hover {
      background: var(--primary-100);
      color: var(--primary);
    }

    .images-grid { display:flex; gap:16px; margin-top: 8px; justify-content:center; flex-wrap:wrap; }
    .image-thumb { width:400px; height:300px; background:#f0f0f0; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:14px; color:#999; position:relative; overflow:hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .image-thumb img { width:100%; height:100%; object-fit:cover; }
    .badge { position:absolute; bottom:8px; left:8px; right:8px; background:rgba(0,0,0,0.7); color:#fff; font-size:13px; padding:6px 10px; border-radius:8px; text-align:center; }
    
    .pedigree-tree { margin-top:16px; padding:20px; background:#fafafa; border-radius:8px; min-height:200px; }
    .pedigree-node { display:inline-block; padding:8px 12px; margin:4px; background:#fff; border:2px solid #2b5cff; border-radius:6px; font-size:13px; cursor:pointer; }
    .pedigree-node:hover { background:#e6f0ff; }
    .pedigree-node.core { border-color:#ffa500; background:#fff8e6; }
    .pedigree-connection { stroke:#2b5cff; stroke-width:2; fill:none; }
    
    /* Ë°ÄÁªüÊ†ëÂÆπÂô®Ê†∑Âºè */
    .pedigree-tree-container {
      position: relative;
      overflow: auto;
    }
    
    /* Ê†ëÁä∂ÂõæËäÇÁÇπÊ†∑Âºè - ‰ºòÂåñÁâà */
    .tree-node {
      display: inline-block;
      padding: 14px 20px;
      margin: 8px;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 2.5px solid #2b5cff;
      border-radius: 12px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(43, 92, 255, 0.15);
      min-width: 160px;
      text-align: center;
      position: relative;
    }
    .tree-node::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #2b5cff 0%, #6366f1 100%);
      border-radius: 12px 12px 0 0;
    }
    .tree-node:hover {
      background: linear-gradient(135deg, #e6f0ff 0%, #f0f7ff 100%);
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 8px 24px rgba(43, 92, 255, 0.25);
      border-color: #6366f1;
    }
    .tree-node.core {
      border-color: #ffa500;
      background: linear-gradient(135deg, #fff8e6 0%, #fffbf0 100%);
      box-shadow: 0 4px 12px rgba(255, 165, 0, 0.2);
    }
    .tree-node.core::before {
      background: linear-gradient(90deg, #ffa500 0%, #ffb84d 100%);
    }
    .tree-node.dead {
      opacity: 0.7;
      border-color: #9ca3af;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .tree-node.dead::before {
      background: #9ca3af;
    }
    .tree-node-name {
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 6px;
      font-size: 14px;
      letter-spacing: -0.2px;
    }
    .tree-node-ring {
      font-size: 11px;
      color: #6b7280;
      font-family: 'Courier New', monospace;
      background: rgba(107, 114, 128, 0.1);
      padding: 3px 8px;
      border-radius: 6px;
      display: inline-block;
      margin-top: 4px;
    }
    .tree-node-label {
      font-size: 10px;
      color: #9ca3af;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid #e5e7eb;
      font-weight: 500;
    }
    
    /* Ê†ëÁä∂ÂõæËøûÊé•Á∫øÂÆπÂô® */
    .tree-connections {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    
    /* Ê†ëÁä∂ÂõæËøûÊé•Á∫ø */
    .tree-connection {
      stroke: #2b5cff;
      stroke-width: 2.5;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity: 0.6;
      filter: drop-shadow(0 1px 2px rgba(43, 92, 255, 0.3));
    }
    
    /* Ê†ëÁä∂ÂõæÂ∏ÉÂ±Ä */
    .tree-level {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      margin: 30px 0;
      position: relative;
    }
    .tree-level-parents {
      display: flex;
      gap: 60px;
      justify-content: center;
      margin-bottom: 40px;
      position: relative;
    }
    .tree-level-children {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
      position: relative;
    }
    .tree-current {
      margin: 40px 0;
      text-align: center;
      position: relative;
      padding: 20px 0;
    }
    .tree-section-title {
      font-size: 15px;
      font-weight: 700;
      color: #374151;
      margin: 30px 0 20px;
      text-align: center;
      padding: 12px 20px;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-radius: 10px;
      border: 1px solid #d1d5db;
      letter-spacing: 0.3px;
    }
    
    /* Áà∂È∏Ω/ÊØçÈ∏ΩÊ†áÁ≠æÊ†∑Âºè */
    .tree-parent-label {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 12px;
      padding: 6px 14px;
      border-radius: 20px;
      display: inline-block;
      letter-spacing: 0.5px;
    }
    .tree-parent-label.father {
      color: #1e40af;
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border: 2px solid #3b82f6;
    }
    .tree-parent-label.mother {
      color: #be185d;
      background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
      border: 2px solid #ec4899;
    }
    
    /* Ê†ëÁä∂ÂõæÂÆπÂô®‰ºòÂåñ */
    .pedigree-tree-container {
      background: linear-gradient(135deg, #fafbfc 0%, #f3f4f6 100%);
    }
    
    @media (max-width: 900px) {
      .image-thumb { width:100%; max-width:400px; height:auto; min-height:250px; }
    }

    .field-row { 
      display:flex; 
      margin-bottom:12px; 
      font-size:14px; 
      padding:12px 16px; 
      border-bottom:1px solid #f0f0f0; 
      align-items:center; 
      min-height:44px;
      transition:background 0.2s;
    }
    .field-row:hover { background:#fafbfc; }
    .field-row:last-child { border-bottom:none; }
    .field-label { 
      width:120px; 
      color:#666; 
      flex-shrink:0; 
      font-weight:500; 
      text-align:right;
      padding-right:16px;
      border-right:1px solid #f0f0f0;
    }
    .field-value { 
      flex:1; 
      color:#222; 
      padding-left:16px;
      word-break:break-word;
    }

    .status-dead { color:#ff4d4f; font-weight:600; margin-left:8px; }
    .badge-small { display:inline-block; padding:2px 6px; border-radius:6px; background:#f5f5f5; font-size:11px; margin-left:4px; }

    .notice { background:#fffbe6; border:1px solid #ffe58f; color:#ad8b00; padding:8px 10px; border-radius:8px; font-size:12px; margin-bottom:10px; }

    /* È∏ΩÂ≠êÂç°ÁâáËßÜÂõæÊ†∑Âºè */
    .pigeon-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 14px;
      margin-top: 16px;
      padding: 8px 0;
    }
    .pigeon-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 10px;
      padding: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .pigeon-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #2b5cff 0%, #6366f1 100%);
    }
    .pigeon-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 32px rgba(43,92,255,0.15);
      border-color: #2b5cff;
    }
    .pigeon-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #f0f0f0;
    }
    .pigeon-card-header > div:first-child {
      flex: 1;
      min-width: 0;
    }
    .pigeon-card-name {
      font-size: 15px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 5px;
      line-height: 1.3;
      letter-spacing: -0.2px;
      word-break: break-word;
    }
    .pigeon-card-ring {
      font-size: 11px;
      color: #6b7280;
      font-family: 'Courier New', monospace;
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      display: inline-block;
    }
    .pigeon-card-info {
      margin-bottom: 10px;
      flex: 1;
      padding: 0;
    }
    .pigeon-card-info-item {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 0;
      display: flex !important;
      justify-content: space-between !important;
      align-items: center;
      padding: 6px 8px;
      line-height: 1.4;
      min-height: 32px;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }
    .pigeon-card-info-item:hover {
      background: #fafbfc;
    }
    .pigeon-card-info-item:last-child {
      border-bottom: none;
    }
    .pigeon-card-info-label {
      flex: 0 0 60px;
      color: #6b7280 !important;
      font-size: 11px !important;
      text-align: left !important;
      font-weight: 500;
      padding-right: 8px;
    }
    .pigeon-card-info-value {
      flex: 1;
      color: #1f2937 !important;
      font-weight: 500 !important;
      text-align: right !important;
      word-break: break-word;
      font-size: 12px !important;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .pigeon-card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: auto;
      padding-top: 10px;
      border-top: 1px solid #f0f0f0;
    }
    .pigeon-card-tags .tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 8px;
    }
    .tag-core {
      background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
      color: #7c3aed;
      border: 1px solid #e9d5ff;
      font-weight: 500;
    }
    .tag-recycled {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      color: #856404;
      border: 1px solid #ffeaa7;
      font-weight: 500;
    }
    @media (max-width: 768px) {
      .pigeon-cards {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .pigeon-card {
        padding: 14px;
      }
    }

    /* Êï∞ÊçÆÊ¶ÇÂÜµÁªüËÆ°Âç°ÁâáÊ†∑Âºè */
    .stats-cards { 
      display: grid; 
      grid-template-columns: repeat(5, 1fr); 
      gap: 20px; 
      margin-top: 8px;
    }
    @media (max-width: 1200px) {
      .stats-cards { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 800px) {
      .stats-cards { grid-template-columns: repeat(2, 1fr); }
    }
    .stat-card { 
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 12px; 
      padding: 24px 20px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #2b5cff 0%, #6366f1 100%);
    }
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    .stat-card-label { 
      font-size: 14px; 
      color: #6b7280; 
      margin-bottom: 12px; 
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .stat-card-number { 
      font-size: 36px; 
      font-weight: 700; 
      color: #1f2937; 
      line-height: 1.2;
      letter-spacing: -0.5px;
    }
    .stat-card:nth-child(1)::before { background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%); }
    .stat-card:nth-child(2)::before { background: linear-gradient(90deg, #10b981 0%, #059669 100%); }
    .stat-card:nth-child(3)::before { background: linear-gradient(90deg, #6b7280 0%, #4b5563 100%); }
    .stat-card:nth-child(4)::before { background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%); }
    .stat-card:nth-child(5)::before { background: linear-gradient(90deg, #8b5cf6 0%, #7c3aed 100%); }

    /* Âπ¥Â∫¶ÁªüËÆ°Ë°®Ê†º‰ºòÂåñ */
    #chartContainer {
      background: #fafbfc;
      border-radius: 8px;
    }
    #chartContainer table {
      width: 100%;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }
    #chartContainer table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      font-weight: 600;
      padding: 14px 16px;
      text-align: center;
    }
    #chartContainer table td {
      padding: 12px 16px;
      text-align: center;
      border-bottom: 1px solid #f0f0f0;
    }
    #chartContainer table tr:last-child td {
      border-bottom: none;
    }
    #chartContainer table tr:hover {
      background: #f8f9ff;
    }

    @media (max-width: 600px) {
      header { padding:12px 16px; }
      .card { padding:16px; }
      .field-label { width:80px; }
      .stats-cards { grid-template-columns: 1fr; gap: 16px; }
      .stat-card { padding: 20px 16px; }
      .stat-card-number { font-size: 28px; }
    }
    
    /* ÊØîËµõÁÆ°ÁêÜÊ†∑Âºè */
    .race-tab-btn {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    .race-tab-btn:hover {
      color: #2b5cff;
      background: #f0f7ff;
    }
    .race-tab-btn.active {
      color: #2b5cff;
      border-bottom-color: #2b5cff;
      font-weight: 600;
    }
    .race-tab-content {
      display: none;
      padding: 20px 0;
    }
    .race-tab-content.active {
      display: block;
    }
    .race-card {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
      transition: all 0.3s;
    }
    .race-card:hover {
      box-shadow: 0 4px 16px rgba(43,92,255,0.15);
      transform: translateY(-2px);
    }
    .race-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }
    .race-card-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }
    .race-card-meta {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      font-size: 13px;
      color: #6b7280;
    }
    .race-card-meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .participant-item {
      transition: all 0.2s;
    }
    .participant-item:hover {
      background: #f3f4f6 !important;
    }
    .stats-chart-container {
      background: #fff;
      border-radius: 10px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .analysis-conclusion {
      background: linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%);
      border-left: 4px solid #2b5cff;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    .analysis-conclusion h4 {
      margin: 0 0 12px 0;
      color: #1f2937;
      font-size: 16px;
    }
    .analysis-conclusion p {
      margin: 8px 0;
      color: #4b5563;
      line-height: 1.6;
    }
    
    /* ÁπÅËÇ≤ÈÖçÂØπÊ®°ÂùóÊ†∑Âºè */
    .breeding-panel {
      padding: 20px 0;
    }
    .breeding-pigeon-card {
      transition: all 0.3s;
    }
    .breeding-pigeon-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }
    .breeding-pigeon-info {
      font-size: 13px;
      color: #4b5563;
    }
    .breeding-pigeon-info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .inbreeding-meter {
      height: 8px;
      border-radius: 4px;
      background: #e5e7eb;
      overflow: hidden;
      margin: 12px 0;
    }
    .inbreeding-meter-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    .inbreeding-low { background: linear-gradient(90deg, #10b981 0%, #34d399 100%); }
    .inbreeding-medium { background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%); }
    .inbreeding-high { background: linear-gradient(90deg, #ef4444 0%, #f87171 100%); }
    
    .pairing-history-item {
      display: grid;
      grid-template-columns: 1fr 1fr 2fr 1fr;
      gap: 16px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 12px;
      align-items: center;
    }
    .pairing-history-item:hover {
      background: #f0f7ff;
    }
    
    /* ÂÅ•Â∫∑ÁÆ°ÁêÜÊ®°ÂùóÊ†∑Âºè */
    .health-alert-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: #fff;
      border-radius: 10px;
      margin-bottom: 12px;
      border-left: 4px solid #e5e7eb;
      transition: all 0.2s;
    }
    .health-alert-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .health-alert-item.urgent {
      border-left-color: #ef4444;
      background: #fef2f2;
    }
    .health-alert-item.warning {
      border-left-color: #f59e0b;
      background: #fffbeb;
    }
    .health-alert-item.info {
      border-left-color: #3b82f6;
      background: #eff6ff;
    }
    
    .health-timeline-item {
      display: flex;
      gap: 20px;
      padding: 20px 0;
      border-bottom: 1px solid #f0f0f0;
      position: relative;
    }
    .health-timeline-item::before {
      content: '';
      position: absolute;
      left: 15px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #e5e7eb;
    }
    .health-timeline-item:last-child::before {
      display: none;
    }
    .health-timeline-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      z-index: 1;
      flex-shrink: 0;
    }
    .health-timeline-dot.vaccine { background: #dbeafe; }
    .health-timeline-dot.deworm { background: #fef3c7; }
    .health-timeline-dot.checkup { background: #d1fae5; }
    .health-timeline-dot.illness { background: #fee2e2; }
    .health-timeline-dot.medication { background: #e0e7ff; }
    .health-timeline-dot.recovery { background: #d1fae5; }
    
    /* Êô∫ËÉΩÂàÜÊûêÊ®°ÂùóÊ†∑Âºè */
    .insight-card {
      transition: all 0.3s;
    }
    .insight-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }
    
    .potential-item {
      display: grid;
      grid-template-columns: 50px 2fr 1fr 1fr 120px;
      gap: 16px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 10px;
      margin-bottom: 12px;
      align-items: center;
    }
    .potential-item:hover {
      background: #f0f7ff;
    }
    .potential-rank {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
    }
    .potential-rank.gold { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #fff; }
    .potential-rank.silver { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); color: #fff; }
    .potential-rank.bronze { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: #fff; }
    .potential-rank.normal { background: #e5e7eb; color: #4b5563; }
    
    .potential-score {
      font-size: 18px;
      font-weight: 700;
      color: #2b5cff;
    }
    .potential-bar {
      height: 8px;
      border-radius: 4px;
      background: #e5e7eb;
      overflow: hidden;
    }
    .potential-bar-fill {
      height: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, #3b82f6 0%, #2b5cff 100%);
      transition: width 0.5s ease;
    }
    
    /* ExcelÂØºÂÖ•Ê†∑Âºè */
    .excel-import-zone {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #fafafa;
    }
    .excel-import-zone:hover {
      border-color: #2b5cff;
      background: #f0f7ff;
    }
    .excel-import-zone.dragover {
      border-color: #2b5cff;
      background: #e6f0ff;
    }
    
    /* Êô∫ËÉΩÊêúÁ¥¢Ê†∑Âºè */
    .smart-search-container {
      position: relative;
    }
    .smart-search-input {
      width: 100%;
      padding: 14px 20px;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      font-size: 15px;
      outline: none;
      transition: all 0.3s;
    }
    .smart-search-input:focus {
      border-color: #2b5cff;
      box-shadow: 0 0 0 4px rgba(43,92,255,0.1);
    }
    .smart-search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      margin-top: 8px;
      max-height: 300px;
      overflow-y: auto;
      display: none;
      z-index: 100;
    }
    .smart-search-suggestions.show {
      display: block;
    }
    .search-suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }
    .search-suggestion-item:hover {
      background: #f0f7ff;
    }
    
    /* Ê†áÁ≠æËá™Âä®ÂåñÊ†∑Âºè */
    .auto-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }
    .auto-tag.stable { background: #d1fae5; color: #047857; }
    .auto-tag.core { background: #fef3c7; color: #b45309; }
    .auto-tag.potential { background: #dbeafe; color: #1e40af; }
    .auto-tag.warning { background: #fee2e2; color: #dc2626; }
    .auto-tag.champion { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #fff; }
    
    /* ==========================================
       üè† È¶ñÈ°µ ¬∑ ËµõÈ∏ΩËµÑËÆØ‰∏≠ÂøÉÊ†∑Âºè
       ========================================== */
    
    .home-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    /* È°∂ÈÉ®‰ªäÊó•Ê¶ÇËßà */
    .home-overview {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 50%, #1e3a5f 100%);
      border-radius: 16px;
      padding: 24px 32px;
      color: #fff;
      box-shadow: 0 8px 32px rgba(30, 58, 95, 0.3);
    }
    .home-overview-left {
      display: flex;
      align-items: center;
      gap: 32px;
    }
    .home-date {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .home-date-day {
      font-size: 56px;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(180deg, #fff 0%, #a0c4ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .home-date-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .home-date-weekday {
      font-size: 18px;
      font-weight: 600;
    }
    .home-date-full {
      font-size: 14px;
      opacity: 0.8;
    }
    .home-weather {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    .home-overview-stats {
      display: flex;
      gap: 24px;
    }
    .home-stat-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    .home-stat-icon {
      font-size: 24px;
    }
    .home-stat-content {
      display: flex;
      flex-direction: column;
    }
    .home-stat-number {
      font-size: 24px;
      font-weight: 700;
    }
    .home-stat-label {
      font-size: 12px;
      opacity: 0.8;
    }
    
    /* ÈáçË¶ÅÂÖ¨Âëä */
    .home-announcement {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      background: linear-gradient(90deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 12px;
      border-left: 4px solid #f59e0b;
    }
    .announcement-icon {
      font-size: 20px;
    }
    .announcement-text {
      flex: 1;
      font-size: 14px;
      color: #92400e;
      font-weight: 500;
    }
    
    /* ‰∏âÊ†èÂ∏ÉÂ±Ä */
    .home-content {
      display: grid;
      grid-template-columns: 1fr 1.2fr 320px;
      gap: 20px;
      min-height: 600px;
    }
    
    /* ÈÄöÁî®ÂàóÊ†∑Âºè */
    .home-column {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .home-column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #f0f0f0;
    }
    .home-column-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }
    .home-column-footer {
      padding: 16px;
      text-align: center;
      border-top: 1px solid #f0f0f0;
    }
    
    /* ËµÑËÆØÁ≠õÈÄâÊåâÈíÆ */
    .news-filter {
      display: flex;
      gap: 4px;
    }
    .news-filter-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 12px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .news-filter-btn:hover {
      background: #f3f4f6;
      color: #1f2937;
    }
    .news-filter-btn.active {
      background: #2b5cff;
      color: #fff;
    }
    
    /* ËµÑËÆØÂàóË°® */
    .home-news-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    .news-card {
      padding: 16px;
      border-radius: 12px;
      background: #f9fafb;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid transparent;
    }
    .news-card:hover {
      background: #f0f7ff;
      border-color: #dbeafe;
      transform: translateX(4px);
    }
    .news-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .news-card-title {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
      line-height: 1.4;
      flex: 1;
    }
    .news-card-time {
      font-size: 11px;
      color: #9ca3af;
      white-space: nowrap;
      margin-left: 12px;
    }
    .news-card-source {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .news-card-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .news-tag {
      padding: 2px 8px;
      background: #e5e7eb;
      border-radius: 4px;
      font-size: 11px;
      color: #4b5563;
    }
    .news-tag.race { background: #dbeafe; color: #1e40af; }
    .news-tag.breeding { background: #fce7f3; color: #be185d; }
    .news-tag.health { background: #d1fae5; color: #047857; }
    .news-tag.hot { background: #fee2e2; color: #dc2626; }
    
    /* Ëµõ‰∫ãÊ†áÁ≠æÈ°µ */
    .event-tabs {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
      background: #f9fafb;
    }
    .event-tab-btn {
      flex: 1;
      padding: 10px 12px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 13px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
      font-weight: 500;
    }
    .event-tab-btn:hover {
      background: #fff;
      color: #1f2937;
    }
    .event-tab-btn.active {
      background: #fff;
      color: #2b5cff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    /* Ëµõ‰∫ãÂàóË°® */
    .home-events-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    .event-card {
      padding: 16px;
      border-radius: 12px;
      background: #fff;
      margin-bottom: 12px;
      border: 1px solid #e5e7eb;
      transition: all 0.3s;
    }
    .event-card:hover {
      border-color: #2b5cff;
      box-shadow: 0 4px 16px rgba(43,92,255,0.12);
    }
    .event-card-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .event-card-status.ongoing {
      background: #d1fae5;
      color: #047857;
    }
    .event-card-status.ongoing::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .event-card-status.upcoming {
      background: #dbeafe;
      color: #1e40af;
    }
    .event-card-status.completed {
      background: #f3f4f6;
      color: #4b5563;
    }
    .event-card-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
    }
    .event-card-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 13px;
      color: #6b7280;
    }
    .event-card-info-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .event-card-progress {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f0f0f0;
    }
    .event-progress-bar {
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 6px;
    }
    .event-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
      border-radius: 3px;
      transition: width 0.5s;
    }
    .event-progress-text {
      font-size: 12px;
      color: #6b7280;
      text-align: center;
    }
    
    /* Âè≥‰æßÂ∞èÈÉ®‰ª∂ */
    .home-sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 16px;
      background: #f9fafb;
    }
    .home-widget {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }
    .home-widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-bottom: 1px solid #e5e7eb;
    }
    .home-widget-header h4 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }
    .home-widget-content {
      padding: 14px 16px;
    }
    
    /* ËÆ¢ÈòÖÊ†áÁ≠æ */
    .subscription-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .subscription-tag {
      padding: 6px 12px;
      background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
      border-radius: 999px;
      font-size: 12px;
      color: #1e40af;
      font-weight: 500;
    }
    .subscription-tag.add-tag {
      background: #f3f4f6;
      color: #6b7280;
      cursor: pointer;
      border: 1px dashed #d1d5db;
    }
    .subscription-tag.add-tag:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }
    
    /* Âø´Êç∑ÂÖ•Âè£ */
    .quick-links {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .quick-link-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 14px 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      color: #4b5563;
    }
    .quick-link-btn:hover {
      background: #f0f7ff;
      border-color: #2b5cff;
      color: #2b5cff;
      transform: translateY(-2px);
    }
    .quick-link-btn span:first-child {
      font-size: 24px;
    }
    
    /* Êé®ËçêÂç°Áâá */
    .recommendation-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .recommendation-item:hover {
      background: #f0f7ff;
    }
    .recommendation-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }
    .recommendation-icon.race { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
    .recommendation-icon.pigeon { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); }
    .recommendation-icon.breeding { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); }
    .recommendation-content {
      flex: 1;
    }
    .recommendation-title {
      font-size: 13px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .recommendation-desc {
      font-size: 11px;
      color: #6b7280;
    }
    
    /* ‰ªäÊó•ÊèêÈÜí */
    .alert-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: #fff;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 3px solid #e5e7eb;
      font-size: 13px;
    }
    .alert-item.urgent { border-left-color: #ef4444; background: #fef2f2; }
    .alert-item.warning { border-left-color: #f59e0b; background: #fffbeb; }
    .alert-item.info { border-left-color: #3b82f6; background: #eff6ff; }
    .alert-item-icon { font-size: 16px; }
    .alert-item-text { flex: 1; color: #4b5563; }
    
    /* ÂìçÂ∫îÂºèËÆæËÆ° */
    @media (max-width: 1200px) {
      .home-content {
        grid-template-columns: 1fr 1fr;
      }
      .home-sidebar {
        grid-column: span 2;
        flex-direction: row;
        flex-wrap: wrap;
      }
      .home-widget {
        flex: 1;
        min-width: 280px;
      }
    }
    @media (max-width: 900px) {
      .home-overview {
        flex-direction: column;
        gap: 20px;
      }
      .home-overview-stats {
        flex-wrap: wrap;
        justify-content: center;
      }
      .home-content {
        grid-template-columns: 1fr;
      }
      .home-sidebar {
        flex-direction: column;
      }
    }
    
    /* ==========================================
       ‚ú® ÂÖ®Â±ÄÂä®ÁîªÊïàÊûú
       ========================================== */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(37, 99, 235, 0.3); }
      50% { box-shadow: 0 0 20px rgba(37, 99, 235, 0.6); }
    }
    
    /* È™®Êû∂Â±èÊïàÊûú */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-md);
    }
    
    /* ÊÇ¨ÊµÆÊïàÊûúÂ¢ûÂº∫ */
    .hover-lift {
      transition: all var(--transition-normal);
    }
    .hover-lift:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
    }
    
    .hover-glow {
      transition: all var(--transition-normal);
    }
    .hover-glow:hover {
      box-shadow: var(--shadow-glow);
    }
    
    /* ==========================================
       üåô Ê∑±Ëâ≤Ê®°ÂºèÂ¢ûÂº∫Ê†∑Âºè
       ========================================== */
    [data-theme="dark"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-light: #334155;
      --border-medium: #475569;
      --gray-50: #1e293b;
      --gray-100: #334155;
      --gray-200: #475569;
    }
    
    [data-theme="dark"] .top-header {
      background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #020617 100%);
      border-bottom-color: rgba(255,255,255,0.05);
    }
    
    [data-theme="dark"] .sidebar {
      background: #1e293b;
      border-right-color: #334155;
    }
    
    [data-theme="dark"] .sidebar-item:hover {
      background: #334155;
    }
    
    [data-theme="dark"] .card {
      background: #1e293b;
      border-color: #334155;
    }
    
    [data-theme="dark"] table th {
      background: #334155;
    }
    
    [data-theme="dark"] table tr:hover {
      background: #334155;
    }
    
    [data-theme="dark"] .form-group input,
    [data-theme="dark"] .form-group select,
    [data-theme="dark"] .form-group textarea {
      background: #334155;
      border-color: #475569;
      color: #f1f5f9;
    }
    
    [data-theme="dark"] .section-title {
      background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
    }
    
    [data-theme="dark"] .news-card {
      background: #334155;
    }
    [data-theme="dark"] .news-card:hover {
      background: #475569;
      border-color: var(--primary);
    }
    
    [data-theme="dark"] .event-card {
      background: #334155;
      border-color: #475569;
    }
    
    [data-theme="dark"] .home-overview {
      background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #1e293b 100%);
    }
    
    [data-theme="dark"] .home-column {
      background: #1e293b;
    }
    
    [data-theme="dark"] .home-sidebar {
      background: #0f172a;
    }
    
    [data-theme="dark"] .home-widget {
      background: #1e293b;
    }
    
    [data-theme="dark"] .home-widget-header {
      background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
      border-bottom-color: #475569;
    }
    
    [data-theme="dark"] .quick-link-btn {
      background: #334155;
      border-color: #475569;
      color: #94a3b8;
    }
    [data-theme="dark"] .quick-link-btn:hover {
      background: #475569;
      color: var(--primary-light);
    }
    
    [data-theme="dark"] .home-announcement {
      background: linear-gradient(90deg, #78350f 0%, #92400e 100%);
      border-left-color: #f59e0b;
    }
    [data-theme="dark"] .announcement-text {
      color: #fef3c7;
    }
    
    [data-theme="dark"] .race-modal .modal-content {
      background: #1e293b;
    }
    
    [data-theme="dark"] .breeding-pigeon-card.male-card {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%);
      border-color: #3b82f6;
    }
    
    [data-theme="dark"] .breeding-pigeon-card.female-card {
      background: linear-gradient(135deg, #5b2845 0%, #1e293b 100%);
      border-color: #ec4899;
    }
    
    [data-theme="dark"] .breeding-assessment {
      background: linear-gradient(135deg, #3b2764 0%, #1e293b 100%);
      border-color: #a855f7;
    }
    
    /* ==========================================
       üì± ÁßªÂä®Á´ØÂìçÂ∫îÂºèÂ¢ûÂº∫
       ========================================== */
    @media (max-width: 768px) {
      .top-header {
        padding: 0 16px;
      }
      .top-header h1 {
        font-size: 16px;
      }
      .top-header h1::before {
        font-size: 20px;
      }
      
      .sidebar {
        transform: translateX(-100%);
        width: 280px;
      }
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
        padding: 16px;
      }
      
      .smart-search-container input {
        width: 180px !important;
      }
      
      .card {
        padding: 16px;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .breeding-selector-row {
        grid-template-columns: 1fr !important;
      }
    }
    
    /* ==========================================
       üñ®Ô∏è ÊâìÂç∞Ê†∑Âºè
       ========================================== */
    @media print {
      .top-header,
      .sidebar,
      .btn,
      .home-announcement {
        display: none !important;
      }
      
      .main-content {
        margin: 0;
        padding: 20px;
      }
      
      .card {
        box-shadow: none;
        border: 1px solid #ddd;
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
<!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
<div class="top-header">
  <h1>‰ø°È∏ΩÊ°£Ê°à‰∏éË°ÄÁªüÁÆ°ÁêÜÁ≥ªÁªü</h1>
  <div class="top-header-actions">
    <div class="smart-search-container" style="position:relative;">
      <input type="text" id="smartSearchInput" placeholder="Êô∫ËÉΩÊêúÁ¥¢: Â¶Ç '2022 ÂÖ¨È∏Ω ËøõÂ•ñ' ÊàñË∂≥ÁéØÂè∑..." style="padding:10px 16px;border-radius:8px;border:none;background:rgba(255,255,255,0.15);color:#fff;font-size:14px;width:320px;outline:none;" />
      <div id="searchSuggestions" class="smart-search-suggestions" style="position:absolute;top:100%;left:0;right:0;background:#fff;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.2);margin-top:8px;max-height:300px;overflow-y:auto;display:none;z-index:1001;">
        <!-- ÊêúÁ¥¢Âª∫ËÆÆÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
      </div>
    </div>
    <button class="btn btn-sm" id="btnBackupData" style="background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.15);backdrop-filter:blur(10px);" title="Â§á‰ªΩÊï∞ÊçÆ">üíæ</button>
    <button class="btn btn-sm" id="btnToggleTheme" style="background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.15);backdrop-filter:blur(10px);width:38px;height:38px;padding:0;" title="ÂàáÊç¢‰∏ªÈ¢ò">üåô</button>
    <button class="btn btn-sm" id="btnGoCreate" style="background:linear-gradient(135deg, #fff 0%, #f0f7ff 100%);color:#1e293b;border:none;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,0.15);">‚ûï Êñ∞Â¢ûÈ∏ΩÂ≠ê</button>
  </div>
</div>

<!-- Â∑¶‰æßËèúÂçï -->
<div class="sidebar">
  <div class="sidebar-menu">
    <div class="sidebar-item active" data-view="homeView">
      <span class="sidebar-item-icon">üè†</span>
      <span>È¶ñÈ°µ</span>
    </div>
    <div class="sidebar-item" data-view="dashboardView">
      <span class="sidebar-item-icon">üìä</span>
      <span>Êï∞ÊçÆÊ¶ÇËßà</span>
    </div>
    <div class="sidebar-item" data-view="listView">
      <span class="sidebar-item-icon">üìã</span>
      <span>È∏ΩÂ≠êÁÆ°ÁêÜ</span>
    </div>
    <div class="sidebar-item" data-view="pedigreeView">
      <span class="sidebar-item-icon">üß¨</span>
      <span>Ë°ÄÁªüÂÖ≥Á≥ª</span>
    </div>
    <div class="sidebar-item" data-view="statsView">
      <span class="sidebar-item-icon">üìà</span>
      <span>ÁªüËÆ°ÂàÜÊûê</span>
    </div>
    <div class="sidebar-item" data-view="raceView">
      <span class="sidebar-item-icon">üèÜ</span>
      <span>ÊØîËµõ‰∏éÊàêÁª©ÁÆ°ÁêÜ</span>
    </div>
    <div class="sidebar-item" data-view="breedingView">
      <span class="sidebar-item-icon">üß¨</span>
      <span>ÁπÅËÇ≤‰∏éÈÖçÂØπ</span>
    </div>
    <div class="sidebar-item" data-view="healthView">
      <span class="sidebar-item-icon">ü©∫</span>
      <span>ÂÅ•Â∫∑ÁÆ°ÁêÜ</span>
    </div>
    <div class="sidebar-item" data-view="analysisView">
      <span class="sidebar-item-icon">üß†</span>
      <span>Êô∫ËÉΩÂàÜÊûê‰∏≠ÂøÉ</span>
    </div>
  </div>
</div>

<!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
<div class="main-content">
  <div class="content-wrapper">

  <!-- üè† È¶ñÈ°µ ¬∑ ËµõÈ∏ΩËµÑËÆØ‰∏≠ÂøÉ -->
  <section id="homeView" class="home-section">
    <!-- È°∂ÈÉ®‰ªäÊó•Ê¶ÇËßà -->
    <div class="home-overview">
      <div class="home-overview-left">
        <div class="home-date">
          <span class="home-date-day" id="homeDay">19</span>
          <div class="home-date-info">
            <span class="home-date-weekday" id="homeWeekday">ÊòüÊúü‰∫î</span>
            <span class="home-date-full" id="homeDateFull">2025Âπ¥12Êúà</span>
          </div>
        </div>
        <div class="home-weather" id="homeWeather">
          <span style="font-size:28px;">‚òÄÔ∏è</span>
          <div>
            <div style="font-weight:600;">Êô¥Êúó</div>
            <div style="font-size:12px;color:#6b7280;">ÈÄÇÂêàÊîæÈ£û</div>
          </div>
        </div>
      </div>
      <div class="home-overview-stats">
        <div class="home-stat-item">
          <span class="home-stat-icon">üì∞</span>
          <div class="home-stat-content">
            <span class="home-stat-number" id="homeNewsCount">12</span>
            <span class="home-stat-label">‰ªäÊó•ËµÑËÆØ</span>
          </div>
        </div>
        <div class="home-stat-item">
          <span class="home-stat-icon">üèÅ</span>
          <div class="home-stat-content">
            <span class="home-stat-number" id="homeActiveRaces">3</span>
            <span class="home-stat-label">ËøõË°å‰∏≠Ëµõ‰∫ã</span>
          </div>
        </div>
        <div class="home-stat-item">
          <span class="home-stat-icon">üèÜ</span>
          <div class="home-stat-content">
            <span class="home-stat-number" id="homeCompletedRaces">5</span>
            <span class="home-stat-label">Â∑≤ÂÖ¨Â∏ÉÊàêÁª©</span>
          </div>
        </div>
        <div class="home-stat-item">
          <span class="home-stat-icon">üïäÔ∏è</span>
          <div class="home-stat-content">
            <span class="home-stat-number" id="homePigeonCount">0</span>
            <span class="home-stat-label">ÊàëÁöÑÈ∏ΩÂ≠ê</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ÈáçË¶ÅÂÖ¨Âëä -->
    <div class="home-announcement" id="homeAnnouncement">
      <span class="announcement-icon">üì¢</span>
      <span class="announcement-text">„ÄêÁ≥ªÁªüÂÖ¨Âëä„Äë2025Âπ¥Êò•Â≠£ËµõÂ≠£Âç≥Â∞ÜÂºÄÂßãÔºåËØ∑ÊèêÂâçÂÅöÂ•ΩÂèÇËµõÂáÜÂ§áÔºÅÂêÑÂú∞Âå∫ËµõÁ®ãÂ∑≤ÈôÜÁª≠ÂèëÂ∏É„ÄÇ</span>
      <button class="btn btn-sm btn-ghost" id="btnCloseAnnouncement">‚úï</button>
    </div>

    <!-- ‰∏âÊ†èÂ∏ÉÂ±Ä -->
    <div class="home-content">
      <!-- Â∑¶Ê†èÔºöËµõÈ∏ΩËµÑËÆØÊµÅ -->
      <div class="home-column home-news">
        <div class="home-column-header">
          <h3>üì∞ ËµõÈ∏ΩËµÑËÆØ</h3>
          <div class="news-filter">
            <button class="news-filter-btn active" data-filter="all">ÂÖ®ÈÉ®</button>
            <button class="news-filter-btn" data-filter="race">Ëµõ‰∫ã</button>
            <button class="news-filter-btn" data-filter="breeding">ËÇ≤Áßç</button>
            <button class="news-filter-btn" data-filter="health">ÂÅ•Â∫∑</button>
          </div>
        </div>
        <div class="home-news-list" id="homeNewsList">
          <!-- ËµÑËÆØÂç°ÁâáÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
        </div>
        <div class="home-column-footer">
          <button class="btn btn-outline btn-sm" id="btnLoadMoreNews">Âä†ËΩΩÊõ¥Â§ö</button>
        </div>
      </div>

      <!-- ‰∏≠Ê†èÔºöÂÆûÊó∂Ëµõ‰∫ã -->
      <div class="home-column home-events">
        <div class="home-column-header">
          <h3>üèÅ ÂÆûÊó∂Ëµõ‰∫ã</h3>
          <button class="btn btn-primary btn-sm" id="btnRefreshEvents">üîÑ Âà∑Êñ∞</button>
        </div>
        <div class="event-tabs">
          <button class="event-tab-btn active" data-tab="ongoing">‚è± ËøõË°å‰∏≠</button>
          <button class="event-tab-btn" data-tab="upcoming">üìÖ Âç≥Â∞ÜÂºÄÂßã</button>
          <button class="event-tab-btn" data-tab="results">üèÜ ÊúÄÊñ∞ÊàêÁª©</button>
        </div>
        <div class="home-events-list" id="homeEventsList">
          <!-- Ëµõ‰∫ãÂç°ÁâáÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
        </div>
      </div>

      <!-- Âè≥Ê†èÔºöÊô∫ËÉΩÊé®Ëçê & ËÆ¢ÈòÖ -->
      <div class="home-column home-sidebar">
        <!-- Êô∫ËÉΩÊé®Ëçê -->
        <div class="home-widget">
          <div class="home-widget-header">
            <h4>üß† Êô∫ËÉΩÊé®Ëçê</h4>
          </div>
          <div class="home-widget-content" id="homeRecommendations">
            <!-- Êé®ËçêÂÜÖÂÆπÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
          </div>
        </div>

        <!-- ÊàëÁöÑÂÖ≥Ê≥® -->
        <div class="home-widget">
          <div class="home-widget-header">
            <h4>‚≠ê ÊàëÁöÑÂÖ≥Ê≥®</h4>
            <button class="btn btn-ghost btn-sm" id="btnEditSubscription">ÁºñËæë</button>
          </div>
          <div class="home-widget-content" id="homeSubscriptions">
            <div class="subscription-tags">
              <span class="subscription-tag">Ë¥µÂ∑ûËµõÂå∫</span>
              <span class="subscription-tag">ÂÖ¨Ê£öËµõ</span>
              <span class="subscription-tag">Êò•Â≠£Ëµõ</span>
              <span class="subscription-tag add-tag" id="btnAddSubscription">+ Ê∑ªÂä†</span>
            </div>
          </div>
        </div>

        <!-- Âø´Êç∑ÂÖ•Âè£ -->
        <div class="home-widget">
          <div class="home-widget-header">
            <h4>üöÄ Âø´Êç∑ÂÖ•Âè£</h4>
          </div>
          <div class="home-widget-content">
            <div class="quick-links">
              <button class="quick-link-btn" data-action="addPigeon">
                <span>‚ûï</span>
                <span>Êñ∞Â¢ûÈ∏ΩÂ≠ê</span>
              </button>
              <button class="quick-link-btn" data-action="addRace">
                <span>üèÜ</span>
                <span>ÂΩïÂÖ•ÊàêÁª©</span>
              </button>
              <button class="quick-link-btn" data-action="breeding">
                <span>üíï</span>
                <span>ÈÖçÂØπËØÑ‰º∞</span>
              </button>
              <button class="quick-link-btn" data-action="analysis">
                <span>üìä</span>
                <span>Êô∫ËÉΩÂàÜÊûê</span>
              </button>
            </div>
          </div>
        </div>

        <!-- ‰ªäÊó•ÊèêÈÜí -->
        <div class="home-widget">
          <div class="home-widget-header">
            <h4>üîî ‰ªäÊó•ÊèêÈÜí</h4>
          </div>
          <div class="home-widget-content" id="homeTodayAlerts">
            <!-- ÊèêÈÜíÂÜÖÂÆπÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ÂàóË°®ËßÜÂõæ -->
  <section id="listView" class="card" style="display:none;">
    <div class="card-header">
      <h2>È∏ΩÂ≠êÁÆ°ÁêÜ</h2>
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="view-switcher">
          <button class="view-switch-btn active" id="btnTableView" data-view-type="table">üìã Ë°®Ê†º</button>
          <button class="view-switch-btn" id="btnCardView" data-view-type="card">üÉè Âç°Áâá</button>
        </div>
      </div>
    </div>
    
    <!-- Ë°®Ê†ºËßÜÂõæ -->
    <div id="tableView">
      <table>
        <thead>
        <tr>
          <th>Ë∂≥ÁéØÂè∑</th>
          <th>ÂêçÁß∞</th>
          <th>Á±ªÂûã</th>
          <th>Áä∂ÊÄÅ</th>
          <th>Áà∂È∏Ω / ÊØçÈ∏Ω</th>
          <th>Áé∞È∏Ω‰∏ª</th>
          <th>ÂèÇËµõËÆ∞ÂΩïÊï∞</th>
          <th>Êìç‰Ωú</th>
        </tr>
        </thead>
        <tbody id="pigeonTableBody">
        <!-- Ë°åÁî± JS Â°´ÂÖÖ -->
        </tbody>
      </table>
    </div>
    
    <!-- Âç°ÁâáËßÜÂõæ -->
    <div id="cardView" style="display:none;">
      <div class="pigeon-cards" id="pigeonCardsBody">
        <!-- Âç°ÁâáÁî± JS Â°´ÂÖÖ -->
      </div>
    </div>
  </section>
  
  <!-- Ë°ÄÁªüÂÖ≥Á≥ªËßÜÂõæ -->
  <section id="pedigreeView" class="card" style="display:none;">
    <div class="card-header">
      <h2>üå≥ Ë°ÄÁªüÂÖ≥Á≥ªÊ†ë</h2>
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <select id="pedigreeSelectPigeon" style="padding:8px 12px;border-radius:6px;border:1px solid #E5E7EB;background:#fff;min-width:250px;">
          <option value="">ÈÄâÊã©È∏ΩÂ≠êÊü•ÁúãË°ÄÁªüÊ†ë</option>
        </select>
        <div style="display:flex;align-items:center;gap:8px;">
          <input type="text" id="pedigreeSearchInput" placeholder="ÊêúÁ¥¢Ë∂≥ÁéØÂè∑ÊàñÂêçÂ≠ó..." style="padding:8px 12px;border-radius:6px;border:1px solid #E5E7EB;background:#fff;min-width:200px;font-size:14px;outline:none;" />
          <button class="btn btn-primary btn-sm" id="btnPedigreeSearch">üîç ÊêúÁ¥¢</button>
        </div>
        <button class="btn btn-outline btn-sm" id="btnShowAllBreeders">üìä ÊòæÁ§∫ÊâÄÊúâÁßçÈ∏ΩÊ†ë</button>
        <button class="btn btn-outline btn-sm" id="btnRefreshPedigree">üîÑ Âà∑Êñ∞</button>
      </div>
    </div>
    <div id="pedigreeTreeContainer" class="pedigree-tree-container" style="min-height:500px;padding:20px;background:#fafbfc;border-radius:8px;">
      <p class="muted" style="text-align:center;padding:40px;">ËØ∑‰ªé‰∏äÊñπ‰∏ãÊãâËèúÂçï‰∏≠ÈÄâÊã©‰∏ÄÂè™È∏ΩÂ≠êÔºåÊàñ‰ΩøÁî®ÊêúÁ¥¢ÂäüËÉΩÊü•ÊâæÔºåÊü•ÁúãÂÖ∂ÂÆåÊï¥Ë°ÄÁªüÂÖ≥Á≥ªÊ†ëÔºàÂåÖÊã¨‰∫≤‰ª£ÂíåÂ≠ê‰ª£Ôºâ</p>
    </div>
  </section>

  <!-- Dashboard Êï∞ÊçÆÊ¶ÇËßà -->
  <section id="dashboardView" class="card">
    <div class="card-header">
      <h2>üìä Êï∞ÊçÆÊ¶ÇËßà</h2>
      <span class="muted" style="font-size: 13px;">ÂÆûÊó∂ÁªüËÆ°ÊÇ®ÁöÑ‰ø°È∏ΩÊ°£Ê°àÊï∞ÊçÆ</span>
    </div>
    
    <!-- Ê†∏ÂøÉÊï∞ÊçÆÂç°Áâá -->
    <div class="stats-cards">
      <div class="stat-card">
        <div class="stat-card-label">
          <span style="font-size: 18px;">üìä</span>
          <span>ÊÄªÈ∏ΩÂ≠êÊï∞</span>
        </div>
        <div class="stat-card-number" id="statTotal" style="color:#2563eb;">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">
          <span style="font-size: 18px;">üïäÔ∏è</span>
          <span>Âú®‰∏ñ</span>
        </div>
        <div class="stat-card-number" id="statAlive" style="color:#059669;">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">
          <span style="font-size: 18px;">üíî</span>
          <span>Â∑≤Ê≠ª‰∫°</span>
        </div>
        <div class="stat-card-number" id="statDead" style="color:#4b5563;">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">
          <span style="font-size: 18px;">üèÜ</span>
          <span>ÊúâÊàêÁª©</span>
        </div>
        <div class="stat-card-number" id="statRaced" style="color:#d97706;">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">
          <span style="font-size: 18px;">‚≠ê</span>
          <span>Ê†∏ÂøÉÁßçÈ∏Ω</span>
        </div>
        <div class="stat-card-number" id="statCore" style="color:#7c3aed;">0</div>
      </div>
    </div>
    
    <!-- ÂõæË°®Âå∫Âüü -->
    <div class="card" style="margin-top:24px;">
      <div class="card-header">
        <h2>üìà Âπ¥Â∫¶ÁªüËÆ°</h2>
        <span class="muted" style="font-size: 13px;">ÊåâÂπ¥‰ªΩÊ±áÊÄªÂá∫Áîü„ÄÅÊ≠ª‰∫°ÂèäÂèÇËµõËÆ∞ÂΩï</span>
      </div>
      <div id="chartContainer" style="min-height:300px; padding:24px;">
        <div id="dashboardStatsTableBody">
          <!-- Âπ¥Â∫¶ÁªüËÆ°Êï∞ÊçÆ -->
        </div>
      </div>
    </div>
  </section>

  <!-- ÁªüËÆ°ËßÜÂõæ -->
  <section id="statsView" class="card" style="display:none;">
    <div class="card-header">
      <h2>Âπ¥Â∫¶ÁªüËÆ°Ê¶ÇËßà</h2>
    </div>
    <p class="muted">ÊåâÂπ¥‰ªΩÊ±áÊÄªÔºöÂá∫ÁîüÊï∞Èáè„ÄÅÊ≠ª‰∫°Êï∞Èáè‰ª•ÂèäÊúâÂèÇËµõËÆ∞ÂΩïÁöÑÈ∏ΩÂ≠êÊï∞Èáè„ÄÇ</p>
    <table>
      <thead>
      <tr>
        <th>Âπ¥‰ªΩ</th>
        <th>Âá∫ÁîüÊï∞Èáè</th>
        <th>Ê≠ª‰∫°Êï∞Èáè</th>
        <th>ÊúâÂèÇËµõËÆ∞ÂΩïÁöÑÈ∏ΩÂ≠êÊï∞</th>
      </tr>
      </thead>
      <tbody id="statsViewTableBody">
      </tbody>
    </table>
  </section>

  <!-- ÊØîËµõ‰∏éÊàêÁª©ÁÆ°ÁêÜËßÜÂõæ -->
  <section id="raceView" class="card" style="display:none;">
    <div class="card-header">
      <h2>üèÜ ÊØîËµõ‰∏éÊàêÁª©ÁÆ°ÁêÜ</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn btn-primary btn-sm" id="btnAddRace">‚ûï Êñ∞Â¢ûÊØîËµõ</button>
        <button class="btn btn-outline btn-sm" id="btnImportExcel">üì• ÂØºÂÖ•Excel</button>
        <button class="btn btn-outline btn-sm" id="btnExportData">üì§ ÂØºÂá∫Êï∞ÊçÆ</button>
        <button class="btn btn-outline btn-sm" id="btnRefreshRaces">üîÑ Âà∑Êñ∞</button>
      </div>
    </div>

    <!-- Ê†áÁ≠æÈ°µÂØºËà™ -->
    <div style="border-bottom:2px solid #e5e7eb;margin-bottom:20px;">
      <div style="display:flex;gap:8px;">
        <button class="race-tab-btn active" data-tab="raceList">üìã ÊØîËµõÂàóË°®</button>
        <button class="race-tab-btn" data-tab="raceImport">üì• ÂØºÂÖ•ÊàêÁª©</button>
        <button class="race-tab-btn" data-tab="raceStats">üìä ÊàêÁª©ÁªüËÆ°</button>
        <button class="race-tab-btn" data-tab="raceAnalysis">üìà ÊàêÁª©ÂàÜÊûê</button>
        <button class="race-tab-btn" data-tab="pedigreeComparison">üß¨ Ë°ÄÁªüÂØπÊØî</button>
      </div>
    </div>

    <!-- ÊØîËµõÂàóË°®Ê†áÁ≠æÈ°µ -->
    <div id="raceListTab" class="race-tab-content active">
      <div id="raceListContainer">
        <p class="muted" style="text-align:center;padding:40px;">ÊöÇÊó†ÊØîËµõËÆ∞ÂΩïÔºåÁÇπÂáª"Êñ∞Â¢ûÊØîËµõ"ÂºÄÂßãËÆ∞ÂΩï</p>
      </div>
    </div>

    <!-- ÂØºÂÖ•ÊàêÁª©Ê†áÁ≠æÈ°µ -->
    <div id="raceImportTab" class="race-tab-content">
      <div style="max-width:800px;margin:0 auto;">
        <div class="excel-import-zone" id="excelDropZone">
          <div style="font-size:48px;margin-bottom:16px;">üìä</div>
          <div style="font-size:16px;font-weight:600;color:#1f2937;margin-bottom:8px;">ÊãñÊîæ Excel/CSV Êñá‰ª∂Âà∞Ê≠§Â§Ñ</div>
          <div style="font-size:13px;color:#6b7280;margin-bottom:16px;">ÊàñÁÇπÂáªÈÄâÊã©Êñá‰ª∂</div>
          <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" style="display:none;" />
          <button class="btn btn-primary" id="btnSelectExcel">ÈÄâÊã©Êñá‰ª∂</button>
        </div>

        <div style="margin-top:24px;padding:20px;background:#f9fafb;border-radius:12px;">
          <h4 style="margin:0 0 12px;color:#1f2937;">üìã Êñá‰ª∂Ê†ºÂºèË¶ÅÊ±Ç</h4>
          <div style="font-size:13px;color:#4b5563;line-height:1.8;">
            <p>Excel Êñá‰ª∂Â∫îÂåÖÂê´‰ª•‰∏ãÂàóÔºàË°®Â§¥ÂêçÁß∞ÔºâÔºö</p>
            <ul style="margin:8px 0;padding-left:20px;">
              <li><strong>Ë∂≥ÁéØÂè∑ / ÁéØÂè∑</strong> - È∏ΩÂ≠êÁöÑË∂≥ÁéØÂè∑Á†ÅÔºàÂøÖÈúÄÔºâ</li>
              <li><strong>ÂêçÊ¨° / ÊéíÂêç</strong> - ÊØîËµõÂêçÊ¨°ÔºàÂøÖÈúÄÔºâ</li>
              <li><strong>ÂàÜÈÄü</strong> - ÊØîËµõÂàÜÈÄüÔºàÂèØÈÄâÔºâ</li>
              <li><strong>ÂΩíÂ∑¢Êó∂Èó¥</strong> - ÂΩíÂ∑¢Êó∂Èó¥ÔºàÂèØÈÄâÔºâ</li>
            </ul>
            <p style="color:#6b7280;font-size:12px;">Á≥ªÁªü‰ºöËá™Âä®ËØÜÂà´Ë°®Â§¥Âπ∂ÂåπÈÖçÊï∞ÊçÆ</p>
          </div>
        </div>

        <div id="importPreviewContainer" style="display:none;margin-top:24px;">
          <div class="card-header">
            <h4 style="margin:0;">üìã Êï∞ÊçÆÈ¢ÑËßà</h4>
            <div style="display:flex;gap:8px;">
              <span id="importMatchedCount" style="padding:4px 12px;background:#d1fae5;color:#047857;border-radius:999px;font-size:12px;">Â∑≤ÂåπÈÖç: 0</span>
              <span id="importUnmatchedCount" style="padding:4px 12px;background:#fee2e2;color:#dc2626;border-radius:999px;font-size:12px;">Êú™ÂåπÈÖç: 0</span>
            </div>
          </div>
          <div id="importPreviewTable" style="max-height:400px;overflow-y:auto;margin-top:16px;"></div>
          <div style="margin-top:16px;display:flex;gap:12px;justify-content:flex-end;">
            <button class="btn btn-outline" id="btnCancelImport">ÂèñÊ∂à</button>
            <button class="btn btn-primary" id="btnConfirmImport">Á°ÆËÆ§ÂØºÂÖ•</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ÊàêÁª©ÁªüËÆ°Ê†áÁ≠æÈ°µ -->
    <div id="raceStatsTab" class="race-tab-content">
      <div style="margin-bottom:20px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;">ÈÄâÊã©ÁªüËÆ°Á±ªÂûãÔºö</label>
        <select id="statsTypeSelect" style="padding:8px 12px;border-radius:6px;border:1px solid #E5E7EB;background:#fff;min-width:200px;">
          <option value="single">ÂçïÈ∏ΩÊàêÁª©ÁªüËÆ°</option>
          <option value="bloodline">Ë°ÄÁ≥ªÊàêÁª©ÁªüËÆ°</option>
          <option value="parents">Áà∂ÊØçÂêé‰ª£ÊàêÁª©ÁªüËÆ°</option>
        </select>
        <select id="statsPigeonSelect" style="padding:8px 12px;border-radius:6px;border:1px solid #E5E7EB;background:#fff;min-width:250px;margin-left:12px;">
          <option value="">ÈÄâÊã©È∏ΩÂ≠ê...</option>
        </select>
        <button class="btn btn-primary btn-sm" id="btnGenerateStats" style="margin-left:12px;">ÁîüÊàêÁªüËÆ°</button>
      </div>
      <div id="raceStatsContainer">
        <p class="muted" style="text-align:center;padding:40px;">ËØ∑ÈÄâÊã©ÁªüËÆ°Á±ªÂûãÂíåÈ∏ΩÂ≠êÔºåÁÑ∂ÂêéÁÇπÂáª"ÁîüÊàêÁªüËÆ°"</p>
      </div>
    </div>

    <!-- ÊàêÁª©ÂàÜÊûêÊ†áÁ≠æÈ°µ -->
    <div id="raceAnalysisTab" class="race-tab-content">
      <div id="raceAnalysisContainer">
        <p class="muted" style="text-align:center;padding:40px;">Ê≠£Âú®Âä†ËΩΩÁªºÂêàÂàÜÊûêÊï∞ÊçÆ...</p>
      </div>
    </div>

    <!-- Ë°ÄÁªüÂØπÊØîÊ†áÁ≠æÈ°µ -->
    <div id="pedigreeComparisonTab" class="race-tab-content">
      <div id="pedigreeComparisonContainer">
        <p class="muted" style="text-align:center;padding:40px;">Ë°ÄÁªüÂØπÊØîÂàÜÊûêÂäüËÉΩÂºÄÂèë‰∏≠...</p>
      </div>
    </div>
  </section>

  <!-- Êñ∞Â¢û/ÁºñËæëÊØîËµõÊ®°ÊÄÅÊ°Ü -->
  <div id="raceModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:800px;">
      <div class="modal-header">
        <h3 id="raceModalTitle">Êñ∞Â¢ûÊØîËµõ</h3>
        <button class="modal-close" id="btnCloseRaceModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group">
            <label>Ëµõ‰∫ãÂêçÁß∞<span class="required">*</span></label>
            <input type="text" id="race_name" placeholder="‰æãÂ¶ÇÔºö2024Êò•Â≠£‰ø°È∏ΩÂ§ßËµõ" required />
          </div>
          <div class="form-group">
            <label>ÊØîËµõÊó∂Èó¥<span class="required">*</span></label>
            <input type="date" id="race_date" required />
          </div>
          <div class="form-group">
            <label>ÊØîËµõÂú∞ÁÇπ<span class="required">*</span></label>
            <input type="text" id="race_location" placeholder="‰æãÂ¶ÇÔºöÂåó‰∫¨" required />
          </div>
          <div class="form-group">
            <label>Â§©Ê∞îÊÉÖÂÜµ</label>
            <select id="race_weather">
              <option value="">ËØ∑ÈÄâÊã©</option>
              <option value="Êô¥Â§©">Êô¥Â§©</option>
              <option value="Â§ö‰∫ë">Â§ö‰∫ë</option>
              <option value="Èò¥Â§©">Èò¥Â§©</option>
              <option value="Â∞èÈõ®">Â∞èÈõ®</option>
              <option value="‰∏≠Èõ®">‰∏≠Èõ®</option>
              <option value="Â§ßÈõ®">Â§ßÈõ®</option>
              <option value="Èõæ">Èõæ</option>
              <option value="Â§ßÈ£é">Â§ßÈ£é</option>
            </select>
          </div>
        </div>
        
        <div class="section-title" style="margin-top:24px;">ÂèÇËµõÈ∏ΩÂèäÊàêÁª©</div>
        <div id="raceParticipantsContainer">
          <div class="participant-item" style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:12px;align-items:center;padding:12px;background:#f9fafb;border-radius:8px;margin-bottom:12px;">
            <select class="participant-pigeon" style="padding:8px;border-radius:6px;border:1px solid #E5E7EB;">
              <option value="">ÈÄâÊã©È∏ΩÂ≠ê...</option>
            </select>
            <input type="number" class="participant-rank" placeholder="ÂêçÊ¨°" min="1" style="padding:8px;border-radius:6px;border:1px solid #E5E7EB;" />
            <input type="number" class="participant-score" placeholder="ÂàÜÊï∞" step="0.01" style="padding:8px;border-radius:6px;border:1px solid #E5E7EB;" />
            <input type="time" class="participant-time" placeholder="ÂΩíÂ∑¢Êó∂Èó¥" style="padding:8px;border-radius:6px;border:1px solid #E5E7EB;" />
            <button class="btn btn-outline btn-sm remove-participant" style="padding:6px 12px;">Âà†Èô§</button>
          </div>
        </div>
        <button class="btn btn-outline btn-sm" id="btnAddParticipant" style="margin-top:12px;">‚ûï Ê∑ªÂä†ÂèÇËµõÈ∏Ω</button>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="btnCancelRace">ÂèñÊ∂à</button>
        <button class="btn btn-primary" id="btnSaveRace">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- üß¨ ÁπÅËÇ≤‰∏éÈÖçÂØπÁÆ°ÁêÜÊ®°Âùó -->
  <section id="breedingView" class="card" style="display:none;">
    <div class="card-header">
      <h2>üß¨ ÁπÅËÇ≤‰∏éÈÖçÂØπÁÆ°ÁêÜ</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn btn-primary btn-sm" id="btnNewPairing">üíï Êñ∞Âª∫ÈÖçÂØπ</button>
        <button class="btn btn-outline btn-sm" id="btnViewPairingHistory">üìã ÈÖçÂØπÂéÜÂè≤</button>
        <button class="btn btn-outline btn-sm" id="btnRefreshBreeding">üîÑ Âà∑Êñ∞</button>
      </div>
    </div>

    <!-- ÈÖçÂØπÈù¢Êùø -->
    <div class="breeding-panel">
      <div class="breeding-selector-row" style="display:grid;grid-template-columns:1fr auto 1fr;gap:24px;align-items:start;margin-bottom:24px;">
        <!-- ÂÖ¨È∏ΩÈÄâÊã© -->
        <div class="breeding-pigeon-card male-card" style="background:linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);border:2px solid #3b82f6;border-radius:16px;padding:24px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
            <span style="font-size:32px;">‚ôÇ</span>
            <div>
              <h3 style="margin:0;color:#1e40af;font-size:18px;">ÈÄâÊã©ÂÖ¨È∏Ω</h3>
              <span style="color:#6b7280;font-size:13px;">Father</span>
            </div>
          </div>
          <select id="breedingMaleSelect" style="width:100%;padding:12px;border-radius:8px;border:2px solid #93c5fd;font-size:14px;background:#fff;">
            <option value="">ËØ∑ÈÄâÊã©ÂÖ¨È∏Ω...</option>
          </select>
          <div id="breedingMaleInfo" style="margin-top:16px;min-height:150px;">
            <p class="muted" style="text-align:center;padding:20px;">ÈÄâÊã©ÂÖ¨È∏ΩÂêéÊòæÁ§∫ËØ¶ÊÉÖ</p>
          </div>
        </div>

        <!-- ÈÖçÂØπËØÑ‰º∞‰∏≠ÂøÉ -->
        <div class="breeding-assessment" style="background:linear-gradient(135deg, #fdf4ff 0%, #faf5ff 100%);border:2px solid #a855f7;border-radius:16px;padding:24px;min-width:300px;">
          <div style="text-align:center;margin-bottom:20px;">
            <span style="font-size:48px;">üíë</span>
            <h3 style="margin:8px 0 0;color:#7e22ce;font-size:18px;">ÈÖçÂØπËØÑ‰º∞</h3>
          </div>
          <div id="breedingAssessment" style="min-height:200px;">
            <div style="text-align:center;padding:40px 20px;color:#9ca3af;">
              <div style="font-size:32px;margin-bottom:12px;">üîÆ</div>
              <p>ËØ∑ÂÖàÈÄâÊã©ÂÖ¨È∏ΩÂíåÊØçÈ∏Ω</p>
              <p style="font-size:12px;">Á≥ªÁªüÂ∞ÜËá™Âä®ÂàÜÊûêËøë‰∫≤È£éÈô©‰∏éÈÖçÂØπÂª∫ËÆÆ</p>
            </div>
          </div>
          <button class="btn btn-primary" id="btnConfirmPairing" style="width:100%;margin-top:16px;padding:14px;font-size:15px;" disabled>‚úÖ Á°ÆËÆ§ÈÖçÂØπ</button>
        </div>

        <!-- ÊØçÈ∏ΩÈÄâÊã© -->
        <div class="breeding-pigeon-card female-card" style="background:linear-gradient(135deg, #fce7f3 0%, #fdf2f8 100%);border:2px solid #ec4899;border-radius:16px;padding:24px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
            <span style="font-size:32px;">‚ôÄ</span>
            <div>
              <h3 style="margin:0;color:#be185d;font-size:18px;">ÈÄâÊã©ÊØçÈ∏Ω</h3>
              <span style="color:#6b7280;font-size:13px;">Mother</span>
            </div>
          </div>
          <select id="breedingFemaleSelect" style="width:100%;padding:12px;border-radius:8px;border:2px solid #f9a8d4;font-size:14px;background:#fff;">
            <option value="">ËØ∑ÈÄâÊã©ÊØçÈ∏Ω...</option>
          </select>
          <div id="breedingFemaleInfo" style="margin-top:16px;min-height:150px;">
            <p class="muted" style="text-align:center;padding:20px;">ÈÄâÊã©ÊØçÈ∏ΩÂêéÊòæÁ§∫ËØ¶ÊÉÖ</p>
          </div>
        </div>
      </div>

      <!-- ÂéÜÂè≤ÈÖçÂØπÊàêÂäüÊ°à‰æã -->
      <div class="breeding-history-section" style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-top:24px;">
        <h4 style="margin:0 0 16px;color:#1f2937;display:flex;align-items:center;gap:8px;">
          <span>üìä</span> ÂéÜÂè≤ÈÖçÂØπ‰∏éÂêé‰ª£Ë°®Áé∞
        </h4>
        <div id="breedingHistoryContainer">
          <p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÈÖçÂØπÂéÜÂè≤ËÆ∞ÂΩï</p>
        </div>
      </div>
    </div>
  </section>

  <!-- ü©∫ ÂÅ•Â∫∑‰∏éÁî®ËçØÁÆ°ÁêÜÊ®°Âùó -->
  <section id="healthView" class="card" style="display:none;">
    <div class="card-header">
      <h2>ü©∫ ÂÅ•Â∫∑‰∏éÁî®ËçØÁÆ°ÁêÜ</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn btn-primary btn-sm" id="btnAddHealthRecord">üíâ Ê∑ªÂä†ËÆ∞ÂΩï</button>
        <button class="btn btn-outline btn-sm" id="btnHealthCalendar">üìÖ ÊèêÈÜíÊó•ÂéÜ</button>
        <button class="btn btn-outline btn-sm" id="btnRefreshHealth">üîÑ Âà∑Êñ∞</button>
      </div>
    </div>

    <!-- ÂÅ•Â∫∑Áä∂ÊÄÅÊ¶ÇËßà -->
    <div class="health-overview" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:16px;margin-bottom:24px;">
      <div style="background:linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);padding:20px;border-radius:12px;border:1px solid #10b981;">
        <div style="font-size:28px;">‚úÖ</div>
        <div style="font-size:13px;color:#047857;margin-top:8px;">ÂÅ•Â∫∑Áä∂ÊÄÅ</div>
        <div id="healthyCount" style="font-size:32px;font-weight:700;color:#047857;">0</div>
      </div>
      <div style="background:linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);padding:20px;border-radius:12px;border:1px solid #f59e0b;">
        <div style="font-size:28px;">‚è∞</div>
        <div style="font-size:13px;color:#b45309;margin-top:8px;">Âç≥Â∞ÜÂà∞Êúü</div>
        <div id="upcomingCount" style="font-size:32px;font-weight:700;color:#b45309;">0</div>
      </div>
      <div style="background:linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);padding:20px;border-radius:12px;border:1px solid #ef4444;">
        <div style="font-size:28px;">üè•</div>
        <div style="font-size:13px;color:#dc2626;margin-top:8px;">ÈúÄË¶ÅÂÖ≥Ê≥®</div>
        <div id="needAttentionCount" style="font-size:32px;font-weight:700;color:#dc2626;">0</div>
      </div>
      <div style="background:linear-gradient(135deg, #e0e7ff 0%, #eef2ff 100%);padding:20px;border-radius:12px;border:1px solid #6366f1;">
        <div style="font-size:28px;">üíä</div>
        <div style="font-size:13px;color:#4338ca;margin-top:8px;">Áî®ËçØ‰∏≠</div>
        <div id="medicatingCount" style="font-size:32px;font-weight:700;color:#4338ca;">0</div>
      </div>
    </div>

    <!-- ÂÅ•Â∫∑ÊèêÈÜíÂàóË°® -->
    <div class="health-alerts" style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:24px;">
      <h4 style="margin:0 0 16px;color:#1f2937;display:flex;align-items:center;gap:8px;">
        <span>üîî</span> ÂÅ•Â∫∑ÊèêÈÜí
      </h4>
      <div id="healthAlertsContainer">
        <p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÂÅ•Â∫∑ÊèêÈÜí</p>
      </div>
    </div>

    <!-- È∏ΩÂ≠êÂÅ•Â∫∑Êó∂Èó¥ËΩ¥ -->
    <div class="health-timeline" style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h4 style="margin:0;color:#1f2937;display:flex;align-items:center;gap:8px;">
          <span>üìã</span> ÂÅ•Â∫∑ËÆ∞ÂΩïÊó∂Èó¥ËΩ¥
        </h4>
        <select id="healthPigeonSelect" style="padding:8px 12px;border-radius:6px;border:1px solid #E5E7EB;min-width:200px;">
          <option value="">ÈÄâÊã©È∏ΩÂ≠êÊü•ÁúãËÆ∞ÂΩï...</option>
        </select>
      </div>
      <div id="healthTimelineContainer">
        <p class="muted" style="text-align:center;padding:40px;">ÈÄâÊã©È∏ΩÂ≠êÂêéÊòæÁ§∫ÂÅ•Â∫∑Êó∂Èó¥ËΩ¥</p>
      </div>
    </div>
  </section>

  <!-- ÂÅ•Â∫∑ËÆ∞ÂΩïÊ∑ªÂä†Ê®°ÊÄÅÊ°Ü -->
  <div id="healthModal" class="race-modal" style="display:none;">
    <div class="modal-content" style="max-width:600px;">
      <div class="modal-header">
        <h3 id="healthModalTitle">Ê∑ªÂä†ÂÅ•Â∫∑ËÆ∞ÂΩï</h3>
        <button class="btn btn-ghost btn-sm" id="btnCloseHealthModal">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group">
            <label>ÈÄâÊã©È∏ΩÂ≠ê<span class="required">*</span></label>
            <select id="healthRecordPigeon" style="padding:8px;border-radius:6px;border:1px solid #E5E7EB;">
              <option value="">ÈÄâÊã©È∏ΩÂ≠ê...</option>
            </select>
          </div>
          <div class="form-group">
            <label>ËÆ∞ÂΩïÁ±ªÂûã<span class="required">*</span></label>
            <select id="healthRecordType" style="padding:8px;border-radius:6px;border:1px solid #E5E7EB;">
              <option value="">ÈÄâÊã©Á±ªÂûã...</option>
              <option value="Áñ´Ëãó">üíâ Áñ´ËãóÊé•Áßç</option>
              <option value="È©±Ëô´">üêõ È©±Ëô´</option>
              <option value="‰ΩìÊ£Ä">üî¨ ‰ΩìÊ£Ä</option>
              <option value="ÁñæÁóÖ">üè• ÁñæÁóÖËÆ∞ÂΩï</option>
              <option value="Áî®ËçØ">üíä Áî®ËçØËÆ∞ÂΩï</option>
              <option value="Â∫∑Â§ç">‚úÖ Â∫∑Â§çËÆ∞ÂΩï</option>
              <option value="ÂÖ∂‰ªñ">üìù ÂÖ∂‰ªñ</option>
            </select>
          </div>
          <div class="form-group">
            <label>Êó•Êúü<span class="required">*</span></label>
            <input type="date" id="healthRecordDate" style="padding:8px;border-radius:6px;border:1px solid #E5E7EB;" />
          </div>
          <div class="form-group">
            <label>‰∏ãÊ¨°ÊèêÈÜíÊó•Êúü</label>
            <input type="date" id="healthRecordNextDate" style="padding:8px;border-radius:6px;border:1px solid #E5E7EB;" />
          </div>
        </div>
        <div class="form-group" style="margin-top:12px;">
          <label>ËØ¶ÁªÜÊèèËø∞</label>
          <textarea id="healthRecordDescription" rows="4" style="width:100%;padding:8px;border-radius:6px;border:1px solid #E5E7EB;resize:vertical;" placeholder="ËÆ∞ÂΩïËØ¶ÁªÜÊÉÖÂÜµÔºåÂ¶ÇÔºöÁñ´ËãóÂêçÁß∞„ÄÅÂâÇÈáè„ÄÅËçØÁâ©ÂêçÁß∞„ÄÅÁóáÁä∂Á≠â"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="btnCancelHealth">ÂèñÊ∂à</button>
        <button class="btn btn-primary" id="btnSaveHealth">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- üß† Êô∫ËÉΩÂàÜÊûê‰∏≠ÂøÉÊ®°Âùó -->
  <section id="analysisView" class="card" style="display:none;">
    <div class="card-header">
      <h2>üß† Êô∫ËÉΩÂàÜÊûê‰∏≠ÂøÉ</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn btn-primary btn-sm" id="btnRunAnalysis">üöÄ ËøêË°åÂÖ®Èù¢ÂàÜÊûê</button>
        <button class="btn btn-outline btn-sm" id="btnExportReport">üì§ ÂØºÂá∫Êä•Âëä</button>
        <button class="btn btn-outline btn-sm" id="btnRefreshAnalysis">üîÑ Âà∑Êñ∞</button>
      </div>
    </div>

    <!-- Êô∫ËÉΩÊ¥ûÂØüÂç°Áâá -->
    <div class="insight-cards" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px;margin-bottom:24px;">
      <!-- ‰ªäÂπ¥ÊúÄÊàêÂäüÁöÑË°ÄÁ≥ª -->
      <div class="insight-card" style="background:linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);padding:24px;border-radius:16px;border:2px solid #f59e0b;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
          <span style="font-size:32px;">üèÜ</span>
          <h4 style="margin:0;color:#92400e;">‰ªäÂπ¥ÊúÄÊàêÂäüË°ÄÁ≥ª</h4>
        </div>
        <div id="topBloodlineCard">
          <p class="muted">ÂàÜÊûê‰∏≠...</p>
        </div>
      </div>

      <!-- ÊúÄÂº∫ÁßçÂÖ¨ -->
      <div class="insight-card" style="background:linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);padding:24px;border-radius:16px;border:2px solid #3b82f6;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
          <span style="font-size:32px;">‚ôÇ</span>
          <h4 style="margin:0;color:#1e40af;">ÊúÄÂº∫ÁßçÂÖ¨</h4>
        </div>
        <div id="topMaleCard">
          <p class="muted">ÂàÜÊûê‰∏≠...</p>
        </div>
      </div>

      <!-- ÊúÄÂº∫ÁßçÊØç -->
      <div class="insight-card" style="background:linear-gradient(135deg, #fce7f3 0%, #fdf2f8 100%);padding:24px;border-radius:16px;border:2px solid #ec4899;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
          <span style="font-size:32px;">‚ôÄ</span>
          <h4 style="margin:0;color:#be185d;">ÊúÄÂº∫ÁßçÊØç</h4>
        </div>
        <div id="topFemaleCard">
          <p class="muted">ÂàÜÊûê‰∏≠...</p>
        </div>
      </div>

      <!-- Êé®ËçêÈÖçÂØπ -->
      <div class="insight-card" style="background:linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);padding:24px;border-radius:16px;border:2px solid #10b981;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
          <span style="font-size:32px;">üíï</span>
          <h4 style="margin:0;color:#047857;">Êô∫ËÉΩÊé®ËçêÈÖçÂØπ</h4>
        </div>
        <div id="recommendedPairingCard">
          <p class="muted">ÂàÜÊûê‰∏≠...</p>
        </div>
      </div>
    </div>

    <!-- È∏ΩÂ≠êÊΩúÂäõÊéíË°åÊ¶ú -->
    <div class="potential-ranking" style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:24px;">
      <h4 style="margin:0 0 16px;color:#1f2937;display:flex;align-items:center;gap:8px;">
        <span>‚≠ê</span> È∏ΩÂ≠êÊΩúÂäõÊéíË°åÊ¶ú
      </h4>
      <div id="potentialRankingContainer">
        <p class="muted" style="text-align:center;padding:20px;">Ê≠£Âú®ËÆ°ÁÆóÊΩúÂäõËØÑÂàÜ...</p>
      </div>
    </div>

    <!-- Â§±Ë¥•ÈÖçÂØπÂàÜÊûê -->
    <div class="failed-pairings" style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:24px;">
      <h4 style="margin:0 0 16px;color:#1f2937;display:flex;align-items:center;gap:8px;">
        <span>‚ö†Ô∏è</span> Â§±Ë¥•ÈÖçÂØπÊéíË°åÊ¶ú
      </h4>
      <div id="failedPairingsContainer">
        <p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÈÖçÂØπËÆ∞ÂΩï</p>
      </div>
    </div>

    <!-- ÁªºÂêàÂàÜÊûêÁªìËÆ∫ -->
    <div class="analysis-conclusion" style="background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);border-radius:12px;padding:24px;border:2px solid #0ea5e9;">
      <h4 style="margin:0 0 16px;color:#0369a1;display:flex;align-items:center;gap:8px;">
        <span>üí°</span> Êô∫ËÉΩÂàÜÊûêÁªìËÆ∫‰∏éÂª∫ËÆÆ
      </h4>
      <div id="analysisConclusion">
        <p class="muted">ÁÇπÂáª"ËøêË°åÂÖ®Èù¢ÂàÜÊûê"ÁîüÊàêÊô∫ËÉΩÂàÜÊûêÊä•Âëä</p>
      </div>
    </div>
  </section>

  <!-- ÈÖçÂØπÊ®°ÊÄÅÊ°Ü -->
  <div id="pairingModal" class="race-modal" style="display:none;">
    <div class="modal-content" style="max-width:500px;">
      <div class="modal-header">
        <h3>Á°ÆËÆ§ÈÖçÂØπ</h3>
        <button class="btn btn-ghost btn-sm" id="btnClosePairingModal">‚úï</button>
      </div>
      <div class="modal-body">
        <div id="pairingConfirmContent">
          <!-- ÈÖçÂØπÁ°ÆËÆ§ÂÜÖÂÆπ -->
        </div>
        <div class="form-group" style="margin-top:16px;">
          <label>ÈÖçÂØπÊó•Êúü<span class="required">*</span></label>
          <input type="date" id="pairingDate" style="width:100%;padding:8px;border-radius:6px;border:1px solid #E5E7EB;" />
        </div>
        <div class="form-group" style="margin-top:12px;">
          <label>Â§áÊ≥®</label>
          <textarea id="pairingNote" rows="3" style="width:100%;padding:8px;border-radius:6px;border:1px solid #E5E7EB;resize:vertical;" placeholder="ÂèØÈÄâÔºöËÆ∞ÂΩïÈÖçÂØπÂéüÂõ†„ÄÅÈ¢ÑÊúüÁ≠â"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="btnCancelPairing">ÂèñÊ∂à</button>
        <button class="btn btn-primary" id="btnSavePairing">Á°ÆËÆ§ÈÖçÂØπ</button>
      </div>
    </div>
  </div>

  <!-- Êñ∞Â¢ûËßÜÂõæ -->
  <section id="createView" class="card" style="display:none;">
    <div class="card-header">
      <h2>Êñ∞Â¢ûÈ∏ΩÂ≠ê‰ø°ÊÅØ</h2>
      <div class="muted">È¶ñÊ¨°ÂΩïÂÖ•‰∏ÄÂè™È∏ΩÂ≠êÁöÑÂÆåÊï¥Ê°£Ê°à„ÄÇ</div>
    </div>

    <div class="section-title">Âü∫Êú¨‰ø°ÊÅØ</div>
    <div class="section-desc">ÂÉèÂ°´ÂÜôË°®Ê†º‰∏ÄÊ†∑ÁÆÄÂçïÔºåË∂≥ÁéØÂè∑ÂøÖÈ°ªÂîØ‰∏Ä„ÄÇ</div>
    <div class="form-grid">
      <div class="form-group">
        <label>È∏ΩÂ≠êÂêçÁß∞</label>
        <input id="c_name" type="text" placeholder="ÂèØÈÄâÔºå‰æãÂ¶ÇÔºöÈ£ûÂ§©001" />
      </div>
      <div class="form-group">
        <label>Ë∂≥ÁéØÂè∑Á†Å<span class="required">*</span></label>
        <input id="c_ring" type="text" placeholder="ÂøÖÂ°´ÔºåÂîØ‰∏ÄÔºåÂ¶ÇÔºöCHN2025-0001" />
      </div>
      <div class="form-group">
        <label>ÊÄßÂà´</label>
        <select id="c_gender">
          <option value="">Êú™ÈÄâÊã©</option>
          <option value="ÂÖ¨">ÂÖ¨</option>
          <option value="ÊØç">ÊØç</option>
          <option value="Êú™Áü•">Êú™Áü•</option>
        </select>
      </div>
      <div class="form-group">
        <label>ÁæΩËâ≤</label>
        <input id="c_color" type="text" placeholder="Â¶ÇÔºöÁÅ∞„ÄÅÈõ®ÁÇπ„ÄÅÁôΩÊù°‚Ä¶" />
      </div>
      <div class="form-group">
        <label>Âá∫ÁîüÊó•Êúü</label>
        <input id="c_birth" type="date" />
      </div>
      <div class="form-group">
        <label>È∏ΩÂ≠êÁ±ªÂûã</label>
        <select id="c_type">
          <option value="">Êú™ÈÄâÊã©</option>
          <option value="ÁßçÈ∏Ω">ÁßçÈ∏Ω</option>
          <option value="ÊØîËµõÈ∏Ω">ÊØîËµõÈ∏Ω</option>
          <option value="Âêé‰ª£È∏Ω">Âêé‰ª£È∏Ω</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ê†∏ÂøÉÁßçÈ∏Ω</label>
        <div class="radio-group">
          <label><input type="checkbox" id="c_core" /> Ê†áËÆ∞‰∏∫Ê†∏ÂøÉÁßçÈ∏Ω ‚≠ê</label>
        </div>
      </div>
    </div>

    <!-- ÁßçÈ∏Ω‰∏ìÁî®‰ø°ÊÅØÔºöÂâçÈ∏Ω‰∏ªÂíåÂâçÂú∞Âå∫ -->
    <div id="c_breederExtra" class="section-title" style="display:none;">ÁßçÈ∏Ω‰ø°ÊÅØ</div>
    <div id="c_breederExtraDesc" class="section-desc" style="display:none;">ÁßçÈ∏ΩÈúÄË¶ÅËÆ∞ÂΩïÂâçÈ∏Ω‰∏ªÂíåÂâçÂú∞Âå∫‰ø°ÊÅØ</div>
    <div id="c_breederExtraFields" class="form-grid" style="display:none;">
      <div class="form-group">
        <label>ÂâçÈ∏Ω‰∏ªÔºàÂèØÈÄâÔºâ</label>
        <input id="c_previousOwner" type="text" placeholder="Â¶ÇÔºöÂº†‰∏â" />
      </div>
      <div class="form-group">
        <label>ÂâçÂú∞Âå∫ÔºàÂèØÈÄâÔºâ</label>
        <input id="c_previousRegion" type="text" placeholder="Â¶ÇÔºöÂåó‰∫¨" />
      </div>
    </div>

    <!-- Áé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫ÔºàÊâÄÊúâÈ∏ΩÂ≠êÈÉΩÊúâÔºâ -->
    <div class="section-title">È∏Ω‰∏ª‰ø°ÊÅØ</div>
    <div class="section-desc">ËÆ∞ÂΩïÂΩìÂâçÈ∏Ω‰∏ªÂíåÊâÄÂú®Âú∞Âå∫</div>
    <div class="form-grid">
      <div class="form-group">
        <label>Áé∞È∏Ω‰∏ª</label>
        <div style="position:relative;">
          <input id="c_currentOwner" type="text" placeholder="Â¶ÇÔºöÊùéÂõΩËæâ" list="c_ownerList" style="width:100%;" />
          <datalist id="c_ownerList"></datalist>
        </div>
        <span class="muted" style="font-size:12px;">ËæìÂÖ•Êàñ‰ªé‰∏ãÊãâÈÄâÊã©</span>
      </div>
      <div class="form-group">
        <label>Áé∞Âú∞Âå∫</label>
        <input id="c_currentRegion" type="text" placeholder="Â¶ÇÔºöË¥µÂ∑ûÈªîË•ø" list="c_regionList" />
        <datalist id="c_regionList"></datalist>
        <span class="muted" style="font-size:12px;">ËæìÂÖ•Êàñ‰ªé‰∏ãÊãâÈÄâÊã©</span>
      </div>
    </div>

    <div class="section-title">Ë°ÄÁªü‰ø°ÊÅØ</div>
    <div class="section-desc">Áà∂È∏Ω / ÊØçÈ∏ΩÂèØ‰ªéÂ∑≤ÂΩïÂÖ•ÁöÑÈ∏ΩÂ≠ê‰∏≠ÈÄâÊã©Ôºå‰πüÂèØ‰ª•ÊöÇÊó∂ÁïôÁ©∫ÔºåÂêéÁª≠ÂÜçË°•ÂÖÖ„ÄÇ</div>
    <div class="form-grid">
      <div class="form-group">
        <label>Áà∂È∏ΩÔºàÂèØÈÄâÔºâ</label>
        <select id="c_father"></select>
      </div>
      <div class="form-group">
        <label>ÊØçÈ∏ΩÔºàÂèØÈÄâÔºâ</label>
        <select id="c_mother"></select>
      </div>
    </div>

    <div class="section-title">ÂèÇËµõ‰ø°ÊÅØÔºàÂèØÊ∑ªÂä†Â§öÊù°Ôºâ</div>
    <div class="section-desc">ÊØèÊ¨°ÊØîËµõÂçïÁã¨‰∏ÄÊù°ËÆ∞ÂΩïÔºåÊñπ‰æøÊó•ÂêéÁªüËÆ°ÂíåÊü•Áúã„ÄÇ</div>
    <div id="c_raceList" class="race-list"></div>
    <button class="btn btn-outline btn-sm" id="btnAddRaceCreate">‚ûï Ê∑ªÂä†‰∏ÄÊù°ÂèÇËµõËÆ∞ÂΩï</button>

    <div class="section-title">È∏ΩÂ≠êÁä∂ÊÄÅ</div>
    <div class="section-desc">Ê≠ª‰∫°Âè™ÊîπÂèòÁä∂ÊÄÅÔºå‰∏ç‰ºöÂà†Èô§‰ªª‰ΩïÂéÜÂè≤ÊàêÁª©„ÄÇ</div>
    <div class="form-grid">
      <div class="form-group">
        <label>ÂΩìÂâçÁä∂ÊÄÅ</label>
        <div class="radio-group">
          <label><input type="radio" name="c_alive" value="alive" checked /> Âú®‰∏ñ</label>
          <label><input type="radio" name="c_alive" value="dead" /> Â∑≤Ê≠ª‰∫°</label>
        </div>
      </div>
      <div class="form-group c-death-extra" style="display:none;">
        <label>Ê≠ª‰∫°Êó•Êúü<span class="required">*</span></label>
        <input id="c_death_date" type="date" />
      </div>
      <div class="form-group c-death-extra" style="display:none;">
        <label>Ê≠ª‰∫°ÂéüÂõ†ÔºàÂèØÈÄâÔºâ</label>
        <input id="c_death_reason" type="text" placeholder="Â¶ÇÔºöÁñæÁóÖ„ÄÅÊÑèÂ§ñ‚Ä¶" />
      </div>
    </div>

    <div class="section-title">ÂõæÁâá‰∏ä‰º†</div>
    <div class="section-desc">ÂèØ‰∏∫ÊØèÂè™È∏ΩÂ≠ê‰∏ä‰º†‰∏§Âº†ÂõæÁâáÔºö‰∏ÄÂº†Á´ôÁ´ã‰æßË∫´ÁÖß„ÄÅ‰∏ÄÂº†ÁúºÁùõÁâπÂÜôÔºõËã•‰∏ç‰∏ä‰º†ÔºåÂ∞Ü‰ΩøÁî®Á§∫‰æãÂõæÁâáÔºàIMG_6540.jpg ‰∏∫Á´ôÁ´ã‰æßË∫´ÂõæÔºåIMG_6539.jpg ‰∏∫ÁúºÈÉ®ÁâπÂÜôÔºâ„ÄÇ</div>
    <div class="form-grid">
      <div class="form-group">
        <label>Á´ôÁ´ã‰æßË∫´ÂõæÁâá</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="c_body_photo" type="file" accept="image/*" style="flex:1;" />
          <input id="c_body_photo_camera" type="file" accept="image/*" capture style="display:none;" />
          <button type="button" class="btn btn-outline btn-sm" id="btnCameraBodyCreate" style="white-space:nowrap;">üì∑ ÊãçÁÖß</button>
        </div>
        <span class="muted">ÊîØÊåÅÂ∏∏ËßÅÂõæÁâáÊ†ºÂºèÔºàJPG„ÄÅPNG„ÄÅGIF„ÄÅWEBPÁ≠âÔºâÔºåÊó†ÂàÜËæ®ÁéáÈôêÂà∂„ÄÇÂèØ‰∏ä‰º†ÂõæÁâáÊàñÁõ¥Êé•ÊãçÁÖß„ÄÇ</span>
      </div>
      <div class="form-group">
        <label>ÁúºÁùõÁâπÂÜôÂõæÁâá</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="c_eye_photo" type="file" accept="image/*" style="flex:1;" />
          <input id="c_eye_photo_camera" type="file" accept="image/*" capture style="display:none;" />
          <button type="button" class="btn btn-outline btn-sm" id="btnCameraEyeCreate" style="white-space:nowrap;">üì∑ ÊãçÁÖß</button>
        </div>
        <span class="muted">ÊîØÊåÅÂ∏∏ËßÅÂõæÁâáÊ†ºÂºèÔºàJPG„ÄÅPNG„ÄÅGIF„ÄÅWEBPÁ≠âÔºâÔºåÊó†ÂàÜËæ®ÁéáÈôêÂà∂„ÄÇÂèØ‰∏ä‰º†ÂõæÁâáÊàñÁõ¥Êé•ÊãçÁÖß„ÄÇ</span>
      </div>
    </div>

    <div style="margin-top:16px; display:flex; justify-content:flex-end; gap:8px;">
      <button class="btn btn-ghost" id="btnCancelCreate">‚ùå ÂèñÊ∂à</button>
      <button class="btn btn-primary" id="btnSaveCreate">üíæ ‰øùÂ≠ò</button>
    </div>
  </section>

  <!-- ËØ¶ÊÉÖËßÜÂõæ -->
  <section id="detailView" class="card" style="display:none;">
    <div class="flex-between">
      <div>
        <h2 id="d_title" style="margin:0 0 4px;"></h2>
        <div class="muted" id="d_subtitle"></div>
      </div>
      <div>
        <button class="btn btn-outline btn-sm" id="btnBackList">‚Üê ËøîÂõûÂàóË°®</button>
        <button class="btn btn-danger btn-sm" id="btnDeletePigeon" style="margin-left:8px;">üóë Âà†Èô§</button>
        <button class="btn btn-primary btn-sm" id="btnToggleEdit" style="margin-left:8px;">‚úè ÁºñËæë‰ø°ÊÅØ</button>
      </div>
    </div>
    <div id="d_statusRow" style="margin-top:8px; font-size:13px;"></div>

    <div class="notice" id="d_editNotice" style="display:none; margin-top:12px;">
      ÂΩìÂâç‰∏∫ÁºñËæëÊ®°Âºè„ÄÇ‰øÆÊîπÂêéÁÇπÂáªÂè≥‰∏ãËßí„Äå‰øùÂ≠ò„ÄçÂç≥ÂèØÁ´ãÂç≥ÁîüÊïàÔºõÁ¶ªÂºÄÂâçÊú™‰øùÂ≠ò‰ºö‰∏¢Â§±„ÄÇ
    </div>

    <div style="margin-top:16px;">
      <!-- ÊµèËßàÊ®°ÂºèÂÆπÂô® -->
      <div id="browseMode">
        <!-- ÂõæÁâáÂå∫ÂüüÔºö‰∏ªË¶ÅÂÜÖÂÆπÔºåÊîæÂú®ÊúÄÂâçÈù¢ -->
        <div id="d_images" style="margin-bottom:24px;"></div>

        <div class="section-title">Âü∫Êú¨‰ø°ÊÅØ</div>
        <div id="d_basic"></div>

        <div class="section-title">Ë°ÄÁªü‰ø°ÊÅØ</div>
        <div id="d_pedigree"></div>

        <div class="section-title">Ë°ÄÁªüÊ†ëÂèØËßÜÂåñ</div>
        <div id="d_pedigreeTree" style="margin-top:8px;"></div>

        <div class="section-title">ÂèÇËµõËÆ∞ÂΩï</div>
        <div id="d_races"></div>
      </div>

      <!-- ÁºñËæëÊ®°ÂºèË°®ÂçïÔºà‰∏éÊñ∞Â¢ûÁ±ª‰ººÔºâ -->
      <div id="editMode" style="display:none;">
        <div class="section-title">Âü∫Êú¨‰ø°ÊÅØ</div>
        <div class="form-grid">
          <div class="form-group">
            <label>È∏ΩÂ≠êÂêçÁß∞</label>
            <input id="e_name" type="text" />
          </div>
          <div class="form-group">
            <label>Ë∂≥ÁéØÂè∑Á†Å<span class="required">*</span></label>
            <input id="e_ring" type="text" disabled />
            <span class="muted">‰Ωú‰∏∫ÂîØ‰∏ÄÊ†áËØÜÔºåÈÄöÂ∏∏‰∏çÂÖÅËÆ∏‰øÆÊîπ„ÄÇ</span>
          </div>
          <div class="form-group">
            <label>ÊÄßÂà´</label>
            <select id="e_gender">
              <option value="">Êú™ÈÄâÊã©</option>
              <option value="ÂÖ¨">ÂÖ¨</option>
              <option value="ÊØç">ÊØç</option>
              <option value="Êú™Áü•">Êú™Áü•</option>
            </select>
          </div>
          <div class="form-group">
            <label>ÁæΩËâ≤</label>
            <input id="e_color" type="text" />
          </div>
          <div class="form-group">
            <label>Âá∫ÁîüÊó•Êúü</label>
            <input id="e_birth" type="date" />
          </div>
          <div class="form-group">
            <label>È∏ΩÂ≠êÁ±ªÂûã</label>
            <select id="e_type">
              <option value="">Êú™ÈÄâÊã©</option>
              <option value="ÁßçÈ∏Ω">ÁßçÈ∏Ω</option>
              <option value="ÊØîËµõÈ∏Ω">ÊØîËµõÈ∏Ω</option>
              <option value="Âêé‰ª£È∏Ω">Âêé‰ª£È∏Ω</option>
            </select>
          </div>
          <div class="form-group">
            <label>Ê†∏ÂøÉÁßçÈ∏Ω</label>
            <div class="radio-group">
              <label><input type="checkbox" id="e_core" /> Ê†áËÆ∞‰∏∫Ê†∏ÂøÉÁßçÈ∏Ω ‚≠ê</label>
            </div>
          </div>
        </div>

        <!-- ÁßçÈ∏Ω‰∏ìÁî®‰ø°ÊÅØÔºöÂâçÈ∏Ω‰∏ªÂíåÂâçÂú∞Âå∫ -->
        <div id="e_breederExtra" class="section-title" style="display:none;">ÁßçÈ∏Ω‰ø°ÊÅØ</div>
        <div id="e_breederExtraDesc" class="section-desc" style="display:none;">ÁßçÈ∏ΩÈúÄË¶ÅËÆ∞ÂΩïÂâçÈ∏Ω‰∏ªÂíåÂâçÂú∞Âå∫‰ø°ÊÅØ</div>
        <div id="e_breederExtraFields" class="form-grid" style="display:none;">
          <div class="form-group">
            <label>ÂâçÈ∏Ω‰∏ªÔºàÂèØÈÄâÔºâ</label>
            <input id="e_previousOwner" type="text" placeholder="Â¶ÇÔºöÂº†‰∏â" />
          </div>
          <div class="form-group">
            <label>ÂâçÂú∞Âå∫ÔºàÂèØÈÄâÔºâ</label>
            <input id="e_previousRegion" type="text" placeholder="Â¶ÇÔºöÂåó‰∫¨" />
          </div>
        </div>

        <!-- Áé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫ÔºàÊâÄÊúâÈ∏ΩÂ≠êÈÉΩÊúâÔºâ -->
        <div class="section-title">È∏Ω‰∏ª‰ø°ÊÅØ</div>
        <div class="section-desc">ËÆ∞ÂΩïÂΩìÂâçÈ∏Ω‰∏ªÂíåÊâÄÂú®Âú∞Âå∫</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Áé∞È∏Ω‰∏ª</label>
            <div style="position:relative;">
              <input id="e_currentOwner" type="text" placeholder="Â¶ÇÔºöÊùéÂõΩËæâ" list="e_ownerList" style="width:100%;" />
              <datalist id="e_ownerList"></datalist>
            </div>
            <span class="muted" style="font-size:12px;">ËæìÂÖ•Êàñ‰ªé‰∏ãÊãâÈÄâÊã©</span>
          </div>
          <div class="form-group">
            <label>Áé∞Âú∞Âå∫</label>
            <input id="e_currentRegion" type="text" placeholder="Â¶ÇÔºöË¥µÂ∑ûÈªîË•ø" list="e_regionList" />
            <datalist id="e_regionList"></datalist>
            <span class="muted" style="font-size:12px;">ËæìÂÖ•Êàñ‰ªé‰∏ãÊãâÈÄâÊã©</span>
          </div>
        </div>

        <div class="section-title">Ë°ÄÁªü‰ø°ÊÅØ</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Áà∂È∏ΩÔºàÂèØÈÄâÔºâ</label>
            <select id="e_father"></select>
          </div>
          <div class="form-group">
            <label>ÊØçÈ∏ΩÔºàÂèØÈÄâÔºâ</label>
            <select id="e_mother"></select>
          </div>
        </div>

        <div class="section-title">ÂèÇËµõ‰ø°ÊÅØÔºàÂèØÂ¢û / Êîπ / Âà†Ôºâ</div>
        <div id="e_raceList" class="race-list"></div>
        <button class="btn btn-outline btn-sm" id="btnAddRaceEdit">‚ûï Ê∑ªÂä†‰∏ÄÊù°ÂèÇËµõËÆ∞ÂΩï</button>

        <div class="section-title">È∏ΩÂ≠êÁä∂ÊÄÅ</div>
        <div class="form-grid">
          <div class="form-group">
            <label>ÂΩìÂâçÁä∂ÊÄÅ</label>
            <div class="radio-group">
              <label><input type="radio" name="e_alive" value="alive" /> Âú®‰∏ñ</label>
              <label><input type="radio" name="e_alive" value="dead" /> Â∑≤Ê≠ª‰∫°</label>
            </div>
          </div>
          <div class="form-group e-death-extra" style="display:none;">
            <label>Ê≠ª‰∫°Êó•Êúü<span class="required">*</span></label>
            <input id="e_death_date" type="date" />
          </div>
          <div class="form-group e-death-extra" style="display:none;">
            <label>Ê≠ª‰∫°ÂéüÂõ†ÔºàÂèØÈÄâÔºâ</label>
            <input id="e_death_reason" type="text" />
          </div>
        </div>

        <div class="section-title">ÂõæÁâáÁÆ°ÁêÜ</div>
        <div class="section-desc">ÂèØ‰∏ä‰º†ÊàñÊõ¥Êñ∞ËØ•È∏ΩÂ≠êÁöÑÁ´ôÁ´ã‰æßË∫´ÁÖß‰∏éÁúºÁùõÁâπÂÜôÔºõ‰∏ä‰º†Êñ∞ÂõæÁâáÂ∞ÜÊõøÊç¢Áé∞ÊúâÂõæÁâáÔºåËã•‰∏çÈÄâÊã©Êñ∞ÂõæÁâáÔºåÂàô‰øùÁïôÂΩìÂâçÂõæÁâáÊàñ‰ΩøÁî®Á§∫‰æãÂõæÁâá„ÄÇ</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Á´ôÁ´ã‰æßË∫´ÂõæÁâá</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="e_body_photo" type="file" accept="image/*" style="flex:1;" />
              <input id="e_body_photo_camera" type="file" accept="image/*" capture style="display:none;" />
              <button type="button" class="btn btn-outline btn-sm" id="btnCameraBodyEdit" style="white-space:nowrap;">üì∑ ÊãçÁÖß</button>
            </div>
            <span class="muted" style="font-size:12px; margin-top:4px;">ÊîØÊåÅÂ∏∏ËßÅÂõæÁâáÊ†ºÂºèÔºåÊó†ÂàÜËæ®ÁéáÈôêÂà∂„ÄÇÂèØ‰∏ä‰º†ÂõæÁâáÊàñÁõ¥Êé•ÊãçÁÖß„ÄÇ</span>
          </div>
          <div class="form-group">
            <label>ÁúºÁùõÁâπÂÜôÂõæÁâá</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="e_eye_photo" type="file" accept="image/*" style="flex:1;" />
              <input id="e_eye_photo_camera" type="file" accept="image/*" capture style="display:none;" />
              <button type="button" class="btn btn-outline btn-sm" id="btnCameraEyeEdit" style="white-space:nowrap;">üì∑ ÊãçÁÖß</button>
            </div>
            <span class="muted" style="font-size:12px; margin-top:4px;">ÊîØÊåÅÂ∏∏ËßÅÂõæÁâáÊ†ºÂºèÔºåÊó†ÂàÜËæ®ÁéáÈôêÂà∂„ÄÇÂèØ‰∏ä‰º†ÂõæÁâáÊàñÁõ¥Êé•ÊãçÁÖß„ÄÇ</span>
          </div>
        </div>

        <div style="margin-top:16px; display:flex; justify-content:flex-end; gap:8px;">
          <button class="btn btn-ghost" id="btnCancelEdit">ÂèñÊ∂à</button>
          <button class="btn btn-primary" id="btnSaveEdit">‰øùÂ≠ò</button>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  // ÁÆÄÂçïÂÜÖÂ≠òÊï∞ÊçÆÁªìÊûÑÔºå‰ΩøÁî® localStorage ÂÅöÊú¨Âú∞ÊåÅ‰πÖÂåñ
  const STORAGE_KEY = 'pigeon_manager_data_v1';
  const USED_NAMES_KEY = 'pigeon_used_names_v1';
  const OWNER_REGION_PAIRS_KEY = 'pigeon_owner_region_pairs_v1';
  let pigeons = [];
  let currentDetailId = null; // ÂΩìÂâçËØ¶ÊÉÖÈ°µÊòæÁ§∫ÁöÑÈ∏ΩÂ≠ê id
  
  // È∏ΩÂ≠êÂêçÂ≠óÂàóË°®Ôºà‰∏ÄÊ¨°ÊÄß‰ΩøÁî®Ôºå‰∏çÈáçÂ§çÔºâ
  const PIGEON_NAMES = [
    'Áâπ', 'Â∏ÉÊñØÂ°î', 'ÂüÉÊñáÊñØ', 'ËØ∫Èáå', 'Ëø™Á±≥ÁâπÊ¥õÂ§´', 'Ë•øË•øÂ∏ïÊñØ', 'ÈΩêÈΩêÂ∏ïÊñØ', 'Âç¢Â∏ÉÂàóÂ§´', 'Âç°ÊãâÈááÂ§´', 'Âç°ÊÅ∞ËØ∫Â§´', 'ÂìàÊÅ∞ËØ∫Â§´', 'Ê¢ÖÂæ∑Èü¶Êù∞Â§´', 'Á¶èÈõ∑Ëø™Âä†ÊñØ', 'ÁΩóÁ∫≥Âæ∑ËåÉË•ø', 'Á±≥Ê≠áÂ∞îÂç°Â§´', 'ÈòøËØ∫Âæ∑Á¥¢', 'ÂºóÊúóË•øÊñØÊÅ©', 'ÊâòÈ©¨ÊñØËØ∫', '‰∫®Âæ∑ÈáåÂÖãËé´', 'Êú¨Êù∞ÊòéËø™', 'ÂÆâ‰∏úÂ∞ºÊÅ©', 'È©¨Â°ûÂ∞îËäí', 'ÁöÆÂüÉÂ∞îË•ø', 'ÈõÖÂÖãÂ∏É‰Ω©', 'Á∫™Â∞ßÂßÜÂßÜ', 'Ë∑ØÊòìÊñØÊãâ', 'Áà±Âæ∑ÂçéÂ§öÁ∫≥', 'Ëé´ÈáåÊñØÂ∞î', 'ÈòøÂ∞îË¥ùÊâòÁª¥', 'Ëµ´Â∞îÊõºÂ∞î', 'È≤ÅËø™Ê†ºÊÅ©', 'Ê†ºÂìàÂæ∑Áßë', 'Áì¶Â∞îÁâπÁßë', 'ËÉ°ÊààÂçö', 'Ëø™ÁâπÈ©¨Â∞îÊ£Æ', 'Ëé±Âõ†ÂìàÂæ∑Â∞î', 'ÂêõÁâπÂìà', 'Âç°Â∞îÊµ∑Âõ†Ëå®', 'ÊõºÂºóÈõ∑Âæ∑ÊÅ©', 'Á∫¶ÈòøÂ∏åÂßÜÂ∞î', 'Áª¥Â∞îÁ∫≥ÊÅ©', 'Êµ∑Âõ†Ëå®Â∞î', 'ÂºóÊúóËå®Â∞î', 'Â°ûÂ∑¥ÊñØËíÇÂÆâ', 'È©¨Â∫ìÊñØÊÅ©', 'ÂÖãÈáåÊñØËíÇÂÆâ', 'ÊñØÁâπÂá°ÊÅ©', 'Á∫¶Ê†ºÊÅ©', 'Á±≥Â§èÂüÉÂ∞îÊÅ©', 'ÂÆâÂæ∑ÁÉà‰∫öÊñØ', 'ÂìàÊãâÂ∞îÂæ∑ÊÅ©', 'Ëø™Â∞îÂÖãÊÅ©', 'Âª∂ÊñØÊÅ©', 'ÂÖãÂä≥ÊñØÊÅ©', '‰πåÈü¶ÊÅ©', 'Á∫¶Â∞îÊ†ºÊÅ©', 'ÊâòÈ©¨ÊñØÊÅ©', 'È©¨ËíÇ‰∫öÊñØÊÅ©', '‰ºØÊÅ©ÂìàÂæ∑ÊÅ©', 'Á∫¶Á∫≥ÊñØÊÅ©', 'ÊãâÊñØÁ©ÜÊñØÊÅ©', 'Â••Âà©ÂºóÊÅ©', 'Êâ¨ÊÅ©', 'Â∞ºÂ∞îÊñØÊÅ©', '‰Ω©Âæ∑Ê£ÆÊÅ©', 'ÂÖãÈáåÊñØÊªïÊ£Æ', 'ÂÆâÂæ∑ÊñØÊÅ©', 'ÂüÉÈáåÂÖãÊùæÊÅ©', 'Âç°Â∞îÊ£ÆÊÅ©', 'ÊûóÂæ∑ÊñØÁâπ‰º¶', 'Â••Â∞îÊ£ÆÊÅ©', 'Á∫¶Áø∞ÊùæÊÅ©', '‰Ω©Â∞îÊùæÊÅ©', 'Âè§ÊñØÂ°îÂ§´Êùæ', 'ÂüÉÈáåÂÖãÊùæÊÅ©', 'ÊØîÁ∫¶ÊÅ©ÊùæÊÅ©', 'ÊñØÊñáÊùæÊÅ©', 'ÊãâÊ£ÆÊÅ©', 'Ê±âÊ£ÆÊÅ©', 'Ëé´ÊªïÊ£ÆÊÅ©', 'Âª∂Ê£ÆÊÅ©', 'ÂÖãÈáåÊñØÊâòÂºó', 'Ëè≤Âà©ÊôÆÊÅ©', 'È©¨ÂÖãË•øÁ±≥ÂÖ∞', 'Âç¢Âç°ÊñØÊÅ©', 'Ë•øËíôÊÅ©', '‰øùÁΩóÊÅ©', 'Êâ¨ÊÅ©', 'Ê≥ΩÊõºÊÅ©', 'ÈúçÂ§´ÊõºÊÅ©', 'ÁßëÁì¶Â•áÊÅ©', 'Ë•øÂ•áÊÅ©', 'Ë¥π‰º¶Ëå®ÊÅ©', '‰πÖÂ∞îÂêâÊÅ©', 'ÁªçÊ¥õ‰ºäÊÅ©', 'ÂçöÊ¥õÂ∞ºÊÅ©', 'Á∫≥ÂêâÊÅ©', 'Ëµ´Ê†ºÊùúÊñØÊÅ©', 'Ëê®ÂçöÊÅ©', 'ÂÖãËé±Âõ†ÊÅ©', 'ËàíÂ∞îËå®ÊÅ©', 'ËøàÂ∞îÊñØÊÅ©', 'ÊñΩËÄêÂæ∑ÊÅ©', 'Èü¶Ê†ºÁ∫≥ÊÅ©', 'ÂìàÊÅ©ÊÅ©', 'Ëè≤ËàçÂ∞îÊÅ©', 'Èü¶‰ºØÊÅ©', 'È≤çÂ∞îÊÅ©', 'Á±≥ÂãíÊÅ©', 'ÊñΩÂØÜÁâπÊÅ©', 'ÈúçÂ§´ÊõºÊÅ©', 'ÁßëËµ´ÊÅ©', 'ÈΩêÈªòÂ∞îÊõº', 'ÊÅ©Ê†ºÂ∞îÂìàÁâπ', 'ÈáåÂ∏åÁâπÊÅ©', 'ËàçË¥πÂ∞îÊÅ©', 'Áì¶Ê†ºÁ∫≥ÊÅ©', 'ËØ∫‰ºäÊõºÊÅ©', '‰Ω©ÁâπÊ£ÆÊÅ©', 'Ê±âÊ£ÆÊÅ©', 'Âª∂Ê£ÆÊÅ©', 'Â∞ºÂ∞îÊ£ÆÊÅ©', 'ÂÆâÂæ∑Ê£ÆÊÅ©', '‰ºØÊ†ºÊñØÁâπ‰º¶', 'ÊûóÂæ∑‰ºØÊ†º', 'Âç°Â∞îÊùæÊÅ©', 'Â••Â∞îÊùæÊÅ©', 'ÂΩºÂæóÊùæÊÅ©', 'ÊñØÊñáÊùæÊÅ©', 'Á∫¶Áø∞ÊùæÊÅ©', 'ÊãâÂ∞îÊ£ÆÊÅ©', '‰Ω©Â∞îÊùæÊÅ©', 'ÂüÉÈáåÂÖãÊùæÊÅ©', '‰º¶Âæ∑ÊñØÁâπ‰º¶', 'Âè§ÊñØÂ°îÂ§´Êùæ', 'ÈòøÂÖãÂ°ûÂ∞îÊùæ', 'ÊØîÁ∫¶ÊÅ©ÊùæÊÅ©', 'Â∞ºÊñØÁâπ‰º¶Âæ∑', 'ÈúçÂ∞îÂßÜÊñØÁâπ', 'Â∏ÉÊãâËµ´ÁâπÊ£Æ', '‰ºäËê®ÂÖãÊùæÊÅ©', 'ÈõÖÂêÑÂ∏ÉÊùæ', 'ÊûóÂæ∑Â•éÊñØÁâπ', 'ÊñØÊñáÊùæÊÅ©', '‰Ω©Âæ∑Ê£ÆÊÅ©', 'ÂÖãÈáåÊñØÊªïÊ£Æ', 'ÊãâÊñØÁ©ÜÊ£Æ', 'Ê±âÊ£ÆÊÅ©', 'Ëé´ÊªïÊ£ÆÊÅ©', 'ÂÖãÂä™Ê£ÆÊÅ©', 'ÂΩºÂæóÊ£ÆÊÅ©', 'Âª∂Ê£ÆÊÅ©', 'ÂÆâÂæ∑Ê£ÆÊÅ©', 'Á¥¢‰º¶Ê£ÆÊÅ©', 'ÈõÖÂêÑÂ∏ÉÊ£Æ', 'ÂÖãÈáåÊñØËíÇÂÆâÊ£Æ', 'ÂºóÈõ∑Âæ∑ÈáåÂÖã', 'Â®ÅÂªâÂßÜÊñØÂü∫', '‰∫öÂéÜÂ±±Â§ßÁΩó', 'Âæ∑Á±≥ÁâπÈáåËÄ∂Â§´', 'Ë∞¢Â∞îÁõñËÄ∂Áª¥', 'ÂºóÊãâÂü∫Á±≥Â∞î', 'Â∞ºÂè§ÊãâËÄ∂Áª¥', 'ÂÆâÂæ∑ÁÉàËÄ∂Áª¥', '‰ºä‰∏áËØ∫Áª¥Â•á', 'ÂΩºÂæóÁΩóÁª¥Â•á', 'Â∏ïÂ§´Ê¥õÁª¥Â•á', 'Áì¶Ë•øÈáåËÄ∂Áª¥', 'ÈòøÂàóÂÖãË∞¢ËÄ∂', 'È©¨ÂÖãË•øËé´Áª¥Â•á', 'Âæ∑Á±≥ÁâπÈáåËÄ∂', 'Â∫∑ÊñØÂù¶‰∏ÅËØ∫', 'Â••ÂàóÊ†ºÁª¥Â•á', 'Âè∂Â§´Ê†πÂ∞ºËÄ∂', 'Ë∞¢Â∞îÁõñËÄ∂Áª¥', '‰ºäÊààÂ∞îÁª¥Â•á', 'È≤çÈáåÁ¥¢Áª¥Â•á', 'Ê†ºÈáåÊààÈáåËÄ∂', 'Â∞ºÂü∫Á¶èÁΩóÁª¥', 'È©¨Â∞îÁßëÁª¥Â•á', 'ÊñØÂù¶ÁßëÁª¥Â•á', '‰Ω©ÁâπÁΩóÁª¥Â•á', 'Á∫¶Áª¥Â•áÂ∞ºÁßë', 'ÁßëÁì¶ÂàáÁª¥Â•á', '‰ºä‰∏áËØ∫Áª¥Â•á', 'Ê≥¢Ê≥¢Áª¥Â•áÁ±≥', 'ÂΩºÂæóÁΩóÂ§´ÊñØ', 'Êâ¨Â∫ìÊ¥õÂ§´ÊñØ', 'Âà´Â∞îÊ¥•ÊñØ', 'Âç°Â∞îÂÆÅÊñØ', 'ÊñØÁâπÂä≥È©¨', 'ÊâéÈúçÊãâÊÅ©', 'ÁßëÁΩóÂªñÂ§´ÊñØ', 'Ë∞¢ËãóËØ∫Â§´ÊñØ', 'Ê≤É‰ºäËØ∫Â§´ÊñØ', 'ÂΩºÂæóÁΩóÂ§´ÊñØ', 'ÊãâËÑ±Áª¥Êâ¨ÊñØ', 'Á´ãÈô∂ÂÆõÊñØ', 'Êâ¨Â∫ìÊñØÂç°ÊñØ', 'Âç°Áì¶Âà©ÊñØ', 'ÊñØÂ°îÂ°ûÁª¥Â•á', 'Âè§ÈáåËÄ∂Â§´ÊñØ', 'Â∏ÉÁΩóÂ§´ÊñØÂç°ÊñØ', 'Êâ¨Â∫ìÊñØÂç°ÊñØ', 'È©¨‰∏òÂà©ÊñØ', 'Âç°ÊôÆËãèÂç°ÊñØ', 'Á∫≥Áª¥Ëå®Âç°ÊñØ', 'Ê†ºÈáåÈ≤çÊñØÂç°ÊñØ', 'Êâ¨ËÄÉÊñØÂç°ÊñØ', 'Áª¥ÁâπÂ∫ìÁ∫≥ÊñØ', 'ÈòøËææÂßÜÂ∫ìÊñØ', 'ÊñØÂù¶ÂÖãÁª¥‰∏ò', 'ÈΩêÂ••Â°ûÊñØÂ∫ì', 'Ê≥¢‰Ω©ÊñØÂ∫ì', 'Êâ¨Â∫ìÊ¥õÂ§´', 'Ëø™Á±≥ÁâπÈáåËÄ∂', 'Â∫∑ÊñØÂù¶‰∏Å', '‰πîÊ≤ª‰πåÂÆâ', 'Â∏ïÂ∏ïÂ§öÊôÆÊ¥õ', 'ÊñØÂ°îÂ§´ÁΩóÊñØ', 'Â∞ºÁßëÊãâÊ¨ß', 'ÂÆâÂæ∑ÁÉà‰∫öÊñØ', 'Â∏ïÂ∏ïÂ∫∑ÊñØÂù¶', 'Ëø™Á±≥ÁâπÈáåÊ¨ß', '‰πîÊ≤ª‰∫öÂ≠£ÊñØ', 'Â∏ïÊΩòÂæ∑ÈáåÊ¨ß', 'Âç°ÂÖãÊãâÈ©¨Á∫≥', 'ÊñØÁöÆÁΩóÊñØ', '‰ºäÂÆâÂ∞ºËø™ÊñØ', 'Â∏ïÂ∏ïÂ§öÊôÆÊ¥õÊñØ', 'È©¨Â§´ÁΩó‰ºäÂÆâ', 'Â∫∑ÊñØÂù¶‰∏ÅÂ∞º', 'Áì¶Ë•øÊãâÁßëÊñØ', 'ÂΩºÂæóÁΩóÊôÆÊ¥õÊñØ', 'Â∞ºÂè§Êãâ‰πå', 'ÂÆâÊù∞Ê¥õÊôÆÊ¥õÊñØ', 'Â≠£Á±≥ÁâπÊ¥õÊôÆ', '‰∫öÂéÜÂ±±Âæ∑ÁΩóÊôÆ', 'Á¥¢ÂÖãÊãâËíÇÊñØ', 'Êâ¨Á∫≥ÁßëÊôÆÊ¥õÊñØ', 'Êü•ÊãâÂÖ∞ÂçöÊñØ', 'Á¶èÈõ∑Ëø™ÈáåÊòÇ', 'ÁΩóÁ∫≥Âæ∑Á¥¢', 'Á±≥Ê≠áÂ∞îËé´', 'ÈòøËØ∫Âæ∑ÊÅ©', 'ÂºóÊúóË•øÊñØÂ∞î', 'ÊâòÈ©¨ÊñØÂ∞î', '‰∫®Âæ∑ÈáåÂÖãÊÅ©', 'Êú¨Êù∞ÊòéÂ∞î', 'ÂÆâ‰∏úÂ∞ºÊÅ©', 'È©¨Â°ûÂ∞îÊÅ©', 'ÁöÆÂüÉÂ∞îÊÅ©', 'ÈõÖÂÖãÂ∏ÉÊÅ©', 'Á∫™Â∞ßÂßÜÊÅ©', 'Ë∑ØÊòìÊñØÊãâ', 'Áà±Âæ∑ÂçéÂ§öÁ∫≥', 'Ëé´ÈáåÊñØÂ∞î', 'ÈòøÂ∞îË¥ùÊâòÁª¥', 'Ëµ´Â∞îÊõºÂ∞î', 'È≤ÅËø™Ê†ºÊÅ©', 'Ê†ºÂìàÂæ∑Áßë', 'Áì¶Â∞îÁâπÁßë', 'ËÉ°ÊààÂçö', 'Ëø™ÁâπÈ©¨Â∞îÊ£Æ', 'Ëé±Âõ†ÂìàÂæ∑Â∞î', 'ÂêõÁâπÂìà', 'Âç°Â∞îÊµ∑Âõ†Ëå®', 'ÊõºÂºóÈõ∑Âæ∑ÊÅ©', 'Á∫¶ÈòøÂ∏åÂßÜÂ∞î', 'Áª¥Â∞îÁ∫≥ÊÅ©', 'Êµ∑Âõ†Ëå®Â∞î', 'ÂºóÊúóËå®Â∞î', 'Â°ûÂ∑¥ÊñØËíÇÂÆâ', 'È©¨Â∫ìÊñØÊÅ©', 'ÂÖãÈáåÊñØËíÇÂÆâ', 'ÊñØÁâπÂá°ÊÅ©', 'Á∫¶Ê†ºÊÅ©', 'Á±≥Â§èÂüÉÂ∞îÊÅ©', 'ÂÆâÂæ∑ÁÉà‰∫öÊñØ', 'ÂìàÊãâÂ∞îÂæ∑ÊÅ©', 'Ëø™Â∞îÂÖãÊÅ©', 'Âª∂ÊñØÊÅ©', 'ÂÖãÂä≥ÊñØÊÅ©', '‰πåÈü¶ÊÅ©', 'Á∫¶Â∞îÊ†ºÊÅ©', 'ÊâòÈ©¨ÊñØÊÅ©', 'È©¨ËíÇ‰∫öÊñØÊÅ©', '‰ºØÊÅ©ÂìàÂæ∑ÊÅ©', 'Á∫¶Á∫≥ÊñØÊÅ©', 'ÊãâÊñØÁ©ÜÊñØÊÅ©', 'Â••Âà©ÂºóÊÅ©', 'Êâ¨ÊÅ©', 'Â∞ºÂ∞îÊñØÊÅ©', '‰Ω©Âæ∑Ê£ÆÊÅ©', 'ÂÖãÈáåÊñØÊªïÊ£Æ', 'ÂÆâÂæ∑ÊñØÊÅ©', 'ÂüÉÈáåÂÖãÊùæÊÅ©', 'Âç°Â∞îÊ£ÆÊÅ©', 'ÊûóÂæ∑ÊñØÁâπ‰º¶', 'Â••Â∞îÊ£ÆÊÅ©', 'Á∫¶Áø∞ÊùæÊÅ©', '‰Ω©Â∞îÊùæÊÅ©', 'Âè§ÊñØÂ°îÂ§´Êùæ', 'ÂüÉÈáåÂÖãÊùæÊÅ©', 'ÊØîÁ∫¶ÊÅ©ÊùæÊÅ©', 'ÊñØÊñáÊùæÊÅ©', 'ÊãâÊ£ÆÊÅ©', 'Ê±âÊ£ÆÊÅ©', 'Ëé´ÊªïÊ£ÆÊÅ©', 'Âª∂Ê£ÆÊÅ©'
  ];
  
  // Âä†ËΩΩÂ∑≤‰ΩøÁî®ÁöÑÂêçÂ≠ó
  function loadUsedNames() {
    try {
      const raw = localStorage.getItem(USED_NAMES_KEY);
      if (!raw) return new Set();
      const names = JSON.parse(raw);
      return new Set(names);
    } catch (e) {
      console.error('Âä†ËΩΩÂ∑≤‰ΩøÁî®ÂêçÂ≠óÂ§±Ë¥•:', e);
      return new Set();
    }
  }
  
  // ‰øùÂ≠òÂ∑≤‰ΩøÁî®ÁöÑÂêçÂ≠ó
  function saveUsedNames(usedNames) {
    try {
      localStorage.setItem(USED_NAMES_KEY, JSON.stringify(Array.from(usedNames)));
    } catch (e) {
      console.error('‰øùÂ≠òÂ∑≤‰ΩøÁî®ÂêçÂ≠óÂ§±Ë¥•:', e);
    }
  }
  
  // Ëé∑ÂèñÈöèÊú∫Êú™‰ΩøÁî®ÁöÑÂêçÂ≠ó
  function getRandomUnusedName() {
    const usedNames = loadUsedNames();
    const availableNames = PIGEON_NAMES.filter(name => !usedNames.has(name));
    if (availableNames.length === 0) {
      return null; // ÊâÄÊúâÂêçÂ≠óÈÉΩÂ∑≤‰ΩøÁî®
    }
    const randomIndex = Math.floor(Math.random() * availableNames.length);
    const selectedName = availableNames[randomIndex];
    usedNames.add(selectedName);
    saveUsedNames(usedNames);
    return selectedName;
  }
  
  // Âä†ËΩΩÈ∏Ω‰∏ª-Âú∞Âå∫ÈÖçÂØπ
  function loadOwnerRegionPairs() {
    try {
      const raw = localStorage.getItem(OWNER_REGION_PAIRS_KEY);
      if (!raw) return [];
      return JSON.parse(raw);
    } catch (e) {
      console.error('Âä†ËΩΩÈ∏Ω‰∏ª-Âú∞Âå∫ÈÖçÂØπÂ§±Ë¥•:', e);
      return [];
    }
  }
  
  // ‰øùÂ≠òÈ∏Ω‰∏ª-Âú∞Âå∫ÈÖçÂØπ
  function saveOwnerRegionPairs(pairs) {
    try {
      localStorage.setItem(OWNER_REGION_PAIRS_KEY, JSON.stringify(pairs));
    } catch (e) {
      console.error('‰øùÂ≠òÈ∏Ω‰∏ª-Âú∞Âå∫ÈÖçÂØπÂ§±Ë¥•:', e);
    }
  }
  
  // Ê∑ªÂä†Êñ∞ÁöÑÈ∏Ω‰∏ª-Âú∞Âå∫ÈÖçÂØπÔºàÂ¶ÇÊûúÂá∫Áé∞‰∏§Ê¨°Âàô‰øùÂ≠òÔºâ
  function addOwnerRegionPair(owner, region) {
    if (!owner || !region) return;
    const pairs = loadOwnerRegionPairs();
    const pairKey = `${owner}|${region}`;
    const existingPair = pairs.find(p => p.key === pairKey);
    if (existingPair) {
      existingPair.count = (existingPair.count || 1) + 1;
      if (existingPair.count >= 2 && !existingPair.saved) {
        existingPair.saved = true;
        saveOwnerRegionPairs(pairs);
      }
    } else {
      pairs.push({ key: pairKey, owner, region, count: 1, saved: false });
      saveOwnerRegionPairs(pairs);
    }
  }

  function loadFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const data = JSON.parse(raw);
      if (Array.isArray(data)) {
        pigeons = data;
        // Ê£ÄÊü•ÊâÄÊúâÈ∏ΩÂ≠êÊòØÂê¶ÊúâÂêçÂ≠óÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôËá™Âä®ÂàÜÈÖç
        let hasChanges = false;
        pigeons.forEach(p => {
          if (!p.name || p.name.trim() === '') {
            const newName = getRandomUnusedName();
            if (newName) {
              p.name = newName;
              hasChanges = true;
            }
          } else {
            // Â¶ÇÊûúÂ∑≤ÊúâÂêçÂ≠ó‰∏îÂú®ÂàóË°®‰∏≠ÔºåÊ†áËÆ∞‰∏∫Â∑≤‰ΩøÁî®
            const usedNames = loadUsedNames();
            if (PIGEON_NAMES.includes(p.name) && !usedNames.has(p.name)) {
              usedNames.add(p.name);
              saveUsedNames(usedNames);
            }
          }
        });
        if (hasChanges) {
          saveToStorage();
        }
      }
    } catch (e) {
      console.error('Âä†ËΩΩÊú¨Âú∞Êï∞ÊçÆÂ§±Ë¥•:', e);
    }
  }

  function saveToStorage() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(pigeons));
    } catch (e) {
      console.error('‰øùÂ≠òÊú¨Âú∞Êï∞ÊçÆÂ§±Ë¥•:', e);
    }
  }

  // ÈªòËÆ§ÂõæÁâáÔºöÁ´ôÁ´ã‰æßË∫´ÂõæÂíåÁúºÁùõÁâπÂÜôÔºàÁ§∫‰æãÂõæÁâáÔºâ
  // IMG_6540.jpg ÊòØÁ´ôÁ´ã‰æßË∫´ÂõæÔºåIMG_6539.jpg ÊòØÁúºÈÉ®ÁâπÂÜô
  const DEFAULT_BODY_IMG = 'picker/IMG_6540.jpg';
  const DEFAULT_EYE_IMG = 'picker/IMG_6539.jpg';

  function generateId() {
    return 'p_' + Math.random().toString(36).slice(2, 10);
  }

  function getPigeonById(id) {
    return pigeons.find(p => p.id === id);
  }

  function getPigeonByRing(ring) {
    const target = (ring || '').trim();
    if (!target) return null;
    return pigeons.find(p => (p.ring || '').toLowerCase() === target.toLowerCase() && p.alive);
  }

  function getAllPigeonsByRing(ring) {
    const target = (ring || '').trim();
    if (!target) return [];
    return pigeons.filter(p => (p.ring || '').toLowerCase() === target.toLowerCase());
  }

  function formatDate(d) {
    if (!d) return '';
    return d;
  }

  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // ËßÜÂõæÂàáÊç¢
  const views = {
    dashboardView: document.getElementById('dashboardView'),
    listView: document.getElementById('listView'),
    createView: document.getElementById('createView'),
    detailView: document.getElementById('detailView'),
    statsView: document.getElementById('statsView'),
    raceView: document.getElementById('raceView') || null,
    pedigreeView: document.getElementById('pedigreeView') || null
  };
  const navButtons = document.querySelectorAll('header nav button');
  const sidebarItems = document.querySelectorAll('.sidebar-item');

  function switchView(name) {
    Object.keys(views).forEach(k => {
      if (views[k]) views[k].style.display = (k === name) ? '' : 'none';
    });
    navButtons.forEach(btn => {
      if (btn.dataset.view === name) btn.classList.add('active');
      else btn.classList.remove('active');
    });
    sidebarItems.forEach(item => {
      if (item.dataset.view === name) item.classList.add('active');
      else item.classList.remove('active');
    });
    
    // ÂàáÊç¢Âà∞Ë°ÄÁªüÂÖ≥Á≥ªËßÜÂõæÊó∂Âà∑Êñ∞
    if (name === 'pedigreeView') {
      refreshPedigreeView();
    }
    
    // ÂàáÊç¢Âà∞ÊØîËµõÁÆ°ÁêÜËßÜÂõæÊó∂Âà∑Êñ∞
    if (name === 'raceView') {
      loadRaces();
      syncRacesToPigeons(); // Ëá™Âä®ÂêåÊ≠•ÊØîËµõÊï∞ÊçÆ
      renderRaceList();
      fillStatsPigeonSelect();
      generateOverallAnalysis(); // Ëá™Âä®ÁîüÊàêÁªºÂêàÂàÜÊûê
    }
  }
  
  // Dashboard Êï∞ÊçÆÂà∑Êñ∞
  function refreshDashboard() {
    const total = pigeons.length;
    const alive = pigeons.filter(p => p.alive).length;
    const dead = pigeons.filter(p => !p.alive).length;
    const raced = pigeons.filter(p => p.races && p.races.length > 0).length;
    const core = pigeons.filter(p => p.isCore).length;
    
    const statTotalEl = document.getElementById('statTotal');
    const statAliveEl = document.getElementById('statAlive');
    const statDeadEl = document.getElementById('statDead');
    const statRacedEl = document.getElementById('statRaced');
    const statCoreEl = document.getElementById('statCore');
    
    if (statTotalEl) statTotalEl.textContent = total;
    if (statAliveEl) statAliveEl.textContent = alive;
    if (statDeadEl) statDeadEl.textContent = dead;
    if (statRacedEl) statRacedEl.textContent = raced;
    if (statCoreEl) statCoreEl.textContent = core;
    
    // ÂêåÊó∂Êõ¥Êñ∞Âπ¥Â∫¶ÁªüËÆ°Ë°®Ê†º
    renderDashboardStats();
  }

  // Âπ¥Â∫¶ÁªüËÆ°Ê∏≤Êüì
  const dashboardStatsTableBody = document.getElementById('dashboardStatsTableBody');
  const statsViewTableBody = document.getElementById('statsViewTableBody');

  // ÁîüÊàêÁªüËÆ°Êï∞ÊçÆ
  function getStatsData() {
    const map = {};
    pigeons.forEach(p => {
      const birthYear = p.birth ? String(p.birth).slice(0, 4) : '';
      const deathYear = p.deathDate ? String(p.deathDate).slice(0, 4) : '';

      if (birthYear) {
        if (!map[birthYear]) map[birthYear] = { born: 0, dead: 0, raced: 0, racedSet: new Set() };
        map[birthYear].born += 1;
      }
      if (deathYear) {
        if (!map[deathYear]) map[deathYear] = { born: 0, dead: 0, raced: 0, racedSet: new Set() };
        map[deathYear].dead += 1;
      }
      if (p.races && p.races.length > 0) {
        p.races.forEach(r => {
          const year = r.date ? String(r.date).slice(0, 4) : '';
          if (!year) return;
          if (!map[year]) map[year] = { born: 0, dead: 0, raced: 0, racedSet: new Set() };
          map[year].racedSet.add(p.id);
        });
      }
    });
    return map;
  }

  // Ê∏≤ÊüìDashboard‰∏≠ÁöÑË°®Ê†ºÔºàÂÆåÊï¥Ë°®Ê†ºÔºâ
  function renderDashboardStats() {
    if (!dashboardStatsTableBody) return;
    dashboardStatsTableBody.innerHTML = '';
    
    if (pigeons.length === 0) {
      const emptyDiv = document.createElement('div');
      emptyDiv.style.cssText = 'text-align:center;padding:60px 20px;color:#9ca3af;';
      emptyDiv.innerHTML = '<div style="font-size:48px;margin-bottom:16px;">üìä</div><div style="font-size:15px;">ÊöÇÊó†Êï∞ÊçÆÔºåÂΩïÂÖ•È∏ΩÂ≠êÂêé‰ºöËá™Âä®ÁîüÊàêÁªüËÆ°</div>';
      dashboardStatsTableBody.appendChild(emptyDiv);
      return;
    }

    const map = getStatsData();
    const years = Object.keys(map).sort().reverse();
    
    // ÂàõÂª∫Ë°®Ê†º
    const table = document.createElement('table');
    table.style.cssText = 'width:100%;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.1);';
    
    // ÂàõÂª∫Ë°®Â§¥
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    const headers = ['Âπ¥‰ªΩ', 'Âá∫ÁîüÊï∞Èáè', 'Ê≠ª‰∫°Êï∞Èáè', 'ÊúâÂèÇËµõËÆ∞ÂΩïÁöÑÈ∏ΩÂ≠êÊï∞'];
    headers.forEach((text, index) => {
      const th = document.createElement('th');
      th.textContent = text;
      if (index === 0) th.style.textAlign = 'left';
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // ÂàõÂª∫Ë°®‰Ωì
    const tbody = document.createElement('tbody');
    years.forEach(year => {
      const info = map[year];
      info.raced = info.racedSet.size;
      const tr = document.createElement('tr');
      
      const tdYear = document.createElement('td');
      tdYear.textContent = year;
      tdYear.style.fontWeight = '600';
      tdYear.style.color = '#1f2937';
      tr.appendChild(tdYear);
      
      const tdBorn = document.createElement('td');
      tdBorn.textContent = info.born || '0';
      tdBorn.style.color = '#059669';
      tdBorn.style.fontWeight = '500';
      tr.appendChild(tdBorn);
      
      const tdDead = document.createElement('td');
      tdDead.textContent = info.dead || '0';
      tdDead.style.color = '#4b5563';
      tdDead.style.fontWeight = '500';
      tr.appendChild(tdDead);
      
      const tdRaced = document.createElement('td');
      tdRaced.textContent = info.raced || '0';
      tdRaced.style.color = '#d97706';
      tdRaced.style.fontWeight = '500';
      tr.appendChild(tdRaced);
      
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    dashboardStatsTableBody.appendChild(table);
  }

  // Ê∏≤ÊüìÁªüËÆ°ËßÜÂõæ‰∏≠ÁöÑË°®Ê†ºÔºà‰ªÖË°®‰ΩìÔºâ
  function renderStatsViewTable() {
    if (!statsViewTableBody) return;
    statsViewTableBody.innerHTML = '';
    
    if (pigeons.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 4;
      td.innerHTML = '<span class="muted" style="display:block;text-align:center;padding:40px;">ÊöÇÊó†Êï∞ÊçÆÔºåÂΩïÂÖ•È∏ΩÂ≠êÂêé‰ºöËá™Âä®ÁîüÊàêÁªüËÆ°</span>';
      tr.appendChild(td);
      statsViewTableBody.appendChild(tr);
      return;
    }

    const map = getStatsData();
    const years = Object.keys(map).sort().reverse();
    
    years.forEach(year => {
      const info = map[year];
      info.raced = info.racedSet.size;
      const tr = document.createElement('tr');
      
      const tdYear = document.createElement('td');
      tdYear.textContent = year;
      tdYear.style.fontWeight = '600';
      tr.appendChild(tdYear);
      
      const tdBorn = document.createElement('td');
      tdBorn.textContent = info.born || '0';
      tdBorn.style.color = '#059669';
      tr.appendChild(tdBorn);
      
      const tdDead = document.createElement('td');
      tdDead.textContent = info.dead || '0';
      tdDead.style.color = '#4b5563';
      tr.appendChild(tdDead);
      
      const tdRaced = document.createElement('td');
      tdRaced.textContent = info.raced || '0';
      tdRaced.style.color = '#d97706';
      tr.appendChild(tdRaced);
      
      statsViewTableBody.appendChild(tr);
    });
  }

  function refreshStats() {
    renderDashboardStats();
    renderStatsViewTable();
  }

  // ÂàóË°®Ê∏≤Êüì
  const tableBody = document.getElementById('pigeonTableBody');
  const cardsBody = document.getElementById('pigeonCardsBody');
  let currentListView = 'table'; // 'table' Êàñ 'card'

  // Ê∏≤ÊüìÂç°ÁâáËßÜÂõæ
  function renderCardView() {
    if (!cardsBody) return;
    cardsBody.innerHTML = '';
    if (pigeons.length === 0) {
      cardsBody.innerHTML = '<div style="text-align:center;padding:40px;color:#6B7280;">ÊöÇÊó†Êï∞ÊçÆÔºåËØ∑ÂÖàÊñ∞Â¢ûÈ∏ΩÂ≠ê‰ø°ÊÅØ„ÄÇ</div>';
      return;
    }
    pigeons.forEach(p => {
      const card = document.createElement('div');
      card.className = 'pigeon-card';
      
      const father = p.fatherId ? getPigeonById(p.fatherId) : null;
      const mother = p.motherId ? getPigeonById(p.motherId) : null;
      
      // Á°Æ‰øùÂêçÂ≠óÂ≠òÂú®
      const displayName = p.name || p.ring;
      const fatherName = father ? (father.name || father.ring) : '‚Äî';
      const motherName = mother ? (mother.name || mother.ring) : '‚Äî';
      
      card.innerHTML = `
        <div class="pigeon-card-header">
          <div style="flex:1;">
            <div class="pigeon-card-name">${displayName}</div>
            <div class="pigeon-card-ring">${p.ring}</div>
          </div>
          ${p.isCore ? '<span class="tag tag-core">‚≠ê Ê†∏ÂøÉ</span>' : ''}
        </div>
        <div class="pigeon-card-info">
          <div class="pigeon-card-info-item">
            <span class="pigeon-card-info-label">Áà∂È∏Ω</span>
            <span class="pigeon-card-info-value">${fatherName}</span>
          </div>
          <div class="pigeon-card-info-item">
            <span class="pigeon-card-info-label">ÊØçÈ∏Ω</span>
            <span class="pigeon-card-info-value">${motherName}</span>
          </div>
          <div class="pigeon-card-info-item">
            <span class="pigeon-card-info-label">Á±ªÂûã</span>
            <span class="pigeon-card-info-value">${p.type || '‚Äî'}</span>
          </div>
          ${p.currentOwner ? `
          <div class="pigeon-card-info-item">
            <span class="pigeon-card-info-label">Áé∞È∏Ω‰∏ª</span>
            <span class="pigeon-card-info-value">${p.currentOwner}</span>
          </div>
          ` : ''}
        </div>
        <div class="pigeon-card-tags">
          ${p.alive ? '<span class="tag tag-alive">üïäÔ∏è Âú®‰∏ñ</span>' : '<span class="tag tag-dead">üíî Â∑≤Ê≠ª‰∫°</span>'}
          ${p.races && p.races.length > 0 ? `<span class="tag" style="background:#FEF3C7;color:#B45309;border:1px solid #FCD34D;">üèÜ ${p.races.length}Âú∫</span>` : ''}
          ${p.ringRecycled ? '<span class="tag tag-recycled">‚ôªÔ∏è ÂõûÊî∂</span>' : ''}
        </div>
      `;
      
      // Âú®ËÆæÁΩÆinnerHTML‰πãÂêéÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
      card.addEventListener('click', (e) => {
        e.stopPropagation();
        openDetail(p.id);
      });
      
      cardsBody.appendChild(card);
    });
  }

  function refreshList() {
    tableBody.innerHTML = '';
    if (pigeons.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 8;
      td.innerHTML = '<span class="muted">ÊöÇÊó†Êï∞ÊçÆÔºåËØ∑ÂÖàÁÇπÂáªÂè≥‰∏äËßí„ÄåÊñ∞Â¢ûÈ∏ΩÂ≠ê‰ø°ÊÅØ„Äç„ÄÇ</span>';
      tr.appendChild(td);
      tableBody.appendChild(tr);
      return;
    }
    pigeons.forEach(p => {
      const tr = document.createElement('tr');

      const tdRing = document.createElement('td');
      const ringText = document.createTextNode(p.ring);
      tdRing.appendChild(ringText);
      if (p.ringRecycled) {
        const recycledBadge = document.createElement('span');
        recycledBadge.className = 'badge-small';
        recycledBadge.style.cssText = 'background:#fff3cd;color:#856404;margin-left:6px;';
        recycledBadge.textContent = 'ÂõûÊî∂';
        tdRing.appendChild(recycledBadge);
      }
      tr.appendChild(tdRing);

      const tdName = document.createElement('td');
      tdName.textContent = p.name || '‚Äî';
      if (p.isCore) {
        const coreTag = document.createElement('span');
        coreTag.className = 'badge-small';
        coreTag.textContent = 'Ê†∏ÂøÉÁßçÈ∏Ω';
        coreTag.style.marginLeft = '4px';
        tdName.appendChild(coreTag);
      }
      tr.appendChild(tdName);

      const tdType = document.createElement('td');
      tdType.textContent = p.type || '‚Äî';
      tr.appendChild(tdType);

      const tdStatus = document.createElement('td');
      const span = document.createElement('span');
      if (p.alive) {
        span.textContent = 'Âú®‰∏ñ';
        span.className = 'tag tag-alive';
      } else {
        span.textContent = 'Â∑≤Ê≠ª‰∫°';
        span.className = 'tag tag-dead';
      }
      tdStatus.appendChild(span);
      tr.appendChild(tdStatus);

      const tdParents = document.createElement('td');
      const father = p.fatherId ? getPigeonById(p.fatherId) : null;
      const mother = p.motherId ? getPigeonById(p.motherId) : null;
      // ÊòæÁ§∫Áà∂È∏ΩÂíåÊØçÈ∏ΩÁöÑÂêçÂ≠óËÄå‰∏çÊòØË∂≥ÁéØÂè∑
      tdParents.textContent =
        (father ? (father.name || father.ring || '') : '‚Äî') + ' / ' +
        (mother ? (mother.name || mother.ring || '') : '‚Äî');
      tr.appendChild(tdParents);

      const tdCurrentOwner = document.createElement('td');
      tdCurrentOwner.textContent = p.currentOwner || '‚Äî';
      tr.appendChild(tdCurrentOwner);

      const tdRaceCount = document.createElement('td');
      tdRaceCount.textContent = (p.races || []).length;
      tr.appendChild(tdRaceCount);

      const tdActions = document.createElement('td');
      const btnDetail = document.createElement('button');
      btnDetail.className = 'btn btn-outline btn-sm';
      btnDetail.textContent = 'Êü•ÁúãËØ¶ÊÉÖ';
      btnDetail.onclick = () => openDetail(p.id);
      tdActions.appendChild(btnDetail);

      const btnQuickDead = document.createElement('button');
      btnQuickDead.className = 'btn btn-danger btn-sm';
      btnQuickDead.style.marginLeft = '4px';
      btnQuickDead.textContent = p.alive ? 'Ê†áËÆ∞Ê≠ª‰∫°' : 'Â∑≤Ê≠ª‰∫°';
      btnQuickDead.disabled = !p.alive;
      btnQuickDead.onclick = () => {
        if (!confirm(`Á°ÆÂÆöÂ∞Ü„Äê${p.ring}„ÄëÊ†áËÆ∞‰∏∫Â∑≤Ê≠ª‰∫°ÂêóÔºü‰∏ç‰ºöÂà†Èô§‰ªª‰ΩïÂéÜÂè≤ÊàêÁª©„ÄÇ`)) return;
        p.alive = false;
        p.deathDate = new Date().toISOString().slice(0,10);
        saveToStorage();
        refreshList();
        refreshStats();
        refreshDashboard();
        refreshPedigreeView(); // Âà∑Êñ∞Ë°ÄÁªüÂÖ≥Á≥ªËßÜÂõæ
      };
      tdActions.appendChild(btnQuickDead);

      tr.appendChild(tdActions);
      tableBody.appendChild(tr);
    });
    
    // ÂêåÊó∂Êõ¥Êñ∞Âç°ÁâáËßÜÂõæ
    renderCardView();
  }

  // Êñ∞Â¢ûË°®Âçï - Â°´ÂÖÖÁà∂ÊØç‰∏ãÊãâ
  function fillParentOptions(selectEl, excludeId) {
    selectEl.innerHTML = '<option value="">Êú™ÈÄâÊã©</option>';
    pigeons.forEach(p => {
      if (p.id === excludeId) return;
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.ring + (p.name ? 'Ôºà' + p.name + 'Ôºâ' : '');
      selectEl.appendChild(opt);
    });
  }

  // Êõ¥Êñ∞È∏Ω‰∏ª‰∏ãÊãâÂàóË°®
  function updateOwnerDatalist(elementId) {
    const datalist = document.getElementById(elementId);
    if (!datalist) return;
    datalist.innerHTML = '';
    
    // Âõ∫ÂÆöÈÄâÈ°πÔºöÊùéÂõΩËæâ
    const option1 = document.createElement('option');
    option1.value = 'ÊùéÂõΩËæâ';
    datalist.appendChild(option1);
    
    // ‰ªé‰øùÂ≠òÁöÑÈÖçÂØπ‰∏≠Ëé∑ÂèñÂ∑≤‰øùÂ≠òÁöÑÈ∏Ω‰∏ª
    const pairs = loadOwnerRegionPairs();
    const savedOwners = new Set();
    pairs.forEach(pair => {
      if (pair.saved && pair.owner) {
        savedOwners.add(pair.owner);
      }
    });
    
    savedOwners.forEach(owner => {
      if (owner !== 'ÊùéÂõΩËæâ') {
        const option = document.createElement('option');
        option.value = owner;
        datalist.appendChild(option);
      }
    });
  }
  
  // Êõ¥Êñ∞Âú∞Âå∫‰∏ãÊãâÂàóË°®
  function updateRegionDatalist(owner, elementId) {
    const datalist = document.getElementById(elementId);
    if (!datalist) return;
    datalist.innerHTML = '';
    
    if (owner === 'ÊùéÂõΩËæâ') {
      const option = document.createElement('option');
      option.value = 'Ë¥µÂ∑ûÈªîË•ø';
      datalist.appendChild(option);
    }
    
    // ‰ªé‰øùÂ≠òÁöÑÈÖçÂØπ‰∏≠Ëé∑ÂèñËØ•È∏Ω‰∏ªÂØπÂ∫îÁöÑÂú∞Âå∫
    const pairs = loadOwnerRegionPairs();
    pairs.forEach(pair => {
      if (pair.saved && pair.owner === owner && pair.region) {
        const option = document.createElement('option');
        option.value = pair.region;
        datalist.appendChild(option);
      }
    });
  }

  function setupCreateForm() {
    fillParentOptions(document.getElementById('c_father'));
    fillParentOptions(document.getElementById('c_mother'));

    // Áä∂ÊÄÅÂàáÊç¢
    const radios = document.querySelectorAll('input[name="c_alive"]');
    const deathExtras = document.querySelectorAll('.c-death-extra');
    radios.forEach(r => {
      r.addEventListener('change', () => {
        if (r.checked && r.value === 'dead') {
          deathExtras.forEach(el => el.style.display = '');
        } else if (r.checked && r.value === 'alive') {
          deathExtras.forEach(el => el.style.display = 'none');
        }
      });
    });
    
    // ÁßçÈ∏ΩÁ±ªÂûãÂàáÊç¢ÔºöÊòæÁ§∫/ÈöêËóèÂâçÈ∏Ω‰∏ªÂíåÂâçÂú∞Âå∫Â≠óÊÆµ
    const typeSelect = document.getElementById('c_type');
    const breederExtra = document.getElementById('c_breederExtra');
    const breederExtraDesc = document.getElementById('c_breederExtraDesc');
    const breederExtraFields = document.getElementById('c_breederExtraFields');
    
    function toggleBreederFields() {
      const isBreeder = typeSelect.value === 'ÁßçÈ∏Ω';
      if (breederExtra) breederExtra.style.display = isBreeder ? '' : 'none';
      if (breederExtraDesc) breederExtraDesc.style.display = isBreeder ? '' : 'none';
      if (breederExtraFields) breederExtraFields.style.display = isBreeder ? '' : 'none';
    }
    
    typeSelect.addEventListener('change', toggleBreederFields);
    toggleBreederFields();
    
    // ÂàùÂßãÂåñÈ∏Ω‰∏ª‰∏ãÊãâÂàóË°®
    updateOwnerDatalist('c_ownerList');
    
    // Áé∞È∏Ω‰∏ªËæìÂÖ•ÂèòÂåñÊó∂Êõ¥Êñ∞Âú∞Âå∫‰∏ãÊãâÂàóË°®
    const currentOwnerInput = document.getElementById('c_currentOwner');
    const currentRegionInput = document.getElementById('c_currentRegion');
    
    function handleOwnerChange() {
      const owner = currentOwnerInput.value.trim();
      updateRegionDatalist(owner, 'c_regionList');
      
      // Â¶ÇÊûúÈÄâÊã©ÊùéÂõΩËæâÔºåËá™Âä®Â°´ÂÖÖË¥µÂ∑ûÈªîË•ø
      if (owner === 'ÊùéÂõΩËæâ') {
        currentRegionInput.value = 'Ë¥µÂ∑ûÈªîË•ø';
      }
    }
    
    currentOwnerInput.addEventListener('input', handleOwnerChange);
    currentOwnerInput.addEventListener('change', handleOwnerChange);
    
    // Áé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫ÈÉΩÂ°´ÂÜôÂêéÔºåÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶Å‰øùÂ≠òÈÖçÂØπ
    let ownerRegionTimer = null;
    currentOwnerInput.addEventListener('input', () => {
      clearTimeout(ownerRegionTimer);
      ownerRegionTimer = setTimeout(() => {
        const owner = currentOwnerInput.value.trim();
        const region = currentRegionInput.value.trim();
        if (owner && region) {
          addOwnerRegionPair(owner, region);
          updateOwnerDatalist('c_ownerList');
          updateRegionDatalist(owner, 'c_regionList');
        }
      }, 1000);
    });
    
    currentRegionInput.addEventListener('input', () => {
      clearTimeout(ownerRegionTimer);
      ownerRegionTimer = setTimeout(() => {
        const owner = currentOwnerInput.value.trim();
        const region = currentRegionInput.value.trim();
        if (owner && region) {
          addOwnerRegionPair(owner, region);
          updateOwnerDatalist('c_ownerList');
          updateRegionDatalist(owner, 'c_regionList');
        }
      }, 1000);
    });
  }

  // ÂèÇËµõËÆ∞ÂΩïÔºöÁîüÊàê‰∏ÄÊù°Ë°®ÂçïÈ°πÔºàÊñ∞Â¢ûÊ®°ÂºèÔºâ
  function createRaceFormItem(container, race = {}, onRemove) {
    const item = document.createElement('div');
    item.className = 'race-item';

    const header = document.createElement('div');
    header.className = 'race-header';
    const title = document.createElement('div');
    title.textContent = race.name || 'Êñ∞ÂèÇËµõËÆ∞ÂΩï';
    header.appendChild(title);
    const btnDel = document.createElement('button');
    btnDel.className = 'btn btn-ghost btn-sm';
    btnDel.textContent = 'Âà†Èô§';
    btnDel.type = 'button';
    btnDel.onclick = () => {
      if (onRemove) onRemove();
      container.removeChild(item);
    };
    header.appendChild(btnDel);
    item.appendChild(header);

    const fields = document.createElement('div');
    fields.className = 'race-fields';

    const fName = document.createElement('div');
    fName.innerHTML = '<label style="font-size:12px;color:#777;">ÊØîËµõÂêçÁß∞</label>';
    const iName = document.createElement('input');
    iName.type = 'text';
    iName.value = race.name || '';
    iName.placeholder = 'Â¶ÇÔºö500ÂÖ¨ÈáåËÅîËµõ';
    iName.style.width = '100%';
    fName.appendChild(iName);
    fields.appendChild(fName);

    const fDate = document.createElement('div');
    fDate.innerHTML = '<label style="font-size:12px;color:#777;">ÊØîËµõÊó∂Èó¥</label>';
    const iDate = document.createElement('input');
    iDate.type = 'date';
    iDate.value = race.date || '';
    iDate.style.width = '100%';
    fDate.appendChild(iDate);
    fields.appendChild(fDate);

    const fDist = document.createElement('div');
    fDist.innerHTML = '<label style="font-size:12px;color:#777;">ÊØîËµõË∑ùÁ¶ªÔºàÂÖ¨ÈáåÔºâ</label>';
    const iDist = document.createElement('input');
    iDist.type = 'number';
    iDist.value = race.distance || '';
    iDist.placeholder = 'Â¶ÇÔºö500';
    iDist.style.width = '100%';
    fDist.appendChild(iDist);
    fields.appendChild(fDist);

    const fRank = document.createElement('div');
    fRank.innerHTML = '<label style="font-size:12px;color:#777;">ÂêçÊ¨°</label>';
    const iRank = document.createElement('input');
    iRank.type = 'number';
    iRank.value = race.rank || '';
    iRank.placeholder = 'Â¶ÇÔºö1';
    iRank.style.width = '100%';
    fRank.appendChild(iRank);
    fields.appendChild(fRank);

    const fTotal = document.createElement('div');
    fTotal.innerHTML = '<label style="font-size:12px;color:#777;">ÂèÇËµõÊÄªÁæΩÊï∞</label>';
    const iTotal = document.createElement('input');
    iTotal.type = 'number';
    iTotal.value = race.total || '';
    iTotal.placeholder = 'Â¶ÇÔºö2000';
    iTotal.style.width = '100%';
    fTotal.appendChild(iTotal);
    fields.appendChild(fTotal);

    const fRemark = document.createElement('div');
    fRemark.innerHTML = '<label style="font-size:12px;color:#777;">Â§áÊ≥®</label>';
    const iRemark = document.createElement('input');
    iRemark.type = 'text';
    iRemark.value = race.remark || '';
    iRemark.placeholder = 'Â¶ÇÔºöÈÄÜÈ£é„ÄÅÈõ®Â§©Á≠âÊÉÖÂÜµËØ¥Êòé';
    iRemark.style.width = '100%';
    fRemark.appendChild(iRemark);
    fields.appendChild(fRemark);

    item.appendChild(fields);

    item.getValue = () => ({
      name: iName.value.trim(),
      date: iDate.value,
      distance: iDist.value,
      rank: iRank.value,
      total: iTotal.value,
      remark: iRemark.value.trim()
    });

    // ËÆ©Ê†áÈ¢òÈöèÊØîËµõÂêçÁß∞ÂèòÂåñ
    iName.addEventListener('input', () => {
      title.textContent = iName.value.trim() || 'Êñ∞ÂèÇËµõËÆ∞ÂΩï';
    });

    container.appendChild(item);
    return item;
  }

  // Êñ∞Â¢ûËßÜÂõæÈÄªËæë
  const cRaceList = document.getElementById('c_raceList');
  document.getElementById('btnAddRaceCreate').onclick = () => {
    createRaceFormItem(cRaceList);
  };

  document.getElementById('btnCancelCreate').onclick = () => {
    if (!confirm('ÂèñÊ∂àÂêéÂΩìÂâçÂ°´ÂÜôÂÜÖÂÆπÂ∞Ü‰ºö‰∏¢Â§±ÔºåÁ°ÆÂÆöÂêóÔºü')) return;
    clearCreateForm();
    switchView('listView');
  };

  function clearCreateForm() {
    document.getElementById('c_name').value = '';
    document.getElementById('c_ring').value = '';
    document.getElementById('c_gender').value = '';
    document.getElementById('c_color').value = '';
    document.getElementById('c_birth').value = '';
    document.getElementById('c_type').value = '';
    document.getElementById('c_father').value = '';
    document.getElementById('c_mother').value = '';
    document.querySelector('input[name="c_alive"][value="alive"]').checked = true;
    document.querySelectorAll('.c-death-extra').forEach(el => el.style.display = 'none');
    document.getElementById('c_death_date').value = '';
    document.getElementById('c_death_reason').value = '';
    const coreEl = document.getElementById('c_core');
    if (coreEl) coreEl.checked = false;
    cRaceList.innerHTML = '';
    // Ê∏ÖÁ©∫ÁßçÈ∏Ω‰∏ìÁî®Â≠óÊÆµ
    if (document.getElementById('c_previousOwner')) document.getElementById('c_previousOwner').value = '';
    if (document.getElementById('c_previousRegion')) document.getElementById('c_previousRegion').value = '';
    // Ê∏ÖÁ©∫Áé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫
    if (document.getElementById('c_currentOwner')) document.getElementById('c_currentOwner').value = '';
    if (document.getElementById('c_currentRegion')) document.getElementById('c_currentRegion').value = '';
    // ÈöêËóèÁßçÈ∏ΩÂ≠óÊÆµ
    const breederExtra = document.getElementById('c_breederExtra');
    const breederExtraDesc = document.getElementById('c_breederExtraDesc');
    const breederExtraFields = document.getElementById('c_breederExtraFields');
    if (breederExtra) breederExtra.style.display = 'none';
    if (breederExtraDesc) breederExtraDesc.style.display = 'none';
    if (breederExtraFields) breederExtraFields.style.display = 'none';
  }

  document.getElementById('btnSaveCreate').onclick = async () => {
    const ring = document.getElementById('c_ring').value.trim();
    if (!ring) {
      alert('Ë∂≥ÁéØÂè∑Á†Å‰∏∫ÂøÖÂ°´È°π„ÄÇ');
      return;
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÊ¥ªÁùÄÁöÑÈ∏ΩÂ≠ê‰ΩøÁî®ËØ•Ë∂≥ÁéØÂè∑
    const existingAlive = getPigeonByRing(ring);
    if (existingAlive) {
      alert('ËØ•Ë∂≥ÁéØÂè∑Á†ÅÂ∑≤Ë¢´Ê¥ªÁùÄÁöÑÈ∏ΩÂ≠ê‰ΩøÁî®ÔºåËØ∑Á°ÆËÆ§ÊòØÂê¶ÈáçÂ§ç„ÄÇ');
      return;
    }

    // Ê£ÄÊü•ÊòØÂê¶ÊúâÂ∑≤Ê≠ª‰∫°ÁöÑÈ∏ΩÂ≠ê‰ΩøÁî®ËØ•Ë∂≥ÁéØÂè∑ÔºàÂõûÊî∂‰ΩøÁî®Ôºâ
    const allWithRing = getAllPigeonsByRing(ring);
    const deadPigeons = allWithRing.filter(p => !p.alive);
    if (deadPigeons.length > 0) {
      // Â∞Ü‰πãÂâç‰ΩøÁî®ËØ•Ë∂≥ÁéØÂè∑ÁöÑÂ∑≤Ê≠ª‰∫°È∏ΩÂ≠êÊ†áËÆ∞‰∏∫"ÂõûÊî∂‰ΩøÁî®"
      deadPigeons.forEach(p => {
        p.ringRecycled = true;
        p.recycledDate = new Date().toISOString().slice(0, 10);
      });
      if (!confirm(`ËØ•Ë∂≥ÁéØÂè∑ÊõæË¢´Â∑≤Ê≠ª‰∫°ÁöÑÈ∏ΩÂ≠ê‰ΩøÁî®ËøáÔºåÁ≥ªÁªüÂ∞ÜËá™Âä®Ê†áËÆ∞‰∏∫"ÂõûÊî∂‰ΩøÁî®"„ÄÇÊòØÂê¶ÁªßÁª≠Ôºü`)) {
        return;
      }
    }
    let name = document.getElementById('c_name').value.trim();
    // Â¶ÇÊûúÂêçÁß∞‰∏∫Á©∫ÔºåËá™Âä®ÂàÜÈÖç‰∏Ä‰∏™Êú™‰ΩøÁî®ÁöÑÂêçÂ≠ó
    if (!name) {
      name = getRandomUnusedName();
      if (!name) {
        alert('ÊâÄÊúâÂèØÁî®ÂêçÂ≠óÈÉΩÂ∑≤‰ΩøÁî®ÂÆåÊØïÔºåËØ∑ÊâãÂä®ËæìÂÖ•‰∏Ä‰∏™ÂêçÂ≠ó„ÄÇ');
        return;
      }
    } else {
      // Â¶ÇÊûúÊâãÂä®ËæìÂÖ•ÁöÑÂêçÂ≠óÂú®ÂàóË°®‰∏≠Ôºå‰πüÊ†áËÆ∞‰∏∫Â∑≤‰ΩøÁî®
      const usedNames = loadUsedNames();
      if (PIGEON_NAMES.includes(name) && !usedNames.has(name)) {
        usedNames.add(name);
        saveUsedNames(usedNames);
      }
    }
    const gender = document.getElementById('c_gender').value;
    const color = document.getElementById('c_color').value.trim();
    const birth = document.getElementById('c_birth').value;
    const type = document.getElementById('c_type').value;
    const fatherId = document.getElementById('c_father').value || null;
    const motherId = document.getElementById('c_mother').value || null;
    const aliveRadio = document.querySelector('input[name="c_alive"]:checked').value;
    const alive = aliveRadio === 'alive';
    const deathDate = alive ? null : document.getElementById('c_death_date').value;
    const deathReason = alive ? '' : document.getElementById('c_death_reason').value.trim();
    if (!alive && !deathDate) {
      alert('Â∑≤Ê≠ª‰∫°Áä∂ÊÄÅ‰∏ãÔºåÊ≠ª‰∫°Êó•Êúü‰∏∫ÂøÖÂ°´„ÄÇ');
      return;
    }
    
    // Ëé∑ÂèñÁßçÈ∏Ω‰∏ìÁî®‰ø°ÊÅØ
    const previousOwner = type === 'ÁßçÈ∏Ω' ? (document.getElementById('c_previousOwner')?.value.trim() || '') : '';
    const previousRegion = type === 'ÁßçÈ∏Ω' ? (document.getElementById('c_previousRegion')?.value.trim() || '') : '';
    
    // Ëé∑ÂèñÁé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫
    const currentOwner = document.getElementById('c_currentOwner')?.value.trim() || '';
    const currentRegion = document.getElementById('c_currentRegion')?.value.trim() || '';
    
    // ËÆ∞ÂΩïÈ∏Ω‰∏ª-Âú∞Âå∫ÈÖçÂØπ
    if (currentOwner && currentRegion) {
      addOwnerRegionPair(currentOwner, currentRegion);
    }

    const races = [];
    cRaceList.querySelectorAll('.race-item').forEach(item => {
      races.push(item.getValue());
    });

    const bodyFile = document.getElementById('c_body_photo').files[0] || null;
    const eyeFile = document.getElementById('c_eye_photo').files[0] || null;

    let bodyImg = null;
    let eyeImg = null;
    if (bodyFile) {
      try {
        if (!bodyFile.type || !bodyFile.type.startsWith('image/')) {
          alert('Á´ôÁ´ã‰æßË∫´ÂõæÁâáÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂ÔºàJPG„ÄÅPNG„ÄÅGIF„ÄÅWEBPÁ≠âÔºâ„ÄÇ');
          return;
        }
        bodyImg = await readFileAsDataURL(bodyFile);
      } catch (e) {
        console.error('ËØªÂèñÁ´ôÁ´ã‰æßË∫´ÂõæÁâáÂ§±Ë¥•', e);
        alert('ËØªÂèñÁ´ôÁ´ã‰æßË∫´ÂõæÁâáÂ§±Ë¥•Ôºö' + (e.message || 'Êú™Áü•ÈîôËØØ') + 'ÔºåËØ∑ÈáçËØï„ÄÇ');
        return;
      }
    }
    if (eyeFile) {
      try {
        if (!eyeFile.type || !eyeFile.type.startsWith('image/')) {
          alert('ÁúºÁùõÁâπÂÜôÂõæÁâáÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂ÔºàJPG„ÄÅPNG„ÄÅGIF„ÄÅWEBPÁ≠âÔºâ„ÄÇ');
          return;
        }
        eyeImg = await readFileAsDataURL(eyeFile);
      } catch (e) {
        console.error('ËØªÂèñÁúºÁùõÂõæÁâáÂ§±Ë¥•', e);
        alert('ËØªÂèñÁúºÁùõÂõæÁâáÂ§±Ë¥•Ôºö' + (e.message || 'Êú™Áü•ÈîôËØØ') + 'ÔºåËØ∑ÈáçËØï„ÄÇ');
        return;
      }
    }

    const pigeon = {
      id: generateId(),
      ring,
      name,
      gender,
      color,
      birth,
      type,
      fatherId,
      motherId,
      alive,
      deathDate,
      deathReason,
      isCore: !!document.getElementById('c_core')?.checked,
      races,
      images: {
        body: bodyImg,
        eye: eyeImg
      },
      ringRecycled: deadPigeons && deadPigeons.length > 0, // Ê†áËÆ∞‰∏∫Êñ∞‰ΩøÁî®ÁöÑÂõûÊî∂Ë∂≥ÁéØÂè∑
      previousOwner: previousOwner, // ÂâçÈ∏Ω‰∏ªÔºà‰ªÖÁßçÈ∏ΩÔºâ
      previousRegion: previousRegion, // ÂâçÂú∞Âå∫Ôºà‰ªÖÁßçÈ∏ΩÔºâ
      currentOwner: currentOwner, // Áé∞È∏Ω‰∏ª
      currentRegion: currentRegion // Áé∞Âú∞Âå∫
    };
    pigeons.push(pigeon);
    saveToStorage();
    alert('‰øùÂ≠òÊàêÂäüÔºåÂ∑≤ÁîüÊàêÊ°£Ê°à„ÄÇ');
    clearCreateForm();
    refreshList();
    refreshStats();
    refreshDashboard();
    refreshPedigreeView(); // Âà∑Êñ∞Ë°ÄÁªüÂÖ≥Á≥ªËßÜÂõæ
    openDetail(pigeon.id);
  };

  document.getElementById('btnGoCreate').onclick = () => {
    setupCreateForm();
    switchView('createView');
  };

  // ËØ¶ÊÉÖËßÜÂõæÔºöÊµèËßà + ÁºñËæë
  const dTitle = document.getElementById('d_title');
  const dSubtitle = document.getElementById('d_subtitle');
  const dStatusRow = document.getElementById('d_statusRow');
  const dBasic = document.getElementById('d_basic');
  const dPedigree = document.getElementById('d_pedigree');
  const dRaces = document.getElementById('d_races');
  const dImages = document.getElementById('d_images');
  const dPedigreeTree = document.getElementById('d_pedigreeTree');
  const browseMode = document.getElementById('browseMode');
  const editMode = document.getElementById('editMode');
  const dEditNotice = document.getElementById('d_editNotice');
  const btnToggleEdit = document.getElementById('btnToggleEdit');

  function openDetail(id) {
    currentDetailId = id;
    renderDetail();
    switchView('detailView');
  }

  function renderDetail() {
    const p = getPigeonById(currentDetailId);
    if (!p) return;

    dTitle.textContent = p.name || p.ring;
    dSubtitle.innerHTML = `Ë∂≥ÁéØÂè∑Ôºö${p.ring}` +
      (p.ringRecycled ? `„ÄÄ<span class="badge-small" style="background:#fff3cd;color:#856404;">ÂõûÊî∂‰ΩøÁî®</span>` : '') +
      (p.type ? `„ÄÄ<span class="badge-small">${p.type}</span>` : '') +
      (p.isCore ? `„ÄÄ<span class="badge-small">Ê†∏ÂøÉÁßçÈ∏Ω ‚≠ê</span>` : '');

    dStatusRow.innerHTML = '';
    const aliveSpan = document.createElement('span');
    if (p.alive) {
      aliveSpan.className = 'tag tag-alive';
      aliveSpan.textContent = 'Âú®‰∏ñ';
    } else {
      aliveSpan.className = 'tag tag-dead';
      aliveSpan.textContent = 'Â∑≤Ê≠ª‰∫°';
      const extra = document.createElement('span');
      extra.className = 'status-dead';
      extra.textContent = (p.deathDate ? `Ôºà${p.deathDate}` : 'Ôºà') +
        (p.deathReason ? `Ôºå${p.deathReason}` : '') + 'Ôºâ';
      dStatusRow.appendChild(extra);
    }
    dStatusRow.appendChild(aliveSpan);

    // Âü∫Êú¨‰ø°ÊÅØ
    dBasic.innerHTML = '';
    // Á°Æ‰øùÂêçÂ≠óÂ≠òÂú®ÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®ÂàôËá™Âä®ÂàÜÈÖç
    if (!p.name || p.name.trim() === '') {
      const newName = getRandomUnusedName();
      if (newName) {
        p.name = newName;
        saveToStorage();
      }
    }
    const fields = [
      ['È∏ΩÂ≠êÂêçÁß∞', p.name || '‚Äî'],
      ['Ë∂≥ÁéØÂè∑Á†Å', p.ring],
      ['ÊÄßÂà´', p.gender || '‚Äî'],
      ['ÁæΩËâ≤', p.color || '‚Äî'],
      ['Âá∫ÁîüÊó•Êúü', formatDate(p.birth) || '‚Äî'],
      ['È∏ΩÂ≠êÁ±ªÂûã', p.type || '‚Äî']
    ];
    fields.forEach(([label, value]) => {
      const row = document.createElement('div');
      row.className = 'field-row';
      const l = document.createElement('div');
      l.className = 'field-label';
      l.textContent = label + 'Ôºö';
      const v = document.createElement('div');
      v.className = 'field-value';
      v.textContent = value;
      row.appendChild(l);
      row.appendChild(v);
      dBasic.appendChild(row);
    });
    // ‰∏∫Âü∫Êú¨‰ø°ÊÅØÂå∫ÂüüÊ∑ªÂä†ÂÆπÂô®Ê†∑Âºè
    if (dBasic && !dBasic.classList.contains('detail-section')) {
      dBasic.style.cssText = 'background:#fff; border-radius:8px; padding:16px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,0.05);';
    }

    // ÂõæÁâáÂå∫Ôºà‰ª•ÂõæÁâá‰∏∫‰∏ªÔºâ
    dImages.innerHTML = '';
    const imgWrap = document.createElement('div');
    
    // Ê£ÄÊü•Áî®Êà∑‰∏ä‰º†ÁöÑÂõæÁâá
    const hasCustomBody = p.images && p.images.body;
    const hasCustomEye = p.images && p.images.eye;
    
    // Á°ÆÂÆöÊòæÁ§∫ÁöÑÂõæÁâáÊ∫ê
    const bodySrc = hasCustomBody ? p.images.body : DEFAULT_BODY_IMG;
    const eyeSrc = hasCustomEye ? p.images.eye : DEFAULT_EYE_IMG;
    
    // Â¶ÇÊûúÂè™Êúâ‰∏ÄÂº†Ëá™ÂÆö‰πâÂõæÁâáÔºåÂ±Ö‰∏≠ÊòæÁ§∫
    const singleImage = (hasCustomBody && !hasCustomEye) || (!hasCustomBody && hasCustomEye);
    
    if (singleImage) {
      imgWrap.style.cssText = 'display:flex; justify-content:center; align-items:center; margin-top:8px;';
    } else {
      imgWrap.className = 'images-grid';
    }

    // ÂàõÂª∫ÂõæÁâáÂç°ÁâáÁöÑÂáΩÊï∞
    function createImageCard(imgSrc, label, isCustom, uploadFieldId) {
      const card = document.createElement('div');
      card.className = 'image-thumb';
      card.style.position = 'relative';
      if (singleImage) {
        card.style.margin = '0 auto';
      }
      
      const imgEl = document.createElement('img');
      imgEl.src = imgSrc;
      imgEl.onerror = function() {
        // Â¶ÇÊûúÂõæÁâáÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®Âç†‰ΩçÁ¨¶
        this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjE4IiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+6IOM5pif5LiK6IOM5bmy5LqG5piv6Z2i6K+V6L6T5YWlPC90ZXh0Pjwvc3ZnPg==';
      };
      card.appendChild(imgEl);
      
      const badge = document.createElement('div');
      badge.className = 'badge';
      badge.textContent = label;
      card.appendChild(badge);
      
      // ÂßãÁªàÊòæÁ§∫‰∏ä‰º†ÂÖ•Âè£ÔºàÂç≥‰ΩøÊúâËá™ÂÆö‰πâÂõæÁâáÔºâ
      const uploadHint = document.createElement('div');
      uploadHint.style.cssText = 'position:absolute; top:10px; right:10px; background:rgba(43,92,255,0.9); color:#fff; padding:6px 12px; border-radius:6px; font-size:12px; cursor:pointer; z-index:10; transition:all 0.2s;';
      uploadHint.textContent = isCustom ? 'üîÑ Êõ¥Êç¢ÂõæÁâá' : 'üì∑ ‰∏ä‰º†ÂõæÁâá';
      uploadHint.onmouseover = function() { this.style.background = 'rgba(43,92,255,1)'; };
      uploadHint.onmouseout = function() { this.style.background = 'rgba(43,92,255,0.9)'; };
      uploadHint.onclick = () => {
        setEditMode(true);
        setTimeout(() => {
          document.getElementById(uploadFieldId).scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
      };
      card.appendChild(uploadHint);
      
      return card;
    }

    // Ê†πÊçÆÊÉÖÂÜµÊòæÁ§∫ÂõæÁâá
    if (singleImage) {
      // Âè™ÊòæÁ§∫‰∏ÄÂº†ÂõæÁâáÔºàÁî®Êà∑‰∏ä‰º†ÁöÑÈÇ£Âº†Ôºâ
      if (hasCustomBody) {
        imgWrap.appendChild(createImageCard(bodySrc, 'Á´ôÁ´ã‰æßË∫´Âõæ', true, 'e_body_photo'));
      } else if (hasCustomEye) {
        imgWrap.appendChild(createImageCard(eyeSrc, 'ÁúºÁùõÁâπÂÜô', true, 'e_eye_photo'));
      }
    } else {
      // ÊòæÁ§∫‰∏§Âº†ÂõæÁâáÔºàÈÉΩÊúâÊàñÈÉΩÊ≤°ÊúâÔºâ
      imgWrap.appendChild(createImageCard(bodySrc, 'Á´ôÁ´ã‰æßË∫´Âõæ', hasCustomBody, 'e_body_photo'));
      imgWrap.appendChild(createImageCard(eyeSrc, 'ÁúºÁùõÁâπÂÜô', hasCustomEye, 'e_eye_photo'));
    }

    dImages.appendChild(imgWrap);
    
    // Â¶ÇÊûú‰∏§Âº†ÂõæÁâáÈÉΩÊú™‰∏ä‰º†ÔºåÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
    if (!hasCustomBody && !hasCustomEye) {
      const tipDiv = document.createElement('div');
      tipDiv.style.cssText = 'text-align:center; margin-top:12px; padding:12px; background:#f0f7ff; border-radius:8px; color:#2b5cff; font-size:13px;';
      tipDiv.innerHTML = 'üí° ÊèêÁ§∫ÔºöÂΩìÂâçÊòæÁ§∫ÁöÑÊòØÁ§∫‰æãÂõæÁâáÔºåÁÇπÂáªÂõæÁâáÂè≥‰∏äËßíÁöÑ"üì∑ ‰∏ä‰º†ÂõæÁâá"ÊåâÈíÆÊàñ‰ΩøÁî®"ÁºñËæë‰ø°ÊÅØ"ÂäüËÉΩ‰∏ä‰º†Ëá™ÂÆö‰πâÂõæÁâá„ÄÇ';
      dImages.appendChild(tipDiv);
    }

    // Ë°ÄÁªüÊ†ëÂèØËßÜÂåñ
    if (dPedigreeTree) renderPedigreeTree(p);

    // Ë°ÄÁªü‰ø°ÊÅØ
    dPedigree.innerHTML = '';
    const father = p.fatherId ? getPigeonById(p.fatherId) : null;
    const mother = p.motherId ? getPigeonById(p.motherId) : null;
    
    // Á°Æ‰øùÁà∂È∏ΩÂíåÊØçÈ∏ΩÈÉΩÊúâÂêçÂ≠ó
    if (father && (!father.name || father.name.trim() === '')) {
      const newName = getRandomUnusedName();
      if (newName) {
        father.name = newName;
        saveToStorage();
      }
    }
    if (mother && (!mother.name || mother.name.trim() === '')) {
      const newName = getRandomUnusedName();
      if (newName) {
        mother.name = newName;
        saveToStorage();
      }
    }
    
    const rowF = document.createElement('div');
    rowF.className = 'field-row';
    const labelF = document.createElement('div');
    labelF.className = 'field-label';
    labelF.textContent = 'Áà∂È∏ΩÔºö';
    const valueF = document.createElement('div');
    valueF.className = 'field-value';
    if (father) {
      // ÊòæÁ§∫ÂêçÂ≠óÔºåÂ¶ÇÊûúÊ≤°ÊúâÂêçÂ≠óÂàôÊòæÁ§∫Ë∂≥ÁéØÂè∑
      valueF.innerHTML = `${father.name || father.ring}${father.name && father.ring ? 'Ôºà' + father.ring + 'Ôºâ' : ''}`;
      valueF.style.cursor = 'pointer';
      valueF.style.color = '#2b5cff';
      valueF.style.textDecoration = 'underline';
      valueF.onclick = () => openDetail(father.id);
    } else {
      valueF.textContent = '‚Äî';
    }
    rowF.appendChild(labelF);
    rowF.appendChild(valueF);
    dPedigree.appendChild(rowF);
    
    const rowM = document.createElement('div');
    rowM.className = 'field-row';
    const labelM = document.createElement('div');
    labelM.className = 'field-label';
    labelM.textContent = 'ÊØçÈ∏ΩÔºö';
    const valueM = document.createElement('div');
    valueM.className = 'field-value';
    if (mother) {
      // ÊòæÁ§∫ÂêçÂ≠óÔºåÂ¶ÇÊûúÊ≤°ÊúâÂêçÂ≠óÂàôÊòæÁ§∫Ë∂≥ÁéØÂè∑
      valueM.innerHTML = `${mother.name || mother.ring}${mother.name && mother.ring ? 'Ôºà' + mother.ring + 'Ôºâ' : ''}`;
      valueM.style.cursor = 'pointer';
      valueM.style.color = '#2b5cff';
      valueM.style.textDecoration = 'underline';
      valueM.onclick = () => openDetail(mother.id);
    } else {
      valueM.textContent = '‚Äî';
    }
    rowM.appendChild(labelM);
    rowM.appendChild(valueM);
    dPedigree.appendChild(rowM);
    // ‰∏∫Ë°ÄÁªü‰ø°ÊÅØÂå∫ÂüüÊ∑ªÂä†ÂÆπÂô®Ê†∑Âºè
    if (dPedigree && !dPedigree.classList.contains('detail-section')) {
      dPedigree.style.cssText = 'background:#fff; border-radius:8px; padding:16px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,0.05);';
    }

    // È∏Ω‰∏ª‰ø°ÊÅØÔºàÂú®Ë°ÄÁªüÊ†ëÂèØËßÜÂåñ‰πãÂâçÊèíÂÖ•Ôºâ
    const dOwnerInfo = document.createElement('div');
    
    // ÁßçÈ∏ΩÁöÑÂâçÈ∏Ω‰∏ªÂíåÂâçÂú∞Âå∫Ôºà‰ªÖÂΩìÊúâÂÄºÊó∂ÊòæÁ§∫Ôºâ
    if (p.type === 'ÁßçÈ∏Ω' && (p.previousOwner || p.previousRegion)) {
      const sectionTitle = document.createElement('div');
      sectionTitle.className = 'section-title';
      sectionTitle.textContent = 'ÁßçÈ∏Ω‰ø°ÊÅØ';
      dOwnerInfo.appendChild(sectionTitle);
      
      if (p.previousOwner) {
        const rowPrevOwner = document.createElement('div');
        rowPrevOwner.className = 'field-row';
        const labelPrevOwner = document.createElement('div');
        labelPrevOwner.className = 'field-label';
        labelPrevOwner.textContent = 'ÂâçÈ∏Ω‰∏ªÔºö';
        const valuePrevOwner = document.createElement('div');
        valuePrevOwner.className = 'field-value';
        valuePrevOwner.textContent = p.previousOwner;
        rowPrevOwner.appendChild(labelPrevOwner);
        rowPrevOwner.appendChild(valuePrevOwner);
        dOwnerInfo.appendChild(rowPrevOwner);
      }
      
      if (p.previousRegion) {
        const rowPrevRegion = document.createElement('div');
        rowPrevRegion.className = 'field-row';
        const labelPrevRegion = document.createElement('div');
        labelPrevRegion.className = 'field-label';
        labelPrevRegion.textContent = 'ÂâçÂú∞Âå∫Ôºö';
        const valuePrevRegion = document.createElement('div');
        valuePrevRegion.className = 'field-value';
        valuePrevRegion.textContent = p.previousRegion;
        rowPrevRegion.appendChild(labelPrevRegion);
        rowPrevRegion.appendChild(valuePrevRegion);
        dOwnerInfo.appendChild(rowPrevRegion);
      }
    }
    
    // Áé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫ÔºàÊâÄÊúâÈ∏ΩÂ≠êÈÉΩÊúâÔºâ
    const sectionTitleCurrent = document.createElement('div');
    sectionTitleCurrent.className = 'section-title';
    sectionTitleCurrent.textContent = 'È∏Ω‰∏ª‰ø°ÊÅØ';
    dOwnerInfo.appendChild(sectionTitleCurrent);
    
    const rowCurrentOwner = document.createElement('div');
    rowCurrentOwner.className = 'field-row';
    const labelCurrentOwner = document.createElement('div');
    labelCurrentOwner.className = 'field-label';
    labelCurrentOwner.textContent = 'Áé∞È∏Ω‰∏ªÔºö';
    const valueCurrentOwner = document.createElement('div');
    valueCurrentOwner.className = 'field-value';
    valueCurrentOwner.textContent = p.currentOwner || '‚Äî';
    rowCurrentOwner.appendChild(labelCurrentOwner);
    rowCurrentOwner.appendChild(valueCurrentOwner);
    dOwnerInfo.appendChild(rowCurrentOwner);
    
    const rowCurrentRegion = document.createElement('div');
    rowCurrentRegion.className = 'field-row';
    const labelCurrentRegion = document.createElement('div');
    labelCurrentRegion.className = 'field-label';
    labelCurrentRegion.textContent = 'Áé∞Âú∞Âå∫Ôºö';
    const valueCurrentRegion = document.createElement('div');
    valueCurrentRegion.className = 'field-value';
    valueCurrentRegion.textContent = p.currentRegion || '‚Äî';
    rowCurrentRegion.appendChild(labelCurrentRegion);
    rowCurrentRegion.appendChild(valueCurrentRegion);
    dOwnerInfo.appendChild(rowCurrentRegion);
    // ‰∏∫È∏Ω‰∏ª‰ø°ÊÅØÂå∫ÂüüÊ∑ªÂä†ÂÆπÂô®Ê†∑Âºè
    dOwnerInfo.style.cssText = 'background:#fff; border-radius:8px; padding:16px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,0.05);';
    
    // Â∞ÜÈ∏Ω‰∏ª‰ø°ÊÅØÊèíÂÖ•Âà∞Ë°ÄÁªüÊ†ëÂèØËßÜÂåñ‰πãÂâç
    const browseMode = document.getElementById('browseMode');
    const pedigreeTreeSection = browseMode.querySelector('.section-title');
    if (pedigreeTreeSection && pedigreeTreeSection.textContent.includes('Ë°ÄÁªüÊ†ëÂèØËßÜÂåñ')) {
      browseMode.insertBefore(dOwnerInfo, pedigreeTreeSection);
    } else if (dPedigreeTree && dPedigreeTree.parentNode) {
      dPedigreeTree.parentNode.insertBefore(dOwnerInfo, dPedigreeTree);
    }

    // ÂèÇËµõËÆ∞ÂΩï
    dRaces.innerHTML = '';
    if (!p.races || p.races.length === 0) {
      dRaces.innerHTML = '<span class="muted">ÊöÇÊó†ÂèÇËµõËÆ∞ÂΩï„ÄÇ</span>';
    } else {
      p.races.forEach((r, idx) => {
        const item = document.createElement('div');
        item.className = 'race-item';
        const header = document.createElement('div');
        header.className = 'race-header';
        header.innerHTML = `<div>${r.name || 'Êú™ÂëΩÂêçÊØîËµõ'} <span class="muted">#${idx + 1}</span></div>`;
        item.appendChild(header);

        const fields = document.createElement('div');
        fields.className = 'race-fields';

        function addField(label, value) {
          const d = document.createElement('div');
          d.innerHTML = `<span class="muted">${label}</span><br>${value || '‚Äî'}`;
          fields.appendChild(d);
        }
        addField('ÊØîËµõÊó∂Èó¥', formatDate(r.date));
        addField('Ë∑ùÁ¶ªÔºàÂÖ¨ÈáåÔºâ', r.distance);
        addField('ÂêçÊ¨°', r.rank);
        addField('ÂèÇËµõÊÄªÁæΩÊï∞', r.total);
        addField('Â§áÊ≥®', r.remark);
        item.appendChild(fields);
        dRaces.appendChild(item);
      });
    }

    // ÈªòËÆ§ÂõûÂà∞ÊµèËßàÊ®°Âºè
    setEditMode(false);
  }

  // Ë°ÄÁªüÊ†ëÂèØËßÜÂåñÂáΩÊï∞
  function renderPedigreeTree(pigeon) {
    if (!dPedigreeTree) return;
    dPedigreeTree.innerHTML = '';

    // ÊûÑÂª∫Ë°ÄÁªüÊ†ëÊï∞ÊçÆ
    function buildTree(p, level = 0, maxLevel = 3) {
      if (!p || level >= maxLevel) return null;
      
      const node = {
        id: p.id,
        ring: p.ring,
        name: p.name,
        isCore: p.isCore,
        alive: p.alive,
        level: level
      };

      const father = p.fatherId ? getPigeonById(p.fatherId) : null;
      const mother = p.motherId ? getPigeonById(p.motherId) : null;

      node.father = father ? buildTree(father, level + 1, maxLevel) : null;
      node.mother = mother ? buildTree(mother, level + 1, maxLevel) : null;

      return node;
    }

    const tree = buildTree(pigeon);
    if (!tree) {
      dPedigreeTree.innerHTML = '<span class="muted">ÊöÇÊó†Ë°ÄÁªüÊ†ëÊï∞ÊçÆÔºàÈúÄË¶ÅËÆæÁΩÆÁà∂È∏ΩÂíåÊØçÈ∏Ω‰ø°ÊÅØÔºâ„ÄÇ</span>';
      return;
    }

    // Ê∏≤ÊüìÊ†ëÁªìÊûÑ
    function renderNode(node, container) {
      if (!node) return;

      const nodeEl = document.createElement('div');
      nodeEl.className = 'pedigree-node' + (node.isCore ? ' core' : '');
      nodeEl.textContent = `${node.ring}${node.name ? 'Ôºà' + node.name + 'Ôºâ' : ''}`;
      if (!node.alive) nodeEl.textContent += ' [Â∑≤Ê≠ª‰∫°]';
      nodeEl.onclick = () => {
        if (node.id !== currentDetailId) {
          openDetail(node.id);
        }
      };
      container.appendChild(nodeEl);

      if (node.father || node.mother) {
        const childrenContainer = document.createElement('div');
        childrenContainer.style.cssText = 'display:flex; gap:16px; margin-top:8px; justify-content:center;';
        
        if (node.father) {
          const fatherContainer = document.createElement('div');
          fatherContainer.style.cssText = 'text-align:center;';
          const fatherLabel = document.createElement('div');
          fatherLabel.textContent = 'Áà∂';
          fatherLabel.style.cssText = 'font-size:12px; color:#888; margin-bottom:4px;';
          fatherContainer.appendChild(fatherLabel);
          renderNode(node.father, fatherContainer);
          childrenContainer.appendChild(fatherContainer);
        }
        
        if (node.mother) {
          const motherContainer = document.createElement('div');
          motherContainer.style.cssText = 'text-align:center;';
          const motherLabel = document.createElement('div');
          motherLabel.textContent = 'ÊØç';
          motherLabel.style.cssText = 'font-size:12px; color:#888; margin-bottom:4px;';
          motherContainer.appendChild(motherLabel);
          renderNode(node.mother, motherContainer);
          childrenContainer.appendChild(motherContainer);
        }
        
        container.appendChild(childrenContainer);
      }
    }

    const treeContainer = document.createElement('div');
    treeContainer.style.cssText = 'text-align:center;';
    const currentLabel = document.createElement('div');
    currentLabel.textContent = 'ÂΩìÂâçÈ∏ΩÂ≠ê';
    currentLabel.style.cssText = 'font-size:14px; font-weight:600; color:#2b5cff; margin-bottom:8px;';
    treeContainer.appendChild(currentLabel);
    renderNode(tree, treeContainer);
    dPedigreeTree.appendChild(treeContainer);
  }

  // ‰øùÂ≠òÁºñËæëË°®ÂçïÁöÑÂàùÂßãÁä∂ÊÄÅÔºåÁî®‰∫éÊ£ÄÊµãÊòØÂê¶ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥Êîπ
  let editFormInitialState = null;
  let isEditFormDirty = false;

  // Ëé∑ÂèñÁºñËæëË°®ÂçïÁöÑÂΩìÂâçÁä∂ÊÄÅ
  function getEditFormState() {
    const p = getPigeonById(currentDetailId);
    if (!p) return null;
    
    return {
      name: document.getElementById('e_name')?.value.trim() || '',
      ring: document.getElementById('e_ring')?.value.trim() || '',
      gender: document.getElementById('e_gender')?.value || '',
      color: document.getElementById('e_color')?.value.trim() || '',
      birth: document.getElementById('e_birth')?.value || '',
      type: document.getElementById('e_type')?.value || '',
      isCore: document.getElementById('e_core')?.checked || false,
      previousOwner: document.getElementById('e_previousOwner')?.value.trim() || '',
      previousRegion: document.getElementById('e_previousRegion')?.value.trim() || '',
      currentOwner: document.getElementById('e_currentOwner')?.value.trim() || '',
      currentRegion: document.getElementById('e_currentRegion')?.value.trim() || '',
      fatherId: document.getElementById('e_father')?.value || null,
      motherId: document.getElementById('e_mother')?.value || null,
      alive: document.querySelector('input[name="e_alive"]:checked')?.value === 'alive',
      deathDate: document.getElementById('e_death_date')?.value || null,
      deathReason: document.getElementById('e_death_reason')?.value.trim() || '',
      bodyPhoto: document.getElementById('e_body_photo')?.files.length > 0,
      eyePhoto: document.getElementById('e_eye_photo')?.files.length > 0,
      races: Array.from(document.querySelectorAll('#e_raceList .race-item')).map(item => {
        try {
          return item.getValue ? item.getValue() : null;
        } catch (e) {
          return null;
        }
      }).filter(r => r !== null)
    };
  }

  // Ê£ÄÊµãÁºñËæëË°®ÂçïÊòØÂê¶ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥Êîπ
  function hasUnsavedChanges() {
    if (!editFormInitialState) return false;
    
    const currentState = getEditFormState();
    if (!currentState) return false;
    
    // ÊØîËæÉÊâÄÊúâÂ≠óÊÆµ
    const fields = ['name', 'ring', 'gender', 'color', 'birth', 'type', 'isCore', 
                    'previousOwner', 'previousRegion', 'currentOwner', 'currentRegion',
                    'fatherId', 'motherId', 'alive', 'deathDate', 'deathReason'];
    
    for (let field of fields) {
      if (editFormInitialState[field] !== currentState[field]) {
        return true;
      }
    }
    
    // Ê£ÄÊü•ÂõæÁâáÊòØÂê¶ÊúâÂèòÂåñ
    if (editFormInitialState.bodyPhoto !== currentState.bodyPhoto ||
        editFormInitialState.eyePhoto !== currentState.eyePhoto) {
      return true;
    }
    
    // Ê£ÄÊü•ÂèÇËµõËÆ∞ÂΩïÊòØÂê¶ÊúâÂèòÂåñ
    if (editFormInitialState.races.length !== currentState.races.length) {
      return true;
    }
    
    // ËØ¶ÁªÜÊØîËæÉÂèÇËµõËÆ∞ÂΩï
    for (let i = 0; i < Math.max(editFormInitialState.races.length, currentState.races.length); i++) {
      const oldRace = editFormInitialState.races[i];
      const newRace = currentState.races[i];
      if (!oldRace || !newRace) return true;
      if (JSON.stringify(oldRace) !== JSON.stringify(newRace)) {
        return true;
      }
    }
    
    return false;
  }

  // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ÈÄÄÂá∫ÁºñËæëÊ®°Âºè
  function canExitEditMode() {
    if (hasUnsavedChanges()) {
      return confirm('ÊÇ®ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥ÊîπÔºåÁ°ÆÂÆöË¶ÅÈÄÄÂá∫ÁºñËæëÈ°µÈù¢ÂêóÔºü\n\nÂ¶ÇÊûúÈÄÄÂá∫ÔºåÊâÄÊúâÊú™‰øùÂ≠òÁöÑÊõ¥ÊîπÂ∞Ü‰ºö‰∏¢Â§±„ÄÇ');
    }
    return true;
  }

  function setEditMode(isEdit) {
    if (isEdit) {
      browseMode.style.display = 'none';
      editMode.style.display = '';
      dEditNotice.style.display = '';
      btnToggleEdit.textContent = '‚Üê ËøîÂõûÊµèËßà';
      fillEditForm();
      // Âª∂Ëøü‰øùÂ≠òÂàùÂßãÁä∂ÊÄÅÔºåÁ°Æ‰øùË°®ÂçïÂ∑≤ÂÆåÂÖ®Â°´ÂÖÖÔºàÂåÖÊã¨Âä®ÊÄÅÊ∑ªÂä†ÁöÑÂèÇËµõËÆ∞ÂΩïÔºâ
      setTimeout(() => {
        editFormInitialState = getEditFormState();
        isEditFormDirty = false;
      }, 200);
      
      // ÁõëÂê¨Ë°®ÂçïÂèòÂåñ
      const editFormInputs = editMode.querySelectorAll('input, select, textarea');
      editFormInputs.forEach(input => {
        input.addEventListener('change', () => {
          isEditFormDirty = hasUnsavedChanges();
        });
        input.addEventListener('input', () => {
          isEditFormDirty = hasUnsavedChanges();
        });
      });
      
      // ÁõëÂê¨Âä®ÊÄÅÊ∑ªÂä†ÁöÑÂèÇËµõËÆ∞ÂΩïÂèòÂåñ
      const eRaceList = document.getElementById('e_raceList');
      if (eRaceList) {
        const observer = new MutationObserver(() => {
          isEditFormDirty = hasUnsavedChanges();
        });
        observer.observe(eRaceList, { childList: true, subtree: true });
      }
    } else {
      // ÈÄÄÂá∫ÁºñËæëÊ®°ÂºèÂâçÊ£ÄÊü•ÊòØÂê¶ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥Êîπ
      if (!canExitEditMode()) {
        return; // Áî®Êà∑ÂèñÊ∂àÈÄÄÂá∫
      }
      browseMode.style.display = '';
      editMode.style.display = 'none';
      dEditNotice.style.display = 'none';
      btnToggleEdit.textContent = '‚úè ÁºñËæë‰ø°ÊÅØ';
      editFormInitialState = null;
      isEditFormDirty = false;
    }
  }

  btnToggleEdit.onclick = () => {
    const editing = editMode.style.display !== 'none';
    if (editing) {
      // ‰ΩøÁî®Áªü‰∏ÄÁöÑÈÄÄÂá∫Ê£ÄÊü•ÂáΩÊï∞
      if (!canExitEditMode()) return;
      setEditMode(false);
    } else {
      setEditMode(true);
    }
  };

  document.getElementById('btnBackList').onclick = () => {
    if (editMode.style.display !== 'none') {
      // ‰ΩøÁî®Áªü‰∏ÄÁöÑÈÄÄÂá∫Ê£ÄÊü•ÂáΩÊï∞
      if (!canExitEditMode()) return;
      setEditMode(false);
    }
    switchView('listView');
  };

  // Âà†Èô§È∏ΩÂ≠êÂäüËÉΩ
  document.getElementById('btnDeletePigeon').onclick = () => {
    const p = getPigeonById(currentDetailId);
    if (!p) return;
    
    if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§„Äê${p.ring}${p.name ? 'Ôºà' + p.name + 'Ôºâ' : ''}„ÄëÁöÑÊâÄÊúâ‰ø°ÊÅØÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
      return;
    }

    const index = pigeons.findIndex(p2 => p2.id === currentDetailId);
    if (index !== -1) {
      pigeons.splice(index, 1);
      saveToStorage();
      refreshList();
      refreshStats();
      refreshDashboard();
      refreshPedigreeView(); // Âà∑Êñ∞Ë°ÄÁªüÂÖ≥Á≥ªËßÜÂõæ
      alert('Â∑≤Âà†Èô§ËØ•È∏ΩÂ≠êÁöÑÊâÄÊúâ‰ø°ÊÅØ„ÄÇ');
      switchView('listView');
    }
  };

  function fillEditForm() {
    const p = getPigeonById(currentDetailId);
    if (!p) return;

    document.getElementById('e_name').value = p.name || '';
    document.getElementById('e_ring').value = p.ring;
    document.getElementById('e_gender').value = p.gender || '';
    document.getElementById('e_color').value = p.color || '';
    document.getElementById('e_birth').value = p.birth || '';
    document.getElementById('e_type').value = p.type || '';
    const eCore = document.getElementById('e_core');
    if (eCore) eCore.checked = !!p.isCore;

    // ÁßçÈ∏ΩÁ±ªÂûãÂàáÊç¢ÔºöÊòæÁ§∫/ÈöêËóèÂâçÈ∏Ω‰∏ªÂíåÂâçÂú∞Âå∫Â≠óÊÆµ
    const typeSelect = document.getElementById('e_type');
    const breederExtra = document.getElementById('e_breederExtra');
    const breederExtraDesc = document.getElementById('e_breederExtraDesc');
    const breederExtraFields = document.getElementById('e_breederExtraFields');
    
    function toggleBreederFields() {
      const isBreeder = typeSelect.value === 'ÁßçÈ∏Ω';
      if (breederExtra) breederExtra.style.display = isBreeder ? '' : 'none';
      if (breederExtraDesc) breederExtraDesc.style.display = isBreeder ? '' : 'none';
      if (breederExtraFields) breederExtraFields.style.display = isBreeder ? '' : 'none';
    }
    
    typeSelect.addEventListener('change', toggleBreederFields);
    toggleBreederFields();
    
    // Â°´ÂÖÖÁßçÈ∏Ω‰∏ìÁî®‰ø°ÊÅØ
    if (document.getElementById('e_previousOwner')) {
      document.getElementById('e_previousOwner').value = p.previousOwner || '';
    }
    if (document.getElementById('e_previousRegion')) {
      document.getElementById('e_previousRegion').value = p.previousRegion || '';
    }
    
    // Â°´ÂÖÖÁé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫
    if (document.getElementById('e_currentOwner')) {
      document.getElementById('e_currentOwner').value = p.currentOwner || '';
    }
    if (document.getElementById('e_currentRegion')) {
      document.getElementById('e_currentRegion').value = p.currentRegion || '';
    }
    
    // ÂàùÂßãÂåñÈ∏Ω‰∏ª‰∏ãÊãâÂàóË°®
    updateOwnerDatalist('e_ownerList');
    if (p.currentOwner) {
      updateRegionDatalist(p.currentOwner, 'e_regionList');
    }
    
    // Áé∞È∏Ω‰∏ªËæìÂÖ•ÂèòÂåñÊó∂Êõ¥Êñ∞Âú∞Âå∫‰∏ãÊãâÂàóË°®
    const currentOwnerInput = document.getElementById('e_currentOwner');
    const currentRegionInput = document.getElementById('e_currentRegion');
    
    if (currentOwnerInput) {
      function handleOwnerChangeEdit() {
        const owner = currentOwnerInput.value.trim();
        updateRegionDatalist(owner, 'e_regionList');
        
        // Â¶ÇÊûúÈÄâÊã©ÊùéÂõΩËæâÔºåËá™Âä®Â°´ÂÖÖË¥µÂ∑ûÈªîË•ø
        if (owner === 'ÊùéÂõΩËæâ') {
          if (currentRegionInput) currentRegionInput.value = 'Ë¥µÂ∑ûÈªîË•ø';
        }
      }
      
      currentOwnerInput.addEventListener('input', handleOwnerChangeEdit);
      currentOwnerInput.addEventListener('change', handleOwnerChangeEdit);
      
      // Áé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫ÈÉΩÂ°´ÂÜôÂêéÔºåÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶Å‰øùÂ≠òÈÖçÂØπ
      let ownerRegionTimer = null;
      currentOwnerInput.addEventListener('input', () => {
        clearTimeout(ownerRegionTimer);
        ownerRegionTimer = setTimeout(() => {
          const owner = currentOwnerInput.value.trim();
          const region = currentRegionInput ? currentRegionInput.value.trim() : '';
          if (owner && region) {
            addOwnerRegionPair(owner, region);
            updateOwnerDatalist('e_ownerList');
            updateRegionDatalist(owner, 'e_regionList');
          }
        }, 1000);
      });
    }
    
    if (currentRegionInput) {
      let ownerRegionTimer = null;
      currentRegionInput.addEventListener('input', () => {
        clearTimeout(ownerRegionTimer);
        ownerRegionTimer = setTimeout(() => {
          const owner = currentOwnerInput ? currentOwnerInput.value.trim() : '';
          const region = currentRegionInput.value.trim();
          if (owner && region) {
            addOwnerRegionPair(owner, region);
            updateOwnerDatalist('e_ownerList');
            updateRegionDatalist(owner, 'e_regionList');
          }
        }, 1000);
      });
    }

    // Áà∂ÊØç‰∏ãÊãâ
    fillParentOptions(document.getElementById('e_father'), p.id);
    fillParentOptions(document.getElementById('e_mother'), p.id);
    document.getElementById('e_father').value = p.fatherId || '';
    document.getElementById('e_mother').value = p.motherId || '';

    // Áä∂ÊÄÅ
    const aliveRadios = document.querySelectorAll('input[name="e_alive"]');
    aliveRadios.forEach(r => {
      r.checked = (r.value === (p.alive ? 'alive' : 'dead'));
    });
    const deathExtras = document.querySelectorAll('.e-death-extra');
    if (p.alive) {
      deathExtras.forEach(el => el.style.display = 'none');
      document.getElementById('e_death_date').value = '';
      document.getElementById('e_death_reason').value = '';
    } else {
      deathExtras.forEach(el => el.style.display = '');
      document.getElementById('e_death_date').value = p.deathDate || '';
      document.getElementById('e_death_reason').value = p.deathReason || '';
    }
    aliveRadios.forEach(r => {
      r.onchange = () => {
        if (r.checked && r.value === 'dead') {
          deathExtras.forEach(el => el.style.display = '');
        } else if (r.checked && r.value === 'alive') {
          deathExtras.forEach(el => el.style.display = 'none');
        }
      };
    });

    // ÂèÇËµõËÆ∞ÂΩï
    const eRaceList = document.getElementById('e_raceList');
    eRaceList.innerHTML = '';
    (p.races || []).forEach((r, index) => {
      createRaceFormItem(eRaceList, r, () => {
        p.races.splice(index, 1);
      });
    });
  }

  document.getElementById('btnAddRaceEdit').onclick = () => {
    const eRaceList = document.getElementById('e_raceList');
    createRaceFormItem(eRaceList);
  };

  document.getElementById('btnCancelEdit').onclick = () => {
    // ‰ΩøÁî®Áªü‰∏ÄÁöÑÈÄÄÂá∫Ê£ÄÊü•ÂáΩÊï∞
    if (!canExitEditMode()) return;
    setEditMode(false);
  };

  document.getElementById('btnSaveEdit').onclick = async () => {
    const p = getPigeonById(currentDetailId);
    if (!p) return;

    // Ê£ÄÊü•Ë∂≥ÁéØÂè∑ÊòØÂê¶‰øÆÊîπ
    const newRing = document.getElementById('e_ring').value.trim();
    if (!newRing) {
      alert('Ë∂≥ÁéØÂè∑Á†Å‰∏∫ÂøÖÂ°´È°π„ÄÇ');
      return;
    }
    
    // Â¶ÇÊûúË∂≥ÁéØÂè∑Ë¢´‰øÆÊîπÔºåÊ£ÄÊü•Êñ∞Âè∑Á†ÅÊòØÂê¶Â∑≤Ë¢´ÂÖ∂‰ªñÊ¥ªÁùÄÁöÑÈ∏ΩÂ≠ê‰ΩøÁî®
    if (newRing !== p.ring) {
      const existingAlive = getPigeonByRing(newRing);
      if (existingAlive && existingAlive.id !== p.id) {
        alert('ËØ•Ë∂≥ÁéØÂè∑Á†ÅÂ∑≤Ë¢´ÂÖ∂‰ªñÊ¥ªÁùÄÁöÑÈ∏ΩÂ≠ê‰ΩøÁî®ÔºåËØ∑‰ΩøÁî®ÂÖ∂‰ªñÂè∑Á†Å„ÄÇ');
        return;
      }
    }

    const name = document.getElementById('e_name').value.trim();
    const gender = document.getElementById('e_gender').value;
    const color = document.getElementById('e_color').value.trim();
    const birth = document.getElementById('e_birth').value;
    const type = document.getElementById('e_type').value;
    const fatherId = document.getElementById('e_father').value || null;
    const motherId = document.getElementById('e_mother').value || null;
    const aliveRadio = document.querySelector('input[name="e_alive"]:checked').value;
    const alive = aliveRadio === 'alive';
    const deathDate = alive ? null : document.getElementById('e_death_date').value;
    const deathReason = alive ? '' : document.getElementById('e_death_reason').value.trim();
    if (!alive && !deathDate) {
      alert('Â∑≤Ê≠ª‰∫°Áä∂ÊÄÅ‰∏ãÔºåÊ≠ª‰∫°Êó•Êúü‰∏∫ÂøÖÂ°´„ÄÇ');
      return;
    }
    
    // Ëé∑ÂèñÁßçÈ∏Ω‰∏ìÁî®‰ø°ÊÅØ
    const previousOwner = type === 'ÁßçÈ∏Ω' ? (document.getElementById('e_previousOwner')?.value.trim() || '') : '';
    const previousRegion = type === 'ÁßçÈ∏Ω' ? (document.getElementById('e_previousRegion')?.value.trim() || '') : '';
    
    // Ëé∑ÂèñÁé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫
    const currentOwner = document.getElementById('e_currentOwner')?.value.trim() || '';
    const currentRegion = document.getElementById('e_currentRegion')?.value.trim() || '';
    
    // ËÆ∞ÂΩïÈ∏Ω‰∏ª-Âú∞Âå∫ÈÖçÂØπ
    if (currentOwner && currentRegion) {
      addOwnerRegionPair(currentOwner, currentRegion);
    }

    const eRaceList = document.getElementById('e_raceList');
    const races = [];
    eRaceList.querySelectorAll('.race-item').forEach(item => {
      races.push(item.getValue());
    });

    const bodyFile = document.getElementById('e_body_photo').files[0] || null;
    const eyeFile = document.getElementById('e_eye_photo').files[0] || null;

    // ÂàùÂßãÂåñÂõæÁâáÂØπË±°Ôºå‰øùÁïôÂéüÊúâÂõæÁâá
    if (!p.images) p.images = {};
    
    // Â¶ÇÊûúÊúâÊñ∞‰∏ä‰º†ÁöÑÁ´ôÁ´ã‰æßË∫´ÂõæÔºåÂàôÊõ¥Êñ∞ÔºõÂê¶Âàô‰øùÁïôÂéüÊúâÂõæÁâá
    if (bodyFile) {
      try {
        if (!bodyFile.type || !bodyFile.type.startsWith('image/')) {
          alert('Á´ôÁ´ã‰æßË∫´ÂõæÁâáÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂ÔºàJPG„ÄÅPNG„ÄÅGIF„ÄÅWEBPÁ≠âÔºâ„ÄÇ');
          return;
        }
        p.images.body = await readFileAsDataURL(bodyFile);
      } catch (e) {
        console.error('Êõ¥Êñ∞Á´ôÁ´ã‰æßË∫´ÂõæÁâáÂ§±Ë¥•', e);
        alert('Êõ¥Êñ∞Á´ôÁ´ã‰æßË∫´ÂõæÁâáÂ§±Ë¥•Ôºö' + (e.message || 'Êú™Áü•ÈîôËØØ') + 'ÔºåËØ∑ÈáçËØï„ÄÇ');
        return;
      }
    }
    
    // Â¶ÇÊûúÊúâÊñ∞‰∏ä‰º†ÁöÑÁúºÁùõÂõæÔºåÂàôÊõ¥Êñ∞ÔºõÂê¶Âàô‰øùÁïôÂéüÊúâÂõæÁâá
    if (eyeFile) {
      try {
        if (!eyeFile.type || !eyeFile.type.startsWith('image/')) {
          alert('ÁúºÁùõÁâπÂÜôÂõæÁâáÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂ÔºàJPG„ÄÅPNG„ÄÅGIF„ÄÅWEBPÁ≠âÔºâ„ÄÇ');
          return;
        }
        p.images.eye = await readFileAsDataURL(eyeFile);
      } catch (e) {
        console.error('Êõ¥Êñ∞ÁúºÁùõÂõæÁâáÂ§±Ë¥•', e);
        alert('Êõ¥Êñ∞ÁúºÁùõÂõæÁâáÂ§±Ë¥•Ôºö' + (e.message || 'Êú™Áü•ÈîôËØØ') + 'ÔºåËØ∑ÈáçËØï„ÄÇ');
        return;
      }
    }

    p.ring = newRing; // Êõ¥Êñ∞Ë∂≥ÁéØÂè∑
    p.name = name;
    p.gender = gender;
    p.color = color;
    p.birth = birth;
    p.type = type;
    p.fatherId = fatherId;
    p.motherId = motherId;
    p.alive = alive;
    p.deathDate = deathDate;
    p.deathReason = deathReason;
    p.races = races;
    p.isCore = !!document.getElementById('e_core')?.checked;
    p.previousOwner = previousOwner; // ÂâçÈ∏Ω‰∏ªÔºà‰ªÖÁßçÈ∏ΩÔºâ
    p.previousRegion = previousRegion; // ÂâçÂú∞Âå∫Ôºà‰ªÖÁßçÈ∏ΩÔºâ
    p.currentOwner = currentOwner; // Áé∞È∏Ω‰∏ª
    p.currentRegion = currentRegion; // Áé∞Âú∞Âå∫

    saveToStorage();
    alert('‰øùÂ≠òÊàêÂäüÔºåÊ°£Ê°àÂ∑≤Êõ¥Êñ∞„ÄÇ');
    refreshList();
    renderDetail();
    refreshStats();
    refreshDashboard();
    refreshPedigreeView(); // Âà∑Êñ∞Ë°ÄÁªüÂÖ≥Á≥ªËßÜÂõæ
    // Ê∏ÖÈô§Êú™‰øùÂ≠òÁä∂ÊÄÅÊ†áËÆ∞
    editFormInitialState = null;
    isEditFormDirty = false;
    setEditMode(false);
  };

  // ÂàùÂßãÂåñÂØºËà™ÁÇπÂáª
  navButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const view = btn.dataset.view;
      if (view === 'listView') {
        switchView('listView');
      } else if (view === 'createView') {
        setupCreateForm();
        switchView('createView');
      } else if (view === 'statsView') {
        refreshStats();
        switchView('statsView');
      }
    });
  });

  // Ë∂≥ÁéØÂè∑ÊêúÁ¥¢ÂäüËÉΩÂ∑≤Êï¥ÂêàÂà∞Êô∫ËÉΩÊêúÁ¥¢‰∏≠

  // ‰æßËæπÊ†èËèúÂçïÁÇπÂáª‰∫ã‰ª∂
  sidebarItems.forEach(item => {
    item.addEventListener('click', () => {
      const view = item.dataset.view;
      if (view) {
        // switchView ÂáΩÊï∞ÂÜÖÈÉ®Â∑≤Áªè‰ºöÊ£ÄÊü•Êú™‰øùÂ≠òÁöÑÊõ¥Êîπ
        switchView(view);
      }
    });
  });

  // ËßÜÂõæÂàáÊç¢ÊåâÈíÆ‰∫ã‰ª∂
  const btnTableView = document.getElementById('btnTableView');
  const btnCardView = document.getElementById('btnCardView');
  const tableView = document.getElementById('tableView');
  const cardView = document.getElementById('cardView');
  
  if (btnTableView && btnCardView) {
    btnTableView.addEventListener('click', () => {
      currentListView = 'table';
      if (tableView) tableView.style.display = '';
      if (cardView) cardView.style.display = 'none';
      btnTableView.classList.add('active');
      btnCardView.classList.remove('active');
    });
    
    btnCardView.addEventListener('click', () => {
      currentListView = 'card';
      if (tableView) tableView.style.display = 'none';
      if (cardView) cardView.style.display = '';
      btnCardView.classList.add('active');
      btnTableView.classList.remove('active');
      renderCardView();
    });
  }

  // ==================== Ë°ÄÁªüÂÖ≥Á≥ªÊ†ëÂäüËÉΩ ====================
  const pedigreeTreeContainer = document.getElementById('pedigreeTreeContainer');
  const pedigreeSelectPigeon = document.getElementById('pedigreeSelectPigeon');
  
  // Ëé∑ÂèñÊâÄÊúâÂ≠ê‰ª£È∏ΩÂ≠ê
  function getChildren(pigeonId) {
    return pigeons.filter(p => p.fatherId === pigeonId || p.motherId === pigeonId);
  }
  
  // ÊûÑÂª∫ÂÆåÊï¥ÁöÑË°ÄÁªüÊ†ëÔºàÂåÖÊã¨‰∫≤‰ª£ÂíåÂ≠ê‰ª£Ôºâ
  function buildFullPedigreeTree(pigeon, visited = new Set(), maxAncestorLevel = 5, currentAncestorLevel = 0) {
    if (!pigeon) return null;
    
    // Èò≤Ê≠¢Âæ™ÁéØÂºïÁî®
    if (visited.has(pigeon.id)) {
      return {
        id: pigeon.id,
        ring: pigeon.ring,
        name: pigeon.name || pigeon.ring,
        isCore: pigeon.isCore,
        alive: pigeon.alive,
        type: pigeon.type,
        father: null,
        mother: null,
        children: [],
        isCircular: true
      };
    }
    
    const newVisited = new Set(visited);
    newVisited.add(pigeon.id);
    
    const tree = {
      id: pigeon.id,
      ring: pigeon.ring,
      name: pigeon.name || pigeon.ring,
      isCore: pigeon.isCore,
      alive: pigeon.alive,
      type: pigeon.type,
      father: null,
      mother: null,
      children: []
    };
    
    // ÊûÑÂª∫‰∫≤‰ª£ÔºàÂêë‰∏äÔºâ- ÈôêÂà∂Ê∑±Â∫¶Èò≤Ê≠¢Êó†ÈôêÈÄíÂΩí
    if (currentAncestorLevel < maxAncestorLevel) {
      if (pigeon.fatherId) {
        const father = getPigeonById(pigeon.fatherId);
        if (father && father.id !== pigeon.id) {
          tree.father = buildFullPedigreeTree(father, newVisited, maxAncestorLevel, currentAncestorLevel + 1);
        }
      }
      
      if (pigeon.motherId) {
        const mother = getPigeonById(pigeon.motherId);
        if (mother && mother.id !== pigeon.id) {
          tree.mother = buildFullPedigreeTree(mother, newVisited, maxAncestorLevel, currentAncestorLevel + 1);
        }
      }
    }
    
    // ÊûÑÂª∫Â≠ê‰ª£ÔºàÂêë‰∏ãÔºâ- ‰∏çÈÄíÂΩíÂ≠ê‰ª£ÁöÑÂ≠ê‰ª£ÔºåÂè™ÊòæÁ§∫Áõ¥Êé•Â≠ê‰ª£
    const children = getChildren(pigeon.id);
    tree.children = children
      .filter(child => child.id !== pigeon.id) // Èò≤Ê≠¢Ëá™ÂºïÁî®
      .map(child => ({
        id: child.id,
        ring: child.ring,
        name: child.name || child.ring,
        isCore: child.isCore,
        alive: child.alive,
        type: child.type,
        father: null,
        mother: null,
        children: [] // Â≠ê‰ª£‰∏çÂÜçÈÄíÂΩíÊòæÁ§∫ÂÖ∂Â≠ê‰ª£ÔºåÈÅøÂÖçÊ†ëËøáÂ§ß
      }));
    
    return tree;
  }
  
  // Ê∏≤ÊüìÂÆåÊï¥ÁöÑË°ÄÁªüÊ†ë
  function renderFullPedigreeTree(pigeon) {
    if (!pedigreeTreeContainer) return;
    pedigreeTreeContainer.innerHTML = '';
    
    if (!pigeon) {
      pedigreeTreeContainer.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ËØ∑ÈÄâÊã©‰∏ÄÂè™È∏ΩÂ≠êÊü•ÁúãË°ÄÁªüÊ†ë</p>';
      return;
    }
    
    const tree = buildFullPedigreeTree(pigeon);
    if (!tree) {
      pedigreeTreeContainer.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ÊöÇÊó†Ë°ÄÁªüÊï∞ÊçÆ</p>';
      return;
    }
    
    const container = document.createElement('div');
    container.style.cssText = 'position:relative; min-height:600px; padding:30px;';
    
    // ÂàõÂª∫SVGÁî®‰∫éÁªòÂà∂ËøûÊé•Á∫ø
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.className = 'tree-connections';
    svg.setAttribute('width', '100%');
    svg.setAttribute('height', '100%');
    container.appendChild(svg);
    
    const contentDiv = document.createElement('div');
    contentDiv.style.cssText = 'position:relative; z-index:2;';
    container.appendChild(contentDiv);
    
    // Â≠òÂÇ®ËäÇÁÇπ‰ΩçÁΩÆ‰ø°ÊÅØÔºåÁî®‰∫éÁªòÂà∂ËøûÊé•Á∫ø
    const nodePositions = new Map();
    
    // Ê∏≤Êüì‰∫≤‰ª£ÔºàÂêë‰∏äÔºâ- ÊòæÁ§∫Áà∂È∏ΩÂíåÊØçÈ∏Ω
    if (tree.father || tree.mother) {
      const parentsSection = document.createElement('div');
      parentsSection.style.cssText = 'margin-bottom:50px; position:relative;';
      
      const sectionTitle = document.createElement('div');
      sectionTitle.className = 'tree-section-title';
      sectionTitle.textContent = 'üë®‚Äçüë© ‰∫≤‰ª£ÔºàÁà∂È∏ΩÂíåÊØçÈ∏ΩÔºâ';
      parentsSection.appendChild(sectionTitle);
      
      const parentsLevel = document.createElement('div');
      parentsLevel.className = 'tree-level-parents';
      parentsLevel.id = 'parents-level';
      
      if (tree.father) {
        const fatherContainer = document.createElement('div');
        fatherContainer.style.cssText = 'text-align:center; position:relative;';
        fatherContainer.id = 'father-container';
        const fatherLabel = document.createElement('div');
        fatherLabel.className = 'tree-parent-label father';
        fatherLabel.textContent = 'üë® Áà∂È∏Ω';
        fatherContainer.appendChild(fatherLabel);
        const fatherNode = createTreeNode(tree.father, '');
        fatherNode.id = 'father-node';
        fatherContainer.appendChild(fatherNode);
        parentsLevel.appendChild(fatherContainer);
      }
      
      if (tree.mother) {
        const motherContainer = document.createElement('div');
        motherContainer.style.cssText = 'text-align:center; position:relative;';
        motherContainer.id = 'mother-container';
        const motherLabel = document.createElement('div');
        motherLabel.className = 'tree-parent-label mother';
        motherLabel.textContent = 'üë© ÊØçÈ∏Ω';
        motherContainer.appendChild(motherLabel);
        const motherNode = createTreeNode(tree.mother, '');
        motherNode.id = 'mother-node';
        motherContainer.appendChild(motherNode);
        parentsLevel.appendChild(motherContainer);
      }
      
      parentsSection.appendChild(parentsLevel);
      contentDiv.appendChild(parentsSection);
    }
    
    // Ê∏≤ÊüìÂΩìÂâçÈ∏ΩÂ≠ê
    const currentSection = document.createElement('div');
    currentSection.className = 'tree-current';
    currentSection.id = 'current-section';
    const currentTitle = document.createElement('div');
    currentTitle.className = 'tree-section-title';
    currentTitle.textContent = '‚≠ê ÂΩìÂâçÈ∏ΩÂ≠ê';
    currentSection.appendChild(currentTitle);
    const currentNode = createTreeNode(tree, '');
    currentNode.id = 'current-node';
    currentNode.style.cssText = 'margin:20px auto; transform: scale(1.1);';
    currentSection.appendChild(currentNode);
    contentDiv.appendChild(currentSection);
    
    // Ê∏≤ÊüìÂ≠ê‰ª£ÔºàÂêë‰∏ãÔºâ- ‰ºòÂåñÂ§öÂ≠ê‰ª£ÊòæÁ§∫
    if (tree.children && tree.children.length > 0) {
      const childrenSection = document.createElement('div');
      childrenSection.style.cssText = 'margin-top:50px; position:relative;';
      
      const sectionTitle = document.createElement('div');
      sectionTitle.className = 'tree-section-title';
      sectionTitle.textContent = `üë∂ Â≠ê‰ª£Ë°ÄÁªüÔºàÂêë‰∏ãÔºåÂÖ±${tree.children.length}Âè™Ôºâ`;
      childrenSection.appendChild(sectionTitle);
      
      const childrenLevel = document.createElement('div');
      childrenLevel.className = 'tree-level-children';
      childrenLevel.id = 'children-level';
      
      // Ê†πÊçÆÂ≠ê‰ª£Êï∞ÈáèË∞ÉÊï¥Â∏ÉÂ±Ä
      const childrenCount = tree.children.length;
      if (childrenCount <= 4) {
        // Â∞ë‰∫éÁ≠â‰∫é4Âè™ÔºåÂçïË°åÊòæÁ§∫
        childrenLevel.style.cssText = 'display:flex; flex-wrap:wrap; gap:20px; justify-content:center; margin:20px 0;';
      } else if (childrenCount <= 8) {
        // 5-8Âè™Ôºå‰∏§Ë°åÊòæÁ§∫
        childrenLevel.style.cssText = 'display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; margin:20px 0; max-width:800px; margin-left:auto; margin-right:auto;';
      } else if (childrenCount <= 12) {
        // 9-12Âè™Ôºå‰∏âË°åÊòæÁ§∫
        childrenLevel.style.cssText = 'display:grid; grid-template-columns: repeat(4, 1fr); gap:14px; margin:20px 0; max-width:900px; margin-left:auto; margin-right:auto;';
      } else {
        // Ë∂ÖËøá12Âè™Ôºå‰ΩøÁî®Êõ¥Á¥ßÂáëÁöÑÁΩëÊ†ºÂ∏ÉÂ±Ä
        childrenLevel.style.cssText = 'display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:12px; margin:20px 0; max-width:1000px; margin-left:auto; margin-right:auto;';
      }
      
      tree.children.forEach((child, index) => {
        const childNode = createTreeNode(child, '');
        childNode.id = `child-node-${index}`;
        // Â¶ÇÊûúÂ≠ê‰ª£ÂæàÂ§öÔºåÁ®çÂæÆÁº©Â∞èËäÇÁÇπ
        if (childrenCount > 8) {
          childNode.style.cssText = 'transform: scale(0.9);';
        }
        childrenLevel.appendChild(childNode);
      });
      
      childrenSection.appendChild(childrenLevel);
      contentDiv.appendChild(childrenSection);
    } else {
      const noChildren = document.createElement('div');
      noChildren.className = 'muted';
      noChildren.style.cssText = 'text-align:center;padding:40px;background:linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);border-radius:12px;margin:30px 0;border:2px dashed #d1d5db;';
      noChildren.innerHTML = '<div style="font-size:48px;margin-bottom:12px;">üë∂</div><div style="font-size:14px;color:#6b7280;">ÊöÇÊó†Â≠ê‰ª£ËÆ∞ÂΩï</div>';
      contentDiv.appendChild(noChildren);
    }
    
    pedigreeTreeContainer.appendChild(container);
    
    // ÁªòÂà∂ËøûÊé•Á∫øÔºàÂª∂ËøüÊâßË°å‰ª•Á°Æ‰øùDOMÂ∑≤Ê∏≤ÊüìÔºâ
    setTimeout(() => {
      drawTreeConnections(container, tree);
    }, 200);
    
    // Á™óÂè£Â§ßÂ∞èÊîπÂèòÊó∂ÈáçÊñ∞ÁªòÂà∂ËøûÊé•Á∫ø
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if (pedigreeTreeContainer.contains(container)) {
          drawTreeConnections(container, tree);
        }
      }, 300);
    });
  }
  
  // ÁªòÂà∂Ê†ëÁä∂ÂõæËøûÊé•Á∫ø
  function drawTreeConnections(container, tree) {
    const svg = container.querySelector('.tree-connections');
    if (!svg) return;
    
    // Á≠âÂæÖDOMÂÆåÂÖ®Ê∏≤Êüì
    requestAnimationFrame(() => {
      // Ëé∑ÂèñÂÆπÂô®‰ΩçÁΩÆ
      const containerRect = container.getBoundingClientRect();
      const containerScrollTop = container.scrollTop || 0;
      const containerScrollLeft = container.scrollLeft || 0;
      
      // ËÆæÁΩÆSVGÂ∞∫ÂØ∏
      const containerHeight = container.scrollHeight || containerRect.height;
      const containerWidth = container.scrollWidth || containerRect.width;
      svg.setAttribute('width', containerWidth);
      svg.setAttribute('height', containerHeight);
      
      // Ê∏ÖÁ©∫‰πãÂâçÁöÑËøûÊé•Á∫ø
      svg.innerHTML = '';
      
      // ÁªòÂà∂Áà∂È∏ΩÂà∞ÂΩìÂâçÈ∏ΩÂ≠êÁöÑËøûÊé•Á∫ø
      const fatherNode = container.querySelector('#father-node');
      const motherNode = container.querySelector('#mother-node');
      const currentNode = container.querySelector('#current-node');
      
      if (fatherNode && currentNode) {
        const fatherRect = fatherNode.getBoundingClientRect();
        const currentRect = currentNode.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        
        const startX = fatherRect.left + fatherRect.width / 2 - containerRect.left;
        const startY = fatherRect.bottom - containerRect.top;
        const endX = currentRect.left + currentRect.width / 2 - containerRect.left;
        const endY = currentRect.top - containerRect.top;
        const midY = startY + (endY - startY) * 0.6;
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', `M ${startX} ${startY} Q ${startX} ${midY} ${(startX + endX) / 2} ${midY} T ${endX} ${endY}`);
        path.setAttribute('class', 'tree-connection');
        path.setAttribute('stroke', '#3b82f6');
        path.setAttribute('stroke-width', '2.5');
        path.setAttribute('fill', 'none');
        svg.appendChild(path);
      }
      
      if (motherNode && currentNode) {
        const motherRect = motherNode.getBoundingClientRect();
        const currentRect = currentNode.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        
        const startX = motherRect.left + motherRect.width / 2 - containerRect.left;
        const startY = motherRect.bottom - containerRect.top;
        const endX = currentRect.left + currentRect.width / 2 - containerRect.left;
        const endY = currentRect.top - containerRect.top;
        const midY = startY + (endY - startY) * 0.6;
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', `M ${startX} ${startY} Q ${startX} ${midY} ${(startX + endX) / 2} ${midY} T ${endX} ${endY}`);
        path.setAttribute('class', 'tree-connection');
        path.setAttribute('stroke', '#ec4899');
        path.setAttribute('stroke-width', '2.5');
        path.setAttribute('fill', 'none');
        svg.appendChild(path);
      }
      
      // ÁªòÂà∂ÂΩìÂâçÈ∏ΩÂ≠êÂà∞Â≠ê‰ª£ÁöÑËøûÊé•Á∫ø
      if (currentNode && tree.children && tree.children.length > 0) {
        const currentRect = currentNode.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        const startX = currentRect.left + currentRect.width / 2 - containerRect.left;
        const startY = currentRect.bottom - containerRect.top;
        
        tree.children.forEach((child, index) => {
          const childNode = container.querySelector(`#child-node-${index}`);
          if (childNode) {
            const childRect = childNode.getBoundingClientRect();
            const endX = childRect.left + childRect.width / 2 - containerRect.left;
            const endY = childRect.top - containerRect.top;
            const midY = startY + (endY - startY) * 0.4;
            
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', `M ${startX} ${startY} Q ${startX} ${midY} ${(startX + endX) / 2} ${midY} T ${endX} ${endY}`);
            path.setAttribute('class', 'tree-connection');
            path.setAttribute('stroke', '#10b981');
            path.setAttribute('stroke-width', '2');
            path.setAttribute('opacity', '0.6');
            path.setAttribute('fill', 'none');
            svg.appendChild(path);
          }
        });
      }
    });
  }
  
  // ÂàõÂª∫Ê†ëËäÇÁÇπ
  function createTreeNode(node, label) {
    const nodeDiv = document.createElement('div');
    nodeDiv.className = 'tree-node' + (node.isCore ? ' core' : '') + (node.alive ? '' : ' dead');
    
    const nameDiv = document.createElement('div');
    nameDiv.className = 'tree-node-name';
    nameDiv.textContent = node.name || node.ring;
    nodeDiv.appendChild(nameDiv);
    
    const ringDiv = document.createElement('div');
    ringDiv.className = 'tree-node-ring';
    ringDiv.textContent = node.ring;
    nodeDiv.appendChild(ringDiv);
    
    if (label) {
      const labelDiv = document.createElement('div');
      labelDiv.className = 'tree-node-label';
      labelDiv.textContent = label;
      nodeDiv.appendChild(labelDiv);
    }
    
    if (node.type) {
      const typeDiv = document.createElement('div');
      typeDiv.style.cssText = 'font-size:10px;color:#6b7280;margin-top:6px;padding:2px 8px;background:rgba(107,114,128,0.1);border-radius:4px;display:inline-block;';
      typeDiv.textContent = node.type;
      nodeDiv.appendChild(typeDiv);
    }
    
    nodeDiv.onclick = (e) => {
      e.stopPropagation();
      openDetail(node.id);
    };
    
    return nodeDiv;
  }
  
  // Â°´ÂÖÖË°ÄÁªüÂÖ≥Á≥ª‰∏ãÊãâÂàóË°®
  function fillPedigreeSelect() {
    if (!pedigreeSelectPigeon) return;
    pedigreeSelectPigeon.innerHTML = '<option value="">ÈÄâÊã©È∏ΩÂ≠êÊü•ÁúãË°ÄÁªüÊ†ë</option>';
    
    pigeons.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = `${p.ring}${p.name ? ' - ' + p.name : ''}${p.isCore ? ' ‚≠ê' : ''}`;
      pedigreeSelectPigeon.appendChild(option);
    });
  }
  
  // Ê£ÄÊü•‰∏§Âè™ÁßçÈ∏ΩÊòØÂê¶ÊòØÂ§´Â¶ªÂÖ≥Á≥ªÔºàÊúâÂÖ±ÂêåÁöÑÂ≠ê‰ª£Ôºå‰∏î‰∏çÊòØÁà∂Â≠ê/ÊØçÂ≠êÂÖ≥Á≥ªÔºâ
  function areBreederCouple(breeder1, breeder2) {
    if (breeder1.id === breeder2.id) return false;
    
    // ÊéíÈô§Áà∂Â≠ê/ÊØçÂ≠êÂÖ≥Á≥ª
    if (breeder1.fatherId === breeder2.id || breeder1.motherId === breeder2.id ||
        breeder2.fatherId === breeder1.id || breeder2.motherId === breeder1.id) {
      return false;
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÂÖ±ÂêåÁöÑÂ≠ê‰ª£Ôºà‰∏ÄÂè™ÁöÑÁà∂ÊòØbreeder1ÔºåÊØçÊòØbreeder2ÔºåÊàñÂèç‰πãÔºâ
    const commonChildren = pigeons.filter(p => {
      return (p.fatherId === breeder1.id && p.motherId === breeder2.id) ||
             (p.fatherId === breeder2.id && p.motherId === breeder1.id);
    });
    
    return commonChildren.length > 0;
  }
  
  // ÊòæÁ§∫ÊâÄÊúâÁßçÈ∏ΩÁöÑÊ†ëÁä∂ÂõæÔºàÂêàÂπ∂Â§´Â¶ªÂÖ≥Á≥ªÔºâ
  function renderAllBreederTrees() {
    if (!pedigreeTreeContainer) return;
    pedigreeTreeContainer.innerHTML = '';
    
    const breeders = pigeons.filter(p => p.type === 'ÁßçÈ∏Ω' || p.isCore);
    
    if (breeders.length === 0) {
      pedigreeTreeContainer.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ÊöÇÊó†ÁßçÈ∏ΩËÆ∞ÂΩï</p>';
      return;
    }
    
    // ÂàÜÁªÑÔºöÊâæÂá∫Â§´Â¶ªÂÖ≥Á≥ªÂπ∂ÂêàÂπ∂
    const processedIds = new Set();
    const breederGroups = [];
    
    breeders.forEach(breeder => {
      if (processedIds.has(breeder.id)) return;
      
      // Êü•ÊâæÊòØÂê¶ÊúâÈÖçÂÅ∂
      const spouse = breeders.find(b => 
        b.id !== breeder.id && 
        !processedIds.has(b.id) && 
        areBreederCouple(breeder, b)
      );
      
      if (spouse) {
        // ÊâæÂà∞ÈÖçÂÅ∂ÔºåÂêàÂπ∂ÊòæÁ§∫
        breederGroups.push([breeder, spouse]);
        processedIds.add(breeder.id);
        processedIds.add(spouse.id);
      } else {
        // Ê≤°ÊúâÈÖçÂÅ∂ÔºåÂçïÁã¨ÊòæÁ§∫
        breederGroups.push([breeder]);
        processedIds.add(breeder.id);
      }
    });
    
    const container = document.createElement('div');
    container.style.cssText = 'display:grid; grid-template-columns: repeat(auto-fill, minmax(450px, 1fr)); gap:24px;';
    
    breederGroups.forEach(group => {
      const breederCard = document.createElement('div');
      breederCard.style.cssText = 'background:#fff; border-radius:8px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.1);';
      
      // Ê†áÈ¢òÔºöÂ¶ÇÊûúÊòØÂ§´Â¶ªÔºåÊòæÁ§∫"Â§´Â¶ªÁßçÈ∏Ω"
      const title = document.createElement('div');
      title.style.cssText = 'font-size:16px; font-weight:600; margin-bottom:12px; padding-bottom:8px; border-bottom:2px solid #f0f0f0;';
      
      if (group.length === 2) {
        // Â§´Â¶ªÁßçÈ∏Ω
        const breeder1 = group[0];
        const breeder2 = group[1];
        title.innerHTML = `üíë Â§´Â¶ªÁßçÈ∏Ω<br>
          <span style="font-size:14px;color:#2b5cff;">${breeder1.name || breeder1.ring}</span> 
          <span style="font-size:12px;color:#6b7280;">(${breeder1.ring})</span>
          <span style="margin:0 8px;">&</span>
          <span style="font-size:14px;color:#ec4899;">${breeder2.name || breeder2.ring}</span> 
          <span style="font-size:12px;color:#6b7280;">(${breeder2.ring})</span>`;
      } else {
        // ÂçïÁã¨ÁßçÈ∏Ω
        const breeder = group[0];
        title.innerHTML = `${breeder.name || breeder.ring} <span style="font-size:12px;color:#6b7280;">${breeder.ring}</span>`;
      }
      breederCard.appendChild(title);
      
      const treeDiv = document.createElement('div');
      treeDiv.style.cssText = 'min-height:200px;';
      
      // Â¶ÇÊûúÊòØÂ§´Â¶ªÔºåÂêàÂπ∂ÊòæÁ§∫Â≠ê‰ª£
      if (group.length === 2) {
        const breeder1 = group[0];
        const breeder2 = group[1];
        
        // ÊòæÁ§∫‰∏§Âè™ÁßçÈ∏Ω
        const breedersDiv = document.createElement('div');
        breedersDiv.style.cssText = 'display:flex;gap:16px;justify-content:center;margin-bottom:16px;';
        
        const breeder1Node = createTreeNode({
          id: breeder1.id,
          ring: breeder1.ring,
          name: breeder1.name || breeder1.ring,
          isCore: breeder1.isCore,
          alive: breeder1.alive,
          type: breeder1.type
        }, '');
        breeder1Node.style.cssText = 'min-width:140px;';
        breedersDiv.appendChild(breeder1Node);
        
        const breeder2Node = createTreeNode({
          id: breeder2.id,
          ring: breeder2.ring,
          name: breeder2.name || breeder2.ring,
          isCore: breeder2.isCore,
          alive: breeder2.alive,
          type: breeder2.type
        }, '');
        breeder2Node.style.cssText = 'min-width:140px;';
        breedersDiv.appendChild(breeder2Node);
        
        treeDiv.appendChild(breedersDiv);
        
        // Ëé∑ÂèñÂÖ±ÂêåÁöÑÂ≠ê‰ª£
        const commonChildren = pigeons.filter(p => {
          return (p.fatherId === breeder1.id && p.motherId === breeder2.id) ||
                 (p.fatherId === breeder2.id && p.motherId === breeder1.id);
        });
        
        if (commonChildren.length > 0) {
          const childrenTitle = document.createElement('div');
          childrenTitle.style.cssText = 'font-size:12px;color:#6b7280;margin:12px 0 8px;font-weight:500;';
          childrenTitle.textContent = `ÂÖ±ÂêåÂ≠ê‰ª£Ôºà${commonChildren.length}Âè™Ôºâ`;
          treeDiv.appendChild(childrenTitle);
          
          const childrenDiv = document.createElement('div');
          childrenDiv.style.cssText = 'display:flex;flex-wrap:wrap;gap:8px;justify-content:center;';
          commonChildren.forEach(child => {
            const childNode = createTreeNode({
              id: child.id,
              ring: child.ring,
              name: child.name || child.ring,
              isCore: child.isCore,
              alive: child.alive,
              type: child.type
            }, '');
            childNode.style.cssText = 'min-width:120px;font-size:12px;';
            childrenDiv.appendChild(childNode);
          });
          treeDiv.appendChild(childrenDiv);
        } else {
          const noChildren = document.createElement('div');
          noChildren.style.cssText = 'text-align:center;padding:12px;color:#9ca3af;font-size:12px;';
          noChildren.textContent = 'ÊöÇÊó†ÂÖ±ÂêåÂ≠ê‰ª£ËÆ∞ÂΩï';
          treeDiv.appendChild(noChildren);
        }
      } else {
        // ÂçïÁã¨ÁßçÈ∏ΩÔºåÊòæÁ§∫ÂÖ∂Ê†ëÁä∂Âõæ
        const breeder = group[0];
        const tree = buildFullPedigreeTree(breeder);
        if (tree) {
          const current = createTreeNode(tree, 'ÁßçÈ∏Ω');
          treeDiv.appendChild(current);
          
          if (tree.children && tree.children.length > 0) {
            const childrenTitle = document.createElement('div');
            childrenTitle.style.cssText = 'font-size:12px;color:#6b7280;margin:12px 0 8px;';
            childrenTitle.textContent = `Â≠ê‰ª£Ôºà${tree.children.length}Âè™Ôºâ`;
            treeDiv.appendChild(childrenTitle);
            
            const childrenDiv = document.createElement('div');
            childrenDiv.style.cssText = 'display:flex;flex-wrap:wrap;gap:8px;justify-content:center;';
            tree.children.forEach(child => {
              const childNode = createTreeNode(child, '');
              childNode.style.cssText = 'min-width:120px;font-size:12px;';
              childrenDiv.appendChild(childNode);
            });
            treeDiv.appendChild(childrenDiv);
          }
        }
      }
      
      breederCard.appendChild(treeDiv);
      container.appendChild(breederCard);
    });
    
    pedigreeTreeContainer.appendChild(container);
  }
  
  // ÊêúÁ¥¢È∏ΩÂ≠êÔºàÈÄöËøáË∂≥ÁéØÂè∑ÊàñÂêçÂ≠óÔºâ
  function searchPigeonForPedigree(searchTerm) {
    if (!searchTerm || !searchTerm.trim()) {
      return null;
    }
    
    const term = searchTerm.trim().toLowerCase();
    
    // ÂÖàÂ∞ùËØïÁ≤æÁ°ÆÂåπÈÖçË∂≥ÁéØÂè∑
    let found = pigeons.find(p => p.ring.toLowerCase() === term);
    
    // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÔºåÂ∞ùËØïÈÉ®ÂàÜÂåπÈÖçË∂≥ÁéØÂè∑
    if (!found) {
      found = pigeons.find(p => p.ring.toLowerCase().includes(term));
    }
    
    // Â¶ÇÊûúËøòÊ≤°ÊúâÊâæÂà∞ÔºåÂ∞ùËØïÂåπÈÖçÂêçÂ≠ó
    if (!found) {
      found = pigeons.find(p => {
        const name = (p.name || '').toLowerCase();
        return name === term || name.includes(term);
      });
    }
    
    return found;
  }
  
  // Ë°ÄÁªüÂÖ≥Á≥ªËßÜÂõæ‰∫ã‰ª∂ÁªëÂÆö
  if (pedigreeSelectPigeon) {
    pedigreeSelectPigeon.addEventListener('change', () => {
      const selectedId = pedigreeSelectPigeon.value;
      if (selectedId) {
        const pigeon = getPigeonById(selectedId);
        if (pigeon) {
          renderFullPedigreeTree(pigeon);
        }
      } else {
        pedigreeTreeContainer.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ËØ∑ÈÄâÊã©‰∏ÄÂè™È∏ΩÂ≠êÊü•ÁúãË°ÄÁªüÊ†ë</p>';
      }
    });
  }
  
  // ÊêúÁ¥¢ÊåâÈíÆ‰∫ã‰ª∂
  const pedigreeSearchInput = document.getElementById('pedigreeSearchInput');
  const btnPedigreeSearch = document.getElementById('btnPedigreeSearch');
  
  function handlePedigreeSearch() {
    if (!pedigreeSearchInput) return;
    
    const searchTerm = pedigreeSearchInput.value.trim();
    if (!searchTerm) {
      alert('ËØ∑ËæìÂÖ•Ë∂≥ÁéØÂè∑ÊàñÂêçÂ≠óËøõË°åÊêúÁ¥¢');
      return;
    }
    
    const found = searchPigeonForPedigree(searchTerm);
    if (found) {
      // Êõ¥Êñ∞‰∏ãÊãâÈÄâÊã©Ê°Ü
      if (pedigreeSelectPigeon) {
        pedigreeSelectPigeon.value = found.id;
      }
      // Ê∏≤ÊüìÊ†ëÁä∂Âõæ
      renderFullPedigreeTree(found);
    } else {
      pedigreeTreeContainer.innerHTML = `<p class="muted" style="text-align:center;padding:40px;">Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÈ∏ΩÂ≠êÔºö${searchTerm}<br><small style="color:#9ca3af;">ËØ∑Ê£ÄÊü•Ë∂≥ÁéØÂè∑ÊàñÂêçÂ≠óÊòØÂê¶Ê≠£Á°Æ</small></p>`;
    }
  }
  
  if (btnPedigreeSearch) {
    btnPedigreeSearch.addEventListener('click', handlePedigreeSearch);
  }
  
  // ÊêúÁ¥¢Ê°ÜÂõûËΩ¶‰∫ã‰ª∂
  if (pedigreeSearchInput) {
    pedigreeSearchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handlePedigreeSearch();
      }
    });
  }
  
  const btnShowAllBreeders = document.getElementById('btnShowAllBreeders');
  const btnRefreshPedigree = document.getElementById('btnRefreshPedigree');
  
  if (btnShowAllBreeders) {
    btnShowAllBreeders.addEventListener('click', () => {
      renderAllBreederTrees();
    });
  }
  
  if (btnRefreshPedigree) {
    btnRefreshPedigree.addEventListener('click', () => {
      fillPedigreeSelect();
      const selectedId = pedigreeSelectPigeon ? pedigreeSelectPigeon.value : '';
      if (selectedId) {
        const pigeon = getPigeonById(selectedId);
        if (pigeon) {
          renderFullPedigreeTree(pigeon);
        }
      }
      // Ê∏ÖÁ©∫ÊêúÁ¥¢Ê°Ü
      if (pedigreeSearchInput) {
        pedigreeSearchInput.value = '';
      }
    });
  }
  
  // Âà∑Êñ∞Ë°ÄÁªüÂÖ≥Á≥ªËßÜÂõæÁöÑÂáΩÊï∞
  function refreshPedigreeView() {
    fillPedigreeSelect();
    const selectedId = pedigreeSelectPigeon ? pedigreeSelectPigeon.value : '';
    if (selectedId) {
      const pigeon = getPigeonById(selectedId);
      if (pigeon) {
        renderFullPedigreeTree(pigeon);
      }
    }
  }

  // ÂàùÂßãÂåñ
  // ==================== ÊØîËµõ‰∏éÊàêÁª©ÁÆ°ÁêÜÂäüËÉΩ ====================
  const RACES_STORAGE_KEY = 'pigeon_races';
  let races = [];
  
  // Âä†ËΩΩÊØîËµõÊï∞ÊçÆ
  function loadRaces() {
    try {
      const raw = localStorage.getItem(RACES_STORAGE_KEY);
      if (raw) {
        races = JSON.parse(raw);
      } else {
        races = [];
      }
    } catch (e) {
      console.error('Âä†ËΩΩÊØîËµõÊï∞ÊçÆÂ§±Ë¥•:', e);
      races = [];
    }
  }
  
  // ‰øùÂ≠òÊØîËµõÊï∞ÊçÆ
  function saveRaces() {
    try {
      localStorage.setItem(RACES_STORAGE_KEY, JSON.stringify(races));
    } catch (e) {
      console.error('‰øùÂ≠òÊØîËµõÊï∞ÊçÆÂ§±Ë¥•:', e);
      alert('‰øùÂ≠òÊØîËµõÊï∞ÊçÆÂ§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ');
    }
  }
  
  // Ê∏≤ÊüìÊØîËµõÂàóË°®
  function renderRaceList() {
    const container = document.getElementById('raceListContainer');
    if (!container) return;
    
    if (races.length === 0) {
      container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ÊöÇÊó†ÊØîËµõËÆ∞ÂΩïÔºåÁÇπÂáª"Êñ∞Â¢ûÊØîËµõ"ÂºÄÂßãËÆ∞ÂΩï</p>';
      return;
    }
    
    container.innerHTML = '';
    races.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(race => {
      const card = document.createElement('div');
      card.className = 'race-card';
      
      const header = document.createElement('div');
      header.className = 'race-card-header';
      
      const left = document.createElement('div');
      const title = document.createElement('div');
      title.className = 'race-card-title';
      title.textContent = race.name;
      left.appendChild(title);
      
      const meta = document.createElement('div');
      meta.className = 'race-card-meta';
      meta.innerHTML = `
        <div class="race-card-meta-item">üìÖ ${race.date}</div>
        <div class="race-card-meta-item">üìç ${race.location}</div>
        ${race.weather ? `<div class="race-card-meta-item">üå§Ô∏è ${race.weather}</div>` : ''}
        <div class="race-card-meta-item">üê¶ ÂèÇËµõÈ∏ΩÔºö${race.participants.length}Âè™</div>
      `;
      left.appendChild(meta);
      header.appendChild(left);
      
      const actions = document.createElement('div');
      actions.style.cssText = 'display:flex;gap:8px;';
      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn btn-outline btn-sm';
      btnEdit.textContent = '‚úèÔ∏è ÁºñËæë';
      btnEdit.onclick = () => openRaceModal(race.id);
      const btnDelete = document.createElement('button');
      btnDelete.className = 'btn btn-outline btn-sm';
      btnDelete.textContent = 'üóëÔ∏è Âà†Èô§';
      btnDelete.onclick = () => {
        if (confirm(`Á°ÆÂÆöÂà†Èô§ÊØîËµõ"${race.name}"ÂêóÔºü`)) {
          races = races.filter(r => r.id !== race.id);
          saveRaces();
          syncRacesToPigeons(); // ÂêåÊ≠•Êõ¥Êñ∞È∏ΩÂ≠êÊ°£Ê°à
          renderRaceList();
          refreshList(); // Âà∑Êñ∞È∏ΩÂ≠êÂàóË°®
        }
      };
      actions.appendChild(btnEdit);
      actions.appendChild(btnDelete);
      header.appendChild(actions);
      
      card.appendChild(header);
      
      // ÊòæÁ§∫ÂèÇËµõÈ∏ΩÊàêÁª©
      if (race.participants && race.participants.length > 0) {
        const participantsDiv = document.createElement('div');
        participantsDiv.style.cssText = 'margin-top:16px;';
        const table = document.createElement('table');
        table.style.cssText = 'width:100%;border-collapse:collapse;';
        table.innerHTML = `
          <thead>
            <tr style="background:#f9fafb;">
              <th style="padding:10px;text-align:left;border-bottom:2px solid #e5e7eb;">È∏ΩÂ≠ê</th>
              <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂêçÊ¨°</th>
              <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂàÜÊï∞</th>
              <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂΩíÂ∑¢Êó∂Èó¥</th>
            </tr>
          </thead>
          <tbody>
        `;
        
        race.participants.sort((a, b) => (a.rank || 9999) - (b.rank || 9999)).forEach(p => {
          const pigeon = getPigeonById(p.pigeonId);
          const row = document.createElement('tr');
          row.style.cssText = 'border-bottom:1px solid #f0f0f0;';
          row.innerHTML = `
            <td style="padding:10px;">
              ${pigeon ? `${pigeon.name || pigeon.ring} (${pigeon.ring})` : 'Êú™Áü•È∏ΩÂ≠ê'}
            </td>
            <td style="padding:10px;text-align:center;font-weight:600;color:#2b5cff;">
              ${p.rank ? `Á¨¨${p.rank}Âêç` : '‚Äî'}
            </td>
            <td style="padding:10px;text-align:center;">
              ${p.score ? p.score : '‚Äî'}
            </td>
            <td style="padding:10px;text-align:center;">
              ${p.returnTime || '‚Äî'}
            </td>
          `;
          table.querySelector('tbody').appendChild(row);
        });
        
        table.innerHTML += '</tbody>';
        participantsDiv.appendChild(table);
        card.appendChild(participantsDiv);
      }
      
      container.appendChild(card);
    });
  }
  
  // ÊâìÂºÄÊØîËµõÊ®°ÊÄÅÊ°Ü
  function openRaceModal(raceId = null) {
    const modal = document.getElementById('raceModal');
    const title = document.getElementById('raceModalTitle');
    if (!modal) return;
    
    if (raceId) {
      const race = races.find(r => r.id === raceId);
      if (race) {
        title.textContent = 'ÁºñËæëÊØîËµõ';
        document.getElementById('race_name').value = race.name;
        document.getElementById('race_date').value = race.date;
        document.getElementById('race_location').value = race.location;
        document.getElementById('race_weather').value = race.weather || '';
        
        const container = document.getElementById('raceParticipantsContainer');
        container.innerHTML = '';
        race.participants.forEach(p => {
          addParticipantRow(p);
        });
        if (race.participants.length === 0) {
          addParticipantRow();
        }
      }
    } else {
      title.textContent = 'Êñ∞Â¢ûÊØîËµõ';
      document.getElementById('race_name').value = '';
      document.getElementById('race_date').value = '';
      document.getElementById('race_location').value = '';
      document.getElementById('race_weather').value = '';
      const container = document.getElementById('raceParticipantsContainer');
      container.innerHTML = '';
      addParticipantRow();
    }
    
    fillParticipantSelects();
    modal.style.display = 'flex';
  }
  
  // Ê∑ªÂä†ÂèÇËµõÈ∏ΩË°å
  function addParticipantRow(data = null) {
    const container = document.getElementById('raceParticipantsContainer');
    if (!container) return;
    
    const row = document.createElement('div');
    row.className = 'participant-item';
    row.style.cssText = 'display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:12px;align-items:center;padding:12px;background:#f9fafb;border-radius:8px;margin-bottom:12px;';
    
    const select = document.createElement('select');
    select.className = 'participant-pigeon';
    select.style.cssText = 'padding:8px;border-radius:6px;border:1px solid #E5E7EB;';
    select.innerHTML = '<option value="">ÈÄâÊã©È∏ΩÂ≠ê...</option>';
    pigeons.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = `${p.ring}${p.name ? ' - ' + p.name : ''}`;
      if (data && data.pigeonId === p.id) {
        option.selected = true;
      }
      select.appendChild(option);
    });
    
    const rankInput = document.createElement('input');
    rankInput.type = 'number';
    rankInput.className = 'participant-rank';
    rankInput.placeholder = 'ÂêçÊ¨°';
    rankInput.min = 1;
    rankInput.style.cssText = 'padding:8px;border-radius:6px;border:1px solid #E5E7EB;';
    if (data && data.rank) rankInput.value = data.rank;
    
    const scoreInput = document.createElement('input');
    scoreInput.type = 'number';
    scoreInput.className = 'participant-score';
    scoreInput.placeholder = 'ÂàÜÊï∞';
    scoreInput.step = '0.01';
    scoreInput.style.cssText = 'padding:8px;border-radius:6px;border:1px solid #E5E7EB;';
    if (data && data.score) scoreInput.value = data.score;
    
    const timeInput = document.createElement('input');
    timeInput.type = 'time';
    timeInput.className = 'participant-time';
    timeInput.placeholder = 'ÂΩíÂ∑¢Êó∂Èó¥';
    timeInput.style.cssText = 'padding:8px;border-radius:6px;border:1px solid #E5E7EB;';
    if (data && data.returnTime) timeInput.value = data.returnTime;
    
    const removeBtn = document.createElement('button');
    removeBtn.className = 'btn btn-outline btn-sm remove-participant';
    removeBtn.textContent = 'Âà†Èô§';
    removeBtn.style.cssText = 'padding:6px 12px;';
    removeBtn.onclick = () => row.remove();
    
    row.appendChild(select);
    row.appendChild(rankInput);
    row.appendChild(scoreInput);
    row.appendChild(timeInput);
    row.appendChild(removeBtn);
    
    container.appendChild(row);
  }
  
  // Â°´ÂÖÖÂèÇËµõÈ∏ΩÈÄâÊã©Ê°Ü
  function fillParticipantSelects() {
    const selects = document.querySelectorAll('.participant-pigeon');
    selects.forEach(select => {
      const currentValue = select.value;
      select.innerHTML = '<option value="">ÈÄâÊã©È∏ΩÂ≠ê...</option>';
      pigeons.forEach(p => {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = `${p.ring}${p.name ? ' - ' + p.name : ''}`;
        if (currentValue === p.id) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    });
  }
  
  // ‰øùÂ≠òÊØîËµõ
  function saveRace() {
    const name = document.getElementById('race_name').value.trim();
    const date = document.getElementById('race_date').value;
    const location = document.getElementById('race_location').value.trim();
    const weather = document.getElementById('race_weather').value;
    
    if (!name || !date || !location) {
      alert('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÊØîËµõ‰ø°ÊÅØÔºàËµõ‰∫ãÂêçÁß∞„ÄÅÊó∂Èó¥„ÄÅÂú∞ÁÇπ‰∏∫ÂøÖÂ°´È°πÔºâ');
      return;
    }
    
    const participants = [];
    document.querySelectorAll('.participant-item').forEach(row => {
      const pigeonId = row.querySelector('.participant-pigeon').value;
      const rank = row.querySelector('.participant-rank').value;
      const score = row.querySelector('.participant-score').value;
      const returnTime = row.querySelector('.participant-time').value;
      
      if (pigeonId) {
        participants.push({
          pigeonId,
          rank: rank ? parseInt(rank) : null,
          score: score ? parseFloat(score) : null,
          returnTime: returnTime || null
        });
      }
    });
    
    const raceId = document.getElementById('raceModalTitle').textContent === 'Êñ∞Â¢ûÊØîËµõ' ? 
      Date.now().toString() : 
      races.find(r => r.name === name && r.date === date)?.id || Date.now().toString();
    
    const race = {
      id: raceId,
      name,
      date,
      location,
      weather: weather || null,
      participants
    };
    
    const index = races.findIndex(r => r.id === raceId);
    if (index >= 0) {
      races[index] = race;
    } else {
      races.push(race);
    }
    
    saveRaces();
    syncRacesToPigeons(); // Ëá™Âä®ÂêåÊ≠•ÊØîËµõÊï∞ÊçÆÂà∞È∏ΩÂ≠êÊ°£Ê°à
    renderRaceList();
    refreshList(); // Âà∑Êñ∞È∏ΩÂ≠êÂàóË°®‰ª•ÊòæÁ§∫Êõ¥Êñ∞ÁöÑÊØîËµõ‰ø°ÊÅØ
    closeRaceModal();
    alert('ÊØîËµõ‰øùÂ≠òÊàêÂäüÔºÅÂ∑≤Ëá™Âä®ÂêåÊ≠•Âà∞È∏ΩÂ≠êÊ°£Ê°à„ÄÇ');
  }
  
  // ÂêåÊ≠•ÊØîËµõÊï∞ÊçÆÂà∞È∏ΩÂ≠êÊ°£Ê°à
  function syncRacesToPigeons() {
    // ÈáçÊñ∞Âä†ËΩΩÈ∏ΩÂ≠êÊï∞ÊçÆ‰ª•Á°Æ‰øù‰ΩøÁî®ÊúÄÊñ∞Êï∞ÊçÆ
    loadFromStorage();
    
    // Ê∏ÖÁ©∫ÊâÄÊúâÈ∏ΩÂ≠êÁöÑÊØîËµõËÆ∞ÂΩïÔºåÈáçÊñ∞‰ªéÊØîËµõÊï∞ÊçÆ‰∏≠ÂêåÊ≠•
    pigeons.forEach(p => {
      p.races = [];
    });
    
    // ‰ªéÊØîËµõÊï∞ÊçÆ‰∏≠ÊèêÂèñÊØèÂè™È∏ΩÂ≠êÁöÑÂèÇËµõËÆ∞ÂΩï
    races.forEach(race => {
      if (race.participants && Array.isArray(race.participants)) {
        race.participants.forEach(participant => {
          if (participant && participant.pigeonId) {
            const pigeon = getPigeonById(participant.pigeonId);
            if (pigeon) {
              if (!pigeon.races) {
                pigeon.races = [];
              }
              pigeon.races.push({
                raceId: race.id,
                raceName: race.name,
                date: race.date,
                location: race.location,
                weather: race.weather,
                rank: participant.rank,
                score: participant.score,
                returnTime: participant.returnTime
              });
            }
          }
        });
      }
    });
    
    // ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑÈ∏ΩÂ≠êÊï∞ÊçÆ
    saveToStorage();
    
    // Ë∞ÉËØï‰ø°ÊÅØÔºàÂèØÂú®ÊéßÂà∂Âè∞Êü•ÁúãÔºâ
    const breedersWithRaces = pigeons.filter(p => (p.type === 'ÁßçÈ∏Ω' || p.isCore) && p.races && p.races.length > 0);
    if (breedersWithRaces.length > 0) {
      console.log(`Â∑≤ÂêåÊ≠•${breedersWithRaces.length}Âè™ÁßçÈ∏ΩÁöÑÂèÇËµõËÆ∞ÂΩïÔºö`, breedersWithRaces.map(p => ({
        name: p.name || p.ring,
        ring: p.ring,
        races: p.races.length
      })));
    }
  }
  
  // ÂÖ≥Èó≠ÊØîËµõÊ®°ÊÄÅÊ°Ü
  function closeRaceModal() {
    const modal = document.getElementById('raceModal');
    if (modal) modal.style.display = 'none';
  }
  
  // Ê†áÁ≠æÈ°µÂàáÊç¢
  function switchRaceTab(tabName) {
    document.querySelectorAll('.race-tab-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.tab === tabName) {
        btn.classList.add('active');
      }
    });
    
    document.querySelectorAll('.race-tab-content').forEach(content => {
      content.classList.remove('active');
      if (content.id === tabName + 'Tab') {
        content.classList.add('active');
      }
    });
  }
  
  // ÊØîËµõÁÆ°ÁêÜ‰∫ã‰ª∂ÁªëÂÆö
  const btnAddRace = document.getElementById('btnAddRace');
  const btnRefreshRaces = document.getElementById('btnRefreshRaces');
  const btnSaveRace = document.getElementById('btnSaveRace');
  const btnCancelRace = document.getElementById('btnCancelRace');
  const btnCloseRaceModal = document.getElementById('btnCloseRaceModal');
  const btnAddParticipant = document.getElementById('btnAddParticipant');
  const raceTabBtns = document.querySelectorAll('.race-tab-btn');
  
  if (btnAddRace) {
    btnAddRace.addEventListener('click', () => openRaceModal());
  }
  
  if (btnRefreshRaces) {
    btnRefreshRaces.addEventListener('click', () => {
      loadRaces();
      syncRacesToPigeons(); // ÂêåÊ≠•Êõ¥Êñ∞È∏ΩÂ≠êÊ°£Ê°à
      renderRaceList();
      refreshList(); // Âà∑Êñ∞È∏ΩÂ≠êÂàóË°®
    });
  }
  
  if (btnSaveRace) {
    btnSaveRace.addEventListener('click', saveRace);
  }
  
  if (btnCancelRace) {
    btnCancelRace.addEventListener('click', closeRaceModal);
  }
  
  if (btnCloseRaceModal) {
    btnCloseRaceModal.addEventListener('click', closeRaceModal);
  }
  
  if (btnAddParticipant) {
    btnAddParticipant.addEventListener('click', () => addParticipantRow());
  }
  
  raceTabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      switchRaceTab(btn.dataset.tab);
      // ÂàáÊç¢Âà∞ÊàêÁª©ÂàÜÊûêÊ†áÁ≠æÈ°µÊó∂Ëá™Âä®ÁîüÊàêÂàÜÊûê
      if (btn.dataset.tab === 'raceAnalysis') {
        generateOverallAnalysis();
      }
    });
  });
  
  // ÁîüÊàêÂçïÈ∏ΩÊàêÁª©ÁªüËÆ°
  function generateSinglePigeonStats(pigeonId) {
    const container = document.getElementById('raceStatsContainer');
    if (!container) return;
    
    const pigeon = getPigeonById(pigeonId);
    if (!pigeon) {
      container.innerHTML = '<p class="muted">Êú™ÊâæÂà∞ËØ•È∏ΩÂ≠ê</p>';
      return;
    }
    
    // Êî∂ÈõÜËØ•È∏ΩÂ≠êÁöÑÊâÄÊúâÊØîËµõÊàêÁª©Ôºà‰ºòÂÖà‰ªéÈ∏ΩÂ≠êÊ°£Ê°à‰∏≠ËØªÂèñÔºåÁ°Æ‰øùÊï∞ÊçÆÂêåÊ≠•Ôºâ
    let pigeonRaces = [];
    
    // Â¶ÇÊûúÈ∏ΩÂ≠êÊ°£Ê°à‰∏≠ÊúâÊØîËµõËÆ∞ÂΩïÔºå‰ºòÂÖà‰ΩøÁî®
    if (pigeon.races && pigeon.races.length > 0) {
      pigeonRaces = pigeon.races.map(race => ({
        raceName: race.raceName,
        date: race.date,
        location: race.location,
        weather: race.weather,
        rank: race.rank,
        score: race.score,
        returnTime: race.returnTime
      }));
    } else {
      // Â¶ÇÊûúÊ≤°ÊúâÔºå‰ªéÊØîËµõÊï∞ÊçÆ‰∏≠Êü•Êâæ
      races.forEach(race => {
        const participant = race.participants.find(p => p.pigeonId === pigeonId);
        if (participant) {
          pigeonRaces.push({
            raceName: race.name,
            date: race.date,
            location: race.location,
            weather: race.weather,
            rank: participant.rank,
            score: participant.score,
            returnTime: participant.returnTime
          });
        }
      });
      // ÂêåÊ≠•Âà∞È∏ΩÂ≠êÊ°£Ê°à
      if (pigeonRaces.length > 0) {
        syncRacesToPigeons();
      }
    }
    
    if (pigeonRaces.length === 0) {
      container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ËØ•È∏ΩÂ≠êÊöÇÊó†ÊØîËµõËÆ∞ÂΩï</p>';
      return;
    }
    
    // ÁîüÊàêÁªüËÆ°‰ø°ÊÅØ
    const sortedByRank = [...pigeonRaces].filter(r => r.rank).sort((a, b) => a.rank - b.rank);
    const bestRank = sortedByRank.length > 0 ? sortedByRank[0].rank : null;
    const avgRank = sortedByRank.length > 0 ? 
      Math.round(sortedByRank.reduce((sum, r) => sum + r.rank, 0) / sortedByRank.length) : null;
    const scores = pigeonRaces.filter(r => r.score).map(r => r.score);
    const avgScore = scores.length > 0 ? 
      (scores.reduce((sum, s) => sum + s, 0) / scores.length).toFixed(2) : null;
    const maxScore = scores.length > 0 ? Math.max(...scores).toFixed(2) : null;
    
    // ÁîüÊàêHTML
    let html = `
      <div class="stats-chart-container">
        <h3 style="margin:0 0 20px 0;color:#1f2937;">${pigeon.name || pigeon.ring} (${pigeon.ring}) ÊàêÁª©ÁªüËÆ°</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:24px;">
          <div style="background:linear-gradient(135deg, #e6f0ff 0%, #dbeafe 100%);padding:16px;border-radius:8px;">
            <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÂèÇËµõÊ¨°Êï∞</div>
            <div style="font-size:24px;font-weight:700;color:#1f2937;">${pigeonRaces.length}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);padding:16px;border-radius:8px;">
            <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÊúÄ‰Ω≥ÂêçÊ¨°</div>
            <div style="font-size:24px;font-weight:700;color:#1f2937;">${bestRank ? `Á¨¨${bestRank}Âêç` : '‚Äî'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);padding:16px;border-radius:8px;">
            <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Âπ≥ÂùáÂêçÊ¨°</div>
            <div style="font-size:24px;font-weight:700;color:#1f2937;">${avgRank ? `Á¨¨${avgRank}Âêç` : '‚Äî'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);padding:16px;border-radius:8px;">
            <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Âπ≥ÂùáÂàÜÊï∞</div>
            <div style="font-size:24px;font-weight:700;color:#1f2937;">${avgScore || '‚Äî'}</div>
          </div>
        </div>
        
        <h4 style="margin:20px 0 12px 0;color:#374151;">ÂêçÊ¨°Ë∂ãÂäøÂõæ</h4>
        <div style="height:200px;background:#f9fafb;border-radius:8px;padding:16px;display:flex;align-items:flex-end;justify-content:space-around;gap:8px;">
    `;
    
    // ÁªòÂà∂ÂêçÊ¨°Ë∂ãÂäøÂõæÔºàÊü±Áä∂ÂõæÔºâ
    sortedByRank.forEach((race, index) => {
      const height = Math.max(10, 180 - (race.rank - 1) * 15);
      html += `
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;">
          <div style="width:100%;background:linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);border-radius:4px 4px 0 0;height:${height}px;min-height:20px;position:relative;">
            <div style="position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:11px;font-weight:600;color:#1f2937;">${race.rank}</div>
          </div>
          <div style="font-size:10px;color:#6b7280;text-align:center;writing-mode:vertical-rl;text-orientation:mixed;max-width:60px;overflow:hidden;text-overflow:ellipsis;">${race.raceName}</div>
        </div>
      `;
    });
    
    html += `
        </div>
        
        <h4 style="margin:24px 0 12px 0;color:#374151;">ËØ¶ÁªÜÊØîËµõËÆ∞ÂΩï</h4>
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#f9fafb;">
              <th style="padding:10px;text-align:left;border-bottom:2px solid #e5e7eb;">ÊØîËµõÂêçÁß∞</th>
              <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">Êó•Êúü</th>
              <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">Âú∞ÁÇπ</th>
              <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂêçÊ¨°</th>
              <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂàÜÊï∞</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    pigeonRaces.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(race => {
      html += `
        <tr style="border-bottom:1px solid #f0f0f0;">
          <td style="padding:10px;">${race.raceName}</td>
          <td style="padding:10px;text-align:center;">${race.date}</td>
          <td style="padding:10px;text-align:center;">${race.location}</td>
          <td style="padding:10px;text-align:center;font-weight:600;color:#2b5cff;">${race.rank ? `Á¨¨${race.rank}Âêç` : '‚Äî'}</td>
          <td style="padding:10px;text-align:center;">${race.score || '‚Äî'}</td>
        </tr>
      `;
    });
    
    html += `
          </tbody>
        </table>
      </div>
      
      <div class="analysis-conclusion">
        <h4>üìä ÊàêÁª©ÂàÜÊûêÁªìËÆ∫</h4>
        <p><strong>ÊÄª‰ΩìË°®Áé∞Ôºö</strong>ËØ•È∏ΩÂ≠êÂÖ±ÂèÇÂä†${pigeonRaces.length}Âú∫ÊØîËµõ${bestRank ? `ÔºåÊúÄ‰Ω≥ÊàêÁª©‰∏∫Á¨¨${bestRank}Âêç` : ''}${avgRank ? `ÔºåÂπ≥ÂùáÂêçÊ¨°‰∏∫Á¨¨${avgRank}Âêç` : ''}„ÄÇ</p>
        ${bestRank && bestRank <= 3 ? '<p><strong>‰ºòÂäøÔºö</strong>ËØ•È∏ΩÂ≠êÂÖ∑Â§áËæÉÂº∫ÁöÑÁ´ûÊäÄËÉΩÂäõÔºåÂú®ÊØîËµõ‰∏≠Ë°®Áé∞Á™ÅÂá∫ÔºåÂª∫ËÆÆÁªßÁª≠‰Ωú‰∏∫ÈáçÁÇπÂüπÂÖªÂØπË±°„ÄÇ</p>' : ''}
        ${avgRank && avgRank <= 10 ? '<p><strong>Á®≥ÂÆöÊÄßÔºö</strong>ËØ•È∏ΩÂ≠êÊàêÁª©ËæÉ‰∏∫Á®≥ÂÆöÔºåÂπ≥ÂùáÂêçÊ¨°Ë°®Áé∞ËâØÂ•Ω„ÄÇ</p>' : avgRank && avgRank > 20 ? '<p><strong>ÊîπËøõÂª∫ËÆÆÔºö</strong>ËØ•È∏ΩÂ≠êÂπ≥ÂùáÂêçÊ¨°ËæÉ‰ΩéÔºåÂª∫ËÆÆÂä†Âº∫ËÆ≠ÁªÉÊàñËÄÉËôëË∞ÉÊï¥ÈÖçÂØπÁ≠ñÁï•„ÄÇ</p>' : ''}
        ${scores.length > 0 && avgScore ? `<p><strong>ÂàÜÊï∞ÂàÜÊûêÔºö</strong>Âπ≥ÂùáÂàÜÊï∞‰∏∫${avgScore}ÂàÜ${maxScore ? `ÔºåÊúÄÈ´òÂàÜÊï∞‰∏∫${maxScore}ÂàÜ` : ''}„ÄÇ</p>` : ''}
        <p><strong>Âª∫ËÆÆÔºö</strong>${bestRank && bestRank <= 5 ? 'ËØ•È∏ΩÂ≠êË°®Áé∞‰ºòÁßÄÔºåÂª∫ËÆÆ‰Ωú‰∏∫ÁßçÈ∏ΩÂÄôÈÄâÔºåÈáçÁÇπÂÖ≥Ê≥®ÂÖ∂Âêé‰ª£Ë°®Áé∞„ÄÇ' : 'Âª∫ËÆÆÁªßÁª≠ËßÇÂØüËØ•È∏ΩÂ≠êÁöÑË°®Áé∞ÔºåÊ†πÊçÆÂêéÁª≠ÊØîËµõÊàêÁª©ÂÜ≥ÂÆöÊòØÂê¶‰Ωú‰∏∫ÁßçÈ∏Ω„ÄÇ'}</p>
      </div>
    `;
    
    container.innerHTML = html;
  }
  
  // ÁîüÊàêÁªºÂêàÂàÜÊûêÔºàËá™Âä®ËØªÂèñÊâÄÊúâÊï∞ÊçÆÔºâ
  function generateOverallAnalysis() {
    const container = document.getElementById('raceAnalysisContainer');
    if (!container) return;
    
    // Ëá™Âä®ÂêåÊ≠•ÊØîËµõÊï∞ÊçÆ
    syncRacesToPigeons();
    
    // ÈáçÊñ∞Âä†ËΩΩÈ∏ΩÂ≠êÊï∞ÊçÆ‰ª•Á°Æ‰øùËé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆ
    loadFromStorage();
    
    // Êî∂ÈõÜÊâÄÊúâÁªüËÆ°Êï∞ÊçÆ
    const allPigeonRaces = [];
    const winners = []; // Ëé∑Â•ñÈ∏ΩÂ≠êÔºàÂâç3ÂêçÔºâ
    const top10 = []; // Ââç10Âêç
    const breedersWithRaces = []; // ÁßçÈ∏ΩÂèÇËµõËÆ∞ÂΩï
    const raceStats = {
      totalRaces: races.length,
      totalParticipants: 0,
      totalWinners: 0,
      byMonth: {},
      byLocation: {},
      byWeather: {}
    };
    
    // ÁªüËÆ°ÊØèÂè™È∏ΩÂ≠êÁöÑÊØîËµõÊï∞ÊçÆ
    pigeons.forEach(p => {
      // Ê£ÄÊü•ÊòØÂê¶ÊúâÊØîËµõËÆ∞ÂΩïÔºà‰ªéracesÂ≠óÊÆµÊàñ‰ªéÊØîËµõÊï∞ÊçÆ‰∏≠Êü•ÊâæÔºâ
      let pigeonRaces = p.races || [];
      
      // Â¶ÇÊûúÈ∏ΩÂ≠êÊ°£Ê°à‰∏≠Ê≤°ÊúâÊØîËµõËÆ∞ÂΩïÔºå‰ªéÊØîËµõÊï∞ÊçÆ‰∏≠Êü•Êâæ
      if (pigeonRaces.length === 0) {
        races.forEach(race => {
          const participant = race.participants.find(part => part.pigeonId === p.id);
          if (participant) {
            pigeonRaces.push({
              raceId: race.id,
              raceName: race.name,
              date: race.date,
              location: race.location,
              weather: race.weather,
              rank: participant.rank,
              score: participant.score,
              returnTime: participant.returnTime
            });
          }
        });
      }
      
      if (pigeonRaces.length > 0) {
        const pigeonStats = {
          pigeon: p,
          totalRaces: pigeonRaces.length,
          bestRank: null,
          avgRank: null,
          totalScore: 0,
          avgScore: null,
          wins: 0, // Ââç3ÂêçÊ¨°Êï∞
          top10Count: 0, // Ââç10ÂêçÊ¨°Êï∞
          isBreeder: p.type === 'ÁßçÈ∏Ω' || p.isCore // Ê†áËÆ∞ÊòØÂê¶‰∏∫ÁßçÈ∏Ω
        };
        
        const ranks = [];
        const scores = [];
        
        pigeonRaces.forEach(race => {
          if (race.rank) {
            ranks.push(race.rank);
            if (race.rank <= 3) pigeonStats.wins++;
            if (race.rank <= 10) pigeonStats.top10Count++;
            if (!pigeonStats.bestRank || race.rank < pigeonStats.bestRank) {
              pigeonStats.bestRank = race.rank;
            }
          }
          if (race.score) {
            scores.push(race.score);
            pigeonStats.totalScore += race.score;
          }
          
          // ÁªüËÆ°ÊØîËµõ‰ø°ÊÅØ
          raceStats.totalParticipants++;
          const month = race.date.substring(0, 7);
          raceStats.byMonth[month] = (raceStats.byMonth[month] || 0) + 1;
          raceStats.byLocation[race.location] = (raceStats.byLocation[race.location] || 0) + 1;
          if (race.weather) {
            raceStats.byWeather[race.weather] = (raceStats.byWeather[race.weather] || 0) + 1;
          }
        });
        
        if (ranks.length > 0) {
          pigeonStats.avgRank = Math.round(ranks.reduce((a, b) => a + b, 0) / ranks.length);
        }
        if (scores.length > 0) {
          pigeonStats.avgScore = (pigeonStats.totalScore / scores.length).toFixed(2);
        }
        
        allPigeonRaces.push(pigeonStats);
        
        // Â¶ÇÊûúÊòØÁßçÈ∏Ω‰∏îÊúâÂèÇËµõËÆ∞ÂΩïÔºåÂçïÁã¨ËÆ∞ÂΩï
        if (pigeonStats.isBreeder) {
          breedersWithRaces.push(pigeonStats);
        }
        
        if (pigeonStats.wins > 0) {
          winners.push(pigeonStats);
        }
        if (pigeonStats.top10Count > 0) {
          top10.push(pigeonStats);
        }
      }
    });
    
    // ÊéíÂ∫è
    winners.sort((a, b) => b.wins - a.wins || (a.bestRank || 999) - (b.bestRank || 999));
    top10.sort((a, b) => b.top10Count - a.top10Count);
    allPigeonRaces.sort((a, b) => b.totalRaces - a.totalRaces);
    
    // ÁîüÊàêHTML
    let html = `
      <div class="stats-chart-container">
        <h3 style="margin:0 0 24px 0;color:#1f2937;">üìä ÁªºÂêàÊàêÁª©ÂàÜÊûêÊä•Âëä</h3>
        
        <!-- ÊÄª‰ΩìÁªüËÆ° -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:24px;">
          <div style="background:linear-gradient(135deg, #e6f0ff 0%, #dbeafe 100%);padding:20px;border-radius:10px;">
            <div style="font-size:13px;color:#6b7280;margin-bottom:8px;">ÊÄªÊØîËµõÂú∫Ê¨°</div>
            <div style="font-size:32px;font-weight:700;color:#1f2937;">${raceStats.totalRaces}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);padding:20px;border-radius:10px;">
            <div style="font-size:13px;color:#6b7280;margin-bottom:8px;">ÊÄªÂèÇËµõÊ¨°Êï∞</div>
            <div style="font-size:32px;font-weight:700;color:#1f2937;">${raceStats.totalParticipants}</div>
          </div>
          <div style="background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);padding:20px;border-radius:10px;">
            <div style="font-size:13px;color:#6b7280;margin-bottom:8px;">Ëé∑Â•ñÈ∏ΩÂ≠êÊï∞</div>
            <div style="font-size:32px;font-weight:700;color:#1f2937;">${winners.length}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);padding:20px;border-radius:10px;">
            <div style="font-size:13px;color:#6b7280;margin-bottom:8px;">ÊúâÂèÇËµõËÆ∞ÂΩïÈ∏ΩÂ≠ê</div>
            <div style="font-size:32px;font-weight:700;color:#1f2937;">${allPigeonRaces.length}</div>
          </div>
        </div>
        
        <!-- Ëé∑Â•ñÈ∏ΩÂ≠êÊéíË°åÊ¶ú -->
        <h4 style="margin:24px 0 16px 0;color:#374151;">üèÜ Ëé∑Â•ñÈ∏ΩÂ≠êÊéíË°åÊ¶úÔºàÂâç3ÂêçÔºâ</h4>
        <div style="background:#fff;border-radius:10px;padding:20px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
    `;
    
    if (winners.length > 0) {
      html += `
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#f9fafb;">
              <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">ÊéíÂêç</th>
              <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">È∏ΩÂ≠ê</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Ëé∑Â•ñÊ¨°Êï∞</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">ÊúÄ‰Ω≥ÂêçÊ¨°</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Âπ≥ÂùáÂêçÊ¨°</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂèÇËµõÊ¨°Êï∞</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      winners.slice(0, 10).forEach((stats, index) => {
        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
        html += `
          <tr style="border-bottom:1px solid #f0f0f0;">
            <td style="padding:12px;font-weight:600;color:#2b5cff;">${medal} ${index + 1}</td>
            <td style="padding:12px;">${stats.pigeon.name || stats.pigeon.ring} (${stats.pigeon.ring})</td>
            <td style="padding:12px;text-align:center;font-weight:600;color:#f59e0b;">${stats.wins}Ê¨°</td>
            <td style="padding:12px;text-align:center;font-weight:600;color:#10b981;">Á¨¨${stats.bestRank}Âêç</td>
            <td style="padding:12px;text-align:center;">${stats.avgRank ? `Á¨¨${stats.avgRank}Âêç` : '‚Äî'}</td>
            <td style="padding:12px;text-align:center;">${stats.totalRaces}Âú∫</td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
    } else {
      html += '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†Ëé∑Â•ñËÆ∞ÂΩï</p>';
    }
    
    html += `
        </div>
        
        <!-- ÊØîËµõÂàÜÂ∏ÉÂõæË°® -->
        <h4 style="margin:24px 0 16px 0;color:#374151;">üìÖ ÊØîËµõÊó∂Èó¥ÂàÜÂ∏É</h4>
        <div style="background:#fff;border-radius:10px;padding:24px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
          <div style="height:200px;display:flex;align-items:flex-end;justify-content:space-around;gap:8px;">
    `;
    
    // ÁîüÊàêÊúà‰ªΩÂàÜÂ∏ÉÊü±Áä∂Âõæ
    const months = Object.keys(raceStats.byMonth).sort();
    const maxCount = Math.max(...Object.values(raceStats.byMonth), 1);
    months.forEach(month => {
      const count = raceStats.byMonth[month];
      const height = (count / maxCount) * 160;
      html += `
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:8px;">
          <div style="width:100%;background:linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);border-radius:4px 4px 0 0;height:${height}px;min-height:20px;position:relative;">
            <div style="position:absolute;top:-24px;left:50%;transform:translateX(-50%);font-size:11px;font-weight:600;color:#1f2937;white-space:nowrap;">${count}</div>
          </div>
          <div style="font-size:11px;color:#6b7280;text-align:center;writing-mode:vertical-rl;text-orientation:mixed;">${month}</div>
        </div>
      `;
    });
    
    html += `
          </div>
        </div>
        
        <!-- Âú∞ÁÇπÂàÜÂ∏É -->
        <h4 style="margin:24px 0 16px 0;color:#374151;">üìç ÊØîËµõÂú∞ÁÇπÂàÜÂ∏É</h4>
        <div style="background:#fff;border-radius:10px;padding:20px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
          <div style="display:flex;flex-wrap:wrap;gap:12px;">
    `;
    
    Object.entries(raceStats.byLocation).sort((a, b) => b[1] - a[1]).forEach(([location, count]) => {
      html += `
        <div style="background:linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%);padding:12px 16px;border-radius:8px;border:1px solid #dbeafe;">
          <span style="font-weight:600;color:#1f2937;">${location}</span>
          <span style="color:#6b7280;margin-left:8px;">${count}Âú∫</span>
        </div>
      `;
    });
    
    html += `
          </div>
        </div>
        
        <!-- ÁßçÈ∏ΩÂèÇËµõÊÉÖÂÜµ -->
        <h4 style="margin:24px 0 16px 0;color:#374151;">‚≠ê ÁßçÈ∏ΩÂèÇËµõÊÉÖÂÜµÂàÜÊûê</h4>
        <div style="background:#fff;border-radius:10px;padding:20px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
    `;
    
    if (breedersWithRaces.length > 0) {
      html += `
        <p style="margin:0 0 16px 0;color:#6b7280;">ÂÖ±Êúâ<strong style="color:#f59e0b;">${breedersWithRaces.length}</strong>Âè™ÁßçÈ∏ΩÂèÇÂä†ËøáÊØîËµõÔºö</p>
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#f9fafb;">
              <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">ÁßçÈ∏Ω</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂèÇËµõÊ¨°Êï∞</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">ÊúÄ‰Ω≥ÂêçÊ¨°</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Âπ≥ÂùáÂêçÊ¨°</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Ëé∑Â•ñÊ¨°Êï∞</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Âπ≥ÂùáÂàÜÊï∞</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      breedersWithRaces.sort((a, b) => b.totalRaces - a.totalRaces || (a.bestRank || 999) - (b.bestRank || 999)).forEach(stats => {
        html += `
          <tr style="border-bottom:1px solid #f0f0f0;">
            <td style="padding:12px;">
              <strong style="color:#f59e0b;">${stats.pigeon.name || stats.pigeon.ring}</strong>
              <span style="color:#6b7280;font-size:12px;margin-left:8px;">(${stats.pigeon.ring})</span>
              ${stats.pigeon.isCore ? '<span style="background:#fef3c7;color:#b45309;padding:2px 6px;border-radius:4px;font-size:11px;margin-left:8px;">Ê†∏ÂøÉÁßçÈ∏Ω</span>' : ''}
            </td>
            <td style="padding:12px;text-align:center;font-weight:600;">${stats.totalRaces}Âú∫</td>
            <td style="padding:12px;text-align:center;font-weight:600;color:#10b981;">${stats.bestRank ? `Á¨¨${stats.bestRank}Âêç` : '‚Äî'}</td>
            <td style="padding:12px;text-align:center;">${stats.avgRank ? `Á¨¨${stats.avgRank}Âêç` : '‚Äî'}</td>
            <td style="padding:12px;text-align:center;font-weight:600;color:#f59e0b;">${stats.wins}Ê¨°</td>
            <td style="padding:12px;text-align:center;">${stats.avgScore || '‚Äî'}</td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
    } else {
      // Ê£ÄÊü•ÊòØÂê¶ÊúâÁßçÈ∏Ω‰ΩÜÊ≤°ÊúâÂèÇËµõËÆ∞ÂΩï
      const allBreeders = pigeons.filter(p => p.type === 'ÁßçÈ∏Ω' || p.isCore);
      if (allBreeders.length > 0) {
        html += `
          <p style="margin:0 0 12px 0;color:#6b7280;">Á≥ªÁªü‰∏≠ÂÖ±Êúâ<strong>${allBreeders.length}</strong>Âè™ÁßçÈ∏ΩÔºå‰ΩÜÊöÇÊó†ÂèÇËµõËÆ∞ÂΩï„ÄÇ</p>
          <p style="margin:0;color:#9ca3af;font-size:13px;">üí° ÊèêÁ§∫ÔºöÂ¶ÇÊûúÁßçÈ∏ΩÂ∑≤ÂèÇÂä†ÊØîËµõÔºåËØ∑Á°Æ‰øùÂú®"ÊØîËµõÂàóË°®"‰∏≠Ê∑ªÂä†ÊØîËµõËÆ∞ÂΩïÂπ∂ÂÖ≥ËÅîËØ•ÁßçÈ∏Ω„ÄÇ</p>
        `;
      } else {
        html += '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÁßçÈ∏ΩÂèÇËµõËÆ∞ÂΩï</p>';
      }
    }
    
    html += `
        </div>
      </div>
      
      <!-- ÁªºÂêàÂàÜÊûêÁªìËÆ∫ -->
      <div class="analysis-conclusion">
        <h4>üìà ÁªºÂêàÂàÜÊûêÁªìËÆ∫</h4>
        <p><strong>ÊÄª‰ΩìÊÉÖÂÜµÔºö</strong>Á≥ªÁªüÂÖ±ËÆ∞ÂΩï${raceStats.totalRaces}Âú∫ÊØîËµõÔºå${allPigeonRaces.length}Âè™È∏ΩÂ≠êÊúâÂèÇËµõËÆ∞ÂΩïÔºåÁ¥ØËÆ°ÂèÇËµõ${raceStats.totalParticipants}Ê¨°„ÄÇ</p>
        ${breedersWithRaces.length > 0 ? `<p><strong>ÁßçÈ∏ΩÂèÇËµõÊÉÖÂÜµÔºö</strong>ÂÖ±Êúâ${breedersWithRaces.length}Âè™ÁßçÈ∏ΩÂèÇÂä†ËøáÊØîËµõÔºåÂÖ∂‰∏≠${breedersWithRaces[0] ? breedersWithRaces[0].pigeon.name || breedersWithRaces[0].pigeon.ring : ''}ÂèÇËµõ${breedersWithRaces[0] ? breedersWithRaces[0].totalRaces : 0}Âú∫${breedersWithRaces[0] && breedersWithRaces[0].bestRank ? `ÔºåÊúÄ‰Ω≥ÊàêÁª©Á¨¨${breedersWithRaces[0].bestRank}Âêç` : ''}„ÄÇ</p>` : ''}
        ${winners.length > 0 ? `<p><strong>Ëé∑Â•ñÊÉÖÂÜµÔºö</strong>ÂÖ±Êúâ${winners.length}Âè™È∏ΩÂ≠êËé∑ÂæóËøáÂâç3ÂêçÁöÑÂ•ΩÊàêÁª©ÔºåÂÖ∂‰∏≠${winners[0] ? winners[0].pigeon.name || winners[0].pigeon.ring : ''}Ë°®Áé∞ÊúÄ‰∏∫Á™ÅÂá∫ÔºåËé∑Âæó${winners[0] ? winners[0].wins : 0}Ê¨°Ââç3Âêç„ÄÇ</p>` : '<p><strong>Ëé∑Â•ñÊÉÖÂÜµÔºö</strong>ÊöÇÊó†Ëé∑Â•ñËÆ∞ÂΩï„ÄÇ</p>'}
        ${allPigeonRaces.length > 0 ? `<p><strong>ÂèÇËµõÊ¥ªË∑ÉÂ∫¶Ôºö</strong>${allPigeonRaces[0] ? allPigeonRaces[0].pigeon.name || allPigeonRaces[0].pigeon.ring : ''}ÂèÇËµõÊúÄ‰∏∫Ê¥ªË∑ÉÔºåÂÖ±ÂèÇÂä†${allPigeonRaces[0] ? allPigeonRaces[0].totalRaces : 0}Âú∫ÊØîËµõ„ÄÇ</p>` : ''}
        ${months.length > 0 ? `<p><strong>Êó∂Èó¥ÂàÜÂ∏ÉÔºö</strong>ÊØîËµõ‰∏ªË¶ÅÈõÜ‰∏≠Âú®${months.slice(0, 3).join('„ÄÅ')}Á≠âÊúà‰ªΩ„ÄÇ</p>` : ''}
        <p><strong>Âª∫ËÆÆÔºö</strong>${breedersWithRaces.length > 0 ? 'ÁßçÈ∏ΩÁöÑÂèÇËµõË°®Áé∞ÊòØËØÑ‰º∞ÂÖ∂ËÇ≤Áßç‰ª∑ÂÄºÁöÑÈáçË¶ÅÊåáÊ†áÔºåÂª∫ËÆÆÈáçÁÇπÂÖ≥Ê≥®ÁßçÈ∏ΩÁöÑÊØîËµõÊàêÁª©ÔºåÁªìÂêàË°ÄÁªüÂàÜÊûê‰ºòÂåñÈÖçÂØπÁ≠ñÁï•„ÄÇ' : winners.length > 0 ? 'Âª∫ËÆÆÈáçÁÇπÂÖ≥Ê≥®Ëé∑Â•ñÈ∏ΩÂ≠êÁöÑË°ÄÁªüÂíåÈÖçÂØπÊÉÖÂÜµÔºåÂàÜÊûêÂÖ∂‰ºòÂäøÂü∫Âõ†ÔºåÁî®‰∫éÂêéÁª≠ËÇ≤Áßç„ÄÇ' : 'Âª∫ËÆÆÂä†Âº∫ËÆ≠ÁªÉÔºåÊèêÈ´òÊï¥‰ΩìÁ´ûÊäÄÊ∞¥Âπ≥„ÄÇ'}ÂÆöÊúüÂàÜÊûêÊØîËµõÊï∞ÊçÆÔºå‰ºòÂåñËÇ≤ÁßçÁ≠ñÁï•„ÄÇ</p>
      </div>
    `;
    
    container.innerHTML = html;
  }
  
  // Â°´ÂÖÖÁªüËÆ°Á±ªÂûãÈÄâÊã©Ê°Ü
  function fillStatsPigeonSelect() {
    const select = document.getElementById('statsPigeonSelect');
    if (!select) return;
    
    const currentValue = select.value;
    select.innerHTML = '<option value="">ÈÄâÊã©È∏ΩÂ≠ê...</option>';
    pigeons.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = `${p.ring}${p.name ? ' - ' + p.name : ''}`;
      if (currentValue === p.id) {
        option.selected = true;
      }
      select.appendChild(option);
    });
  }
  
  // ÁîüÊàêÁªüËÆ°ÊåâÈíÆ‰∫ã‰ª∂
  const btnGenerateStats = document.getElementById('btnGenerateStats');
  const statsTypeSelect = document.getElementById('statsTypeSelect');
  const statsPigeonSelect = document.getElementById('statsPigeonSelect');
  
  if (btnGenerateStats) {
    btnGenerateStats.addEventListener('click', () => {
      const type = statsTypeSelect ? statsTypeSelect.value : 'single';
      const pigeonId = statsPigeonSelect ? statsPigeonSelect.value : '';
      
      if (!pigeonId) {
        alert('ËØ∑ÈÄâÊã©Ë¶ÅÁªüËÆ°ÁöÑÈ∏ΩÂ≠ê');
        return;
      }
      
      if (type === 'single') {
        generateSinglePigeonStats(pigeonId);
      } else if (type === 'bloodline') {
        // TODO: ÂÆûÁé∞Ë°ÄÁ≥ªÁªüËÆ°
        alert('Ë°ÄÁ≥ªÁªüËÆ°ÂäüËÉΩÂºÄÂèë‰∏≠...');
      } else if (type === 'parents') {
        // TODO: ÂÆûÁé∞Áà∂ÊØçÂêé‰ª£ÁªüËÆ°
        alert('Áà∂ÊØçÂêé‰ª£ÁªüËÆ°ÂäüËÉΩÂºÄÂèë‰∏≠...');
      }
    });
  }
  
  // ========================================
  // üß¨ Ê®°Âùó2ÔºöÁπÅËÇ≤‰∏éÈÖçÂØπÁÆ°ÁêÜ
  // ========================================
  
  const PAIRINGS_STORAGE_KEY = 'pigeon_pairings_v1';
  let pairings = [];
  
  function loadPairings() {
    try {
      const raw = localStorage.getItem(PAIRINGS_STORAGE_KEY);
      if (raw) pairings = JSON.parse(raw);
    } catch (e) {
      console.error('Âä†ËΩΩÈÖçÂØπÊï∞ÊçÆÂ§±Ë¥•:', e);
    }
  }
  
  function savePairings() {
    try {
      localStorage.setItem(PAIRINGS_STORAGE_KEY, JSON.stringify(pairings));
    } catch (e) {
      console.error('‰øùÂ≠òÈÖçÂØπÊï∞ÊçÆÂ§±Ë¥•:', e);
    }
  }
  
  // Ëé∑ÂèñÈ∏ΩÂ≠êÁöÑÁ•ñÂÖàÔºàÈÄíÂΩíÂêë‰∏ä N ‰ª£Ôºâ
  function getAncestors(pigeonId, generations = 5, visited = new Set()) {
    if (!pigeonId || generations <= 0 || visited.has(pigeonId)) return [];
    visited.add(pigeonId);
    
    const pigeon = getPigeonById(pigeonId);
    if (!pigeon) return [];
    
    const ancestors = [];
    
    // Ê∑ªÂä†Áà∂È∏ΩÁ•ñÂÖà
    if (pigeon.fatherId) {
      ancestors.push({ id: pigeon.fatherId, generation: 1, side: 'father' });
      const fatherAncestors = getAncestors(pigeon.fatherId, generations - 1, visited);
      fatherAncestors.forEach(a => {
        ancestors.push({ ...a, generation: a.generation + 1 });
      });
    }
    
    // Ê∑ªÂä†ÊØçÈ∏ΩÁ•ñÂÖà
    if (pigeon.motherId) {
      ancestors.push({ id: pigeon.motherId, generation: 1, side: 'mother' });
      const motherAncestors = getAncestors(pigeon.motherId, generations - 1, visited);
      motherAncestors.forEach(a => {
        ancestors.push({ ...a, generation: a.generation + 1 });
      });
    }
    
    return ancestors;
  }
  
  // ËÆ°ÁÆóËøë‰∫≤Á≥ªÊï∞ÔºàÊ†∏ÂøÉÁÆóÊ≥ïÔºâ
  function calculateInbreedingCoefficient(maleId, femaleId) {
    const maleAncestors = getAncestors(maleId, 5);
    const femaleAncestors = getAncestors(femaleId, 5);
    
    const maleAncestorMap = new Map();
    maleAncestors.forEach(a => {
      if (!maleAncestorMap.has(a.id)) {
        maleAncestorMap.set(a.id, []);
      }
      maleAncestorMap.get(a.id).push(a.generation);
    });
    
    let inbreedingCoefficient = 0;
    const commonAncestors = [];
    
    femaleAncestors.forEach(fa => {
      if (maleAncestorMap.has(fa.id)) {
        const maleGenerations = maleAncestorMap.get(fa.id);
        maleGenerations.forEach(mg => {
          // Ëøë‰∫≤Á≥ªÊï∞ÂÖ¨Âºè: Œ£ (1 / 2^(n1 + n2))
          const contribution = Math.pow(0.5, mg + fa.generation);
          inbreedingCoefficient += contribution;
          
          const ancestor = getPigeonById(fa.id);
          if (ancestor && !commonAncestors.find(ca => ca.id === fa.id)) {
            commonAncestors.push({
              id: fa.id,
              name: ancestor.name || ancestor.ring,
              maleGen: mg,
              femaleGen: fa.generation
            });
          }
        });
      }
    });
    
    // ËΩ¨Êç¢‰∏∫ÁôæÂàÜÊØî (ÈÄöÂ∏∏‰∏çË∂ÖËøá50%)
    const percentage = Math.min(inbreedingCoefficient * 100, 50);
    
    return {
      coefficient: inbreedingCoefficient,
      percentage: percentage.toFixed(2),
      commonAncestors: commonAncestors,
      riskLevel: percentage < 6.25 ? 'low' : percentage < 12.5 ? 'medium' : 'high'
    };
  }
  
  // ËÆ°ÁÆóÂéÜÂè≤ÊàêÂäüÁéá
  function calculatePairingSuccessRate(maleId, femaleId) {
    const male = getPigeonById(maleId);
    const female = getPigeonById(femaleId);
    if (!male || !female) return null;
    
    // Êü•ÊâæÁõ∏ÂêåË°ÄÁ≥ªÁöÑÂéÜÂè≤ÈÖçÂØπ
    const relatedPairings = pairings.filter(p => {
      const pMale = getPigeonById(p.maleId);
      const pFemale = getPigeonById(p.femaleId);
      if (!pMale || !pFemale) return false;
      
      // Ê£ÄÊü•ÊòØÂê¶ÊòØÁõ∏ÂêåÊàñÁõ∏ÂÖ≥Ë°ÄÁ≥ª
      return (
        p.maleId === maleId || p.femaleId === femaleId ||
        pMale.fatherId === male.fatherId || pMale.motherId === male.motherId ||
        pFemale.fatherId === female.fatherId || pFemale.motherId === female.motherId
      );
    });
    
    if (relatedPairings.length === 0) return null;
    
    // ËÆ°ÁÆóÂêé‰ª£Ë°®Áé∞
    let totalOffspring = 0;
    let racedOffspring = 0;
    let awardedOffspring = 0;
    let totalRank = 0;
    let rankCount = 0;
    
    relatedPairings.forEach(pairing => {
      // Êü•ÊâæËøôÂØπÈÖçÂØπÁöÑÂêé‰ª£
      const offspring = pigeons.filter(p => 
        p.fatherId === pairing.maleId && p.motherId === pairing.femaleId
      );
      
      totalOffspring += offspring.length;
      
      offspring.forEach(child => {
        if (child.races && child.races.length > 0) {
          racedOffspring++;
          child.races.forEach(race => {
            if (race.rank) {
              totalRank += race.rank;
              rankCount++;
              if (race.rank <= 10) awardedOffspring++;
            }
          });
        }
      });
    });
    
    return {
      relatedPairings: relatedPairings.length,
      totalOffspring,
      racedOffspring,
      awardedOffspring,
      avgRank: rankCount > 0 ? (totalRank / rankCount).toFixed(1) : null,
      raceRate: totalOffspring > 0 ? ((racedOffspring / totalOffspring) * 100).toFixed(1) : 0,
      awardRate: racedOffspring > 0 ? ((awardedOffspring / racedOffspring) * 100).toFixed(1) : 0
    };
  }
  
  // ÁîüÊàêÈÖçÂØπËØÑ‰º∞
  function generatePairingAssessment(maleId, femaleId) {
    const male = getPigeonById(maleId);
    const female = getPigeonById(femaleId);
    
    if (!male || !female) {
      return { score: 0, recommendation: 'unknown', reasons: [] };
    }
    
    const inbreeding = calculateInbreedingCoefficient(maleId, femaleId);
    const successRate = calculatePairingSuccessRate(maleId, femaleId);
    
    let score = 70; // Âü∫Á°ÄÂàÜ
    const reasons = [];
    
    // Ëøë‰∫≤Á≥ªÊï∞ËØÑ‰º∞
    if (inbreeding.riskLevel === 'low') {
      score += 15;
      reasons.push('‚úÖ Ëøë‰∫≤Á≥ªÊï∞‰ΩéÔºåÈÅó‰º†Â§öÊ†∑ÊÄßÂ•Ω');
    } else if (inbreeding.riskLevel === 'medium') {
      score += 5;
      reasons.push('‚ö†Ô∏è ‰∏≠Á≠âËøë‰∫≤È£éÈô©ÔºåÈúÄË¶ÅÂÖ≥Ê≥®');
    } else {
      score -= 20;
      reasons.push('‚ùå È´òËøë‰∫≤È£éÈô©Ôºå‰∏çÂª∫ËÆÆÈÖçÂØπ');
    }
    
    // ÂéÜÂè≤ÊàêÂäüÁéáËØÑ‰º∞
    if (successRate) {
      if (parseFloat(successRate.awardRate) > 30) {
        score += 15;
        reasons.push(`‚úÖ Áõ∏ÂÖ≥Ë°ÄÁ≥ªÂéÜÂè≤Ëé∑Â•ñÁéá${successRate.awardRate}%`);
      } else if (parseFloat(successRate.raceRate) > 50) {
        score += 10;
        reasons.push(`‚úÖ Áõ∏ÂÖ≥Ë°ÄÁ≥ªÂá∫ËµõÁéá${successRate.raceRate}%`);
      }
    }
    
    // ÁßçÈ∏ΩËØÑ‰º∞
    if (male.isCore) {
      score += 10;
      reasons.push('‚úÖ ÂÖ¨È∏Ω‰∏∫Ê†∏ÂøÉÁßçÈ∏Ω');
    }
    if (female.isCore) {
      score += 10;
      reasons.push('‚úÖ ÊØçÈ∏Ω‰∏∫Ê†∏ÂøÉÁßçÈ∏Ω');
    }
    
    // ÂèÇËµõÊàêÁª©ËØÑ‰º∞
    const maleRaces = male.races || [];
    const femaleRaces = female.races || [];
    
    const maleBestRank = maleRaces.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999);
    const femaleBestRank = femaleRaces.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999);
    
    if (maleBestRank <= 10) {
      score += 10;
      reasons.push(`‚úÖ ÂÖ¨È∏ΩÊúÄ‰Ω≥ÊàêÁª©Á¨¨${maleBestRank}Âêç`);
    }
    if (femaleBestRank <= 10) {
      score += 10;
      reasons.push(`‚úÖ ÊØçÈ∏ΩÊúÄ‰Ω≥ÊàêÁª©Á¨¨${femaleBestRank}Âêç`);
    }
    
    // ÈôêÂà∂ÂàÜÊï∞ËåÉÂõ¥
    score = Math.max(0, Math.min(100, score));
    
    // Êé®ËçêÁ≠âÁ∫ß
    let recommendation;
    if (score >= 80) recommendation = 'Âº∫ÁÉàÊé®Ëçê';
    else if (score >= 60) recommendation = 'Êé®Ëçê';
    else if (score >= 40) recommendation = 'Ë∞®ÊÖéÈÖçÂØπ';
    else recommendation = '‰∏çÂª∫ËÆÆ';
    
    return {
      score,
      recommendation,
      reasons,
      inbreeding,
      successRate
    };
  }
  
  // Â°´ÂÖÖÁπÅËÇ≤ÈÖçÂØπÈÄâÊã©Ê°Ü
  function fillBreedingSelects() {
    const maleSelect = document.getElementById('breedingMaleSelect');
    const femaleSelect = document.getElementById('breedingFemaleSelect');
    
    if (!maleSelect || !femaleSelect) return;
    
    maleSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©ÂÖ¨È∏Ω...</option>';
    femaleSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©ÊØçÈ∏Ω...</option>';
    
    pigeons.filter(p => p.alive && p.gender === 'ÂÖ¨').forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = `${p.name || p.ring} (${p.ring})${p.isCore ? ' ‚≠ê' : ''}`;
      maleSelect.appendChild(option);
    });
    
    pigeons.filter(p => p.alive && p.gender === 'ÊØç').forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = `${p.name || p.ring} (${p.ring})${p.isCore ? ' ‚≠ê' : ''}`;
      femaleSelect.appendChild(option);
    });
  }
  
  // ÊòæÁ§∫È∏ΩÂ≠ê‰ø°ÊÅØÂç°Áâá
  function showPigeonBreedingInfo(pigeon, containerId) {
    const container = document.getElementById(containerId);
    if (!container || !pigeon) {
      if (container) {
        container.innerHTML = '<p class="muted" style="text-align:center;padding:20px;">ÈÄâÊã©ÂêéÊòæÁ§∫ËØ¶ÊÉÖ</p>';
      }
      return;
    }
    
    const races = pigeon.races || [];
    const bestRank = races.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999);
    const wins = races.filter(r => r.rank && r.rank <= 3).length;
    
    container.innerHTML = `
      <div class="breeding-pigeon-info">
        <div class="breeding-pigeon-info-row">
          <span>ÂêçÁß∞</span>
          <strong>${pigeon.name || '‚Äî'}</strong>
        </div>
        <div class="breeding-pigeon-info-row">
          <span>Ë∂≥ÁéØÂè∑</span>
          <strong>${pigeon.ring}</strong>
        </div>
        <div class="breeding-pigeon-info-row">
          <span>Á±ªÂûã</span>
          <strong>${pigeon.type || '‚Äî'} ${pigeon.isCore ? '‚≠ê' : ''}</strong>
        </div>
        <div class="breeding-pigeon-info-row">
          <span>ÁæΩËâ≤</span>
          <strong>${pigeon.color || '‚Äî'}</strong>
        </div>
        <div class="breeding-pigeon-info-row">
          <span>ÂèÇËµõÊ¨°Êï∞</span>
          <strong>${races.length}Âú∫</strong>
        </div>
        <div class="breeding-pigeon-info-row">
          <span>ÊúÄ‰Ω≥ÊàêÁª©</span>
          <strong>${bestRank < 999 ? `Á¨¨${bestRank}Âêç` : '‚Äî'}</strong>
        </div>
        <div class="breeding-pigeon-info-row">
          <span>Ââç3ÂêçÊ¨°Êï∞</span>
          <strong style="color:#f59e0b;">${wins}Ê¨°</strong>
        </div>
      </div>
    `;
  }
  
  // Êõ¥Êñ∞ÈÖçÂØπËØÑ‰º∞ÊòæÁ§∫
  function updateBreedingAssessment() {
    const maleId = document.getElementById('breedingMaleSelect')?.value;
    const femaleId = document.getElementById('breedingFemaleSelect')?.value;
    const container = document.getElementById('breedingAssessment');
    const confirmBtn = document.getElementById('btnConfirmPairing');
    
    if (!container) return;
    
    // ÊòæÁ§∫ÂêÑËá™ÁöÑ‰ø°ÊÅØ
    showPigeonBreedingInfo(getPigeonById(maleId), 'breedingMaleInfo');
    showPigeonBreedingInfo(getPigeonById(femaleId), 'breedingFemaleInfo');
    
    if (!maleId || !femaleId) {
      container.innerHTML = `
        <div style="text-align:center;padding:40px 20px;color:#9ca3af;">
          <div style="font-size:32px;margin-bottom:12px;">üîÆ</div>
          <p>ËØ∑ÂÖàÈÄâÊã©ÂÖ¨È∏ΩÂíåÊØçÈ∏Ω</p>
          <p style="font-size:12px;">Á≥ªÁªüÂ∞ÜËá™Âä®ÂàÜÊûêËøë‰∫≤È£éÈô©‰∏éÈÖçÂØπÂª∫ËÆÆ</p>
        </div>
      `;
      if (confirmBtn) confirmBtn.disabled = true;
      return;
    }
    
    const assessment = generatePairingAssessment(maleId, femaleId);
    
    // Ëøë‰∫≤Á≥ªÊï∞È¢úËâ≤
    const inbreedingColor = assessment.inbreeding.riskLevel === 'low' ? '#10b981' : 
                           assessment.inbreeding.riskLevel === 'medium' ? '#f59e0b' : '#ef4444';
    const inbreedingClass = `inbreeding-${assessment.inbreeding.riskLevel}`;
    
    container.innerHTML = `
      <div style="text-align:center;margin-bottom:20px;">
        <div style="font-size:48px;font-weight:700;color:${assessment.score >= 60 ? '#10b981' : assessment.score >= 40 ? '#f59e0b' : '#ef4444'};">
          ${assessment.score}
        </div>
        <div style="font-size:14px;color:#6b7280;">ÈÖçÂØπËØÑÂàÜ</div>
        <div style="margin-top:8px;padding:6px 16px;border-radius:999px;display:inline-block;font-size:13px;font-weight:600;
          background:${assessment.score >= 80 ? '#d1fae5' : assessment.score >= 60 ? '#fef3c7' : assessment.score >= 40 ? '#fee2e2' : '#fecaca'};
          color:${assessment.score >= 80 ? '#047857' : assessment.score >= 60 ? '#b45309' : assessment.score >= 40 ? '#dc2626' : '#b91c1c'};">
          ${assessment.recommendation}
        </div>
      </div>
      
      <div style="margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px;">
          <span>Ëøë‰∫≤Á≥ªÊï∞</span>
          <span style="font-weight:600;color:${inbreedingColor};">${assessment.inbreeding.percentage}%</span>
        </div>
        <div class="inbreeding-meter">
          <div class="inbreeding-meter-fill ${inbreedingClass}" style="width:${Math.min(assessment.inbreeding.percentage * 2, 100)}%;"></div>
        </div>
      </div>
      
      ${assessment.inbreeding.commonAncestors.length > 0 ? `
        <div style="margin-bottom:16px;padding:12px;background:rgba(0,0,0,0.03);border-radius:8px;">
          <div style="font-size:12px;color:#6b7280;margin-bottom:8px;">ÂÖ±ÂêåÁ•ñÂÖàÔºö</div>
          ${assessment.inbreeding.commonAncestors.slice(0, 3).map(a => `
            <span style="display:inline-block;padding:4px 8px;background:#fff;border-radius:4px;font-size:12px;margin:2px;">${a.name}</span>
          `).join('')}
        </div>
      ` : ''}
      
      <div style="font-size:12px;">
        ${assessment.reasons.map(r => `<div style="padding:4px 0;color:#4b5563;">${r}</div>`).join('')}
      </div>
      
      ${assessment.successRate ? `
        <div style="margin-top:16px;padding:12px;background:rgba(0,0,0,0.03);border-radius:8px;font-size:12px;">
          <div style="font-weight:600;margin-bottom:8px;">üìä Áõ∏ÂÖ≥Ë°ÄÁ≥ªÂéÜÂè≤</div>
          <div>Áõ∏ÂÖ≥ÈÖçÂØπÔºö${assessment.successRate.relatedPairings}ÂØπ</div>
          <div>Âêé‰ª£Êï∞ÈáèÔºö${assessment.successRate.totalOffspring}Âè™</div>
          <div>Âá∫ËµõÁéáÔºö${assessment.successRate.raceRate}%</div>
          <div>Ëé∑Â•ñÁéáÔºö${assessment.successRate.awardRate}%</div>
        </div>
      ` : ''}
    `;
    
    if (confirmBtn) {
      confirmBtn.disabled = false;
      confirmBtn.style.background = assessment.score >= 60 ? 
        'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 
        assessment.score >= 40 ? 
        'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : 
        'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
    }
  }
  
  // Ê∏≤ÊüìÈÖçÂØπÂéÜÂè≤
  function renderPairingHistory() {
    const container = document.getElementById('breedingHistoryContainer');
    if (!container) return;
    
    if (pairings.length === 0) {
      container.innerHTML = '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÈÖçÂØπÂéÜÂè≤ËÆ∞ÂΩï</p>';
      return;
    }
    
    let html = '';
    pairings.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(pairing => {
      const male = getPigeonById(pairing.maleId);
      const female = getPigeonById(pairing.femaleId);
      if (!male || !female) return;
      
      // Êü•ÊâæÂêé‰ª£
      const offspring = pigeons.filter(p => 
        p.fatherId === pairing.maleId && p.motherId === pairing.femaleId
      );
      
      const offspringWithRaces = offspring.filter(o => o.races && o.races.length > 0);
      const offspringWins = offspring.reduce((count, o) => {
        return count + (o.races || []).filter(r => r.rank && r.rank <= 3).length;
      }, 0);
      
      html += `
        <div class="pairing-history-item">
          <div>
            <div style="font-weight:600;color:#1e40af;">‚ôÇ ${male.name || male.ring}</div>
            <div style="font-size:12px;color:#6b7280;">${male.ring}</div>
          </div>
          <div>
            <div style="font-weight:600;color:#be185d;">‚ôÄ ${female.name || female.ring}</div>
            <div style="font-size:12px;color:#6b7280;">${female.ring}</div>
          </div>
          <div>
            <div style="font-size:13px;">Âêé‰ª£Ôºö<strong>${offspring.length}</strong>Âè™</div>
            <div style="font-size:12px;color:#6b7280;">
              ÂèÇËµõ${offspringWithRaces.length}Âè™ | Ëé∑Â•ñ${offspringWins}Ê¨°
            </div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:12px;color:#6b7280;">${pairing.date}</div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html || '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÈÖçÂØπÂéÜÂè≤ËÆ∞ÂΩï</p>';
  }
  
  // ‰øùÂ≠òÈÖçÂØπ
  function savePairingRecord() {
    const maleId = document.getElementById('breedingMaleSelect')?.value;
    const femaleId = document.getElementById('breedingFemaleSelect')?.value;
    const date = document.getElementById('pairingDate')?.value;
    const note = document.getElementById('pairingNote')?.value;
    
    if (!maleId || !femaleId) {
      alert('ËØ∑ÈÄâÊã©ÂÖ¨È∏ΩÂíåÊØçÈ∏Ω');
      return;
    }
    if (!date) {
      alert('ËØ∑ÈÄâÊã©ÈÖçÂØπÊó•Êúü');
      return;
    }
    
    const pairing = {
      id: 'pair_' + Date.now(),
      maleId,
      femaleId,
      date,
      note,
      createdAt: new Date().toISOString()
    };
    
    pairings.push(pairing);
    savePairings();
    
    // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
    document.getElementById('pairingModal').style.display = 'none';
    
    // Âà∑Êñ∞ÊòæÁ§∫
    renderPairingHistory();
    
    alert('ÈÖçÂØπËÆ∞ÂΩïÂ∑≤‰øùÂ≠òÔºÅ');
  }
  
  // ÁπÅËÇ≤Ê®°Âùó‰∫ã‰ª∂ÁªëÂÆö
  document.getElementById('breedingMaleSelect')?.addEventListener('change', updateBreedingAssessment);
  document.getElementById('breedingFemaleSelect')?.addEventListener('change', updateBreedingAssessment);
  
  document.getElementById('btnConfirmPairing')?.addEventListener('click', () => {
    const maleId = document.getElementById('breedingMaleSelect')?.value;
    const femaleId = document.getElementById('breedingFemaleSelect')?.value;
    
    if (!maleId || !femaleId) {
      alert('ËØ∑ÂÖàÈÄâÊã©ÂÖ¨È∏ΩÂíåÊØçÈ∏Ω');
      return;
    }
    
    const male = getPigeonById(maleId);
    const female = getPigeonById(femaleId);
    const assessment = generatePairingAssessment(maleId, femaleId);
    
    document.getElementById('pairingConfirmContent').innerHTML = `
      <div style="text-align:center;margin-bottom:20px;">
        <div style="display:flex;justify-content:center;align-items:center;gap:20px;">
          <div style="text-align:center;">
            <div style="font-size:32px;">‚ôÇ</div>
            <div style="font-weight:600;color:#1e40af;">${male.name || male.ring}</div>
          </div>
          <div style="font-size:24px;">üíï</div>
          <div style="text-align:center;">
            <div style="font-size:32px;">‚ôÄ</div>
            <div style="font-weight:600;color:#be185d;">${female.name || female.ring}</div>
          </div>
        </div>
        <div style="margin-top:16px;padding:8px 16px;border-radius:8px;display:inline-block;
          background:${assessment.score >= 60 ? '#d1fae5' : '#fef3c7'};
          color:${assessment.score >= 60 ? '#047857' : '#b45309'};">
          ÈÖçÂØπËØÑÂàÜÔºö${assessment.score} | ${assessment.recommendation}
        </div>
      </div>
    `;
    
    document.getElementById('pairingDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('pairingModal').style.display = 'flex';
  });
  
  document.getElementById('btnClosePairingModal')?.addEventListener('click', () => {
    document.getElementById('pairingModal').style.display = 'none';
  });
  
  document.getElementById('btnCancelPairing')?.addEventListener('click', () => {
    document.getElementById('pairingModal').style.display = 'none';
  });
  
  document.getElementById('btnSavePairing')?.addEventListener('click', savePairingRecord);
  
  document.getElementById('btnRefreshBreeding')?.addEventListener('click', () => {
    fillBreedingSelects();
    renderPairingHistory();
    updateBreedingAssessment();
  });
  
  // ========================================
  // ü©∫ Ê®°Âùó4ÔºöÂÅ•Â∫∑‰∏éÁî®ËçØÁÆ°ÁêÜ
  // ========================================
  
  const HEALTH_RECORDS_KEY = 'pigeon_health_records_v1';
  let healthRecords = [];
  
  function loadHealthRecords() {
    try {
      const raw = localStorage.getItem(HEALTH_RECORDS_KEY);
      if (raw) healthRecords = JSON.parse(raw);
    } catch (e) {
      console.error('Âä†ËΩΩÂÅ•Â∫∑ËÆ∞ÂΩïÂ§±Ë¥•:', e);
    }
  }
  
  function saveHealthRecords() {
    try {
      localStorage.setItem(HEALTH_RECORDS_KEY, JSON.stringify(healthRecords));
    } catch (e) {
      console.error('‰øùÂ≠òÂÅ•Â∫∑ËÆ∞ÂΩïÂ§±Ë¥•:', e);
    }
  }
  
  // Ëé∑ÂèñÂÅ•Â∫∑Áä∂ÊÄÅÁªüËÆ°
  function getHealthStats() {
    const today = new Date();
    const weekLater = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
    
    let healthy = 0;
    let upcoming = 0;
    let needAttention = 0;
    let medicating = 0;
    
    const pigeonHealthMap = new Map();
    
    healthRecords.forEach(record => {
      if (!pigeonHealthMap.has(record.pigeonId)) {
        pigeonHealthMap.set(record.pigeonId, []);
      }
      pigeonHealthMap.get(record.pigeonId).push(record);
    });
    
    pigeons.filter(p => p.alive).forEach(pigeon => {
      const records = pigeonHealthMap.get(pigeon.id) || [];
      const latestRecord = records.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
      
      if (!latestRecord) {
        healthy++;
        return;
      }
      
      // Ê£ÄÊü•ÊòØÂê¶ÊúâÂç≥Â∞ÜÂà∞ÊúüÁöÑÊèêÈÜí
      if (latestRecord.nextDate) {
        const nextDate = new Date(latestRecord.nextDate);
        if (nextDate <= today) {
          needAttention++;
        } else if (nextDate <= weekLater) {
          upcoming++;
        } else {
          healthy++;
        }
      } else if (latestRecord.type === 'ÁñæÁóÖ' || latestRecord.type === 'Áî®ËçØ') {
        const recordDate = new Date(latestRecord.date);
        const daysSince = (today - recordDate) / (1000 * 60 * 60 * 24);
        if (daysSince < 14) {
          if (latestRecord.type === 'Áî®ËçØ') medicating++;
          else needAttention++;
        } else {
          healthy++;
        }
      } else {
        healthy++;
      }
    });
    
    return { healthy, upcoming, needAttention, medicating };
  }
  
  // Ëé∑ÂèñÂÅ•Â∫∑ÊèêÈÜí
  function getHealthAlerts() {
    const today = new Date();
    const alerts = [];
    
    healthRecords.forEach(record => {
      if (record.nextDate) {
        const nextDate = new Date(record.nextDate);
        const pigeon = getPigeonById(record.pigeonId);
        if (!pigeon || !pigeon.alive) return;
        
        const daysUntil = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysUntil <= 0) {
          alerts.push({
            type: 'urgent',
            icon: '‚ö†Ô∏è',
            pigeon,
            record,
            message: `Â∑≤ËøáÊúü${Math.abs(daysUntil)}Â§©`,
            daysUntil
          });
        } else if (daysUntil <= 7) {
          alerts.push({
            type: 'warning',
            icon: '‚è∞',
            pigeon,
            record,
            message: `${daysUntil}Â§©ÂêéÂà∞Êúü`,
            daysUntil
          });
        } else if (daysUntil <= 30) {
          alerts.push({
            type: 'info',
            icon: 'üìÖ',
            pigeon,
            record,
            message: `${daysUntil}Â§©ÂêéÂà∞Êúü`,
            daysUntil
          });
        }
      }
    });
    
    return alerts.sort((a, b) => a.daysUntil - b.daysUntil);
  }
  
  // Ê∏≤ÊüìÂÅ•Â∫∑Áä∂ÊÄÅ
  function renderHealthOverview() {
    const stats = getHealthStats();
    
    document.getElementById('healthyCount').textContent = stats.healthy;
    document.getElementById('upcomingCount').textContent = stats.upcoming;
    document.getElementById('needAttentionCount').textContent = stats.needAttention;
    document.getElementById('medicatingCount').textContent = stats.medicating;
  }
  
  // Ê∏≤ÊüìÂÅ•Â∫∑ÊèêÈÜí
  function renderHealthAlerts() {
    const container = document.getElementById('healthAlertsContainer');
    if (!container) return;
    
    const alerts = getHealthAlerts();
    
    if (alerts.length === 0) {
      container.innerHTML = '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÂÅ•Â∫∑ÊèêÈÜíÔºåÊâÄÊúâÈ∏ΩÂ≠êÁä∂ÊÄÅËâØÂ•Ω ‚úÖ</p>';
      return;
    }
    
    container.innerHTML = alerts.slice(0, 10).map(alert => `
      <div class="health-alert-item ${alert.type}">
        <div style="font-size:24px;">${alert.icon}</div>
        <div style="flex:1;">
          <div style="font-weight:600;color:#1f2937;">${alert.pigeon.name || alert.pigeon.ring}</div>
          <div style="font-size:13px;color:#6b7280;">${alert.record.type}: ${alert.record.description || ''}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:600;color:${alert.type === 'urgent' ? '#dc2626' : alert.type === 'warning' ? '#b45309' : '#2563eb'};">
            ${alert.message}
          </div>
          <div style="font-size:12px;color:#9ca3af;">ÊèêÈÜíÊó•ÊúüÔºö${alert.record.nextDate}</div>
        </div>
      </div>
    `).join('');
  }
  
  // Â°´ÂÖÖÂÅ•Â∫∑È∏ΩÂ≠êÈÄâÊã©Ê°Ü
  function fillHealthPigeonSelects() {
    const selects = ['healthPigeonSelect', 'healthRecordPigeon'];
    
    selects.forEach(selectId => {
      const select = document.getElementById(selectId);
      if (!select) return;
      
      select.innerHTML = '<option value="">ÈÄâÊã©È∏ΩÂ≠ê...</option>';
      pigeons.filter(p => p.alive).forEach(p => {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = `${p.name || p.ring} (${p.ring})`;
        select.appendChild(option);
      });
    });
  }
  
  // Ê∏≤ÊüìÂÅ•Â∫∑Êó∂Èó¥ËΩ¥
  function renderHealthTimeline(pigeonId) {
    const container = document.getElementById('healthTimelineContainer');
    if (!container) return;
    
    if (!pigeonId) {
      container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ÈÄâÊã©È∏ΩÂ≠êÂêéÊòæÁ§∫ÂÅ•Â∫∑Êó∂Èó¥ËΩ¥</p>';
      return;
    }
    
    const records = healthRecords
      .filter(r => r.pigeonId === pigeonId)
      .sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (records.length === 0) {
      container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ËØ•È∏ΩÂ≠êÊöÇÊó†ÂÅ•Â∫∑ËÆ∞ÂΩï</p>';
      return;
    }
    
    const typeIcons = {
      'Áñ´Ëãó': 'üíâ',
      'È©±Ëô´': 'üêõ',
      '‰ΩìÊ£Ä': 'üî¨',
      'ÁñæÁóÖ': 'üè•',
      'Áî®ËçØ': 'üíä',
      'Â∫∑Â§ç': '‚úÖ',
      'ÂÖ∂‰ªñ': 'üìù'
    };
    
    const typeClasses = {
      'Áñ´Ëãó': 'vaccine',
      'È©±Ëô´': 'deworm',
      '‰ΩìÊ£Ä': 'checkup',
      'ÁñæÁóÖ': 'illness',
      'Áî®ËçØ': 'medication',
      'Â∫∑Â§ç': 'recovery'
    };
    
    container.innerHTML = records.map(record => `
      <div class="health-timeline-item">
        <div class="health-timeline-dot ${typeClasses[record.type] || ''}">${typeIcons[record.type] || 'üìã'}</div>
        <div style="flex:1;">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
            <strong style="color:#1f2937;">${record.type}</strong>
            <span style="color:#6b7280;font-size:13px;">${record.date}</span>
          </div>
          <div style="font-size:14px;color:#4b5563;">${record.description || '‚Äî'}</div>
          ${record.nextDate ? `
            <div style="margin-top:8px;padding:6px 12px;background:#fef3c7;border-radius:6px;font-size:12px;color:#b45309;display:inline-block;">
              ‚è∞ ‰∏ãÊ¨°ÊèêÈÜíÔºö${record.nextDate}
            </div>
          ` : ''}
        </div>
      </div>
    `).join('');
  }
  
  // ‰øùÂ≠òÂÅ•Â∫∑ËÆ∞ÂΩï
  function saveHealthRecord() {
    const pigeonId = document.getElementById('healthRecordPigeon')?.value;
    const type = document.getElementById('healthRecordType')?.value;
    const date = document.getElementById('healthRecordDate')?.value;
    const nextDate = document.getElementById('healthRecordNextDate')?.value;
    const description = document.getElementById('healthRecordDescription')?.value;
    
    if (!pigeonId) {
      alert('ËØ∑ÈÄâÊã©È∏ΩÂ≠ê');
      return;
    }
    if (!type) {
      alert('ËØ∑ÈÄâÊã©ËÆ∞ÂΩïÁ±ªÂûã');
      return;
    }
    if (!date) {
      alert('ËØ∑ÈÄâÊã©Êó•Êúü');
      return;
    }
    
    const record = {
      id: 'health_' + Date.now(),
      pigeonId,
      type,
      date,
      nextDate: nextDate || null,
      description,
      createdAt: new Date().toISOString()
    };
    
    healthRecords.push(record);
    saveHealthRecords();
    
    // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
    document.getElementById('healthModal').style.display = 'none';
    
    // Ê∏ÖÁ©∫Ë°®Âçï
    document.getElementById('healthRecordPigeon').value = '';
    document.getElementById('healthRecordType').value = '';
    document.getElementById('healthRecordDate').value = '';
    document.getElementById('healthRecordNextDate').value = '';
    document.getElementById('healthRecordDescription').value = '';
    
    // Âà∑Êñ∞ÊòæÁ§∫
    renderHealthOverview();
    renderHealthAlerts();
    
    alert('ÂÅ•Â∫∑ËÆ∞ÂΩïÂ∑≤‰øùÂ≠òÔºÅ');
  }
  
  // ÂÅ•Â∫∑Ê®°Âùó‰∫ã‰ª∂ÁªëÂÆö
  document.getElementById('btnAddHealthRecord')?.addEventListener('click', () => {
    fillHealthPigeonSelects();
    document.getElementById('healthRecordDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('healthModal').style.display = 'flex';
  });
  
  document.getElementById('btnCloseHealthModal')?.addEventListener('click', () => {
    document.getElementById('healthModal').style.display = 'none';
  });
  
  document.getElementById('btnCancelHealth')?.addEventListener('click', () => {
    document.getElementById('healthModal').style.display = 'none';
  });
  
  document.getElementById('btnSaveHealth')?.addEventListener('click', saveHealthRecord);
  
  document.getElementById('healthPigeonSelect')?.addEventListener('change', (e) => {
    renderHealthTimeline(e.target.value);
  });
  
  document.getElementById('btnRefreshHealth')?.addEventListener('click', () => {
    fillHealthPigeonSelects();
    renderHealthOverview();
    renderHealthAlerts();
  });
  
  // ========================================
  // üß† Ê®°Âùó5&6ÔºöÊô∫ËÉΩÂàÜÊûê‰∏≠ÂøÉ & ÂÜ≥Á≠ñÁ≥ªÁªü
  // ========================================
  
  // ËÆ°ÁÆóÈ∏ΩÂ≠êÊΩúÂäõËØÑÂàÜ
  function calculatePotentialScore(pigeon) {
    let score = 50; // Âü∫Á°ÄÂàÜ
    const factors = [];
    
    // Ë°ÄÁªüÂõ†Á¥† (30ÂàÜ)
    const father = pigeon.fatherId ? getPigeonById(pigeon.fatherId) : null;
    const mother = pigeon.motherId ? getPigeonById(pigeon.motherId) : null;
    
    if (father?.isCore) {
      score += 10;
      factors.push('Áà∂‰∏∫Ê†∏ÂøÉÁßçÈ∏Ω');
    }
    if (mother?.isCore) {
      score += 10;
      factors.push('ÊØç‰∏∫Ê†∏ÂøÉÁßçÈ∏Ω');
    }
    
    // Áà∂ÊØçÊàêÁª©
    const fatherBest = father?.races?.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999) || 999;
    const motherBest = mother?.races?.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999) || 999;
    
    if (fatherBest <= 3) {
      score += 5;
      factors.push('Áà∂ÊúâÂâç3ÊàêÁª©');
    }
    if (motherBest <= 3) {
      score += 5;
      factors.push('ÊØçÊúâÂâç3ÊàêÁª©');
    }
    
    // Ëá™Ë∫´ÊàêÁª©Âõ†Á¥† (40ÂàÜ)
    const races = pigeon.races || [];
    const wins = races.filter(r => r.rank && r.rank <= 3).length;
    const top10 = races.filter(r => r.rank && r.rank <= 10).length;
    const bestRank = races.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999);
    
    if (wins >= 3) {
      score += 20;
      factors.push(`${wins}Ê¨°Ââç3Âêç`);
    } else if (wins >= 1) {
      score += wins * 5;
      factors.push(`${wins}Ê¨°Ââç3Âêç`);
    }
    
    if (top10 >= 5) {
      score += 10;
      factors.push('Á®≥ÂÆöÂèëÊå•');
    }
    
    if (bestRank === 1) {
      score += 10;
      factors.push('ÂÜ†ÂÜõ');
    }
    
    // ÂÅ•Â∫∑Âõ†Á¥† (10ÂàÜ)
    const pigeonHealth = healthRecords.filter(r => r.pigeonId === pigeon.id);
    const hasIllness = pigeonHealth.some(r => r.type === 'ÁñæÁóÖ');
    if (!hasIllness && pigeonHealth.length > 0) {
      score += 10;
      factors.push('ÂÅ•Â∫∑ËÆ∞ÂΩïËâØÂ•Ω');
    }
    
    // Âπ¥ÈæÑÂõ†Á¥† (10ÂàÜ)
    if (pigeon.birth) {
      const age = new Date().getFullYear() - parseInt(pigeon.birth.substring(0, 4));
      if (age >= 2 && age <= 5) {
        score += 10;
        factors.push('ÈªÑÈáëÂπ¥ÈæÑ');
      } else if (age < 2) {
        score += 5;
        factors.push('Âπ¥ËΩªÊúâÊΩúÂäõ');
      }
    }
    
    return {
      score: Math.min(100, Math.max(0, score)),
      factors
    };
  }
  
  // Ëé∑ÂèñÊúÄÂº∫ÁßçÂÖ¨/ÁßçÊØç
  function getTopBreeders() {
    const males = pigeons.filter(p => p.gender === 'ÂÖ¨' && p.alive);
    const females = pigeons.filter(p => p.gender === 'ÊØç' && p.alive);
    
    // ËÆ°ÁÆóÊØèÂè™ÁßçÈ∏ΩÁöÑÂêé‰ª£Ë°®Áé∞
    const calculateBreederScore = (breeder, isMale) => {
      const offspring = pigeons.filter(p => 
        isMale ? p.fatherId === breeder.id : p.motherId === breeder.id
      );
      
      if (offspring.length === 0) return { score: 0, offspring: 0, wins: 0 };
      
      let totalWins = 0;
      let totalRaces = 0;
      
      offspring.forEach(child => {
        const races = child.races || [];
        totalRaces += races.length;
        totalWins += races.filter(r => r.rank && r.rank <= 3).length;
      });
      
      // ËØÑÂàÜÂÖ¨Âºè: (Ëé∑Â•ñÊï∞ * 3 + Âêé‰ª£Êï∞) / (ÂèÇËµõÊï∞ || 1)
      const score = (totalWins * 3 + offspring.length) / (totalRaces || 1) * 10;
      
      return {
        score,
        offspring: offspring.length,
        wins: totalWins,
        racedCount: offspring.filter(c => c.races && c.races.length > 0).length
      };
    };
    
    const maleScores = males.map(m => ({
      pigeon: m,
      ...calculateBreederScore(m, true)
    })).sort((a, b) => b.score - a.score);
    
    const femaleScores = females.map(f => ({
      pigeon: f,
      ...calculateBreederScore(f, false)
    })).sort((a, b) => b.score - a.score);
    
    return {
      topMale: maleScores[0] || null,
      topFemale: femaleScores[0] || null,
      males: maleScores,
      females: femaleScores
    };
  }
  
  // Ëé∑ÂèñÊúÄ‰Ω≥Ë°ÄÁ≥ª
  function getTopBloodlines() {
    // ÊåâÁà∂Á≥ªÂíåÊØçÁ≥ªÂàÜÁªÑÁªüËÆ°
    const bloodlineStats = new Map();
    
    pigeons.forEach(p => {
      if (p.fatherId) {
        const father = getPigeonById(p.fatherId);
        if (father) {
          const key = `${father.id}_father`;
          if (!bloodlineStats.has(key)) {
            bloodlineStats.set(key, {
              ancestor: father,
              type: 'Áà∂Á≥ª',
              descendants: [],
              wins: 0,
              races: 0
            });
          }
          const stats = bloodlineStats.get(key);
          stats.descendants.push(p);
          const pRaces = p.races || [];
          stats.races += pRaces.length;
          stats.wins += pRaces.filter(r => r.rank && r.rank <= 3).length;
        }
      }
    });
    
    // ËÆ°ÁÆóÂæóÂàÜÂπ∂ÊéíÂ∫è
    const bloodlines = Array.from(bloodlineStats.values())
      .map(b => ({
        ...b,
        score: b.races > 0 ? (b.wins * 3 + b.descendants.length) / b.races : 0
      }))
      .filter(b => b.descendants.length >= 2)
      .sort((a, b) => b.score - a.score);
    
    return bloodlines;
  }
  
  // Êô∫ËÉΩÈÖçÂØπÊé®Ëçê
  function getRecommendedPairings() {
    const males = pigeons.filter(p => p.gender === 'ÂÖ¨' && p.alive);
    const females = pigeons.filter(p => p.gender === 'ÊØç' && p.alive);
    
    const recommendations = [];
    
    males.forEach(male => {
      females.forEach(female => {
        const assessment = generatePairingAssessment(male.id, female.id);
        if (assessment.score >= 70) {
          recommendations.push({
            male,
            female,
            assessment
          });
        }
      });
    });
    
    return recommendations
      .sort((a, b) => b.assessment.score - a.assessment.score)
      .slice(0, 5);
  }
  
  // Ê∏≤ÊüìÊô∫ËÉΩÂàÜÊûê
  function runFullAnalysis() {
    // ÊúÄ‰Ω≥Ë°ÄÁ≥ª
    const bloodlines = getTopBloodlines();
    const topBloodlineContainer = document.getElementById('topBloodlineCard');
    if (topBloodlineContainer) {
      if (bloodlines.length > 0) {
        const top = bloodlines[0];
        topBloodlineContainer.innerHTML = `
          <div style="font-size:24px;font-weight:700;color:#92400e;">${top.ancestor.name || top.ancestor.ring}</div>
          <div style="font-size:13px;color:#78350f;margin-top:8px;">
            Âêé‰ª£Êï∞Ôºö${top.descendants.length}Âè™<br>
            Ëé∑Â•ñÊ¨°Êï∞Ôºö${top.wins}Ê¨°<br>
            Ë°ÄÁ≥ªÂæóÂàÜÔºö${top.score.toFixed(2)}
          </div>
        `;
      } else {
        topBloodlineContainer.innerHTML = '<p class="muted">Êï∞ÊçÆ‰∏çË∂≥</p>';
      }
    }
    
    // ÊúÄÂº∫ÁßçÂÖ¨/ÁßçÊØç
    const topBreeders = getTopBreeders();
    
    const topMaleContainer = document.getElementById('topMaleCard');
    if (topMaleContainer && topBreeders.topMale) {
      const top = topBreeders.topMale;
      topMaleContainer.innerHTML = `
        <div style="font-size:24px;font-weight:700;color:#1e40af;">${top.pigeon.name || top.pigeon.ring}</div>
        <div style="font-size:13px;color:#1e3a8a;margin-top:8px;">
          Âêé‰ª£Êï∞Ôºö${top.offspring}Âè™<br>
          Âêé‰ª£Ëé∑Â•ñÔºö${top.wins}Ê¨°<br>
          ËÇ≤ÁßçÂæóÂàÜÔºö${top.score.toFixed(2)}
        </div>
      `;
    }
    
    const topFemaleContainer = document.getElementById('topFemaleCard');
    if (topFemaleContainer && topBreeders.topFemale) {
      const top = topBreeders.topFemale;
      topFemaleContainer.innerHTML = `
        <div style="font-size:24px;font-weight:700;color:#be185d;">${top.pigeon.name || top.pigeon.ring}</div>
        <div style="font-size:13px;color:#9d174d;margin-top:8px;">
          Âêé‰ª£Êï∞Ôºö${top.offspring}Âè™<br>
          Âêé‰ª£Ëé∑Â•ñÔºö${top.wins}Ê¨°<br>
          ËÇ≤ÁßçÂæóÂàÜÔºö${top.score.toFixed(2)}
        </div>
      `;
    }
    
    // Êé®ËçêÈÖçÂØπ
    const recommendations = getRecommendedPairings();
    const recommendedContainer = document.getElementById('recommendedPairingCard');
    if (recommendedContainer) {
      if (recommendations.length > 0) {
        const top = recommendations[0];
        recommendedContainer.innerHTML = `
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
            <span style="color:#1e40af;font-weight:600;">‚ôÇ ${top.male.name || top.male.ring}</span>
            <span>√ó</span>
            <span style="color:#be185d;font-weight:600;">‚ôÄ ${top.female.name || top.female.ring}</span>
          </div>
          <div style="font-size:32px;font-weight:700;color:#047857;">${top.assessment.score}ÂàÜ</div>
          <div style="font-size:12px;color:#065f46;margin-top:4px;">${top.assessment.recommendation}</div>
        `;
      } else {
        recommendedContainer.innerHTML = '<p class="muted">ÊöÇÊó†Êé®Ëçê</p>';
      }
    }
    
    // ÊΩúÂäõÊéíË°åÊ¶ú
    const potentialContainer = document.getElementById('potentialRankingContainer');
    if (potentialContainer) {
      const potentials = pigeons
        .filter(p => p.alive)
        .map(p => ({
          pigeon: p,
          ...calculatePotentialScore(p)
        }))
        .sort((a, b) => b.score - a.score)
        .slice(0, 10);
      
      if (potentials.length > 0) {
        potentialContainer.innerHTML = potentials.map((item, index) => {
          const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : 'normal';
          return `
            <div class="potential-item">
              <div class="potential-rank ${rankClass}">${index + 1}</div>
              <div>
                <div style="font-weight:600;color:#1f2937;">${item.pigeon.name || item.pigeon.ring}</div>
                <div style="font-size:12px;color:#6b7280;">${item.pigeon.ring}</div>
              </div>
              <div style="font-size:12px;color:#6b7280;">${item.factors.slice(0, 2).join('„ÄÅ')}</div>
              <div class="potential-score">${item.score}</div>
              <div class="potential-bar">
                <div class="potential-bar-fill" style="width:${item.score}%;"></div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        potentialContainer.innerHTML = '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†Êï∞ÊçÆ</p>';
      }
    }
    
    // ÁªºÂêàÁªìËÆ∫
    const conclusionContainer = document.getElementById('analysisConclusion');
    if (conclusionContainer) {
      const totalPigeons = pigeons.length;
      const alivePigeons = pigeons.filter(p => p.alive).length;
      const totalRaces = races.length;
      const totalWins = pigeons.reduce((sum, p) => {
        return sum + (p.races || []).filter(r => r.rank && r.rank <= 3).length;
      }, 0);
      
      conclusionContainer.innerHTML = `
        <p><strong>üìä Êï∞ÊçÆÊ¶ÇÂÜµÔºö</strong>Á≥ªÁªüÂÖ±ËÆ∞ÂΩï ${totalPigeons} Âè™È∏ΩÂ≠êÔºåÂÖ∂‰∏≠ ${alivePigeons} Âè™Âú®‰∏ñÔºåÂÖ±ÂèÇÂä† ${totalRaces} Âú∫ÊØîËµõÔºåËé∑Âæó ${totalWins} Ê¨°Ââç‰∏âÂêç„ÄÇ</p>
        
        ${bloodlines.length > 0 ? `
          <p><strong>üß¨ Ë°ÄÁ≥ªÂàÜÊûêÔºö</strong>${bloodlines[0].ancestor.name || bloodlines[0].ancestor.ring} Ë°ÄÁ≥ªË°®Áé∞ÊúÄ‰∏∫Á™ÅÂá∫ÔºåÂ∑≤‰∫ßÂá∫ ${bloodlines[0].descendants.length} Âè™Âêé‰ª£ÔºåÁ¥ØËÆ°Ëé∑Â•ñ ${bloodlines[0].wins} Ê¨°ÔºåË°ÄÁ≥ªÂæóÂàÜ ${bloodlines[0].score.toFixed(2)}„ÄÇÂª∫ËÆÆÈáçÁÇπÂÖ≥Ê≥®ËØ•Ë°ÄÁ≥ªÁöÑÈÖçÂØπÁπÅËÇ≤„ÄÇ</p>
        ` : ''}
        
        ${topBreeders.topMale ? `
          <p><strong>‚ôÇ ÁßçÂÖ¨ËØÑ‰ª∑Ôºö</strong>${topBreeders.topMale.pigeon.name || topBreeders.topMale.pigeon.ring} ÊòØÁõÆÂâçË°®Áé∞ÊúÄÂ•ΩÁöÑÁßçÂÖ¨ÔºåÂêé‰ª£ ${topBreeders.topMale.offspring} Âè™ÔºåÁ¥ØËÆ°Ëé∑Â•ñ ${topBreeders.topMale.wins} Ê¨°„ÄÇ</p>
        ` : ''}
        
        ${topBreeders.topFemale ? `
          <p><strong>‚ôÄ ÁßçÊØçËØÑ‰ª∑Ôºö</strong>${topBreeders.topFemale.pigeon.name || topBreeders.topFemale.pigeon.ring} ÊòØÁõÆÂâçË°®Áé∞ÊúÄÂ•ΩÁöÑÁßçÊØçÔºåÂêé‰ª£ ${topBreeders.topFemale.offspring} Âè™ÔºåÁ¥ØËÆ°Ëé∑Â•ñ ${topBreeders.topFemale.wins} Ê¨°„ÄÇ</p>
        ` : ''}
        
        ${recommendations.length > 0 ? `
          <p><strong>üíï ÈÖçÂØπÂª∫ËÆÆÔºö</strong>Á≥ªÁªüÊé®Ëçê ${recommendations[0].male.name || recommendations[0].male.ring} ‰∏é ${recommendations[0].female.name || recommendations[0].female.ring} ÈÖçÂØπÔºåËØÑÂàÜ ${recommendations[0].assessment.score} ÂàÜÔºå${recommendations[0].assessment.recommendation}„ÄÇ</p>
        ` : ''}
        
        <p><strong>üìã ÂêéÁª≠Âª∫ËÆÆÔºö</strong></p>
        <ul style="margin:8px 0;padding-left:20px;">
          <li>ÂÆöÊúüÊõ¥Êñ∞È∏ΩÂ≠êÁöÑÊØîËµõÊàêÁª©Ôºå‰øùÊåÅÊï∞ÊçÆÂáÜÁ°ÆÊÄß</li>
          <li>ÂÖ≥Ê≥®È´òÊΩúÂäõÈ∏ΩÂ≠êÁöÑËÆ≠ÁªÉÂíåÂèÇËµõÂÆâÊéí</li>
          <li>Ê†πÊçÆÈÖçÂØπËØÑ‰º∞ÁªìÊûú‰ºòÂåñÁπÅËÇ≤ËÆ°Âàí</li>
          <li>ÊåÅÁª≠ËøΩË∏™‰ºòÁßÄË°ÄÁ≥ªÁöÑÂêé‰ª£Ë°®Áé∞</li>
        </ul>
      `;
    }
  }
  
  // Êô∫ËÉΩÂàÜÊûêÊ®°Âùó‰∫ã‰ª∂ÁªëÂÆö
  document.getElementById('btnRunAnalysis')?.addEventListener('click', runFullAnalysis);
  document.getElementById('btnRefreshAnalysis')?.addEventListener('click', runFullAnalysis);
  
  // ========================================
  // üè∑ Ê®°Âùó8ÔºöËá™Âä®Ê†áÁ≠æÁ≥ªÁªü
  // ========================================
  
  function generateAutoTags(pigeon) {
    const tags = [];
    const races = pigeon.races || [];
    
    // ËøûÁª≠3Ê¨°ËøõÂ•ñ ‚Üí "Á®≥ÂÆöÂèëÊå•"
    const top10Count = races.filter(r => r.rank && r.rank <= 10).length;
    if (top10Count >= 3) {
      tags.push({ text: 'Á®≥ÂÆöÂèëÊå•', class: 'stable' });
    }
    
    // Áà∂ÊØçÊòØÊ†∏ÂøÉÁßçÈ∏Ω ‚Üí "Ê†∏ÂøÉË°ÄÁ≥ª"
    const father = pigeon.fatherId ? getPigeonById(pigeon.fatherId) : null;
    const mother = pigeon.motherId ? getPigeonById(pigeon.motherId) : null;
    if (father?.isCore || mother?.isCore) {
      tags.push({ text: 'Ê†∏ÂøÉË°ÄÁ≥ª', class: 'core' });
    }
    
    // ÊúâÂÜ†ÂÜõÊàêÁª©
    const hasChampion = races.some(r => r.rank === 1);
    if (hasChampion) {
      tags.push({ text: 'ÂÜ†ÂÜõ', class: 'champion' });
    }
    
    // ÊΩúÂäõËÇ°
    const potential = calculatePotentialScore(pigeon);
    if (potential.score >= 80 && races.length < 5) {
      tags.push({ text: 'È´òÊΩúÂäõ', class: 'potential' });
    }
    
    // ÂÅ•Â∫∑Ë≠¶Âëä
    const healthIssues = healthRecords.filter(r => 
      r.pigeonId === pigeon.id && r.type === 'ÁñæÁóÖ'
    );
    if (healthIssues.length > 0) {
      const recentIssue = healthIssues.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
      const daysSince = (new Date() - new Date(recentIssue.date)) / (1000 * 60 * 60 * 24);
      if (daysSince < 30) {
        tags.push({ text: 'ÂÅ•Â∫∑ÂÖ≥Ê≥®', class: 'warning' });
      }
    }
    
    return tags;
  }
  
  // ========================================
  // ËßÜÂõæÂàáÊç¢Êõ¥Êñ∞
  // ========================================
  
  // Êâ©Â±ïËßÜÂõæÂØπË±°
  views.breedingView = document.getElementById('breedingView');
  views.healthView = document.getElementById('healthView');
  views.analysisView = document.getElementById('analysisView');
  
  // ÂéüÂßã switchView ÂáΩÊï∞Â¢ûÂº∫
  const originalSwitchView = switchView;
  switchView = function(name) {
    // Ë∞ÉÁî®ÂéüÂßãÂàáÊç¢ÈÄªËæë
    Object.keys(views).forEach(k => {
      if (views[k]) views[k].style.display = (k === name) ? '' : 'none';
    });
    
    sidebarItems.forEach(item => {
      if (item.dataset.view === name) item.classList.add('active');
      else item.classList.remove('active');
    });
    
    // Ë°ÄÁªüÂÖ≥Á≥ªËßÜÂõæ
    if (name === 'pedigreeView') {
      refreshPedigreeView();
    }
    
    // ÊØîËµõÁÆ°ÁêÜËßÜÂõæ
    if (name === 'raceView') {
      loadRaces();
      syncRacesToPigeons();
      renderRaceList();
      fillStatsPigeonSelect();
      generateOverallAnalysis();
    }
    
    // ÁπÅËÇ≤ÈÖçÂØπËßÜÂõæ
    if (name === 'breedingView') {
      loadPairings();
      fillBreedingSelects();
      renderPairingHistory();
      updateBreedingAssessment();
    }
    
    // ÂÅ•Â∫∑ÁÆ°ÁêÜËßÜÂõæ
    if (name === 'healthView') {
      loadHealthRecords();
      fillHealthPigeonSelects();
      renderHealthOverview();
      renderHealthAlerts();
    }
    
    // Êô∫ËÉΩÂàÜÊûêËßÜÂõæ
    if (name === 'analysisView') {
      loadPairings();
      loadHealthRecords();
      runFullAnalysis();
    }
  };
  
  // ========================================
  // üîç Ê®°Âùó7ÔºöÊô∫ËÉΩÊêúÁ¥¢
  // ========================================
  
  // Ëß£ÊûêËá™ÁÑ∂ËØ≠Ë®ÄÊêúÁ¥¢
  function parseSmartSearch(query) {
    const conditions = {
      year: null,
      gender: null,
      type: null,
      hasAward: false,
      hasRaces: false,
      isCore: false,
      isAlive: null,
      ring: null,
      name: null,
      owner: null
    };
    
    const q = query.toLowerCase().trim();
    
    // Âπ¥‰ªΩÂåπÈÖç (2020-2030)
    const yearMatch = q.match(/20[2-3][0-9]/);
    if (yearMatch) {
      conditions.year = yearMatch[0];
    }
    
    // ÊÄßÂà´ÂåπÈÖç
    if (q.includes('ÂÖ¨') || q.includes('ÈõÑ')) {
      conditions.gender = 'ÂÖ¨';
    } else if (q.includes('ÊØç') || q.includes('Èõå')) {
      conditions.gender = 'ÊØç';
    }
    
    // Á±ªÂûãÂåπÈÖç
    if (q.includes('ÁßçÈ∏Ω')) {
      conditions.type = 'ÁßçÈ∏Ω';
    } else if (q.includes('ÊØîËµõ')) {
      conditions.type = 'ÊØîËµõÈ∏Ω';
    } else if (q.includes('Âêé‰ª£')) {
      conditions.type = 'Âêé‰ª£È∏Ω';
    }
    
    // ÊàêÁª©ÂåπÈÖç
    if (q.includes('ËøõÂ•ñ') || q.includes('Ëé∑Â•ñ') || q.includes('Ââç‰∏â') || q.includes('ÂÜ†ÂÜõ')) {
      conditions.hasAward = true;
    }
    if (q.includes('ÂèÇËµõ') || q.includes('ÊØîËµõ')) {
      conditions.hasRaces = true;
    }
    
    // Ê†∏ÂøÉÁßçÈ∏Ω
    if (q.includes('Ê†∏ÂøÉ')) {
      conditions.isCore = true;
    }
    
    // Áä∂ÊÄÅÂåπÈÖç
    if (q.includes('Âú®‰∏ñ') || q.includes('Â≠òÊ¥ª')) {
      conditions.isAlive = true;
    } else if (q.includes('Ê≠ª‰∫°') || q.includes('Â∑≤ÊïÖ')) {
      conditions.isAlive = false;
    }
    
    // Â¶ÇÊûúÊ≤°ÊúâÂåπÈÖç‰ªª‰ΩïÊù°‰ª∂Ôºå‰Ωú‰∏∫Ë∂≥ÁéØÂè∑„ÄÅÂêçÂ≠óÊàñÈ∏Ω‰∏ªÊêúÁ¥¢
    if (!conditions.year && !conditions.gender && !conditions.type && 
        !conditions.hasAward && !conditions.hasRaces && !conditions.isCore && 
        conditions.isAlive === null) {
      conditions.ring = q;
      conditions.name = q;
      conditions.owner = q;
    }
    
    return conditions;
  }
  
  // ÊâßË°åÊô∫ËÉΩÊêúÁ¥¢
  function executeSmartSearch(query) {
    if (!query || query.trim() === '') return pigeons;
    
    const conditions = parseSmartSearch(query);
    const q = query.toLowerCase().trim();
    
    // Âà§Êñ≠ÊòØÂê¶‰∏∫Áõ¥Êé•ÊêúÁ¥¢Ê®°ÂºèÔºàÊ≤°ÊúâÂåπÈÖçÂà∞ÁâπÊÆäÊù°‰ª∂Ôºâ
    const isDirectSearch = conditions.ring && conditions.name && conditions.owner && 
                           !conditions.year && !conditions.gender && !conditions.type && 
                           !conditions.hasAward && !conditions.hasRaces && !conditions.isCore && 
                           conditions.isAlive === null;
    
    return pigeons.filter(p => {
      // Áõ¥Êé•ÊêúÁ¥¢Ê®°ÂºèÔºöÂè™ÂåπÈÖçË∂≥ÁéØÂè∑„ÄÅÂêçÂ≠óÊàñÈ∏Ω‰∏ª
      if (isDirectSearch) {
        const ringMatch = (p.ring || '').toLowerCase().includes(q);
        const nameMatch = (p.name || '').toLowerCase().includes(q);
        const ownerMatch = (p.currentOwner || '').toLowerCase().includes(q);
        return ringMatch || nameMatch || ownerMatch;
      }
      
      // Êù°‰ª∂ÊêúÁ¥¢Ê®°ÂºèÔºöÈúÄË¶ÅÊª°Ë∂≥ÊâÄÊúâÊù°‰ª∂
      // Âπ¥‰ªΩÊù°‰ª∂
      if (conditions.year) {
        const birthYear = (p.birth || '').substring(0, 4);
        if (birthYear !== conditions.year) return false;
      }
      
      // ÊÄßÂà´Êù°‰ª∂
      if (conditions.gender && p.gender !== conditions.gender) return false;
      
      // Á±ªÂûãÊù°‰ª∂
      if (conditions.type && p.type !== conditions.type) return false;
      
      // Ëé∑Â•ñÊù°‰ª∂
      if (conditions.hasAward) {
        const hasAward = (p.races || []).some(r => r.rank && r.rank <= 3);
        if (!hasAward) return false;
      }
      
      // ÂèÇËµõÊù°‰ª∂
      if (conditions.hasRaces) {
        if (!p.races || p.races.length === 0) return false;
      }
      
      // Ê†∏ÂøÉÁßçÈ∏Ω
      if (conditions.isCore && !p.isCore) return false;
      
      // Â≠òÊ¥ªÁä∂ÊÄÅ
      if (conditions.isAlive !== null && p.alive !== conditions.isAlive) return false;
      
      // Â¶ÇÊûúËÆæÁΩÆ‰∫Ü ring/name/ownerÔºå‰πüÈúÄË¶ÅÊ£ÄÊü•Ëøô‰∫õÂ≠óÊÆµÔºàÊù°‰ª∂ÊêúÁ¥¢Ê®°Âºè‰∏ã‰Ωú‰∏∫È¢ùÂ§ñÊù°‰ª∂Ôºâ
      if (conditions.ring || conditions.name || conditions.owner) {
        const ringMatch = conditions.ring ? (p.ring || '').toLowerCase().includes(q) : true;
        const nameMatch = conditions.name ? (p.name || '').toLowerCase().includes(q) : true;
        const ownerMatch = conditions.owner ? (p.currentOwner || '').toLowerCase().includes(q) : true;
        if (!ringMatch && !nameMatch && !ownerMatch) return false;
      }
      
      return true;
    });
  }
  
  // ÊòæÁ§∫ÊêúÁ¥¢Âª∫ËÆÆ
  function showSearchSuggestions(query) {
    const container = document.getElementById('searchSuggestions');
    if (!container) return;
    
    if (!query || query.trim() === '') {
      container.style.display = 'none';
      return;
    }
    
    const results = executeSmartSearch(query).slice(0, 8);
    
    if (results.length === 0) {
      container.innerHTML = '<div style="padding:16px;text-align:center;color:#9ca3af;">Êú™ÊâæÂà∞ÂåπÈÖçÁªìÊûú</div>';
      container.style.display = 'block';
      return;
    }
    
    container.innerHTML = results.map(p => {
      const tags = generateAutoTags(p);
      return `
        <div class="search-suggestion-item" data-pigeon-id="${p.id}" style="padding:12px 16px;cursor:pointer;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:600;color:#1f2937;">${p.name || p.ring}</div>
            <div style="font-size:12px;color:#6b7280;">${p.ring} | ${p.gender || '‚Äî'} | ${p.type || '‚Äî'}${p.currentOwner ? ' | È∏Ω‰∏ª: ' + p.currentOwner : ''}</div>
          </div>
          <div style="display:flex;gap:4px;">
            ${tags.slice(0, 2).map(tag => `<span class="auto-tag ${tag.class}">${tag.text}</span>`).join('')}
          </div>
        </div>
      `;
    }).join('');
    
    container.style.display = 'block';
    
    // ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
    container.querySelectorAll('.search-suggestion-item').forEach(item => {
      item.addEventListener('click', () => {
        const pigeonId = item.dataset.pigeonId;
        container.style.display = 'none';
        document.getElementById('smartSearchInput').value = '';
        openDetail(pigeonId);
        switchView('detailView');
      });
    });
  }
  
  // Êô∫ËÉΩÊêúÁ¥¢‰∫ã‰ª∂ÁªëÂÆö
  const smartSearchInput = document.getElementById('smartSearchInput');
  if (smartSearchInput) {
    let searchTimeout;
    smartSearchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        showSearchSuggestions(e.target.value);
      }, 200);
    });
    
    smartSearchInput.addEventListener('focus', () => {
      if (smartSearchInput.value.trim()) {
        showSearchSuggestions(smartSearchInput.value);
      }
    });
    
    smartSearchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const results = executeSmartSearch(smartSearchInput.value);
        if (results.length > 0) {
          document.getElementById('searchSuggestions').style.display = 'none';
          // ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûúÂàóË°®
          pigeons.length = 0;
          pigeons.push(...executeSmartSearch(smartSearchInput.value));
          refreshList();
          switchView('listView');
          // ÊÅ¢Â§çÂéüÂßãÊï∞ÊçÆ
          loadFromStorage();
        }
      }
    });
  }
  
  // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠ÊêúÁ¥¢Âª∫ËÆÆ
  document.addEventListener('click', (e) => {
    const container = document.getElementById('searchSuggestions');
    const input = document.getElementById('smartSearchInput');
    if (container && input && !container.contains(e.target) && e.target !== input) {
      container.style.display = 'none';
    }
  });
  
  // ========================================
  // üì• Ê®°Âùó3ÔºöExcel ÂØºÂÖ•ÂäüËÉΩ
  // ========================================
  
  let importedData = [];
  let currentImportRace = null;
  
  // Excel/CSV Êñá‰ª∂Ëß£ÊûêÔºàÁÆÄÊòìÂÆûÁé∞ÔºåÂÆûÈôÖÈ°πÁõÆ‰∏≠Âª∫ËÆÆ‰ΩøÁî® SheetJS Á≠âÂ∫ìÔºâ
  function parseCSV(text) {
    const lines = text.split('\n').filter(line => line.trim());
    if (lines.length < 2) return [];
    
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    const data = [];
    
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
      const row = {};
      headers.forEach((h, idx) => {
        row[h] = values[idx] || '';
      });
      data.push(row);
    }
    
    return data;
  }
  
  // ËØÜÂà´Â≠óÊÆµÊò†Â∞Ñ
  function identifyFields(headers) {
    const mapping = {
      ring: null,
      rank: null,
      score: null,
      returnTime: null
    };
    
    const ringPatterns = ['Ë∂≥ÁéØÂè∑', 'ÁéØÂè∑', 'Ë∂≥ÁéØ', 'ring', 'ÁºñÂè∑'];
    const rankPatterns = ['ÂêçÊ¨°', 'ÊéíÂêç', 'rank', 'Âêç', '‰Ωç'];
    const scorePatterns = ['ÂàÜÈÄü', 'ÂàÜÊï∞', 'score', 'ÈÄüÂ∫¶'];
    const timePatterns = ['ÂΩíÂ∑¢Êó∂Èó¥', 'ËøîÂõûÊó∂Èó¥', 'Êó∂Èó¥', 'time'];
    
    headers.forEach((h, idx) => {
      const lh = h.toLowerCase();
      if (ringPatterns.some(p => lh.includes(p))) mapping.ring = h;
      else if (rankPatterns.some(p => lh.includes(p))) mapping.rank = h;
      else if (scorePatterns.some(p => lh.includes(p))) mapping.score = h;
      else if (timePatterns.some(p => lh.includes(p))) mapping.returnTime = h;
    });
    
    return mapping;
  }
  
  // Â§ÑÁêÜÂØºÂÖ•Êñá‰ª∂
  function handleImportFile(file) {
    const reader = new FileReader();
    
    reader.onload = (e) => {
      try {
        let data;
        if (file.name.endsWith('.csv')) {
          data = parseCSV(e.target.result);
        } else {
          // ÂØπ‰∫é xlsx Êñá‰ª∂ÔºåÊòæÁ§∫ÊèêÁ§∫ÈúÄË¶ÅËΩ¨Êç¢‰∏∫ CSV
          alert('Excel (.xlsx) Êñá‰ª∂ËØ∑ÂÖàËΩ¨Êç¢‰∏∫ CSV Ê†ºÂºèÔºåÊàñ‰ΩøÁî® CSV Êñá‰ª∂Áõ¥Êé•ÂØºÂÖ•„ÄÇ\n\nÊèêÁ§∫ÔºöÂú® Excel ‰∏≠ÈÄâÊã©"Âè¶Â≠ò‰∏∫" ‚Üí CSV (ÈÄóÂè∑ÂàÜÈöî)');
          return;
        }
        
        if (data.length === 0) {
          alert('Êñá‰ª∂‰∏∫Á©∫ÊàñÊ†ºÂºè‰∏çÊ≠£Á°Æ');
          return;
        }
        
        const headers = Object.keys(data[0]);
        const fieldMapping = identifyFields(headers);
        
        if (!fieldMapping.ring) {
          alert('Êó†Ê≥ïËØÜÂà´Ë∂≥ÁéØÂè∑ÂàóÔºåËØ∑Á°Æ‰øùÊñá‰ª∂ÂåÖÂê´"Ë∂≥ÁéØÂè∑"Êàñ"ÁéØÂè∑"Âàó');
          return;
        }
        
        // ÂåπÈÖçÈ∏ΩÂ≠ê
        let matchedCount = 0;
        let unmatchedCount = 0;
        
        importedData = data.map(row => {
          const ring = row[fieldMapping.ring]?.trim();
          const pigeon = pigeons.find(p => (p.ring || '').toLowerCase() === (ring || '').toLowerCase());
          
          if (pigeon) {
            matchedCount++;
          } else {
            unmatchedCount++;
          }
          
          return {
            ring,
            rank: parseInt(row[fieldMapping.rank]) || null,
            score: parseFloat(row[fieldMapping.score]) || null,
            returnTime: row[fieldMapping.returnTime] || null,
            pigeon,
            matched: !!pigeon
          };
        });
        
        // Êõ¥Êñ∞ÁªüËÆ°
        document.getElementById('importMatchedCount').textContent = `Â∑≤ÂåπÈÖç: ${matchedCount}`;
        document.getElementById('importUnmatchedCount').textContent = `Êú™ÂåπÈÖç: ${unmatchedCount}`;
        
        // ÊòæÁ§∫È¢ÑËßàË°®Ê†º
        renderImportPreview();
        document.getElementById('importPreviewContainer').style.display = 'block';
        
      } catch (err) {
        console.error('Ëß£ÊûêÊñá‰ª∂Â§±Ë¥•:', err);
        alert('Ëß£ÊûêÊñá‰ª∂Â§±Ë¥•Ôºö' + err.message);
      }
    };
    
    if (file.name.endsWith('.csv')) {
      reader.readAsText(file);
    } else {
      reader.readAsArrayBuffer(file);
    }
  }
  
  // Ê∏≤ÊüìÂØºÂÖ•È¢ÑËßà
  function renderImportPreview() {
    const container = document.getElementById('importPreviewTable');
    if (!container || importedData.length === 0) return;
    
    let html = `
      <table style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead>
          <tr style="background:#f9fafb;">
            <th style="padding:10px;text-align:left;border-bottom:2px solid #e5e7eb;">Áä∂ÊÄÅ</th>
            <th style="padding:10px;text-align:left;border-bottom:2px solid #e5e7eb;">Ë∂≥ÁéØÂè∑</th>
            <th style="padding:10px;text-align:left;border-bottom:2px solid #e5e7eb;">È∏ΩÂ≠êÂêçÁß∞</th>
            <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂêçÊ¨°</th>
            <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂàÜÈÄü</th>
            <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂΩíÂ∑¢Êó∂Èó¥</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    importedData.forEach(item => {
      const statusIcon = item.matched ? '‚úÖ' : '‚ö†Ô∏è';
      const statusColor = item.matched ? '#d1fae5' : '#fee2e2';
      
      html += `
        <tr style="border-bottom:1px solid #f0f0f0;background:${statusColor}20;">
          <td style="padding:10px;">${statusIcon}</td>
          <td style="padding:10px;font-weight:500;">${item.ring || '‚Äî'}</td>
          <td style="padding:10px;">${item.pigeon?.name || (item.matched ? '‚Äî' : '<span style="color:#dc2626;">Êú™ÊâæÂà∞</span>')}</td>
          <td style="padding:10px;text-align:center;">${item.rank || '‚Äî'}</td>
          <td style="padding:10px;text-align:center;">${item.score || '‚Äî'}</td>
          <td style="padding:10px;text-align:center;">${item.returnTime || '‚Äî'}</td>
        </tr>
      `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
  }
  
  // Á°ÆËÆ§ÂØºÂÖ•
  function confirmImport() {
    const matchedData = importedData.filter(item => item.matched);
    
    if (matchedData.length === 0) {
      alert('Ê≤°ÊúâÂèØÂØºÂÖ•ÁöÑÂåπÈÖçÊï∞ÊçÆ');
      return;
    }
    
    // ÂàõÂª∫ÊàñËé∑ÂèñÂΩìÂâçÊØîËµõ
    const raceName = prompt('ËØ∑ËæìÂÖ•ÊØîËµõÂêçÁß∞Ôºö', `ÂØºÂÖ•ÊØîËµõ ${new Date().toLocaleDateString()}`);
    if (!raceName) return;
    
    const raceDate = prompt('ËØ∑ËæìÂÖ•ÊØîËµõÊó•Êúü (YYYY-MM-DD)Ôºö', new Date().toISOString().split('T')[0]);
    if (!raceDate) return;
    
    const race = {
      id: 'race_' + Date.now(),
      name: raceName,
      date: raceDate,
      location: '',
      weather: '',
      participants: matchedData.map(item => ({
        pigeonId: item.pigeon.id,
        rank: item.rank,
        score: item.score,
        returnTime: item.returnTime
      }))
    };
    
    races.push(race);
    saveRaces();
    
    // ÂêåÊ≠•Âà∞È∏ΩÂ≠êËÆ∞ÂΩï
    syncRacesToPigeons();
    saveToStorage();
    
    // Ê∏ÖÈô§ÂØºÂÖ•Êï∞ÊçÆ
    importedData = [];
    document.getElementById('importPreviewContainer').style.display = 'none';
    
    // Âà∑Êñ∞ÊòæÁ§∫
    renderRaceList();
    generateOverallAnalysis();
    
    alert(`ÊàêÂäüÂØºÂÖ• ${matchedData.length} Êù°ÊàêÁª©ËÆ∞ÂΩïÔºÅ`);
  }
  
  // Excel ÂØºÂÖ•‰∫ã‰ª∂ÁªëÂÆö
  const excelDropZone = document.getElementById('excelDropZone');
  const excelFileInput = document.getElementById('excelFileInput');
  
  if (excelDropZone && excelFileInput) {
    excelDropZone.addEventListener('click', () => excelFileInput.click());
    
    excelDropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      excelDropZone.classList.add('dragover');
    });
    
    excelDropZone.addEventListener('dragleave', () => {
      excelDropZone.classList.remove('dragover');
    });
    
    excelDropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      excelDropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) handleImportFile(file);
    });
    
    excelFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleImportFile(file);
    });
  }
  
  document.getElementById('btnSelectExcel')?.addEventListener('click', () => {
    document.getElementById('excelFileInput')?.click();
  });
  
  document.getElementById('btnCancelImport')?.addEventListener('click', () => {
    importedData = [];
    document.getElementById('importPreviewContainer').style.display = 'none';
  });
  
  document.getElementById('btnConfirmImport')?.addEventListener('click', confirmImport);
  
  document.getElementById('btnImportExcel')?.addEventListener('click', () => {
    // ÂàáÊç¢Âà∞ÂØºÂÖ•Ê†áÁ≠æÈ°µ
    document.querySelectorAll('.race-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.race-tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelector('[data-tab="raceImport"]')?.classList.add('active');
    document.getElementById('raceImportTab')?.classList.add('active');
  });
  
  // ========================================
  // üíæ Ê®°Âùó9ÔºöÊï∞ÊçÆÂ§á‰ªΩ‰∏éÊÅ¢Â§ç
  // ========================================
  
  // ÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆ
  function exportAllData() {
    const exportData = {
      version: '2.0',
      exportDate: new Date().toISOString(),
      data: {
        pigeons: pigeons,
        races: races,
        pairings: pairings,
        healthRecords: healthRecords,
        usedNames: Array.from(loadUsedNames()),
        ownerRegionPairs: loadOwnerRegionPairs()
      }
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pigeon_backup_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('Êï∞ÊçÆÂ§á‰ªΩÂ∑≤‰∏ãËΩΩÔºÅËØ∑Â¶•ÂñÑ‰øùÁÆ°Â§á‰ªΩÊñá‰ª∂„ÄÇ');
  }
  
  // ÂØºÂÖ•Â§á‰ªΩÊï∞ÊçÆ
  function importBackupData(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const backupData = JSON.parse(e.target.result);
        
        if (!backupData.data || !backupData.data.pigeons) {
          alert('Êó†ÊïàÁöÑÂ§á‰ªΩÊñá‰ª∂Ê†ºÂºè');
          return;
        }
        
        if (!confirm(`Á°ÆÂÆöË¶ÅÊÅ¢Â§çÂ§á‰ªΩÊï∞ÊçÆÂêóÔºü\n\nÂ§á‰ªΩÊó∂Èó¥: ${backupData.exportDate}\nÈ∏ΩÂ≠êÊï∞Èáè: ${backupData.data.pigeons.length}\nÊØîËµõÊï∞Èáè: ${backupData.data.races?.length || 0}\n\n‚ö†Ô∏è ËøôÂ∞ÜË¶ÜÁõñÂΩìÂâçÊâÄÊúâÊï∞ÊçÆÔºÅ`)) {
          return;
        }
        
        // ÊÅ¢Â§çÊï∞ÊçÆ
        pigeons.length = 0;
        pigeons.push(...backupData.data.pigeons);
        saveToStorage();
        
        if (backupData.data.races) {
          races.length = 0;
          races.push(...backupData.data.races);
          saveRaces();
        }
        
        if (backupData.data.pairings) {
          pairings.length = 0;
          pairings.push(...backupData.data.pairings);
          savePairings();
        }
        
        if (backupData.data.healthRecords) {
          healthRecords.length = 0;
          healthRecords.push(...backupData.data.healthRecords);
          saveHealthRecords();
        }
        
        if (backupData.data.usedNames) {
          saveUsedNames(new Set(backupData.data.usedNames));
        }
        
        if (backupData.data.ownerRegionPairs) {
          localStorage.setItem(OWNER_REGION_PAIRS_KEY, JSON.stringify(backupData.data.ownerRegionPairs));
        }
        
        // Âà∑Êñ∞ÁïåÈù¢
        refreshList();
        refreshStats();
        refreshDashboard();
        fillPedigreeSelect();
        
        alert('Êï∞ÊçÆÊÅ¢Â§çÊàêÂäüÔºÅ');
        
      } catch (err) {
        console.error('ÊÅ¢Â§çÂ§á‰ªΩÂ§±Ë¥•:', err);
        alert('ÊÅ¢Â§çÂ§á‰ªΩÂ§±Ë¥•Ôºö' + err.message);
      }
    };
    reader.readAsText(file);
  }
  
  // Â§á‰ªΩÊåâÈíÆ‰∫ã‰ª∂
  document.getElementById('btnBackupData')?.addEventListener('click', exportAllData);
  
  document.getElementById('btnExportData')?.addEventListener('click', exportAllData);
  
  // ========================================
  // ‚ö†Ô∏è Ê®°Âùó10ÔºöÂºÇÂ∏∏Ê£ÄÊµã‰∏éÊèêÈÜí
  // ========================================
  
  function detectAnomalies() {
    const anomalies = [];
    
    pigeons.forEach(p => {
      // Âπ¥ÈæÑÂºÇÂ∏∏Ê£ÄÊµã
      if (p.birth) {
        const birthYear = parseInt(p.birth.substring(0, 4));
        const currentYear = new Date().getFullYear();
        const age = currentYear - birthYear;
        
        if (age > 15) {
          anomalies.push({
            type: 'age',
            severity: 'warning',
            pigeon: p,
            message: `${p.name || p.ring} Âπ¥ÈæÑË∂ÖËøá15Â≤ÅÔºåËØ∑Á°ÆËÆ§Âá∫ÁîüÊó•ÊúüÊòØÂê¶Ê≠£Á°Æ`
          });
        }
        
        if (age < 0) {
          anomalies.push({
            type: 'age',
            severity: 'error',
            pigeon: p,
            message: `${p.name || p.ring} Âá∫ÁîüÊó•ÊúüÂú®Êú™Êù•ÔºåËØ∑‰øÆÊ≠£`
          });
        }
      }
      
      // Ë°ÄÁªüÊñ≠Â±ÇÊ£ÄÊµã
      if (p.type === 'Âêé‰ª£È∏Ω' && !p.fatherId && !p.motherId) {
        anomalies.push({
          type: 'pedigree',
          severity: 'info',
          pigeon: p,
          message: `${p.name || p.ring} ÊòØÂêé‰ª£È∏Ω‰ΩÜÊú™ËÆ∞ÂΩïÁà∂ÊØç‰ø°ÊÅØ`
        });
      }
      
      // ÊÄßÂà´‰∏éÁà∂ÊØçÂÖ≥Á≥ªÊ£ÄÊµã
      if (p.fatherId) {
        const father = getPigeonById(p.fatherId);
        if (father && father.gender === 'ÊØç') {
          anomalies.push({
            type: 'gender',
            severity: 'error',
            pigeon: p,
            message: `${p.name || p.ring} ÁöÑÁà∂È∏Ω ${father.name || father.ring} ÊÄßÂà´Ê†áËÆ∞‰∏∫ÊØçÔºåËØ∑Ê£ÄÊü•`
          });
        }
      }
      if (p.motherId) {
        const mother = getPigeonById(p.motherId);
        if (mother && mother.gender === 'ÂÖ¨') {
          anomalies.push({
            type: 'gender',
            severity: 'error',
            pigeon: p,
            message: `${p.name || p.ring} ÁöÑÊØçÈ∏Ω ${mother.name || mother.ring} ÊÄßÂà´Ê†áËÆ∞‰∏∫ÂÖ¨ÔºåËØ∑Ê£ÄÊü•`
          });
        }
      }
    });
    
    return anomalies;
  }
  
  // ÊòæÁ§∫ÂºÇÂ∏∏ÊèêÈÜí
  function showAnomalyAlerts() {
    const anomalies = detectAnomalies();
    if (anomalies.length === 0) return;
    
    const errors = anomalies.filter(a => a.severity === 'error');
    const warnings = anomalies.filter(a => a.severity === 'warning');
    
    if (errors.length > 0) {
      console.warn('Êï∞ÊçÆÂºÇÂ∏∏Ê£ÄÊµãÂèëÁé∞‰ª•‰∏ãÈîôËØØÔºö', errors);
      // ÂèØ‰ª•Âú®ËøôÈáåÊòæÁ§∫ÈÄöÁü•
    }
  }
  
  // ========================================
  // üè† È¶ñÈ°µ ¬∑ ËµõÈ∏ΩËµÑËÆØ‰∏≠ÂøÉ
  // ========================================
  
  // Ê®°ÊãüËµÑËÆØÊï∞ÊçÆÔºàÂÆûÈôÖÈ°πÁõÆ‰∏≠‰ªéAPIËé∑ÂèñÔºâ
  const NEWS_DATA = [
    {
      id: 1,
      title: '2025Âπ¥Êò•Â≠£ÂÖ¨Ê£öËµõÊúÄÊñ∞ËµõÁ®ãÂÖ¨Â∏É',
      source: '‰∏≠ÂõΩËµõÈ∏ΩÁΩë',
      time: '2Â∞èÊó∂Ââç',
      tags: ['ÂÖ¨Ê£öËµõ', 'Êò•Ëµõ', 'ËµõÁ®ã'],
      category: 'race',
      hot: true
    },
    {
      id: 2,
      title: 'Ë©πÊ£ÆË°ÄÁªüÁßçÈ∏ΩÈÖçÂØπÊäÄÂ∑ßÂàÜ‰∫´',
      source: 'ËµõÈ∏ΩÂ§©Âú∞',
      time: '5Â∞èÊó∂Ââç',
      tags: ['ËÇ≤Áßç', 'Ë©πÊ£Æ', 'ÈÖçÂØπ'],
      category: 'breeding'
    },
    {
      id: 3,
      title: 'Êò•Â≠£ËµõÈ∏ΩÁñæÁóÖÈ¢ÑÈò≤ÊåáÂçó',
      source: '‰ø°È∏ΩÂÅ•Â∫∑',
      time: '8Â∞èÊó∂Ââç',
      tags: ['ÂÅ•Â∫∑', 'È¢ÑÈò≤', 'Êò•Â≠£'],
      category: 'health'
    },
    {
      id: 4,
      title: 'Ë¥µÂ∑ûÁúÅ‰ø°È∏ΩÂçè‰ºö2025Âπ¥Â∑•‰ΩúËÆ°ÂàíÂèëÂ∏É',
      source: 'Ë¥µÂ∑ûËµõÈ∏Ω',
      time: '1Â§©Ââç',
      tags: ['Âçè‰ºö', 'Ë¥µÂ∑û', 'ËßÑÂàí'],
      category: 'race'
    },
    {
      id: 5,
      title: 'Â¶Ç‰ΩïÊèêÈ´òÂπºÈ∏ΩÂΩíÂ∑¢ÁéáÔºü‰∏ìÂÆ∂Ëß£Á≠î',
      source: 'ËµõÈ∏ΩËÆ∫Âùõ',
      time: '1Â§©Ââç',
      tags: ['ËÆ≠ÁªÉ', 'ÂπºÈ∏Ω', 'ÂΩíÂ∑¢'],
      category: 'breeding'
    },
    {
      id: 6,
      title: '2024Âπ¥Â∫¶ÂÖ®ÂõΩËµõÈ∏ΩÂÜ†ÂÜõË°ÄÁªüÂàÜÊûê',
      source: 'ÂÜ†ÂÜõÈ∏ΩËàç',
      time: '2Â§©Ââç',
      tags: ['ÂÜ†ÂÜõ', 'Ë°ÄÁªü', 'ÂàÜÊûê'],
      category: 'race',
      hot: true
    },
    {
      id: 7,
      title: 'ËµõÈ∏ΩÁúºÁ†ÇÈâ¥Âà´‰∏éÈÄâÁßçË¶ÅÁÇπ',
      source: '‰∏ì‰∏öËÇ≤Áßç',
      time: '2Â§©Ââç',
      tags: ['ÁúºÁ†Ç', 'ÈÄâÁßç', 'Èâ¥Âà´'],
      category: 'breeding'
    },
    {
      id: 8,
      title: '‰ø°È∏ΩÊØõÊª¥Ëô´ÁóÖÁöÑËØäÊñ≠‰∏éÊ≤ªÁñó',
      source: 'ÂÖΩÂåªÂú®Á∫ø',
      time: '3Â§©Ââç',
      tags: ['ÁñæÁóÖ', 'Ê≤ªÁñó', 'ËØäÊñ≠'],
      category: 'health'
    }
  ];
  
  // Ê®°ÊãüËµõ‰∫ãÊï∞ÊçÆ
  const EVENTS_DATA = {
    ongoing: [
      {
        id: 1,
        name: '2025Ë¥µÂ∑ûÊò•Â≠£500ÂÖ¨ÈáåÂÖ¨Ê£öËµõ',
        organizer: 'Ë¥µÂ∑ûÁúÅ‰ø°È∏ΩÂçè‰ºö',
        releaseTime: '‰ªäÊó• 06:30',
        distance: '500ÂÖ¨Èáå',
        status: 'ongoing',
        returned: 156,
        total: 320,
        weather: 'Êô¥ËΩ¨Â§ö‰∫ë'
      },
      {
        id: 2,
        name: 'ÈªîË•øÂ∏ÇÊò•Â≠£ÁâπÊØîÁéØÂ§ßËµõ',
        organizer: 'ÈªîË•øÂ∏ÇËµõÈ∏Ω‰ø±‰πêÈÉ®',
        releaseTime: '‰ªäÊó• 07:00',
        distance: '350ÂÖ¨Èáå',
        status: 'ongoing',
        returned: 89,
        total: 150,
        weather: 'Êô¥'
      }
    ],
    upcoming: [
      {
        id: 3,
        name: 'Ë¥µÈò≥Â∏Ç‰ø°È∏ΩÂçè‰ºö700ÂÖ¨ÈáåËµõ',
        organizer: 'Ë¥µÈò≥Â∏Ç‰ø°È∏ΩÂçè‰ºö',
        startTime: 'ÊòéÊó• 06:00',
        distance: '700ÂÖ¨Èáå',
        status: 'upcoming',
        participants: 280,
        weather: 'È¢ÑËÆ°Êô¥'
      },
      {
        id: 4,
        name: '2025Ë•øÂçóÂú∞Âå∫Á≤æËã±Ëµõ',
        organizer: 'Ë•øÂçóËµõÈ∏ΩËÅîÁõü',
        startTime: '12Êúà25Êó•',
        distance: '600ÂÖ¨Èáå',
        status: 'upcoming',
        participants: 450,
        weather: 'ÂæÖÂÆö'
      }
    ],
    results: [
      {
        id: 5,
        name: 'ÊØïËäÇÂ∏ÇÁßãÂ≠£300ÂÖ¨ÈáåËµõ',
        organizer: 'ÊØïËäÇÂ∏ÇËµõÈ∏ΩÂçè‰ºö',
        endTime: 'Êò®Êó• 15:30',
        distance: '300ÂÖ¨Èáå',
        status: 'completed',
        champion: 'È£ûÁøî001',
        championRing: 'CHN2023-0156',
        championTime: '4Â∞èÊó∂12ÂàÜ'
      },
      {
        id: 6,
        name: 'ÈÅµ‰πâÂ∏ÇÂÜ¨Â≠£ÂèãË∞äËµõ',
        organizer: 'ÈÅµ‰πâÂ∏Ç‰ø°È∏Ω‰ø±‰πêÈÉ®',
        endTime: '3Â§©Ââç',
        distance: '400ÂÖ¨Èáå',
        status: 'completed',
        champion: 'Â§©ÈôÖÂè∑',
        championRing: 'CHN2022-0892',
        championTime: '5Â∞èÊó∂28ÂàÜ'
      }
    ]
  };
  
  let currentNewsFilter = 'all';
  let currentEventTab = 'ongoing';
  
  // Êõ¥Êñ∞È¶ñÈ°µÊó•ÊúüÊòæÁ§∫
  function updateHomeDate() {
    const now = new Date();
    const weekdays = ['ÊòüÊúüÊó•', 'ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î', 'ÊòüÊúüÂÖ≠'];
    
    const dayEl = document.getElementById('homeDay');
    const weekdayEl = document.getElementById('homeWeekday');
    const dateFullEl = document.getElementById('homeDateFull');
    
    if (dayEl) dayEl.textContent = now.getDate();
    if (weekdayEl) weekdayEl.textContent = weekdays[now.getDay()];
    if (dateFullEl) dateFullEl.textContent = `${now.getFullYear()}Âπ¥${now.getMonth() + 1}Êúà`;
  }
  
  // Êõ¥Êñ∞È¶ñÈ°µÁªüËÆ°
  function updateHomeStats() {
    const pigeonCountEl = document.getElementById('homePigeonCount');
    if (pigeonCountEl) {
      pigeonCountEl.textContent = pigeons.filter(p => p.alive).length;
    }
    
    // Êõ¥Êñ∞ÂÖ∂‰ªñÁªüËÆ°ÔºàÂÆûÈôÖÈ°πÁõÆ‰∏≠‰ªéÂêéÁ´ØËé∑ÂèñÔºâ
    document.getElementById('homeNewsCount').textContent = NEWS_DATA.length;
    document.getElementById('homeActiveRaces').textContent = EVENTS_DATA.ongoing.length;
    document.getElementById('homeCompletedRaces').textContent = EVENTS_DATA.results.length;
  }
  
  // Ê∏≤ÊüìËµÑËÆØÂàóË°®
  function renderNewsList(filter = 'all') {
    const container = document.getElementById('homeNewsList');
    if (!container) return;
    
    const filteredNews = filter === 'all' 
      ? NEWS_DATA 
      : NEWS_DATA.filter(n => n.category === filter);
    
    container.innerHTML = filteredNews.map(news => `
      <div class="news-card" data-news-id="${news.id}">
        <div class="news-card-header">
          <div class="news-card-title">${news.title}</div>
          <div class="news-card-time">${news.time}</div>
        </div>
        <div class="news-card-source">Êù•Ê∫êÔºö${news.source}</div>
        <div class="news-card-tags">
          ${news.hot ? '<span class="news-tag hot">üî• ÁÉ≠Èó®</span>' : ''}
          ${news.tags.map(tag => `<span class="news-tag ${news.category}">#${tag}</span>`).join('')}
        </div>
      </div>
    `).join('');
    
    // ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
    container.querySelectorAll('.news-card').forEach(card => {
      card.addEventListener('click', () => {
        const newsId = card.dataset.newsId;
        alert(`ÊâìÂºÄËµÑËÆØËØ¶ÊÉÖ ID: ${newsId}\n\nÔºàÂÆûÈôÖÈ°πÁõÆ‰∏≠‰ºöË∑≥ËΩ¨Âà∞ËµÑËÆØËØ¶ÊÉÖÈ°µÈù¢ÊàñÊâìÂºÄÂ§ñÈÉ®ÈìæÊé•Ôºâ`);
      });
    });
  }
  
  // Ê∏≤ÊüìËµõ‰∫ãÂàóË°®
  function renderEventsList(tab = 'ongoing') {
    const container = document.getElementById('homeEventsList');
    if (!container) return;
    
    const events = EVENTS_DATA[tab] || [];
    
    if (events.length === 0) {
      container.innerHTML = '<div style="padding:40px;text-align:center;color:#9ca3af;">ÊöÇÊó†Ëµõ‰∫ã</div>';
      return;
    }
    
    if (tab === 'ongoing') {
      container.innerHTML = events.map(event => `
        <div class="event-card">
          <div class="event-card-status ongoing">
            <span>ËøõË°å‰∏≠</span>
          </div>
          <div class="event-card-title">${event.name}</div>
          <div class="event-card-info">
            <div class="event-card-info-item">
              <span>üè¢</span>
              <span>${event.organizer}</span>
            </div>
            <div class="event-card-info-item">
              <span>üìè</span>
              <span>${event.distance}</span>
            </div>
            <div class="event-card-info-item">
              <span>üïê</span>
              <span>ÊîæÈ£ûÔºö${event.releaseTime}</span>
            </div>
            <div class="event-card-info-item">
              <span>üå§Ô∏è</span>
              <span>${event.weather}</span>
            </div>
          </div>
          <div class="event-card-progress">
            <div class="event-progress-bar">
              <div class="event-progress-fill" style="width:${(event.returned / event.total * 100).toFixed(1)}%;"></div>
            </div>
            <div class="event-progress-text">Â∑≤ÂΩíÂ∑¢ ${event.returned} / ${event.total} Âè™Ôºà${(event.returned / event.total * 100).toFixed(1)}%Ôºâ</div>
          </div>
        </div>
      `).join('');
    } else if (tab === 'upcoming') {
      container.innerHTML = events.map(event => `
        <div class="event-card">
          <div class="event-card-status upcoming">Âç≥Â∞ÜÂºÄÂßã</div>
          <div class="event-card-title">${event.name}</div>
          <div class="event-card-info">
            <div class="event-card-info-item">
              <span>üè¢</span>
              <span>${event.organizer}</span>
            </div>
            <div class="event-card-info-item">
              <span>üìè</span>
              <span>${event.distance}</span>
            </div>
            <div class="event-card-info-item">
              <span>üïê</span>
              <span>ÂºÄÂßãÔºö${event.startTime}</span>
            </div>
            <div class="event-card-info-item">
              <span>üïäÔ∏è</span>
              <span>ÂèÇËµõÔºö${event.participants}Âè™</span>
            </div>
          </div>
        </div>
      `).join('');
    } else if (tab === 'results') {
      container.innerHTML = events.map(event => `
        <div class="event-card">
          <div class="event-card-status completed">Â∑≤ÁªìÊùü</div>
          <div class="event-card-title">${event.name}</div>
          <div class="event-card-info">
            <div class="event-card-info-item">
              <span>üè¢</span>
              <span>${event.organizer}</span>
            </div>
            <div class="event-card-info-item">
              <span>üìè</span>
              <span>${event.distance}</span>
            </div>
          </div>
          <div style="margin-top:12px;padding:12px;background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border-radius:8px;">
            <div style="font-size:12px;color:#92400e;margin-bottom:4px;">üèÜ ÂÜ†ÂÜõ</div>
            <div style="font-weight:700;color:#78350f;">${event.champion}</div>
            <div style="font-size:12px;color:#92400e;">${event.championRing} | Áî®Êó∂ ${event.championTime}</div>
          </div>
        </div>
      `).join('');
    }
  }
  
  // Ê∏≤ÊüìÊô∫ËÉΩÊé®Ëçê
  function renderRecommendations() {
    const container = document.getElementById('homeRecommendations');
    if (!container) return;
    
    const recommendations = [];
    
    // Âü∫‰∫éË°ÄÁªüÊé®ËçêËµõ‰∫ã
    const corePigeons = pigeons.filter(p => p.isCore);
    if (corePigeons.length > 0) {
      recommendations.push({
        type: 'race',
        icon: 'üèÜ',
        iconClass: 'race',
        title: 'Êé®ËçêÂèÇËµõ',
        desc: `ÊÇ®Êúâ${corePigeons.length}Âè™Ê†∏ÂøÉÁßçÈ∏ΩÔºåÂª∫ËÆÆÂèÇÂä†Êò•Â≠£ÂÖ¨Ê£öËµõ`
      });
    }
    
    // Âü∫‰∫éÂÅ•Â∫∑ËÆ∞ÂΩïÊé®Ëçê
    const upcomingAlerts = getHealthAlerts().filter(a => a.type === 'warning');
    if (upcomingAlerts.length > 0) {
      recommendations.push({
        type: 'health',
        icon: 'üíâ',
        iconClass: 'pigeon',
        title: 'ÂÅ•Â∫∑ÊèêÈÜí',
        desc: `${upcomingAlerts.length}Âè™È∏ΩÂ≠êÂç≥Â∞ÜÈúÄË¶ÅÂÅ•Â∫∑Ê£ÄÊü•`
      });
    }
    
    // ÈÖçÂØπÊé®Ëçê
    const pairingRecs = getRecommendedPairings();
    if (pairingRecs.length > 0) {
      recommendations.push({
        type: 'breeding',
        icon: 'üíï',
        iconClass: 'breeding',
        title: 'ÈÖçÂØπÂª∫ËÆÆ',
        desc: `ÂèëÁé∞${pairingRecs.length}ÂØπÈ´òËØÑÂàÜÈÖçÂØπÁªÑÂêà`
      });
    }
    
    // ÈªòËÆ§Êé®Ëçê
    if (recommendations.length === 0) {
      recommendations.push(
        {
          type: 'race',
          icon: 'üèÅ',
          iconClass: 'race',
          title: 'ÂÖ≥Ê≥®Ëµõ‰∫ã',
          desc: '2025Êò•Â≠£ËµõÂ≠£Âç≥Â∞ÜÂºÄÂßã'
        },
        {
          type: 'breeding',
          icon: 'üìö',
          iconClass: 'pigeon',
          title: 'Â≠¶‰π†ËµÑÊñô',
          desc: 'Ë©πÊ£ÆË°ÄÁªüÈÖçÂØπÊäÄÂ∑ßÊåáÂçó'
        }
      );
    }
    
    container.innerHTML = recommendations.map(rec => `
      <div class="recommendation-item">
        <div class="recommendation-icon ${rec.iconClass}">${rec.icon}</div>
        <div class="recommendation-content">
          <div class="recommendation-title">${rec.title}</div>
          <div class="recommendation-desc">${rec.desc}</div>
        </div>
      </div>
    `).join('');
  }
  
  // Ê∏≤Êüì‰ªäÊó•ÊèêÈÜí
  function renderTodayAlerts() {
    const container = document.getElementById('homeTodayAlerts');
    if (!container) return;
    
    const alerts = [];
    
    // ÂÅ•Â∫∑ÊèêÈÜí
    const healthAlerts = getHealthAlerts();
    healthAlerts.slice(0, 2).forEach(alert => {
      alerts.push({
        type: alert.type,
        icon: alert.icon,
        text: `${alert.pigeon.name || alert.pigeon.ring} ${alert.message}`
      });
    });
    
    // ÊØîËµõÊèêÈÜíÔºàÊ®°ÊãüÔºâ
    if (EVENTS_DATA.ongoing.length > 0) {
      alerts.push({
        type: 'info',
        icon: 'üèÅ',
        text: `${EVENTS_DATA.ongoing.length}Âú∫ÊØîËµõÊ≠£Âú®ËøõË°å‰∏≠`
      });
    }
    
    // Êï∞ÊçÆÂºÇÂ∏∏ÊèêÈÜí
    const anomalies = detectAnomalies();
    if (anomalies.length > 0) {
      alerts.push({
        type: 'warning',
        icon: '‚ö†Ô∏è',
        text: `ÂèëÁé∞${anomalies.length}Êù°Êï∞ÊçÆÈúÄË¶ÅÊ£ÄÊü•`
      });
    }
    
    if (alerts.length === 0) {
      container.innerHTML = '<div style="padding:16px;text-align:center;color:#9ca3af;font-size:13px;">ÊöÇÊó†ÊèêÈÜíÔºå‰∏ÄÂàáÊ≠£Â∏∏ ‚úÖ</div>';
      return;
    }
    
    container.innerHTML = alerts.map(alert => `
      <div class="alert-item ${alert.type}">
        <span class="alert-item-icon">${alert.icon}</span>
        <span class="alert-item-text">${alert.text}</span>
      </div>
    `).join('');
  }
  
  // ÂàùÂßãÂåñÈ¶ñÈ°µ
  function initHomePage() {
    updateHomeDate();
    updateHomeStats();
    renderNewsList();
    renderEventsList();
    renderRecommendations();
    renderTodayAlerts();
  }
  
  // È¶ñÈ°µ‰∫ã‰ª∂ÁªëÂÆö
  // ËµÑËÆØÁ≠õÈÄâ
  document.querySelectorAll('.news-filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.news-filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentNewsFilter = btn.dataset.filter;
      renderNewsList(currentNewsFilter);
    });
  });
  
  // Ëµõ‰∫ãÊ†áÁ≠æÈ°µ
  document.querySelectorAll('.event-tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.event-tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentEventTab = btn.dataset.tab;
      renderEventsList(currentEventTab);
    });
  });
  
  // Âà∑Êñ∞Ëµõ‰∫ã
  document.getElementById('btnRefreshEvents')?.addEventListener('click', () => {
    renderEventsList(currentEventTab);
    alert('Ëµõ‰∫ãÊï∞ÊçÆÂ∑≤Âà∑Êñ∞ÔºÅ');
  });
  
  // ÂÖ≥Èó≠ÂÖ¨Âëä
  document.getElementById('btnCloseAnnouncement')?.addEventListener('click', () => {
    document.getElementById('homeAnnouncement').style.display = 'none';
  });
  
  // Âø´Êç∑ÂÖ•Âè£
  document.querySelectorAll('.quick-link-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const action = btn.dataset.action;
      switch (action) {
        case 'addPigeon':
          switchView('createView');
          break;
        case 'addRace':
          switchView('raceView');
          break;
        case 'breeding':
          switchView('breedingView');
          break;
        case 'analysis':
          switchView('analysisView');
          break;
      }
    });
  });
  
  // Ê∑ªÂä†ËÆ¢ÈòÖ
  document.getElementById('btnAddSubscription')?.addEventListener('click', () => {
    const tag = prompt('ËØ∑ËæìÂÖ•Ë¶ÅÂÖ≥Ê≥®ÁöÑÊ†áÁ≠æÔºàÂ¶ÇÔºöÂú∞Âå∫„ÄÅËµõ‰∫ãÁ±ªÂûãÁ≠âÔºâÔºö');
    if (tag && tag.trim()) {
      const tagsContainer = document.querySelector('.subscription-tags');
      const addBtn = document.getElementById('btnAddSubscription');
      const newTag = document.createElement('span');
      newTag.className = 'subscription-tag';
      newTag.textContent = tag.trim();
      tagsContainer.insertBefore(newTag, addBtn);
    }
  });
  
  // Êâ©Â±ïËßÜÂõæÂØπË±°ÔºåÊ∑ªÂä†È¶ñÈ°µ
  views.homeView = document.getElementById('homeView');
  
  // Êõ¥Êñ∞ switchView ÂáΩÊï∞‰ª•ÊîØÊåÅÈ¶ñÈ°µ
  const originalSwitchViewHome = switchView;
  switchView = function(name) {
    // Â¶ÇÊûúÂΩìÂâçÂú®ÁºñËæëÊ®°Âºè‰∏îË¶ÅÂàáÊç¢Âà∞ÂÖ∂‰ªñËßÜÂõæÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥Êîπ
    const detailView = document.getElementById('detailView');
    if (detailView && detailView.style.display !== 'none') {
      const editMode = document.getElementById('editMode');
      if (editMode && editMode.style.display !== 'none') {
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥Êîπ
        if (hasUnsavedChanges()) {
          if (!confirm('ÊÇ®ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥ÊîπÔºåÁ°ÆÂÆöË¶ÅÁ¶ªÂºÄÁºñËæëÈ°µÈù¢ÂêóÔºü\n\nÂ¶ÇÊûúÁ¶ªÂºÄÔºåÊâÄÊúâÊú™‰øùÂ≠òÁöÑÊõ¥ÊîπÂ∞Ü‰ºö‰∏¢Â§±„ÄÇ')) {
            return; // Áî®Êà∑ÂèñÊ∂àÂàáÊç¢
          }
          // Áî®Êà∑Á°ÆËÆ§Á¶ªÂºÄÔºåÈÄÄÂá∫ÁºñËæëÊ®°Âºè
          setEditMode(false);
        }
      }
    }
    
    // ÂÖàÈöêËóèÊâÄÊúâËßÜÂõæ
    Object.keys(views).forEach(k => {
      if (views[k]) views[k].style.display = (k === name) ? '' : 'none';
    });
    
    // Êõ¥Êñ∞‰æßËæπÊ†è
    sidebarItems.forEach(item => {
      if (item.dataset.view === name) item.classList.add('active');
      else item.classList.remove('active');
    });
    
    // È¶ñÈ°µËßÜÂõæ
    if (name === 'homeView') {
      initHomePage();
    }
    
    // Ë°ÄÁªüÂÖ≥Á≥ªËßÜÂõæ
    if (name === 'pedigreeView') {
      refreshPedigreeView();
    }
    
    // ÊØîËµõÁÆ°ÁêÜËßÜÂõæ
    if (name === 'raceView') {
      loadRaces();
      syncRacesToPigeons();
      renderRaceList();
      fillStatsPigeonSelect();
      generateOverallAnalysis();
    }
    
    // ÁπÅËÇ≤ÈÖçÂØπËßÜÂõæ
    if (name === 'breedingView') {
      loadPairings();
      fillBreedingSelects();
      renderPairingHistory();
      updateBreedingAssessment();
    }
    
    // ÂÅ•Â∫∑ÁÆ°ÁêÜËßÜÂõæ
    if (name === 'healthView') {
      loadHealthRecords();
      fillHealthPigeonSelects();
      renderHealthOverview();
      renderHealthAlerts();
    }
    
    // Êô∫ËÉΩÂàÜÊûêËßÜÂõæ
    if (name === 'analysisView') {
      loadPairings();
      loadHealthRecords();
      runFullAnalysis();
    }
  };
  
  // ========================================
  // üåô Ê∑±Ëâ≤Ê®°ÂºèÂàáÊç¢
  // ========================================
  
  const THEME_KEY = 'pigeon_theme_preference';
  
  function getPreferredTheme() {
    const stored = localStorage.getItem(THEME_KEY);
    if (stored) return stored;
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }
  
  function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem(THEME_KEY, theme);
    
    const themeBtn = document.getElementById('btnToggleTheme');
    if (themeBtn) {
      themeBtn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      themeBtn.title = theme === 'dark' ? 'ÂàáÊç¢Âà∞ÊµÖËâ≤Ê®°Âºè' : 'ÂàáÊç¢Âà∞Ê∑±Ëâ≤Ê®°Âºè';
    }
  }
  
  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme') || 'light';
    const next = current === 'dark' ? 'light' : 'dark';
    setTheme(next);
  }
  
  // ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ‰∫ã‰ª∂
  document.getElementById('btnToggleTheme')?.addEventListener('click', toggleTheme);
  
  // ÁõëÂê¨Á≥ªÁªü‰∏ªÈ¢òÂèòÂåñ
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (!localStorage.getItem(THEME_KEY)) {
      setTheme(e.matches ? 'dark' : 'light');
    }
  });
  
  // ========================================
  // ‚ú® Âä®ÁîªÂ¢ûÂº∫
  // ========================================
  
  // È°µÈù¢Âä†ËΩΩÂä®Áîª
  function addLoadingAnimation() {
    document.body.style.opacity = '0';
    document.body.style.transition = 'opacity 0.3s ease';
    setTimeout(() => {
      document.body.style.opacity = '1';
    }, 100);
  }
  
  // Âç°ÁâáËøõÂÖ•Âä®Áîª
  function animateCards() {
    const cards = document.querySelectorAll('.card, .stat-card, .home-column, .home-widget');
    cards.forEach((card, index) => {
      card.style.opacity = '0';
      card.style.transform = 'translateY(20px)';
      card.style.transition = `opacity 0.4s ease ${index * 0.05}s, transform 0.4s ease ${index * 0.05}s`;
      setTimeout(() => {
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
      }, 50);
    });
  }
  
  // Êï∞Â≠óËÆ°Êï∞Âä®Áîª
  function animateCounter(element, target, duration = 1000) {
    if (!element) return;
    const start = 0;
    const increment = target / (duration / 16);
    let current = start;
    
    const timer = setInterval(() => {
      current += increment;
      if (current >= target) {
        element.textContent = target;
        clearInterval(timer);
      } else {
        element.textContent = Math.floor(current);
      }
    }, 16);
  }
  
  // ========================================
  // üîî ÈÄöÁü•Á≥ªÁªü
  // ========================================
  
  function showNotification(message, type = 'info', duration = 3000) {
    const container = document.getElementById('notificationContainer') || createNotificationContainer();
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
      <span class="notification-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
      <span class="notification-message">${message}</span>
      <button class="notification-close">‚úï</button>
    `;
    
    notification.style.cssText = `
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: ${type === 'success' ? '#d1fae5' : type === 'error' ? '#fee2e2' : type === 'warning' ? '#fef3c7' : '#dbeafe'};
      color: ${type === 'success' ? '#047857' : type === 'error' ? '#b91c1c' : type === 'warning' ? '#92400e' : '#1e40af'};
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      margin-bottom: 10px;
      animation: slideIn 0.3s ease;
      font-weight: 500;
    `;
    
    container.appendChild(notification);
    
    notification.querySelector('.notification-close').addEventListener('click', () => {
      notification.style.animation = 'slideOut 0.3s ease forwards';
      setTimeout(() => notification.remove(), 300);
    });
    
    if (duration > 0) {
      setTimeout(() => {
        if (notification.parentNode) {
          notification.style.animation = 'slideOut 0.3s ease forwards';
          setTimeout(() => notification.remove(), 300);
        }
      }, duration);
    }
  }
  
  function createNotificationContainer() {
    const container = document.createElement('div');
    container.id = 'notificationContainer';
    container.style.cssText = `
      position: fixed;
      top: 80px;
      right: 24px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
    `;
    document.body.appendChild(container);
    
    // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
    
    return container;
  }
  
  // ========================================
  // ‚å®Ô∏è Âø´Êç∑ÈîÆÊîØÊåÅ
  // ========================================
  
  document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + K: ËÅöÁÑ¶ÊêúÁ¥¢Ê°Ü
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      document.getElementById('smartSearchInput')?.focus();
    }
    
    // Ctrl/Cmd + N: Êñ∞Â¢ûÈ∏ΩÂ≠ê
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
      e.preventDefault();
      switchView('createView');
    }
    
    // Escape: ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÊàñÈÄÄÂá∫ÁºñËæëÊ®°Âºè
    if (e.key === 'Escape') {
      // ÂÖàÊ£ÄÊü•ÊòØÂê¶Âú®ÁºñËæëÊ®°Âºè
      const editMode = document.getElementById('editMode');
      if (editMode && editMode.style.display !== 'none') {
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥Êîπ
        if (hasUnsavedChanges()) {
          if (confirm('ÊÇ®ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥ÊîπÔºåÁ°ÆÂÆöË¶ÅÈÄÄÂá∫ÁºñËæëÈ°µÈù¢ÂêóÔºü\n\nÂ¶ÇÊûúÈÄÄÂá∫ÔºåÊâÄÊúâÊú™‰øùÂ≠òÁöÑÊõ¥ÊîπÂ∞Ü‰ºö‰∏¢Â§±„ÄÇ')) {
            setEditMode(false);
          }
        } else {
          setEditMode(false);
        }
        return;
      }
      
      // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
      document.querySelectorAll('.race-modal').forEach(modal => {
        if (modal.style.display !== 'none') {
          modal.style.display = 'none';
        }
      });
    }
  });
  
  // ========================================
  // ÂàùÂßãÂåñ
  // ========================================
  
  // ËÆæÁΩÆ‰∏ªÈ¢ò
  setTheme(getPreferredTheme());
  
  // È°µÈù¢Âä†ËΩΩÂä®Áîª
  addLoadingAnimation();
  
  // ÂàùÂßãÂåñÊØîËµõÁÆ°ÁêÜ
  loadRaces();
  syncRacesToPigeons();
  renderRaceList();
  fillStatsPigeonSelect();
  
  // ÂàùÂßãÂåñÈÖçÂØπÁÆ°ÁêÜ
  loadPairings();
  
  // ÂàùÂßãÂåñÂÅ•Â∫∑ÁÆ°ÁêÜ
  loadHealthRecords();

  // Áõ∏Êú∫ÊãçÁÖßÂäüËÉΩÔºöÂ∞ÜÁõ∏Êú∫ËæìÂÖ•Ê°ÜÁöÑÊñá‰ª∂ÂêåÊ≠•Âà∞‰∏ªËæìÂÖ•Ê°Ü
  function syncCameraToMain(cameraInputId, mainInputId) {
    const cameraInput = document.getElementById(cameraInputId);
    const mainInput = document.getElementById(mainInputId);
    if (cameraInput && mainInput) {
      cameraInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files.length > 0) {
          // ÂàõÂª∫Êñ∞ÁöÑ FileList ÂØπË±°Âπ∂ÂêåÊ≠•Âà∞‰∏ªËæìÂÖ•Ê°Ü
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(e.target.files[0]);
          mainInput.files = dataTransfer.files;
          // Ëß¶Âèë change ‰∫ã‰ª∂‰ª•‰æøÂÖ∂‰ªñÁõëÂê¨Âô®‰πüËÉΩÂìçÂ∫î
          mainInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
    }
  }
  
  // ÂàùÂßãÂåñÁõ∏Êú∫ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
  function initCameraButtons() {
    // Êñ∞Â¢ûÈ°µÈù¢ÁöÑÁõ∏Êú∫ÊåâÈíÆ
    const btnCameraBodyCreate = document.getElementById('btnCameraBodyCreate');
    const btnCameraEyeCreate = document.getElementById('btnCameraEyeCreate');
    const cameraBodyCreate = document.getElementById('c_body_photo_camera');
    const cameraEyeCreate = document.getElementById('c_eye_photo_camera');
    
    if (btnCameraBodyCreate && cameraBodyCreate) {
      btnCameraBodyCreate.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        // ÁßªÈô§Âπ∂ÈáçÊñ∞Ê∑ªÂä† capture Â±ûÊÄßÔºåÁ°Æ‰øùÊØèÊ¨°ÈÉΩËÉΩËß¶ÂèëÁõ∏Êú∫
        cameraBodyCreate.removeAttribute('capture');
        // ‰ΩøÁî® requestAnimationFrame Á°Æ‰øù DOM Êõ¥Êñ∞ÂêéÂÜçËß¶Âèë
        requestAnimationFrame(() => {
          cameraBodyCreate.setAttribute('capture', '');
          // Ê∏ÖÁ©∫ÂÄºÔºåÁ°Æ‰øùÊØèÊ¨°ÁÇπÂáªÈÉΩËÉΩËß¶Âèë
          cameraBodyCreate.value = '';
          // Ëß¶ÂèëÁÇπÂáª
          setTimeout(() => {
            cameraBodyCreate.click();
          }, 50);
        });
      });
    }
    
    if (btnCameraEyeCreate && cameraEyeCreate) {
      btnCameraEyeCreate.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        cameraEyeCreate.removeAttribute('capture');
        requestAnimationFrame(() => {
          cameraEyeCreate.setAttribute('capture', '');
          cameraEyeCreate.value = '';
          setTimeout(() => {
            cameraEyeCreate.click();
          }, 50);
        });
      });
    }
    
    // ÁºñËæëÈ°µÈù¢ÁöÑÁõ∏Êú∫ÊåâÈíÆ
    const btnCameraBodyEdit = document.getElementById('btnCameraBodyEdit');
    const btnCameraEyeEdit = document.getElementById('btnCameraEyeEdit');
    const cameraBodyEdit = document.getElementById('e_body_photo_camera');
    const cameraEyeEdit = document.getElementById('e_eye_photo_camera');
    
    if (btnCameraBodyEdit && cameraBodyEdit) {
      btnCameraBodyEdit.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        cameraBodyEdit.removeAttribute('capture');
        requestAnimationFrame(() => {
          cameraBodyEdit.setAttribute('capture', '');
          cameraBodyEdit.value = '';
          setTimeout(() => {
            cameraBodyEdit.click();
          }, 50);
        });
      });
    }
    
    if (btnCameraEyeEdit && cameraEyeEdit) {
      btnCameraEyeEdit.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        cameraEyeEdit.removeAttribute('capture');
        requestAnimationFrame(() => {
          cameraEyeEdit.setAttribute('capture', '');
          cameraEyeEdit.value = '';
          setTimeout(() => {
            cameraEyeEdit.click();
          }, 50);
        });
      });
    }
  }
  
  // ÂàùÂßãÂåñÁõ∏Êú∫ÊãçÁÖßÂêåÊ≠•ÂäüËÉΩÂíåÊåâÈíÆ‰∫ã‰ª∂ÔºàÂª∂ËøüÊâßË°å‰ª•Á°Æ‰øùDOMÂ∑≤Âä†ËΩΩÔºâ
  setTimeout(() => {
    syncCameraToMain('c_body_photo_camera', 'c_body_photo');
    syncCameraToMain('c_eye_photo_camera', 'c_eye_photo');
    syncCameraToMain('e_body_photo_camera', 'e_body_photo');
    syncCameraToMain('e_eye_photo_camera', 'e_eye_photo');
    initCameraButtons();
  }, 100);

  loadFromStorage();
  refreshList();
  refreshStats();
  refreshDashboard();
  fillPedigreeSelect();
  
  // ÂàùÂßãÂåñÈ¶ñÈ°µ
  initHomePage();
  
  // ËøêË°åÂºÇÂ∏∏Ê£ÄÊµã
  setTimeout(showAnomalyAlerts, 1000);
  
  // Âç°ÁâáÂä®Áîª
  setTimeout(animateCards, 200);
  
  // Ê¨¢ËøéÈÄöÁü•
  setTimeout(() => {
    const pigeonCount = pigeons.filter(p => p.alive).length;
    if (pigeonCount > 0) {
      showNotification(`Ê¨¢ËøéÂõûÊù•ÔºÅÊÇ®Êúâ ${pigeonCount} Âè™È∏ΩÂ≠êÂú®Ê°£`, 'info', 4000);
    }
  }, 1000);
  
  // ÈªòËÆ§ÊòæÁ§∫È¶ñÈ°µ
  switchView('homeView');
  
  console.log('%cüïäÔ∏è ‰ø°È∏ΩÊ°£Ê°à‰∏éË°ÄÁªüÁÆ°ÁêÜÁ≥ªÁªü Pro v2.0', 'color: #2563eb; font-size: 16px; font-weight: bold;');
  console.log('%cÂø´Êç∑ÈîÆ: Ctrl+K ÊêúÁ¥¢ | Ctrl+N Êñ∞Â¢û | Esc ÂÖ≥Èó≠ÂºπÁ™ó', 'color: #64748b; font-size: 12px;');
</script>
</body>
</html>